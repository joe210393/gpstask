# 安全性分析：`/api/user/quest-progress` API

## 📋 當前實現

### 修改內容
允許從 `x-username` header 獲取用戶名，作為 JWT 認證的備用方案。

```javascript
const username = req.user?.username || req.headers['x-username'];
```

## ⚠️ 安全風險分析

### 1. **Header 偽造風險**
- **風險等級**：中
- **描述**：HTTP headers 可以被客戶端任意設置，攻擊者可以偽造 `x-username` header
- **影響**：攻擊者可以查詢其他用戶的劇情進度（資訊洩露）

### 2. **資訊洩露風險**
- **風險等級**：低-中
- **描述**：雖然只是查詢劇情進度，但仍然洩露了其他用戶的遊戲進度
- **影響**：
  - 攻擊者可以知道其他用戶完成了哪些關卡
  - 可能用於推斷用戶的遊戲習慣或活躍度

### 3. **權限繞過風險**
- **風險等級**：低（當前）
- **描述**：如果這個 API 未來被用於更敏感的操作，風險會增加
- **影響**：目前只是查詢操作，但如果未來擴展功能，可能會有更大風險

## ✅ 當前實現的緩解措施

### 1. **優先使用 JWT 認證**
```javascript
let username = req.user?.username; // 優先從 JWT 獲取
```

### 2. **格式驗證**
```javascript
if (/^09\d{8}$/.test(headerUsername)) {
  // 只接受手機號格式
}
```

### 3. **只讀操作**
- API 只返回數據，不修改任何資料
- 返回的數據（劇情進度）相對不敏感

### 4. **日誌記錄**
- 記錄使用 header 的情況，便於審計

## 🔒 最佳實踐建議

### 短期方案（當前實現）
✅ **已實施**：
1. 優先使用 JWT 認證
2. 添加格式驗證（手機號格式）
3. 記錄警告日誌
4. 僅用於只讀查詢操作

### 中期方案（建議）
1. **強制 JWT 認證**：
   ```javascript
   app.get('/api/user/quest-progress', authenticateToken, async (req, res) => {
     const username = req.user.username; // 強制從 JWT 獲取
     // ...
   });
   ```

2. **前端統一使用 JWT**：
   - 確保所有 API 調用都使用 `credentials: 'include'`
   - 移除 `x-username` header 的使用

### 長期方案（理想）
1. **完全移除 header 支持**：
   - 所有 API 都使用 JWT 認證
   - 統一認證機制

2. **添加速率限制**：
   - 對未認證的請求添加更嚴格的速率限制
   - 防止暴力查詢

3. **審計日誌**：
   - 記錄所有查詢操作
   - 監控異常查詢模式

## 📊 風險評估總結

| 風險類型 | 風險等級 | 當前緩解 | 建議改進 |
|---------|---------|---------|---------|
| Header 偽造 | 中 | 格式驗證 | 強制 JWT 認證 |
| 資訊洩露 | 低-中 | 只讀操作 | 添加速率限制 |
| 權限繞過 | 低 | 僅查詢操作 | 統一認證機制 |

## 🎯 結論

### 當前風險可接受的原因：
1. ✅ 只讀查詢操作，不修改數據
2. ✅ 返回的數據（劇情進度）相對不敏感
3. ✅ 已添加格式驗證和日誌記錄
4. ✅ 優先使用 JWT 認證

### 建議改進：
1. 🔄 **短期**：保持當前實現，但添加更詳細的日誌
2. 🔄 **中期**：遷移到完整的 JWT 認證
3. 🔄 **長期**：統一所有 API 的認證機制

## 📝 實施建議

如果決定加強安全性，可以：

1. **立即實施**（低風險）：
   - 添加更詳細的日誌記錄
   - 監控異常查詢模式

2. **短期實施**（中風險）：
   - 強制使用 JWT 認證
   - 移除 `x-username` header 支持

3. **長期實施**（最佳實踐）：
   - 統一所有 API 的認證機制
   - 實施完整的審計日誌系統

