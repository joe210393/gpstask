# 系統規格書（GPS 任務系統 / 實境解謎）

本文件描述系統的 **架構、資料模型、API、前端頁面、部署方式** 與重要設計決策，供開發與維運參考。

---

## 1. 系統目標

- 以 **GPS 定位** 為核心，提供「到點接任務 → 解題 → 得分/獎勵」體驗
- 支援 **劇情式解謎**（關卡解鎖）與 **限時活動**
- 提供 **WebAR（相機 + 指引 + 多媒體線索）** 入口
- 以 **自動驗證題型（數字/關鍵字/選擇/打卡）** 讓劇情流暢推進；必要時保留 **人工審核**（拍照）

---

## 2. 技術架構

- **Backend**：Node.js (18.x) + Express + MySQL（mysql2/promise）
- **Frontend**：純 HTML/CSS/JS（無框架）+ Leaflet 地圖
- **部署**：Zeabur（HTTPS）
- **檔案上傳**：multer，圖片存放於 `/data/public/images`（Zeabur volume）

---

## 3. 前端頁面與核心行為

### 3.1 玩家端

- `public/map.html` + `public/js/map.js`
  - 顯示任務點標記（依任務分類顯示不同 icon：單題/限時/劇情）
  - 限時任務顯示剩餘名額/剩餘時間（簡訊息）
  - 劇情任務：依玩家進度只顯示當前關卡

- `public/tasks-list.html` + `public/js/tasks-list.js`
  - 任務列表（含篩選）
  - 劇情任務同樣依玩家進度只顯示當前關卡
  - 卡片標籤顯示：任務分類（單題/限時/劇情）+ 題型（選擇/拍照/數字/關鍵字/打卡）

- `public/task-detail.html`
  - 接取任務（加入 `user_tasks`，狀態進行中）
  - 依題型渲染不同答題 UI（選擇/拍照/數字/關鍵字/打卡）
  - 開啟 AR：導向 `ar-view.html?taskId=...&lat=...&lng=...`

- `public/ar-view.html`
  - 相機畫面 + GPS + 羅盤指引（CSS 偽 AR）
  - 15m 內顯示 AR 內容（AR 圖片/YouTube 影片），超過則只顯示導航箭頭
  - Modal 放大檢視
  - **數字解謎專用：旋轉密碼鎖 UI**（在 AR 頁提交答案並自動比對）

### 3.2 管理/審核端

- `public/staff-dashboard.html` + `public/js/staff-dashboard.js`
  - 任務 CRUD（含：任務分類 single/timed/quest、題型、AR 圖片上傳、YouTube 連結）
  - 劇情任務線（Quest Chain）管理與任務分組顯示（折疊展開）

- `public/user-tasks.html` + `public/js/user-tasks.js`
  - 工作人員/管理員審核玩家進行中任務
  - Admin 可刪除玩家任務紀錄（重置）

---

## 4. 資料庫設計（核心表）

### 4.1 users

- `id`
- `username`
- `password`（bcrypt hash）
- `role`：`user` / `staff` / `shop` / `admin`（系統同時支援舊角色）

### 4.2 tasks

- 位置：`lat`, `lng`, `radius`
- 內容：`name`, `description`, `photoUrl`, `youtubeUrl`, `ar_image_url`
- 獎勵：`points`
- 建立者：`created_by`

#### 任務「分類」（關卡/限時/單題）
- `type`：`single` / `timed` / `quest`
- `quest_chain_id`, `quest_order`
- `time_limit_start`, `time_limit_end`, `max_participants`, `current_participants`

#### 任務「題型」（答題方式）
> 原始系統為 ENUM，已以 migration 調整為可擴充的型別（VARCHAR）以支援新題型。

- `task_type`：`multiple_choice` / `photo` / `number` / `keyword` / `location`（`qa` 為舊類型保留）
- `options`（JSON）：選擇題選項
- `correct_answer`：自動驗證標準答案（選擇/數字/關鍵字），或地點打卡用的固定密語（目前建議 `ARRIVED`）

### 4.3 user_tasks（玩家任務狀態）

- `user_id`, `task_id`
- `status`：`進行中` / `完成` / `放棄`
- `answer`：玩家提交內容（字串或圖片 URL）
- `started_at`, `finished_at`
- `redeemed` / `redeemed_at` / `redeemed_by`（兌換/核銷）

### 4.4 quest_chains / user_quests / user_badges

由 `migrate-task-system.js` 建立，用於劇情任務線與玩家進度/獎章（目前進度查詢 API 已使用 `user_quests`）。

---

## 5. API 規格（主要）

### 5.1 任務

- `GET /api/tasks`
  - 回傳任務列表（玩家端）

- `GET /api/tasks/:id`
  - 回傳單一任務（AR / 詳情頁）

- `GET /api/tasks/admin`
  - 後台任務列表（需 staff/admin 權限）

- `POST /api/tasks`
  - 新增任務（需 staff/admin 權限）

- `PUT /api/tasks/:id`
  - 編輯任務（需 staff/admin 權限）

- `DELETE /api/tasks/:id`
  - 刪除任務（需 staff/admin 權限；並清除相關 `user_tasks`）

### 5.2 玩家任務（接取/完成/答案）

- `POST /api/user-tasks`
  - 玩家接取任務（admin/staff/shop 被禁止）

- `GET /api/user-tasks?username=...`
  - 查詢玩家「進行中」任務（包含 `user_task_id`）

- `GET /api/user-tasks/all?username=...`
  - 查詢玩家全部任務（進行中/完成）

- `PATCH /api/user-tasks/:id/answer`
  - 送出答案
  - 若題型為 `multiple_choice` / `number` / `keyword`：後端自動比對 `correct_answer`，答對即完成並發放積分
  - 其他題型：僅儲存答案，狀態保持進行中（需人工審核或另行完成）

- `POST /api/user-tasks/finish`
  - 工作人員將指定任務設為完成（審核用）

- `DELETE /api/user-tasks/:id`
  - Admin 刪除玩家任務紀錄（重置）

### 5.3 劇情進度

- `GET /api/user/quest-progress`
  - 回傳玩家各劇情線的 `current_step_order`
  - 供 `map.js` 與 `tasks-list.js` 過濾顯示當前關卡

### 5.4 檔案上傳

- `POST /api/upload`
  - 上傳圖片（任務封面/AR 圖片/拍照題答案）
  - 回傳 URL（`/images/...`）

---

## 6. 部署與資料庫遷移

### 6.1 Zeabur 啟動流程

`package.json` 的 `start` 會依序執行 migrations 後再啟動 server：
- `node migrate-ar-image.js`
- `node migrate-task-system.js`
- `node migrate-task-type.js`
- `node index.js`

### 6.2 環境變數（建議）

- `MYSQL_HOST`
- `MYSQL_PORT`
- `MYSQL_USERNAME`
- `MYSQL_ROOT_PASSWORD`
- `MYSQL_DATABASE`
- `JWT_SECRET`

> 若平台未注入 DB 密碼，migration 腳本需確保能連線（目前已有對 Zeabur 連線的預設值，但建議仍以環境變數管理）。

---

## 7. 重要設計決策與限制

- WebAR 採用「相機畫面 + CSS 偽 AR」以提高跨裝置穩定性（避開 WebGL/AR.js 顯示不穩定問題）
- 劇情任務在地圖與列表 **只顯示當前關卡**，避免任務點過度擁擠
- 自動驗證題型（選擇/數字/關鍵字/打卡）用於劇情關卡；拍照題保留給最終人工審核


