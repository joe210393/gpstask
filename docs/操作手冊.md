# 操作手冊（GPS 任務系統 / 實境解謎）

本手冊給 **管理員 / 工作人員 / 玩家** 使用，說明日常操作流程與常見情境處理。

---

## 1. 角色與權限

- **玩家 (`user`)**：可在地圖接任務、進入任務頁解題、開啟 AR、送出答案/照片。
- **工作人員 (`shop` / `staff`)**：可新增/編輯/刪除任務與商品；可進入任務審核區將玩家任務設為完成；不可接取任務。
- **管理員 (`admin`)**：具備工作人員功能 + 可查看全部工作人員建立的內容；可在審核頁 **刪除玩家任務紀錄** 以重置（讓玩家重新接取）；不可接取任務。

> 備註：系統同時存在 `staff` 與 `shop` 角色（向後相容），兩者都視為工作人員權限。

---

## 2. 玩家操作流程

### 2.1 註冊 / 登入

- **註冊**：`/register.html`
- **登入**：`/login.html`

登入後可使用：
- 地圖：`/map.html`
- 任務列表：`/tasks-list.html`
- 個人任務/進度：`/user-dashboard.html`、`/user-tasks.html`

### 2.2 在地圖接取任務

1. 進入 `map.html`，允許 GPS 權限。
2. 點擊地圖上的任務標記，查看任務資訊。
3. 進入任務詳情：`task-detail.html?id=任務ID`
4. 在任務詳情頁點擊 **開始任務**（接取任務，狀態變為進行中）。

> 注意：管理員/工作人員帳號在地圖頁會被阻擋接取任務。

### 2.3 任務詳情頁解題與送出

進入 `task-detail.html?id=任務ID` 後，依「題型」顯示不同操作：

- **選擇題 (`multiple_choice`)**：選擇後送出；若答對系統立即完成任務。
- **拍照上傳 (`photo`)**：上傳照片後送出；通常需要工作人員審核（視活動規則）。
- **數字解謎 (`number`)**：輸入數字後送出；答錯可重試，答對立即完成。
- **關鍵字解碼 (`keyword`)**：輸入關鍵字後送出；答錯可重試，答對立即完成。
- **地理圍欄打卡 (`location`)**：點「我已到達」按鈕進行定位檢查；符合範圍即完成。

### 2.4 開啟 AR 尋找線索

1. 在任務詳情頁點擊 **📸 開啟 AR 尋找線索**。
2. AR 頁：`/ar-view.html?taskId=任務ID&lat=...&lng=...`
3. 依指引允許相機與方向感測器權限。
4. 接近目標點（目前設定：15m 內才會顯示主要 AR 物件；更遠只顯示導航箭頭）。

### 2.5 AR 旋轉密碼鎖（數字解謎專用）

若任務題型為 **數字解謎 (`number`)**：
1. 進入 AR 頁後會看到 **🔒 輸入密碼**。
2. 打開後可用 ▲/▼ 或上下滑動輪盤調整每一位數。
3. 按 **確定解鎖**：
   - 系統會自動提交答案並比對
   - **答對**：自動完成任務並導回任務頁
   - **答錯**：提示錯誤，玩家可繼續重試

> 若提示「找不到進行中的任務紀錄」，請先回任務頁按 **開始任務** 讓任務進入「進行中」，再進入 AR。

---

## 3. 工作人員 / 管理員操作流程

### 3.1 進入後台（新增任務）

後台頁面：`/staff-dashboard.html`

可操作：
- **新增任務點**
- **編輯/刪除任務**
- **新增劇情任務線（Quest Chain）**
- **商品管理**（如已啟用）

### 3.2 任務分類（單題 / 限時 / 劇情）

在後台新增/編輯任務時可選：
- **單題任務 (`single`)**：完成一次後不可再接（一般任務）
- **限時任務 (`timed`)**：需設定開始/結束時間、名額（max_participants）
- **劇情任務 (`quest`)**：需指定劇情任務線 + 關卡順序（quest_order）

> 前台地圖/任務列表會「依玩家進度只顯示劇情當前關卡」。若玩家尚未接取該劇情，預設只顯示第 1 關。

### 3.3 任務題型（選擇 / 拍照 / 數字 / 關鍵字 / 打卡）

後台新增/編輯任務時，可選題型：
- **選擇題**：需填 4 個選項與正確答案
- **拍照/上傳照片**：玩家上傳後，通常由工作人員審核是否完成
- **數字解謎**：需填「標準答案」（數字字串）
- **關鍵字解碼**：需填「標準答案」（關鍵字字串）
- **地理圍欄打卡**：以任務座標與半徑判定；（目前建議標準答案固定設定為 `ARRIVED`，由前台自動送出）

### 3.4 任務審核（玩家完成/兌換）

任務審核頁：`/user-tasks.html`

- **工作人員/管理員**：可查看玩家「進行中任務」
- **設為完成**：對需要人工審核的任務（例如拍照）可點「設為完成」
- **刪除紀錄（管理員）**：若玩家卡關或需重置，可刪除該筆 `user_tasks` 紀錄，玩家即可重新接取

---

## 4. 常見問題（FAQ）

### 4.1 手機無法開啟相機或定位
- 手機瀏覽器通常要求 **HTTPS** 才能使用相機/定位（`localhost` 例外）。
- 請用 Zeabur 部署網址測試（HTTPS）。

### 4.2 AR 一直顯示「啟動相機中…」
- iOS 需要「使用者點擊」才能授權感測器與相機。
- AR 頁會先顯示啟動蓋板，點擊「開始搜尋」才會啟動。

### 4.3 劇情任務為什麼只看到第一關？
系統設計為「依玩家進度顯示當前關卡」，避免地圖過度擁擠；未接取時預設顯示第 1 關。


