# 近期修改記錄 (Recent Changes Log)

## 修改日期：2026-02-01

### 1. 兩階段 RAG 搜尋系統 (Two-Stage RAG Search System)

#### 目的
- 提高辨識準確度：先進行傳統 embedding 搜尋作為基準，再進行 traits-based 混合搜尋
- 避免高分數結果被低分數結果覆蓋：只有當新結果分數明顯更高（>15%）時才替換

#### 實現位置
- `index.js` 第 3306-3443 行

#### 關鍵邏輯
1. **第一階段：傳統搜尋（embedding only）**
   - 使用 `classify()` 判斷是否為植物
   - 使用 `smartSearch()` 進行純 embedding 搜尋
   - 保存結果到 `preSearchResults` 作為基準

2. **第二階段：Traits-based 混合搜尋**
   - 從 AI 回應中提取結構化 traits（JSON）
   - 使用 `isPlantFromTraits()` 判斷是否為植物
   - 使用 `hybridSearch()` 進行混合搜尋（embedding + feature matching）

3. **結果比較與選擇**
   - 比較第一階段和第二階段的最高分數
   - 只有當新結果分數 > 舊結果分數 + 0.15 時，才使用新結果
   - 否則保留第一階段結果（更可靠的 embedding 搜尋）

#### 日誌輸出
- `📋 第一階段檢測到的植物：` - 顯示第一階段所有結果
- `📋 第二階段檢測到的植物：` - 顯示第二階段所有結果（包含 embedding 和 feature 分數）
- `✅ 保留第一階段結果` 或 `🔄 第二階段結果分數更高`

---

### 2. LM 與 RAG 協作模式 (LM-RAG Collaboration Mode)

#### 目的
- 當 LM（語言模型）和 RAG 都正確識別同一植物時，提高信心度
- 避免錯誤匹配：嚴格匹配植物名稱，避免「木麻黃」匹配到「錦帶花」

#### 實現位置
- `index.js` 第 3619-3694 行

#### 關鍵邏輯
1. **提取 LM 提到的植物名稱**
   - 從 `<reply>` 標籤中提取文字
   - 從 RAG 結果中取得所有可能的中文名和學名
   - 在 LM 回答中搜尋這些名稱

2. **嚴格匹配**
   - 完全匹配：`plantNameLower === lmNameLower`
   - 學名匹配：`scientificNameLower === lmNameLower`
   - 包含匹配（長度 >= 3）：避免短字串誤匹配

3. **信心度加成**
   - 只有當最高分數 >= 0.5 時才應用加成
   - 加成值：0.4（40%）
   - 記錄不匹配的情況用於調試

#### 日誌輸出
- `✅ LM 與 RAG 匹配: LM提到「...」，RAG找到「...」，給予信心度加成 40%`
- `⚠️ LM 提到「...」，但 RAG 找到「...」，名稱不匹配，不給予加成`

---

### 3. 分數調整機制優化 (Score Adjustment Optimization)

#### 目的
- 修復分數調整過度問題：之前所有分數都變成 100%，失去區分度
- 保留分數差異：使用漸進式加成，最多加成原始分數的 50%

#### 實現位置
- `index.js` 第 3704-3725 行

#### 關鍵邏輯
1. **漸進式加成**
   - 最多加成原始分數的 50%：`maxBoost = p.score * 0.5`
   - 實際加成：`actualBoost = Math.min(lmConfidenceBoost, maxBoost)`
   - 調整後分數：`adjusted = Math.min(1.0, p.score + actualBoost)`

2. **範例**
   - 原始分數 63.5%：最多加成 31.75%，調整後約 95.25%
   - 原始分數 59.9%：最多加成 29.95%，調整後約 89.85%
   - 保留分數差異，避免全部變成 100%

#### 日誌輸出
- `📊 分數調整: 原始=63.5%, 加成=31.8%, 調整後=95.3%`

---

### 4. 快速特徵提取模式 (Quick Feature Extraction Mode)

#### 目的
- 兩階段 UX：先快速顯示特徵，再進行完整分析
- 避免重複 API 調用：使用 `quickOnly=true` 標記，後端只返回特徵

#### 實現位置
- `index.js` 第 3168-3214 行
- `public/js/ai-lab.js` 第 1496-1532 行

#### 關鍵邏輯
1. **前端發送 `quickOnly=true`**
   - 快速特徵提取：使用簡化的 prompt，只提取特徵
   - 不進行 RAG 和完整分析

2. **後端處理**
   - 檢查 `quickOnly` 標記
   - 如果為 true，只進行特徵提取並立即返回
   - 跳過 RAG 搜尋和完整分析

#### 日誌輸出
- `⚡ 快速特徵提取模式：只提取特徵，跳過 RAG 和完整分析`
- `📊 快速特徵提取完成`

---

### 5. 截斷處理改進 (Truncation Handling Improvement)

#### 目的
- 檢測 AI 回應被截斷的情況
- 提供更詳細的警告和建議

#### 實現位置
- `index.js` 第 3266-3304 行

#### 關鍵邏輯
1. **檢測截斷**
   - 檢查 `finish_reason === 'length'`
   - 檢查描述長度是否過短（< 100 字元）

2. **警告和建議**
   - 如果截斷：警告可能缺少完整的 XML 格式
   - 如果描述過短：警告可能影響 RAG 搜尋準確度
   - 提供建議：增加 max_tokens 或優化 prompt

#### 日誌輸出
- `⚠️ AI 回應被截斷（finish_reason: length），可能缺少完整的 XML 格式`
- `⚠️ 提取的描述過短（XX 字元），可能影響 RAG 搜尋準確度`
- `✅ 提取的描述長度足夠（XX 字元），應該不影響 RAG 搜尋`

---

## 代碼結構說明

### 主要流程
1. **快速特徵提取**（如果 `quickOnly=true`）
   - 只提取特徵，立即返回

2. **完整分析流程**
   - AI 視覺辨識 → 提取詳細描述
   - 第一階段 RAG 搜尋（embedding only）
   - 第二階段 RAG 搜尋（traits-based hybrid）
   - 結果比較與選擇
   - LM-RAG 匹配與信心度加成
   - 分數調整

### 關鍵變數
- `preSearchResults`: 保存第一階段搜尋結果作為基準
- `plantResults`: 最終的植物搜尋結果
- `lmConfidenceBoost`: LM 與 RAG 匹配時的信心度加成
- `quickOnly`: 快速特徵提取模式標記

### 注意事項
1. **分數比較閾值**：15%（0.15）- 只有當新結果分數明顯更高時才替換
2. **LM 加成條件**：原始分數 >= 0.5 才應用加成
3. **分數調整上限**：最多加成原始分數的 50%
4. **嚴格匹配**：LM 名稱匹配需要長度 >= 3 或完全匹配

---

## 未來改進建議

1. **多語言支援**：快速特徵提取模式需要加入語言指示
2. **特徵匹配優化**：改進 traits 提取和匹配邏輯
3. **分數計算優化**：考慮更複雜的分數計算公式
4. **日誌優化**：統一日誌格式，方便調試
