# RAG 診斷與行動計畫（2026-02-05）

## 一、現況診斷（基於 test-report-12.md）

### 1.1 結果
- **12 筆全部失敗**（0/12 通過）
- Top1 常錯：火筒樹→水漆、長穗木→金露花、風鈴草→花煙草、西印度櫻桃→白木漿果、棕竹→澀葉榕、黃椰子→十里香

### 1.2 觀察到的現象

| 現象 | 證據 | 推論 |
|------|------|------|
| Query 特徵數量 4–6 個 | 火筒樹 6 個、長穗木 5 個、風鈴草 4 個 | 特徵數量不算過多，但類別內有重複 |
| 圓錐+總狀同時出現 | 火筒樹：圓錐花序+總狀花序 | 同一類別（flower_inflo）不應有兩個，造成「誰都容易中」 |
| 錯的候選 feature 100% | 長穗木 case：金露花 100% feature match | 金露花、長穗木都有 灌木+互生+鋸齒+總狀/圓錐，通用特徵多，無法區分 |
| 棕櫚類仍被榕樹吸走 | 棕竹→澀葉榕、黃椰子→十里香 | Gate-A 降權後仍不夠，或 Gate 未真正打到錯候選 |
| 強特徵未發揮 | 長穗木有蒴果、穗狀花序，但 query 沒蒴果 | keyword-assist 沒抽到蒴果；或 LM 描述沒提到 |

### 1.3 根因分析（邏輯鏈）

```
1. 雜訊特徵淹沒強特徵
   → 灌木、互生、全緣、鋸齒、總狀、圓錐 都是高頻特徵（df 大）
   → 很多候選都能匹配 4–5 個 → feature_score 拉高 → 錯的也能排前面

2. 類別內無上限，矛盾未處理
   → 圓錐+總狀同時進 query（互斥，應只留 1 個）
   → 全緣+鋸齒 若同時出現（互斥）
   → 類別內多個值讓「碰巧命中」機率變高

3. Gate 只降權不淘汰
   → 棕櫚 query 但候選無棕櫚 → ×0.25~0.6 後，若 embedding 高仍可排前
   → 需要「強特徵不匹配 → 直接淘汰」才能擋住

4. 強特徵門檻低（confidence 0.3）
   → 猜的特徵也進 query → 增加雜訊

5. 無「類別上限」
   → 43 個特徵全進 df 計算，但 query 組裝時沒有 cap
   → 實際上 traits + keyword-assist 合併後可能 6–8 個，但若不做類別內去重，仍會出現圓錐+總狀等矛盾
```

---

## 二、目前 43 個特徵的類別分布（FEATURE_VOCAB）

| 類別 | 特徵數 | 特徵列舉 | 建議上限 |
|------|--------|----------|----------|
| life_form | 4 | 喬木、灌木、草本、藤本 | 1 |
| leaf_arrangement | 4 | 互生、對生、輪生、叢生 | 1 |
| leaf_type | 6 | 單葉、複葉、羽狀複葉、掌狀複葉、二回羽狀、三出複葉 | 1 |
| leaf_margin | 3 | 全緣、鋸齒、波狀 | 1 |
| flower_inflo | 8 | 總狀、圓錐、聚繖、繖房、頭狀、繖形、穗狀、佛焰 | 1 |
| fruit_type | 8 | 莢果、漿果、核果、蒴果、翅果、瘦果、堅果、梨果 | 1 |
| flower_color | 6 | 白花、黃花、紅花、紫花、粉紅花、橙花 | 1 |
| trunk_root | 2 | 板根、氣生根 | 1 |
| special | 4 | 有刺、乳汁、胎生苗、棕櫚 | 2 |

**總目標**：12–18 個（每類最多 1–2 個）

---

## 三、建議的下一步選項（按優先級與影響力）

### 選項 A：類別上限 + 矛盾處理（最優先，立即有效）

**邏輯**：減少「誰都匹配到一堆」的狀況，讓 feature_score 更能區分正解與錯解。

**方法**：
1. 在 `index.js` 合併 traits + keyword-assist 後，送 hybrid 前，加一道 **capByCategory**：
   - life_form / leaf_arrangement / leaf_margin / leaf_type / flower_inflo / fruit_type / flower_color：每類最多 1
   - special：最多 2
   - trunk_root：最多 1
2. 矛盾處理（先做「包含」再做「互斥」）：
   - 包含：羽狀複葉/掌狀複葉 → 刪複葉；漿果/蒴果 等 → 若有細類則刪「果實」泛稱
   - 互斥：全緣 vs 鋸齒 vs 波狀 只留 1；互生 vs 對生 vs 輪生 只留 1；圓錐 vs 總狀 vs 穗狀 只留 1

**預期效果**：Query 特徵從 6–8 個壓成 5–7 個高品質，匹配更有鑑別力。

**風險**：若 cap 太嚴，可能漏掉某些有效特徵；可先用「每類最多 1」觀察。

---

### 選項 B：提高強特徵門檻（fruit / inflo / special / trunk_root）

**邏輯**：低信心（0.3）的強特徵往往是猜的，會拉高錯候選的分數。

**方法**：
- 在 `traits-parser.js` 的 `traitsToFeatureList` 或 `evaluateTraitQuality` 中：
  - life_form / leaf_arrangement / leaf_margin：維持 confidence ≥ 0.35
  - fruit_type / flower_inflo / special / trunk_root：提高到 **≥ 0.55**
- 若 evidence 太短（< 6 字）→ confidence 上限 ×0.8

**預期效果**：進 query 的強特徵更可靠，減少「猜的漿果/花序」幫錯候選加分。

**風險**：可能漏掉一些正確但信心稍低的強特徵；可先設 0.5 觀察。

---

### 選項 C：Gate-A 升級為兩層（硬淘汰 + 軟降權）

**邏輯**：棕櫚/複葉類仍被榕樹吸走，代表「只降權」不夠，需要「不匹配就淘汰」。

**方法**：
- **硬淘汰**（confidence ≥ 0.65 且 evidence 非空）：
  - query 有：羽狀複葉/掌狀複葉/二回羽狀/三出複葉、棕櫚、乳汁、有刺、氣生根、板根、蒴果/漿果/核果/翅果/莢果、佛焰花序、頭狀花序
  - 候選完全沒有同義詞 → **直接淘汰**（不進入 final results）
- **軟降權**：confidence 0.45–0.65 → 維持現有 ×0.25~0.6

**預期效果**：棕竹、黃椰子等 case，榕樹類會被淘汰，正解有機會進 Top1。

**風險**：若候選 payload 缺 key_features_norm / trait_tokens，可能誤殺正解；需確保 enriched 資料有寫入。

---

### 選項 D：矛盾表擴充（leaf_margin / leaf_arrangement / compound 包含關係）

**邏輯**：已做「複葉→移除單葉」，但還有其他互斥與包含關係未處理。

**方法**：
- **互斥**（同時出現只留高信心）：
  - leaf_margin：全緣 / 鋸齒 / 波狀
  - leaf_arrangement：互生 / 對生 / 輪生
  - surface_hair：無毛 / 有毛
- **包含**（有細類則刪粗類）：
  - 羽狀複葉/掌狀複葉/二回羽狀/三出複葉 ⇒ 刪「複葉」
  - 佛焰/頭狀/繖形/穗狀/總狀/圓錐 ⇒ 若有細類則不額外加「花序」泛稱
  - 漿果/核果/蒴果… ⇒ 若有細類則不額外加「果實」泛稱

**預期效果**：Query 更乾淨，與選項 A 相輔相成。

---

### 選項 E：觀測指標調整（驗證用）

**邏輯**：除了 Top1，還要看「強特徵是否真的在幫忙」。

**方法**：
- 追蹤：Top1 / Top5 命中率
- 追蹤：當 query 有蒴果/漿果/穗狀花序 時，Top30 中至少幾筆有對應特徵
- 若「強特徵命中率」低，代表 payload 或 matching 有問題

---

## 四、建議執行順序與理由

| 順序 | 選項 | 理由 |
|------|------|------|
| 1 | **A（類別上限 + 矛盾）** | 直接減少雜訊，不改 Gate、不改門檻，風險最低，效果最可預期 |
| 2 | **D（矛盾表擴充）** | 與 A 一起做，在 traits-parser 或 index.js 合併後統一處理 |
| 3 | **B（強特徵門檻）** | 減少猜的特徵進 query，與 A 疊加效果 |
| 4 | **C（Gate 硬淘汰）** | 改動較大，建議 A+B+D 後若棕櫚類仍錯，再上 |
| 5 | **E（觀測指標）** | 用於驗證，可與 1–4 並行 |

---

## 五、需要你選擇的方向

請回覆以下之一（可多選）：

1. **先做 A + D**：類別上限 + 矛盾處理（最快落地、風險最低）
2. **先做 B**：提高強特徵門檻
3. **先做 C**：Gate 硬淘汰（改動大，建議 A 之後）
4. **A + B + D 一起做**：一次到位，再測 report
5. **其他**：例如只做 A、或調整上述參數

我會依你的選擇，產出對應的程式修改與具體程式碼位置。
