#!/usr/bin/env python3
"""
ç”¨ã€Œäººé¡ç†æƒ³ä¸­æ–‡æè¿°ã€ç›´æ¥æ‰“ Embedding `/search`ï¼Œ
æª¢æŸ¥ç‰¹å®šç‰©ç¨®åœ¨ Top100 å…§çš„çœŸå¯¦æ’åã€‚

ç›®æ¨™ï¼šé‡åŒ–ç›®å‰ embedding+DB çš„èƒ½åŠ›ä¸Šé™ï¼Œæ±ºå®šå¾ŒçºŒæŠ•è³‡æ–¹å‘ã€‚
"""

import os
import sys
import json
import textwrap
from typing import List, Dict

import requests


EMBEDDING_API_URL = os.environ.get("EMBEDDING_API_URL", "http://gpstask-ooffix:8080")


# éƒ¨åˆ†å¸¸è¦‹åˆ¥åï¼ˆåƒ…æ‹¿ä¾†æ¯”å° chinese_nameï¼‰
COMMON_SYNONYMS = {
    "è”“æ€§é¦¬çº“ä¸¹": ["è”“é¦¬çº“ä¸¹", "é¦¬çº“ä¸¹", "äº”è‰²æ¢…"],
    "ä¹é‡è‘›": ["ä¸‰è§’æ¢…", "ç°•æœéµ‘"],
    "ç´«ç ": ["ç´«ç ", "ç´«ç æ¨¹"],
    "å—å¤©ç«¹": ["å—å¤©ç«º"],
    "å¤§æ³¢æ–¯èŠ": ["ç§‹æ«»"],
    "è…è•¨": ["æ³¢å£«é “è…è•¨"],
}


def expand_expected(expected: str) -> List[str]:
    names = [expected]
    if expected in COMMON_SYNONYMS:
        names.extend(COMMON_SYNONYMS[expected])
    # å»é‡
    seen = set()
    out: List[str] = []
    for n in names:
        n = n.strip()
        if n and n not in seen:
            seen.add(n)
            out.append(n)
    return out


TESTS: List[Dict] = [
    {
        "name": "ç´«ç ",
        "expected": "ç´«ç ",
        "query": "ç´«ç ï¼ŒçŒæœ¨ï¼Œå°ç´«è‰²æ¼¿æœæˆä¸²è‘—ç”Ÿåœ¨ææ¢ä¸Šï¼Œæˆç†Ÿæ™‚æ•´ææ›æ»¿ç´«è‰²å°æœï¼Œè‘‰ç‚ºå–®è‘‰å°ç”Ÿæˆ–è¿‘å°ç”Ÿã€‚"
    },
    {
        "name": "é³¥å°¾èŠ±",
        "expected": "é³¥å°¾èŠ±",
        "query": "é³¥å°¾èŠ±ï¼Œæ°´ç”Ÿæˆ–æ¿•åœ°å¤šå¹´ç”Ÿè‰æœ¬ï¼Œç´°é•·çš„ç©—ç‹€èŠ±åºå¾æ°´é¢ä¼¸å‡ºï¼Œé ‚ç«¯é›†ä¸­è¨±å¤šå°èŠ±ï¼Œè‘‰ç·šå½¢æˆ–æ²‰æ°´è‘‰ã€‚"
    },
    {
        "name": "è”“æ€§å¤å ‡",
        "expected": "è”“æ€§å¤å ‡",
        "query": "è”“æ€§å¤å ‡ï¼Œå°å‹åœ’è—è‰æœ¬ï¼Œææ¢è”“ç”Ÿæˆ–å‚åŠï¼Œè‘‰å°ç”Ÿæˆ–äº’ç”Ÿï¼ŒèŠ±æœµæ¼æ–—ç‹€æˆ–å£ç‹€ï¼Œå¸¸è¦‹è—ç´«è‰²æˆ–ç´«è‰²ï¼Œå¤å­£é–‹èŠ±ã€‚"
    },
    {
        "name": "è¶Šæ©˜è‘‰è”“æ¦•",
        "expected": "è¶Šæ©˜è‘‰è”“æ¦•",
        "query": "è¶Šæ©˜è‘‰è”“æ¦•ï¼Œå¸¸ç¶ åŒåŒæˆ–æ”€çˆ¬æ€§æ¦•æ¨¹ï¼Œç´°æè²¼é™„ç‰†é¢ï¼Œè‘‰ç‰‡å°è€Œåšï¼Œåµå½¢æˆ–æ©¢åœ“å½¢ï¼Œè‘‰ç·£å…¨ç·£ã€‚"
    },
    {
        "name": "ä¹é‡è‘›",
        "expected": "ä¹é‡è‘›",
        "query": "ä¹é‡è‘›ï¼Œæ”€çˆ¬çŒæœ¨ï¼Œæœ‰åˆºï¼Œææ¢æŸ”è»Ÿå¯æ”€é™„ï¼Œè‘‰åµå½¢ï¼Œè‹ç‰‡å¤§è€Œè–„ç´™è³ªï¼Œå¸¸è¦‹ç´«ç´…ã€æ¡ƒç´…æˆ–ç™½è‰²ï¼Œçœ‹èµ·ä¾†åƒèŠ±ç“£ã€‚"
    },
    {
        "name": "å°è‘‰å—æ´‹æ‰",
        "expected": "å°è‘‰å—æ´‹æ‰",
        "query": "å°è‘‰å—æ´‹æ‰ï¼Œé«˜å¤§å¸¸ç¶ é‡è‘‰æ¨¹ï¼Œæ¨¹å½¢å¡”ç‹€ï¼Œææ¢å±¤è¼ªç‹€æ°´å¹³ä¼¸å‡ºï¼Œå°æå¯†é›†ï¼Œè‘‰ç´°å°å‘ˆé‡ç‹€æˆ–é±—ç‰‡ç‹€ã€‚"
    },
    {
        "name": "è¿·è¿­é¦™",
        "expected": "è¿·è¿­é¦™",
        "query": "è¿·è¿­é¦™ï¼Œå¸¸ç¶ çŒæœ¨ï¼Œææ¢ç´°é•·ï¼Œç·šå½¢è‘‰å°ç”Ÿï¼Œè‘‰å­ç‹¹é•·é‚Šç·£æ²æ›²ï¼Œæ‰æ»æœ‰å¼·çƒˆé¦™å‘³ï¼Œå¤šç”¨ä½œé¦™è‰æ¤ç‰©ã€‚"
    },
    {
        "name": "å—å¤©ç«¹",
        "expected": "å—å¤©ç«¹",
        "query": "å—å¤©ç«¹ï¼Œå¸¸ç¶ çŒæœ¨ï¼Œä¸‰å›ç¾½ç‹€è¤‡è‘‰ï¼Œå°è‘‰ç‹¹é•·ï¼Œç§‹å†¬è‘‰è‰²å¯è½‰ç´…ï¼Œçµæœæ™‚æˆä¸²ç´…è‰²æ¼¿æœã€‚"
    },
    {
        "name": "å…‰è‘‰çŸ³æ¥ ",
        "expected": "å…‰è‘‰çŸ³æ¥ ",
        "query": "å…‰è‘‰çŸ³æ¥ ï¼Œå¸¸ç¶ çŒæœ¨æˆ–å°å–¬æœ¨ï¼Œæ–°è‘‰ç´…è‰²ï¼Œæˆè‘‰æœ‰å…‰æ¾¤ï¼Œè‘‰åµå½¢æˆ–é•·æ©¢åœ“å½¢ï¼Œæ˜¥å­£é–‹ç™½è‰²å°èŠ±æˆèšç¹–ç‹€èŠ±åºï¼Œçµæœç´…è‰²å°æœã€‚"
    },
    {
        "name": "è’²è‘µ",
        "expected": "è’²è‘µ",
        "query": "è’²è‘µï¼Œé«˜å¤§æ£•æ«šæ¨¹ï¼Œå–®ä¸€ç²—å¹¹ï¼Œé ‚ç«¯é•·å‡ºå¤§å‹æ‰‡å½¢è‘‰ï¼Œè‘‰æŒç‹€æ·±è£‚å‘ˆåœ“å‚˜å½¢ï¼Œä¸‹å‚çš„æ¯è‘‰åœç¹æ¨¹å¹¹ã€‚"
    },
    {
        "name": "éºµåŒ…æ¨¹",
        "expected": "éºµåŒ…æ¨¹",
        "query": "éºµåŒ…æ¨¹ï¼Œç†±å¸¶å¸¸ç¶ å–¬æœ¨ï¼Œè‘‰å¤§è€Œæ·±è£‚ï¼Œé¡ä¼¼æ¥“è‘‰ä½†æ›´å¤§ï¼Œçµæœæ™‚æ¨¹ä¸Šè‘—ç”Ÿå¤§å‹ç¶ è‰²æˆ–é»ƒç¶ è‰²æ¤­åœ“å½¢æœå¯¦ã€‚"
    },
    {
        "name": "å¤§æ³¢æ–¯èŠ",
        "expected": "å¤§æ³¢æ–¯èŠ",
        "query": "å¤§æ³¢æ–¯èŠï¼Œä¸€å¹´ç”Ÿè‰æœ¬ï¼Œæ¤æ ªé«˜è€Œç´°ï¼Œç¾½ç‹€è£‚è‘‰ç´°é•·ï¼Œé ­ç‹€èŠ±åºé ‚ç”Ÿï¼ŒèˆŒç‹€èŠ±å¸¸ç‚ºç²‰ç´…ã€ç™½è‰²æˆ–ç´«è‰²ï¼ŒèŠ±å¿ƒé»ƒè‰²ã€‚"
    },
    {
        "name": "åƒæ—¥ç´…",
        "expected": "åƒæ—¥ç´…",
        "query": "åƒæ—¥ç´…ï¼Œä¸€å¹´ç”Ÿè‰æœ¬ï¼Œç›´ç«‹åˆ†æï¼Œè‘‰å°ç”Ÿï¼ŒèŠ±é ­ç‹€çƒå½¢ï¼Œå°è‹ç‰‡ç¡¬ä¸”è‰²å½©é®®è±”ï¼Œå¸¸è¦‹ç´«ç´…ã€ç²‰ç´…æˆ–ç™½è‰²ã€‚"
    },
    {
        "name": "è…è•¨",
        "expected": "è…è•¨",
        "query": "è…è•¨ï¼Œå¤šå¹´ç”Ÿè•¨é¡è§€è‘‰æ¤ç‰©ï¼Œå¢ç”Ÿç¾½ç‹€è¤‡è‘‰å¾åŸºéƒ¨æŠ½å‡ºï¼Œè‘‰ç‰‡ç‹¹é•·å‘ˆå¼“å½¢ä¸‹å‚ï¼Œç„¡èŠ±ç„¡æœï¼Œå¸¸ä½œå®¤å…§ç›†æ ½ã€‚"
    },
    {
        "name": "æ°´ç«¹èŠ‹",
        "expected": "æ°´ç«¹èŠ‹",
        "query": "æ°´ç«¹èŠ‹ï¼Œè§€è‘‰æ¤ç‰©ï¼Œåœ°ä¸‹è–åŒåŒï¼Œè‘‰é•·æ©¢åœ“å½¢æˆ–æŠ«é‡å½¢ï¼Œæœ‰æ˜é¡¯æ–‘ç´‹æˆ–æ¢ç´‹ï¼Œè‘‰èƒŒå¸¸å¸¶ç´«è‰²ï¼Œç”Ÿé•·æ–¼æ½®æ¿•ç’°å¢ƒã€‚"
    },
    {
        "name": "æ°´è•¨",
        "expected": "æ°´è•¨",
        "query": "æ°´è•¨ï¼Œæ°´ç”Ÿæˆ–æ¿•åœ°è•¨é¡ï¼ŒåŒåŒè–ï¼Œè‘‰ç‰‡ç¾½ç‹€æ·±è£‚ï¼Œå¸¸è¦‹ç”Ÿé•·åœ¨æ°´é‚Šæˆ–æ·ºæ°´ä¸­ï¼Œç„¡èŠ±ç„¡æœã€‚"
    },
    {
        "name": "ç´…åˆºéœ²å…œæ¨¹",
        "expected": "ç´…åˆºéœ²å…œæ¨¹",
        "query": "ç´…åˆºéœ²å…œæ¨¹ï¼Œéœ²å…œæ¨¹ç§‘æ¤ç‰©ï¼Œå¹¹å¸¸æœ‰æ”¯æŸ±æ ¹ï¼Œè‘‰é•·è€Œå …ç¡¬å…·é‹¸é½’ï¼Œæ²¿å¹¹é ‚å¯†é›†æˆæŸï¼Œæˆç†Ÿæœå¯¦ç‚ºçƒç‹€èšåˆæœï¼Œå¤–è§€ä¼¼é³³æ¢¨ã€‚"
    },
    {
        "name": "è˜­å¶¼æµ·æ¡",
        "expected": "è˜­å¶¼æµ·æ¡",
        "query": "è˜­å¶¼æµ·æ¡ï¼Œæµ·æ¿±å¸¸ç¶ çŒæœ¨æˆ–å°å–¬æœ¨ï¼Œè‘‰å€’åµå½¢æˆ–åŒ™å½¢ï¼Œåšé©è³ªï¼Œå¸¸èšç”Ÿæç«¯ï¼Œç™½è‰²æˆ–æ·¡é»ƒè‰²å°èŠ±æˆèšç¹–èŠ±åºã€‚"
    },
    {
        "name": "è”“æ€§é¦¬çº“ä¸¹",
        "expected": "è”“æ€§é¦¬çº“ä¸¹",
        "query": "è”“æ€§é¦¬çº“ä¸¹ï¼ŒåŒåŒæˆ–è”“ç”ŸçŒæœ¨ï¼Œæ–¹å½¢ææ¢ï¼Œè‘‰åµå½¢å…·ç²—é‹¸é½’ï¼ŒèŠ±ç‚ºå°å‹é ­ç‹€èŠ±åºï¼ŒèŠ±è‰²æ©™é»ƒç´…ç­‰æ¼¸è®Šï¼Œå¸¸è¦‹ä½œåœ°è¢«æˆ–å‚åŠã€‚"
    },
    {
        "name": "é¦™æ¤¿",
        "expected": "é¦™æ¤¿",
        "query": "é¦™æ¤¿ï¼Œè½è‘‰å–¬æœ¨ï¼Œç¾½ç‹€è¤‡è‘‰ï¼Œå°è‘‰å¤šå°å°ç”Ÿï¼Œå«©è‘‰ç´…è‰²å¯é£Ÿï¼Œå¹¹ç°è¤è‰²å…·æ˜é¡¯çš®å­”ã€‚"
    },
]


def find_rank(results: List[Dict], expected_names: List[str]) -> int:
    """åœ¨ embedding-only çµæœä¸­æ‰¾é æœŸç‰©ç¨®çš„æ’åï¼ˆ1-basedï¼‰ï¼Œæ‰¾ä¸åˆ°å›å‚³ 999ã€‚"""
    name_set = set(expected_names)
    for idx, item in enumerate(results, start=1):
        cname = (item.get("chinese_name") or "").strip()
        if cname in name_set:
            return idx
    return 999


def run():
    print("=" * 60)
    print("ğŸ” Embedding-only /search æ‰‹å‹• Query æ¸¬è©¦")
    print("=" * 60)
    print(f"EMBEDDING_API_URL: {EMBEDDING_API_URL}")
    print(f"æ¸¬è©¦ç­†æ•¸: {len(TESTS)}")
    print()

    top10 = top50 = top100 = missing = 0

    for t in TESTS:
        name = t["name"]
        expected = t["expected"]
        query = t["query"]
        expected_list = expand_expected(expected)

        print("-" * 40)
        print(f"ğŸŒ¿ ç‰©ç¨®: {name}")
        print(f"   é æœŸåç¨±: {', '.join(expected_list)}")
        print("   Query:")
        print(textwrap.fill(query, width=70, initial_indent="     ", subsequent_indent="     "))

        try:
            resp = requests.get(
                f"{EMBEDDING_API_URL}/search",
                params={"q": query, "top_k": 100},
                timeout=20,
            )
            if resp.status_code != 200:
                print(f"   âŒ /search å›æ‡‰éŒ¯èª¤: {resp.status_code}")
                print(f"      {resp.text[:200]}")
                missing += 1
                continue
            data = resp.json()
            if isinstance(data, dict) and "results" in data:
                # è‹¥ä¸å°å¿ƒæ‰“åˆ° smart_search å½¢å¼ï¼Œå–å…¶ä¸­çš„ results
                results = data.get("results") or []
            else:
                results = data

            if not isinstance(results, list):
                print("   âš ï¸ /search å›å‚³æ ¼å¼é listï¼Œç„¡æ³•è§£æ")
                missing += 1
                continue

            rank = find_rank(results, expected_list)
            if rank == 999:
                print("   âœ æ’å: æ‰¾ä¸åˆ°ï¼ˆ>100 æˆ–å®Œå…¨ä¸åœ¨å€™é¸ä¸­ï¼‰")
                missing += 1
            else:
                print(f"   âœ æ’å: Top{rank}")
                if rank <= 10:
                    top10 += 1
                elif rank <= 50:
                    top50 += 1
                else:
                    top100 += 1

        except Exception as e:
            print(f"   âŒ è«‹æ±‚éŒ¯èª¤: {e}")
            missing += 1

    print("\n" + "=" * 60)
    print("ğŸ“Š çµ±è¨ˆï¼ˆä»¥äººé¡ç†æƒ³ query æ¸¬ embedding-onlyï¼‰")
    print(f"Top10 å…§: {top10}")
    print(f"Top11â€“50: {top50}")
    print(f"Top51â€“100: {top100}")
    print(f">100 æˆ–æ‰¾ä¸åˆ°: {missing}")
    print("=" * 60)


if __name__ == "__main__":
    run()

