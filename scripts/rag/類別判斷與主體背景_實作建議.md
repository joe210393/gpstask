# 類別判斷與主體／背景 — 具體修改片段與實作建議

目標：
1. **判斷是什麼東西 → 給什麼答案**：植物才走植物 RAG、回植物名；動物／昆蟲／人造物則回對應類別與訊息，絕不回植物 Top1。
2. **主體 vs 背景**：使用者圈選範圍可能同時有「主體（焦點）」與「背景（如植物或人造物）」；若**主體是動物／昆蟲／人造物**而植物僅在背景，應判為非植物並跳過植物 RAG。

---

## 一、index.js：擴充「非植物」提早跳過（動物／昆蟲同人造物）

**位置**：`index.js` 約 3777–3793 行，現有人造物跳過邏輯。

**理由**：目前只對「第三步：人造物」跳過植物 RAG；動物／昆蟲也應同一處理，避免回傳植物答案。

**修改前**：
```javascript
        // 人造物跳過：第三步說人造物 且 第四步明確寫「不提取生物特徵」→ 一律跳過
        const saysArtifact = description && description.includes('第三步：判斷類別') && description.includes('人造物');
        const explicitlyNoBioFeatures = /不提取生物特徵|由於判斷為人造物|不進行猜測/.test(description || '');
        const hasRealPlantEvidence = /葉片[^N]*[形狀狀卵披針]|花朵[^直徑N]*[色紫紅白黃]|花序|枝條|果實|樹皮|脈序|鋸齒緣/.test(description || '');
        const skipAsArtifact = !previousSessionRaw && saysArtifact && (explicitlyNoBioFeatures || !hasRealPlantEvidence);
        if (skipAsArtifact) {
          console.log('⏭️ Vision 判斷為人造物，跳過植物 RAG');
          plantResults = {
            is_plant: false,
            category: 'human_made',
            message: 'Vision 分析判斷為人造物，已略過植物搜尋'
          };
        } else {
          if (saysArtifact && !skipAsArtifact) {
            console.log('⚠️ Vision 判人造物但描述含植物特徵，仍執行植物 RAG');
          }
```

**修改後**：
```javascript
        // 非植物跳過：第三步為人造物/動物/昆蟲/其他 且 非植物特徵明確 → 一律跳過植物 RAG（判斷是什麼就給什麼答案）
        const hasStep3 = description && description.includes('第三步：判斷類別');
        const saysNonPlant = hasStep3 && (
          description.includes('人造物') ||
          description.includes('動物') ||
          description.includes('昆蟲') ||
          description.includes('其他')
        );
        const explicitlyNoBioFeatures = /不提取生物特徵|由於判斷為人造物|不進行猜測|主體是動物|主體是昆蟲|植物僅在背景|主要為人造物/.test(description || '');
        const hasRealPlantEvidence = /葉片[^N]*[形狀狀卵披針]|花朵[^直徑N]*[色紫紅白黃]|花序|枝條|果實|樹皮|脈序|鋸齒緣/.test(description || '');
        const skipAsNonPlant = !previousSessionRaw && saysNonPlant && (explicitlyNoBioFeatures || !hasRealPlantEvidence);

        let nonPlantCategory = 'other';
        if (hasStep3 && description.includes('人造物')) nonPlantCategory = 'human_made';
        else if (hasStep3 && (description.includes('動物') || description.includes('昆蟲'))) nonPlantCategory = 'animal';

        if (skipAsNonPlant) {
          console.log(`⏭️ Vision 判斷為非植物（${nonPlantCategory}），跳過植物 RAG`);
          plantResults = {
            is_plant: false,
            category: nonPlantCategory,
            message: `Vision 分析判斷為${nonPlantCategory === 'human_made' ? '人造物' : nonPlantCategory === 'animal' ? '動物/昆蟲' : '其他'}，已略過植物搜尋`
          };
        } else {
          if (saysNonPlant && !skipAsNonPlant) {
            console.log('⚠️ Vision 判非植物但描述含植物特徵，仍執行植物 RAG');
          }
```

**說明**：
- 用 `saysNonPlant` 統一處理「人造物／動物／昆蟲／其他」。
- 用 `explicitlyNoBioFeatures` 順便辨識「主體是動物／昆蟲」「植物僅在背景」等語句（依你後面 prompt 用字可再微調）。
- `nonPlantCategory` 回傳給前端，方便顯示「動物／昆蟲／人造物／其他」對應文案。

---

## 二、index.js：分類為非植物時絕不帶入植物結果

**位置**：`index.js` 約 4325–4336 行，`classification.is_plant === false` 時設定 `plantResults`。

**理由**：確保 Classify API 回傳非植物時，回應裡沒有植物候選、且 category 正確。

**建議**：維持現有邏輯（已設 `is_plant: false`、`category: classification.category`），僅確認兩點：
- 此分支**不要**把任何 `ragResult.results` 或第一階段植物列表塞進 `plantResults.plants`。
- 若前端會依 `category` 顯示不同 UI（動物／昆蟲／人造物），確認 `classification.category` 與 Embedding API 的類別一致（plant / animal / artifact / other）。若 API 回 `animal`，可對應你前端的「動物」或「昆蟲」文案。

**可選強化**：在進入植物 RAG 前加一層防呆：
```javascript
// 僅在「從未設為非植物」時才可能寫入植物結果；若已設為非植物則不再覆蓋為植物
if (plantResults && plantResults.is_plant === false && plantResults.category) {
  // 後續任何 ragResult 都不應把 plantResults 改回 is_plant: true
  // 實作上可在賦值 plantResults = { is_plant: true, ... } 前加條件：若先前已 is_plant false 且 category 為 animal/artifact/other，則不覆蓋
}
```
實作方式：在 3814、3821、4283 等「設定 `plantResults = { is_plant: true, ... }`」的程式塊前，檢查「若前面已因 Vision/Classify 設成非植物，則不要用 RAG 結果覆蓋」。例如在 3805 之前先記住 `const wasSkippedAsNonPlant = false;`，在 3777 區塊若 `skipAsNonPlant` 則設為 `true`，之後所有「要設 plantResults 為植物」的地方都加 `if (!wasSkippedAsNonPlant) { ... }`。這樣可避免極少數路徑把「已判非植物」覆蓋成植物。

---

## 三、Vision Prompt：主體 vs 背景（feature_weights.py）

**位置**：`scripts/rag/vectordb/feature_weights.py`，`NEW_VISION_ROUTER_PROMPT` 中「第一部分：分析」的開頭（約 1119–1126 行）。

**理由**：使用者圈選範圍可能含背景植物或人造物，但**主體**是昆蟲、動物或物品；若模型只說「有植物」而沒區分主體，會誤觸植物 RAG。

**修改**：在「1. 圖片中主要是什麼類型的東西？」前新增一段「主體與背景」說明，並在第一步明確要求先判斷「圈選範圍內的主體」：

在
```text
在 <analysis> 標籤內，用繁體中文分段描述：

1. 圖片中主要是什麼類型的東西？
   - 植物 / 疑似植物 / 人造物 / 動物 / 其他。
   - 若不是植物或幾乎看不到植物，請直接說明。
```
改為：
```text
在 <analysis> 標籤內，用繁體中文分段描述：

0. 【主體與背景】使用者圈選的區域可能同時包含「主體（焦點）」與「背景」：
   - 若主體（用戶最可能想問的對象）是動物、昆蟲或人造物，而植物或其它東西僅在背景出現 → 請在下一步直接判斷為「動物／人造物／其他」，並在 traits 輸出空 JSON {}。
   - 只有當「主體」是植物或疑似植物時，才提取植物特徵。

1. 圖片中「圈選範圍內的主要焦點」是什麼類型的東西？
   - 植物 / 疑似植物 / 人造物 / 動物 / 其他。
   - 若不是植物或幾乎看不到植物為主體，請直接說明（例如「主體為昆蟲，植物僅在背景」）。
```

並在「若第三步判斷為動物/人造物/其他」的規則處（約 1088、1177）強調：**若主體為動物／昆蟲／人造物（植物僅在背景），請輸出空 JSON {}**。

---

## 四、Vision Prompt：前端版（ai-lab.js）— 若實際使用此 prompt

**位置**：`public/js/ai-lab.js` 約 207–212 行，「第三步：判斷類別」前後。

**理由**：若實際送給 Vision 的是前端這段 prompt，需與後端邏輯一致，加入「主體 vs 背景」。

**建議**：在「第三步：判斷類別（必須完成）」前加一段說明，例如：

```text
**圈選範圍內的主體與背景：**
使用者圈選的區域可能同時包含主體（焦點）與背景。請判斷「主要焦點」是什麼：
- 若主體是動物、昆蟲或人造物，植物僅在背景 → 第三步請判斷為「動物」或「人造物」，並輸出空 JSON。
- 只有當主體是植物時，才在第四步提取植物特徵。

**第三步：判斷類別（必須完成）**
明確指出「圈選範圍內的主要焦點」是：植物 / 動物 / 人造物 / 其他
```

這樣模型會先區分主體再判斷類別，減少「背景有植物就回植物答案」的錯誤。

---

## 五、start_api.py：Classify 類別與閾值（可選）

**位置**：`scripts/rag/vectordb/start_api.py`，`classify_query` 與 `PLANT_THRESHOLD`。

**理由**：確保「動物／昆蟲」在 embedding 分類裡有足夠區分度，避免動物描述被判成植物。

**建議**：
- 類別關鍵字已含 `"animal": ["動物", "鳥", "魚", "蟲", "獸"]`，不需改。
- 若實測發現動物/昆蟲常被誤判為植物，可微調 `PLANT_THRESHOLD`（例如略為提高），或為 `animal` 加權（例如在 scores 計算後對 `animal` 相似度加一個小 bonus），讓「動物」描述更容易贏過「植物」。實作細節可依你現有 `classify_query` 回傳格式再補。

---

## 六、實作順序建議

1. **先做 一（index.js 非植物跳過）**：動物／昆蟲／其他與人造物同一邏輯，立即避免「判成動物卻回植物」。
2. **再做 三（feature_weights.py 主體與背景）**：讓 Vision 輸出更符合「主體是什麼」，減少背景植物觸發植物 RAG。
3. **若前端確實用 ai-lab 的 prompt，再做 四（ai-lab.js）**。
4. **二（防呆不覆蓋非植物）** 與 **五（Classify 微調）** 視需要再補。

---

## 七、驗證建議

- 準備幾張「主體是昆蟲／動物／物品、背景有植物」的圖，圈選主體，確認：
  - Vision 描述中出現「主體為…」「植物僅在背景」或「第三步：動物/人造物」；
  - 回應為 `is_plant: false`、`category: 'animal'` 或 `'human_made'`，且無植物候選。
- 準備「主體是植物、背景有建築或物品」的圖，確認仍會走植物 RAG 且回傳植物候選。

完成以上修改後，系統會更符合「判斷是什麼東西就給什麼答案」，並把「主體 vs 背景」納入考量，避免圈選主體為動物／昆蟲／人造物時仍回植物答案。
