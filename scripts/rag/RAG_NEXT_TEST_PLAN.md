# RAG 下一輪測試行動計畫（雙向整合版）

> 整合 reviewer 建議與既有分析，目標：讓下次測試從 2/12 推進到 3–4/12。

---

## 一、現況與根因

### 通過 2/12，卡點整理

| 現象 | 可能根因 |
|------|----------|
| 黃椰子 Top1 仍冇拱 | Gate-A 未生效，或 冇拱 payload 含「複葉」等關鍵字 |
| 金露花 query 無漿果 | 橙紅色果實正則未命中，或尚未部署 |
| 長穗木 #7、野牡丹 #7 | 正解已在池內，差 1–2% 需 rerank/boost |
| 通用特徵主導 | 灌木/對生/單葉/全緣 命中量過大，feature 拉不開 |
| 高頻物種霸榜 | 水漆、翠玲瓏、珊瑚塔、西施花、冇拱 等 embedding 聚類中心 |

---

## 二、優先改動（依影響排序）

### 改動 1：Gate-A 與 冇拱 驗證（必做）

**目的**：確認 Gate-A 是否套用、是否有誤判。

**作法**：
1. 查 冇拱（Sapium discolor）在 Qdrant 的 `key_features` / `summary`，看是否含「複葉」「棕櫚」「扇形」等
2. 若有，調整 `PALM_COMPOUND_PLANT_KEYWORDS` 排除該詞或改為更精準匹配
3. 若無，檢查 Zeabur 是否已部署含 Gate-A 的版本

**已實作**：P1b 掌狀→掌狀複。若 冇拱 有「複葉」單字，需再加排除邏輯或負向關鍵字。

---

### 改動 2：LM 猜名 → guess_names 傳入 hybrid（高影響）

**目的**：讓 LM 猜的物種名能進 hybrid，提升召回與排序。

**現況**：`guessNames` 來自第一階段 embedding 回傳的植物名，**未包含 LM 描述中的猜測**。

**作法**：
1. 從 `description` 抽取 LM 猜測名，例如：
   - 「可能是 X、Y 或 Z」
   - 「推測為 X」
   - 「像是 X」
2. 將抽出的名稱與 `guessNamesFromFirst` 合併後傳給 `hybridSearch`
3. 若 LM 猜名與 COMMON_NAME_SYNONYMS 對應（如 長穗木 ↔ 紫花長穗木），可一併傳入同義名

**實作位置**：`index.js`，在呼叫 `hybridSearch` 前解析 description，並合併 `guessNames`。

**預期**：LM 若猜到正確名或同義名，可透過 keyword 匹配與加分拉高排名。

---

### 改動 3：候選池擴大到 100（中高影響）

**目的**：提高正解被納入 rerank 池的機率。

**現況**：`candidate_limit = max(60, top_k * 10)`，top_k=30 時為 60。

**作法**：改為 `max(100, top_k * 10)` 或固定 `100`。

**實作位置**：`start_api.py`，`hybrid_search` 中的 `candidate_limit`。

---

### 改動 4：果實關鍵字正則強化（中影響）

**目的**：金露花「橙紅色的果實」應能抽出 漿果。

**現況**：已有 `橙紅色的果實`，若仍無 漿果，可能需更寬 pattern。

**作法**：增加 `橙紅.*果實` 作為 fallback，避免被「的」等字阻斷。

**實作位置**：`traits-parser.js`，`extractFeaturesFromDescriptionKeywords`。

---

### 改動 5：Top5–10 LM 猜名加分（rerank boost）（中影響）

**目的**：當 LM 猜名出現在 hybrid 的 Top5–10 時，給予小幅加分，翻轉 1–2% 差距。

**作法**：
1. 從 description 抽 LM 猜名（與改動 2 共用邏輯）
2. hybrid 回傳後，對 `plants` 中名稱在 LM 猜名或同義名內的候選，加 `+0.02`（約 2%）
3. 再依新分數重新排序

**實作位置**：`index.js`，在 `mergePlantResults` 或處理 `plantResults` 後、回傳前。

**注意**：LM 猜錯時不應大幅改動排序，故加分不宜過大。

---

### 改動 6：keyword 匹配植物併入候選池（可選）

**目的**：guess_names 命中但不在 embedding top60 的植物，仍能進入 rerank。

**現況**：`keyword_matched_ids` 只對**已在候選池**的植物加分，不新增候選。

**作法**：對 scroll 得到的 keyword 匹配植物，若其 id 不在 `candidates` 中，則加入候選池再一起計分。

**實作位置**：`start_api.py`，`hybrid_search` 內，在取得 `candidates` 之後。

**風險**：候選數變多，計分與排序成本略增。

---

## 三、建議實作順序

| 順序 | 改動 | 複雜度 | 預期效果 |
|------|------|--------|----------|
| 1 | 改動 4：果實正則強化 | 低 | 金露花 query 帶漿果 |
| 2 | 改動 3：候選池 60→100 | 低 | 提高正解入池率 |
| 3 | 改動 2：LM 猜名進 guess_names | 中 | 長穗木/野牡丹等有機會提升 |
| 4 | 改動 5：LM 猜名 Top5–10 加分 | 中 | 微調排序、翻轉小幅差距 |
| 5 | 改動 1：驗證 Gate-A / 冇拱 | 需查 DB | 黃椰子 冇拱 問題 |
| 6 | 改動 6：keyword 植物併入池 | 中高 | 召回補充 |

---

## 四、LM 猜名抽取邏輯（改動 2、5 共用）

```
來源：description（Vision/LM 輸出）

範例模式：
- 「我初步猜測這可能是紫花蔓達或金光藤」
- 「推測為金雀花」
- 「可能是杜鵑花屬、山茶花屬或薔薇科」
- 「根據特徵，這可能是 X」

正則建議：
- /(?:可能|推測|像是|或許|大概)(?:是|為)?\s*([^。，、]+?)(?:的|屬|科|或|和|與|$)/g
- 或較保守：/可能是\s*([^。]+?)(?:屬|科|或|$)/g
- 取括號內片段，以「、」「或」「和」分割為多個候選名

同義擴展（可選）：
- 長穗木 → 加入 紫花長穗木
- 棕竹 → 加入 棕樹
```

---

## 五、驗證指標

| 指標 | 當前 | 目標 |
|------|------|------|
| 通過數 | 2/12 | 3–4/12 |
| 黃椰子 | 冇拱 Top1 | 棕竹/黃椰子類 Top1 |
| 金露花 | query 無漿果 | query 含漿果 |
| 長穗木 | #7 | Top3 或通過（紫花長穗木=長穗木） |
| 野牡丹 | #7 | Top3 或通過 |

---

## 六、風險與注意

1. **LM 猜名噪音**：抽到的名稱可能是科/屬（如「杜鵑花屬」），需過濾或限制為物種級名稱
2. **加分幅度**：LM 猜名加分不宜超過 0.02–0.03，避免過度信任錯誤猜測
3. **部署延遲**：Zeabur 部署後需確認版本，再跑驗證腳本
