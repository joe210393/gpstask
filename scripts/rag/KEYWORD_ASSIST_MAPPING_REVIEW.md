# Keyword-Assist 建議對照與實作評估

> 對照 reviewer 建議與現有 `feature_weights.py` / `traits-parser.js`，標註可納入項目與需補欄位。

---

## 一、現有 FEATURE_VOCAB 對應

| 類別 | 現有 feature（中文） | 說明 |
|------|---------------------|------|
| leaf_type | 單葉、複葉、羽狀複葉、二回羽狀、掌狀複葉、三出複葉 | 已有 |
| leaf_arrangement | 互生、對生、輪生 | 缺「叢生」 |
| leaf_margin | 全緣、鋸齒 | 缺「波狀」 |
| flower_inflo | 總狀、圓錐、聚繖、頭狀、繖形、穗狀 | 缺「繖房」 |
| fruit_type | 莢果、漿果、核果、蒴果 | 缺「翅果」「梨果」 |
| life_form | 喬木、灌木、草本、藤本 | 已有 |
| special | 有刺、胎生苗、棕櫚 | 缺「乳汁」 |
| leaf_shape | **無** | 需新增才支援 披針形、卵形 等 |

---

## 二、建議合理性評估

### A 區（P0）— 建議合理，可直接對齊

| 建議關鍵字 | 對應 feature | 我們有? | 評估 |
|------------|--------------|---------|------|
| 棕櫚、棕櫚科 | 棕櫚 | ✅ | 已有，可補 棕櫚科 |
| 羽狀複葉、小葉成對/密集排列 | 羽狀複葉 | ✅ | 補「小葉成對排列」「小葉密集排列」 |
| 掌狀複葉、小葉放射狀 | 掌狀複葉 | ✅ | 補「小葉放射狀」 |
| 二回羽狀、二回複葉 | 二回羽狀 | ✅ | 補「二回複葉」 |
| 三出複葉、三小葉 | 三出複葉 | ✅ | 補「三小葉」 |
| 扇形葉、扇狀葉、扇形裂片 | 棕櫚 | ✅ | 已有 扇形，可補 扇狀葉、扇形裂片 |
| 漿果、核果、蒴果、朔果 | 漿果/核果/蒴果 | ✅ | 補「朔果」錯字 |
| 紅色果、橙紅色果（需「果」guard） | 漿果 | ✅ | 加 guard：必須含「果/果實/成熟」 |
| 繖房花序、繖房 | 繖房花序 | ❌ | 需在 FEATURE_VOCAB 新增 |
| 翅果、具翅 | 翅果 | ❌ | 可選，需新增 |

### B 區（P1）— 部分可納入

| 建議關鍵字 | 對應 feature | 我們有? | 評估 |
|------------|--------------|---------|------|
| 輪生 | 輪生 | ✅ | 可加（目前沒在 keyword-assist） |
| 叢生（葉叢生） | 叢生 | ❌ | 需在 leaf_arrangement 新增 |
| 波狀緣、波狀 | 波狀 | ❌ | 需在 leaf_margin 新增 |
| 藤本、攀緣、蔓性 | 藤本 | ✅ | 可補 攀緣、蔓性 |

### C 區（P2）— 需補 FEATURE_VOCAB

| 建議關鍵字 | 對應 feature | 我們有? | 評估 |
|------------|--------------|---------|------|
| 有刺、具刺、刺狀 | 有刺 | ✅ | 可補 具刺、刺狀 |
| 乳汁、白色汁液 | 乳汁 | ❌ | 需在 special 新增 |
| 披針形、橢圓形、卵形、心形、線形 | leaf_shape | ❌ | 需新增 leaf_shape 類別 |

---

## 三、建議規則 D1/D2 的納入方式

### D1) 強特徵優先

1. **若命中 二回羽狀/三出/羽狀複葉/掌狀複葉 → 不再加「複葉」**  
   實作：在加入複葉前檢查是否已有上述任一。

2. **複葉類 → 移除單葉**  
   已有，維持。

3. **habit 最多加 1 個**  
   喬木/灌木/草本/藤本 只取第一個命中的。

4. **fruit_color 必須搭配「果」**  
   紅色果、橙紅色果 等：正則或邏輯上加條件 `/(?:果|果實|結實|成熟)/.test(text)`。

5. **flower_inflo 只保留 1 個（按優先序）**  
   優先序：繖房 > 聚繖 > 穗狀 > 繖形 > 頭狀 > 總狀 > 圓錐  
   實作：依序檢查，命中第一個就加入並跳過其餘。

### D2) 避坑

- **羽狀裂 ≠ 羽狀複葉**：`羽狀裂` 只當 leaf_margin，不映射到 羽狀複葉。  
  建議：`/羽狀裂/.test(text)` 時不加 羽狀複葉；或改用更精準的 羽狀複葉 pattern，排除「羽狀裂」「羽狀葉脈」。

---

## 四、需在 feature_weights.py 新增的欄位

```python
# leaf_arrangement 補
"叢生": {"en": "fascicled", "base_w": 0.05, "max_cap": 0.07},

# leaf_margin 補
"波狀": {"en": "undulate", "base_w": 0.05, "max_cap": 0.07},

# flower_inflo 補（火筒樹常用）
"繖房花序": {"en": "corymb", "base_w": 0.06, "max_cap": 0.09},

# fruit_type 可選
"翅果": {"en": "samara", "base_w": 0.07, "max_cap": 0.11},

# special 補
"乳汁": {"en": "latex", "base_w": 0.08, "max_cap": 0.12},
```

---

## 五、建議的 extractFeaturesFromDescriptionKeywords 流程

```
1. 依優先序處理（避免重複、衝突）：
   a. 棕櫚/複葉：棕櫚 → 二回羽狀 → 三出複葉 → 掌狀複葉 → 羽狀複葉 → 複葉（若前述皆無）
   b. 果實：漿果/核果/蒴果/朔果；紅色果等（需果 guard）
   c. 花序：只保留 1 個，按 繖房>聚繖>穗狀>繖形>頭狀>總狀>圓錐
   d. 葉序：對生/互生/輪生/叢生（最多 1 個）
   e. 葉緣：鋸齒/全緣/波狀（羽狀裂不當羽狀複葉）
   f. 生活型：喬木/灌木/草本/藤本（最多 1 個）
   g. 刺/乳汁：有刺、乳汁
2. 最後套用矛盾處理：有複葉類則移除單葉
```

---

## 六、可立即納入 vs 需先補 FEATURE_VOCAB

| 項目 | 可立即納入 | 需補 FEATURE_VOCAB |
|------|------------|---------------------|
| 小葉成對排列、小葉密集排列、小葉放射狀、二回複葉、三小葉 | ✅ | - |
| 朔果、攀緣、蔓性、具刺、刺狀 | ✅ | - |
| 果實顏色 guard（果/果實/成熟） | ✅ | - |
| 花序只保留 1 個（優先序） | ✅ | - |
| 有羽狀/掌狀/二回/三出則不加複葉 | ✅ | - |
| 繖房花序 | ❌ | ✅ 繖房花序 |
| 叢生 | ❌ | ✅ 叢生 |
| 波狀 | ❌ | ✅ 波狀 |
| 翅果、乳汁 | ❌ | ✅ 翅果、乳汁 |
| 披針形、卵形等 leaf_shape | ❌ | ✅ 新增 leaf_shape 類別 |

---

## 七、建議實作順序

1. **先補 FEATURE_VOCAB**：繖房花序、叢生、波狀（與可選的 翅果、乳汁）
2. **擴充 traits-parser 的 keyword patterns**：依 A/B 區對照表補齊
3. **實作 D1/D2 規則**：花序只留 1 個、複葉不加「複葉」、果實 guard
4. **羽狀裂避坑**：羽狀複葉 pattern 排除「羽狀裂」「羽狀葉脈」單獨出現

完成後，keyword-assist 會對齊建議，並與現有 feature 結構一致。
