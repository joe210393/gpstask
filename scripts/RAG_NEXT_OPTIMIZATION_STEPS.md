# RAG 下一步優化步驟

依 P0 後 12+ 筆測試案例的系統性分析，彙整優先順序與實作規格。

---

## 一、現況摘要

| 指標 | 數值 |
|------|------|
| P0 後測試筆數 | 12 筆 |
| 正確辨識（Top1） | 0 (0%) |
| 正確在 Top30 內 | 約 5 筆（棕竹、野牡丹、金露花、風鈴草、車桑子等） |
| XX屬／XX科 污染 | P0 已解決 ✅ |

### 問題分類統計

| 問題類型 | 案例數 | 案例 |
|----------|--------|------|
| LM 加成邏輯錯誤（對全體加成） | 1 | 棕竹 |
| LM 猜錯 + 加成放大錯誤 | 1 | 小金雀花 |
| Vision 葉序錯誤（對生→互生） | 3 | 野牡丹、馬纓丹、臺灣野牡丹藤 |
| Vision 特徵錯誤（葉型/生活型） | 2 | 火筒樹、黃椰子 |
| LM 猜對但 RAG 未召回 | 2 | 馬纓丹、長穗木 |
| LM 猜錯（學名錯誤） | 3 | 風鈴草、長穗木、小金雀花 |
| TraitsParser 映射缺失 | 多筆 | lavender、prostrate、racemose、paniculate 等 |
| 正確在 Top30 但排名靠後 | 5 | 棕竹、金露花、風鈴草、車桑子、台灣野牡丹藤 |

---

## 二、優化步驟（優先順序）

### 步驟 1：修正 LM 加成套用範圍（高優先，可直接實作）

**問題**：只要任一樣本與 LM 匹配，就對**全部 30 筆**加成，導致非匹配候選（如凹葉柃木）被加成超越正確候選（棕竹、棕樹）。

**規格**：
- 僅對「與 LM 名稱匹配」的候選加成
- 未匹配的候選維持原分數

**預期效果**：棕竹案例中，僅棕樹、棕竹獲加成，凹葉柃木維持原分，棕竹/棕樹有機會成為 Top1。

**檔案**：`index.js`（LM 加成邏輯）

---

### 步驟 2：LM 加成門檻制（高優先，建議與步驟 1 一併實作）

**問題**：LM 猜錯（如小金雀花猜金合歡）時，仍因名稱匹配而觸發加成，把錯誤候選推上 Top1。

**規格**：LM 名稱匹配時，須**同時滿足**以下任二項才加成：
1. 候選的 feature match 數 ≥ 2（或 feature 分數 ≥ 門檻）
2. 候選在第一階段 embedding 排名 ≤ 15
3. 候選與 LM 猜測為同種或近緣（可選，較難實作則可略過）

簡化版：僅採用 (1)，即 `matched_features.length >= 2` 才加成。

**預期效果**：小金雀花案例中，金合歡若 feature 匹配不足，不加成，可降低錯誤推升。

**檔案**：`index.js`

---

### 步驟 3：TraitsParser 映射補齊（中優先）

**問題**：多筆出現「未找到 XXX 的中文映射，已忽略」。

**待補映射**：

| 欄位 | 缺失值 | 建議中文 |
|------|--------|----------|
| flower_color | lavender | 淡紫色 |
| stem_type | prostrate | 匍匐 |
| inflorescence | racemose | 總狀花序 |
| inflorescence | paniculate | 圓錐花序 |
| inflorescence | terminal_paniculate | 頂生圓錐花序 |
| phenology | spring_flowering | 春華 |

**檔案**：`scripts/rag/vectordb/traits-parser.js` 或對應 vocab

---

### 步驟 4：plant-name-mapping 學名補齊（中優先）

**問題**：LM 猜 Lantana camara、Stachytarpheta 等，RAG 無對應。

**規格**：確認 `plant-name-mapping.json` 是否由 `build_plant_name_mapping.js` 從 clean 資料產生；clean 資料應含馬纓丹、紫花長穗木等，理論上會自動納入。若無，需檢查 clean 資料的 `scientific_name` 是否正確。

**檔案**：`scripts/rag/data/plant-name-mapping.json`（由 build 腳本產生，無須手動改）

---

### 步驟 5：評估動態權重與 feature 權重（中低優先）

**觀察**：generic_ratio 高時 wE=0.30、wF=0.70，feature 權重已較高，但 feature 匹配數少（多為「灌木、互生」），區分力不足。

**可選方向**：
- 提高「高區辨特徵」（如羽狀複葉、掌狀裂、穗狀花序）的權重
- 微調 wE/wF 公式門檻

**建議**：先完成步驟 1–4 並測試，再依結果決定是否調整。

---

### 步驟 6：Vision prompt 強化（長期）

**問題**：葉序（對生→互生）、生活型（喬木→灌木）、葉型（羽狀複葉→卵形）等錯誤頻繁。

**規格**：在 Vision 的 system prompt 中明確要求：
- 區分羽狀複葉 vs 單葉卵形
- 區分對生 vs 互生
- 區分喬木 vs 灌木

**檔案**：主程式中呼叫 Vision 的 prompt 設定

---

## 三、建議執行順序

| 順序 | 步驟 | 預估工時 | 備註 |
|------|------|----------|------|
| 1 | 步驟 1：LM 加成僅對匹配候選 | 小 | 直接改 index.js |
| 2 | 步驟 2：LM 加成門檻（feature match ≥ 2） | 小 | 可與步驟 1 合併 |
| 3 | 步驟 3：TraitsParser 映射補齊 | 小 | 查 traits-parser/vocab |
| 4 | 步驟 4：確認 plant-name-mapping 涵蓋馬纓丹、長穗木等 | 小 | 多數應已包含，需驗證 |
| 5 | 測試 12 筆，評估正確率變化 | - | 若明顯提升再考慮步驟 5、6 |

---

## 四、驗收標準

- **步驟 1+2**：棕竹案例中，Top1 應為棕竹或棕樹；小金雀花案例中，金合歡不應因錯誤加成而成為 Top1。
- **步驟 3**：日誌中「未找到映射」次數顯著減少。
- **整體**：12 筆測試正確率從 0% 提升至目標 30% 以上（逐步向 70% 邁進）。
