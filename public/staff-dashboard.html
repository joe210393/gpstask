<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>新增任務（工作人員）| GPS 觸發任務系統</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      /* 手機版讓新增任務排在最上面 */
      .dashboard-grid > .left-col {
        order: 1;
      }
      .dashboard-grid > .right-col {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div class="header-content" id="headerContent">
      <h1 id="pageTitle">新增任務</h1>
      <button id="hamburgerBtn" class="hamburger" aria-label="展開選單">&#9776;</button>
      <nav class="main-nav">
        <a href="/index.html">首頁</a>
        <a href="/map.html">地圖頁</a>
        <a href="/user-tasks.html">任務審核</a>
        <a href="/staff-dashboard.html" class="current-page" id="navStaff">新增任務</a>
        <a href="/role-management.html" id="navRoleMgmt">權限管理</a>
        <a href="/user-dashboard.html" id="navUserTasks" style="display:none;">用戶任務管理</a>
        <a href="/products.html" id="navProducts">商品兌換</a>
        <a href="/redeem-tasks.html" id="navRedeem">兌換商品管理</a>
        <span id="loginUserInfo" style="display:none; color:var(--text-secondary); padding:0.5rem 1rem;"></span>
        <button id="logoutBtn" style="display:none;">登出</button>
      </nav>
    </div>
  </header>

  <main>
    <div class="dashboard-grid mb-4">
      <!-- 左欄：新增任務 -->
      <div class="left-col">
        <div class="form-container" style="height: 100%;">
          <h2 class="text-center mb-4">新增任務點</h2>
          <form id="addTaskForm" enctype="multipart/form-data">
            <!-- 任務分類選擇 -->
            <div class="form-group" style="background: #eef2f7; padding: 10px; border-radius: 6px;">
              <label class="form-label" style="color: #2c3e50; font-weight: bold;">任務分類</label>
              <select name="type" id="taskCategorySelect" class="form-select">
                <option value="single">一般單題任務 (Single)</option>
                <option value="timed">限時/限量任務 (Timed)</option>
                <option value="quest">劇情連續任務 (Quest)</option>
              </select>
            </div>

            <!-- 劇情任務專用欄位 -->
            <div id="questFields" style="display:none; background:#f0f8ff; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #bee5eb;">
              <div class="form-group">
                <label class="form-label">選擇所屬劇情</label>
                <select name="quest_chain_id" id="questChainSelect" class="form-select">
                  <option value="">-- 請先建立劇情 --</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">劇情順序 (Step Order)</label>
                <input class="form-input" type="number" name="quest_order" min="1" placeholder="例如：1 代表第一關" />
                <small style="color: #666;">必須完成第 1 關才能解鎖第 2 關</small>
              </div>
              <div class="form-group">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                  <input type="checkbox" name="is_final_step" value="1" style="width:18px; height:18px; cursor:pointer;" />
                  <span style="font-weight:bold; color:#d97706;">🏆 標記為結局關卡</span>
                </label>
                <small style="color: #666; display:block; margin-top:4px;">勾選後，此關卡將被標記為劇情任務的結局，完成後可獲得劇情獎勵</small>
              </div>
            </div>

            <!-- 限時任務專用欄位 -->
            <div id="timedFields" style="display:none; background:#fff0f5; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #f5c6cb;">
              <div class="form-group">
                <label class="form-label">開始時間</label>
                <input class="form-input" type="datetime-local" name="time_limit_start" />
              </div>
              <div class="form-group">
                <label class="form-label">結束時間</label>
                <input class="form-input" type="datetime-local" name="time_limit_end" />
              </div>
              <div class="form-group">
                <label class="form-label">名額限制 (Max Participants)</label>
                <input class="form-input" type="number" name="max_participants" min="0" placeholder="0 或空值代表不限" />
              </div>
            </div>

            <div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.9rem;background:#f3f4f6;padding:10px;border-radius:6px;">
              提示：經緯度請貼入十進位格式（如 24.678222, 121.760361），可用 Google Maps 右鍵複製座標。
            </div>
            
            <div class="form-group">
              <label class="form-label">任務名稱</label>
              <input class="form-input" type="text" name="name" required />
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">緯度</label>
                <input class="form-input" type="number" name="lat" step="any" required />
              </div>
              <div class="form-group">
                <label class="form-label">經度</label>
                <input class="form-input" type="number" name="lng" step="any" required />
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">觸發半徑（公尺）</label>
                <input class="form-input" type="number" name="radius" required />
              </div>
              <div class="form-group">
                <label class="form-label">積分</label>
                <input class="form-input" type="number" name="points" min="0" step="1" value="0" required />
              </div>
            </div>
            
              <div class="form-group">
                <label class="form-label">任務類型</label>
                <select name="task_type" id="taskTypeSelect" class="form-select">
                  <option value="qa">問答題 (人工審核)</option>
                  <option value="multiple_choice">選擇題 (自動驗證)</option>
                  <option value="photo">拍照/上傳照片 (人工審核)</option>
                  <option value="number">數字解謎 (自動驗證)</option>
                  <option value="keyword">關鍵字解碼 (自動驗證)</option>
                  <option value="location">地理圍欄打卡 (自動驗證)</option>
                </select>
              </div>

              <div id="multipleChoiceOptions" style="display:none;background:#f9f9f9;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #eee;">
                <div class="form-group">
                   <label class="form-label">選項 A</label>
                   <input class="form-input" type="text" name="optionA" />
                </div>
                <div class="form-group">
                   <label class="form-label">選項 B</label>
                   <input class="form-input" type="text" name="optionB" />
                </div>
                <div class="form-group">
                   <label class="form-label">選項 C</label>
                   <input class="form-input" type="text" name="optionC" />
                </div>
                <div class="form-group">
                   <label class="form-label">選項 D</label>
                   <input class="form-input" type="text" name="optionD" />
                </div>
                <div class="form-group">
                  <label class="form-label">正確答案</label>
                  <select name="correct_answer_select" class="form-select">
                    <option value="A">選項 A</option>
                    <option value="B">選項 B</option>
                    <option value="C">選項 C</option>
                    <option value="D">選項 D</option>
                  </select>
                </div>
              </div>

              <div id="standardAnswerBlock" style="display:none;background:#f0f8ff;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #cce5ff;">
                <div class="form-group">
                  <label class="form-label">標準答案</label>
                  <input class="form-input" type="text" name="correct_answer_text" placeholder="請輸入正確的數字或關鍵字" />
                  <small style="color:var(--text-secondary);display:block;margin-top:4px;">系統將精確比對此答案 (不分大小寫)</small>
                </div>
              </div>
            
            <div class="form-group">
              <label class="form-label">任務說明</label>
              <textarea name="description" class="form-textarea" required style="height:100px;"></textarea>
            </div>

            <!-- 道具關聯設定 -->
            <div class="form-group" style="background:#fdfdfe; border:1px solid #eaeaea; padding:10px; border-radius:6px;">
              <label class="form-label" style="color:#555;">道具關聯設定 (選填)</label>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                  <label class="form-label" style="font-size:0.85rem;">🔒 解鎖所需道具</label>
                  <select name="required_item_id" class="form-select item-select">
                    <option value="">-- 無 --</option>
                  </select>
                  <small style="color:#999; font-size:0.8rem;">玩家必須持有此道具才能進行任務</small>
                </div>
                <div>
                  <label class="form-label" style="font-size:0.85rem;">🎁 完成獎勵道具</label>
                  <select name="reward_item_id" class="form-select item-select">
                    <option value="">-- 無 --</option>
                  </select>
                  <small style="color:#999; font-size:0.8rem;">任務完成後自動發放</small>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">任務照片 (封面)</label>
              <input class="form-input" type="file" name="photo" accept="image/*" required />
            </div>

            <!-- AR 內容設定區塊 -->
            <div class="form-group" style="background:#f8f9fa; border:1px solid #ddd; padding:15px; border-radius:8px;">
              <label class="form-label" style="font-weight:bold; color:#2c3e50;">AR 內容顯示設定 (多步驟提示)</label>
              <div style="font-size:0.85rem; color:#666; margin-bottom:15px;">設定顯示順序：1=第一步，2=第二步... 留空=不顯示</div>
              
              <!-- 3D 模型 -->
              <div style="margin-bottom:15px; padding:10px; background:white; border-radius:6px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                  <label class="form-label" style="margin:0; flex:1;">🧊 3D 模型</label>
                  <input type="number" name="ar_order_model" min="1" placeholder="順序" style="width:80px; padding:5px; border:1px solid #ccc; border-radius:4px;" />
                </div>
                <select name="ar_model_id" class="form-select" id="arModelSelect">
                  <option value="">-- 請選擇模型 (選填) --</option>
                </select>
                <div style="margin-top:5px; font-size:0.8rem; color:#666;">沒有想要的？<a href="#" id="quickUploadModelBtn" style="color:#0d6efd;">上傳新模型</a></div>
              </div>

              <!-- AR 圖片 -->
              <div style="margin-bottom:15px; padding:10px; background:white; border-radius:6px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                  <label class="form-label" style="margin:0; flex:1;">🖼️ AR 圖片</label>
                  <input type="number" name="ar_order_image" min="1" placeholder="順序" style="width:80px; padding:5px; border:1px solid #ccc; border-radius:4px;" />
                </div>
                <input class="form-input" type="file" name="arImage" accept="image/*" />
                <small style="color:#666;">將在 AR 中懸浮顯示</small>
              </div>

              <!-- YouTube -->
              <div style="padding:10px; background:white; border-radius:6px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                  <label class="form-label" style="margin:0; flex:1;">📺 YouTube</label>
                  <input type="number" name="ar_order_youtube" min="1" placeholder="順序" style="width:80px; padding:5px; border:1px solid #ccc; border-radius:4px;" />
                </div>
                <input class="form-input" type="text" name="youtubeUrl" placeholder="https://youtu.be/..." />
                <small style="color:#666;">將在 AR 中播放影片</small>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">新增任務</button>
            <div id="addTaskMsg" class="mt-2 text-center text-danger" style="min-height: 24px;"></div>
          </form>
        </div>
      </div>

      <!-- 右欄：道具 + 劇情 -->
      <div class="right-col" style="display: flex; flex-direction: column; gap: 20px;">
        
        <!-- 道具管理區塊 -->
        <div class="form-container" style="background: #fffcf5; border: 1px solid #ffeeba;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0; color: #856404;">🎒 道具管理</h2>
            <button id="btnCreateItem" class="btn btn-secondary" style="font-size: 0.9rem; background: #ffc107; border-color: #ffc107; color: #212529;">+ 新增道具</button>
          </div>
          <div id="itemList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem;">
            <!-- 道具列表動態載入 -->
            <div style="color: #888; font-size: 0.9rem;">載入中...</div>
          </div>
        </div>

        <!-- 3D 模型庫管理區塊 -->
        <div class="form-container" style="background: #e3f2fd; border: 1px solid #b6d4fe;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0; color: #052c65;">🧊 3D 模型庫</h2>
            <button id="btnUploadModel" class="btn btn-secondary" style="font-size: 0.9rem; background: #0d6efd; border-color: #0d6efd; color: white;">+ 上傳模型</button>
          </div>
          <div id="modelList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
            <!-- 模型列表動態載入 -->
            <div style="color: #888; font-size: 0.9rem;">載入中...</div>
          </div>
        </div>

        <!-- 劇情任務管理區塊 -->
        <div class="form-container" style="background: #fdfdfd; border: 1px solid #e0e0e0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">劇情任務線管理</h2>
            <button id="btnCreateQuest" class="btn btn-secondary" style="font-size: 0.9rem;">+ 新增劇情</button>
          </div>
          <div id="questChainList" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            <!-- 劇情列表動態載入 -->
            <div style="color: #888; font-size: 0.9rem;">載入中...</div>
          </div>
        </div>

      </div>
    </div>

    <section class="task-list">
      <h2 class="text-center mb-4">所有任務</h2>
      <div id="allTasks" class="card-grid"></div>
    </section>

    <!-- 編輯任務 Modal -->
    <div class="task-modal" id="editModal">
      <div class="task-modal-overlay"></div>
      <div class="task-modal-content">
        <div class="task-modal-header">
          <h3>編輯任務</h3>
          <button class="close-btn" id="closeEditModal">&times;</button>
        </div>
        <div class="task-modal-body">
          <form id="editTaskForm">
            <input type="hidden" name="id" />
            
            <!-- 任務分類選擇 (編輯) -->
            <div class="form-group" style="background: #eef2f7; padding: 10px; border-radius: 6px;">
              <label class="form-label" style="color: #2c3e50; font-weight: bold;">任務分類</label>
              <select name="type" id="editTaskCategorySelect" class="form-select">
                <option value="single">一般單題任務</option>
                <option value="timed">限時/限量任務</option>
                <option value="quest">劇情連續任務</option>
              </select>
            </div>

            <!-- 劇情任務專用欄位 (編輯) -->
            <div id="editQuestFields" style="display:none; background:#f0f8ff; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #bee5eb;">
              <div class="form-group">
                <label class="form-label">選擇所屬劇情</label>
                <select name="quest_chain_id" id="editQuestChainSelect" class="form-select">
                  <option value="">-- 請選擇 --</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">劇情順序</label>
                <input class="form-input" type="number" name="quest_order" min="1" />
              </div>
              <div class="form-group">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                  <input type="checkbox" name="is_final_step" id="editIsFinalStep" value="1" style="width:18px; height:18px; cursor:pointer;" />
                  <span style="font-weight:bold; color:#d97706;">🏆 標記為結局關卡</span>
                </label>
                <small style="color: #666; display:block; margin-top:4px;">勾選後，此關卡將被標記為劇情任務的結局，完成後可獲得劇情獎勵</small>
              </div>
            </div>

            <!-- 限時任務專用欄位 (編輯) -->
            <div id="editTimedFields" style="display:none; background:#fff0f5; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #f5c6cb;">
              <div class="form-group">
                <label class="form-label">開始時間</label>
                <input class="form-input" type="datetime-local" name="time_limit_start" />
              </div>
              <div class="form-group">
                <label class="form-label">結束時間</label>
                <input class="form-input" type="datetime-local" name="time_limit_end" />
              </div>
              <div class="form-group">
                <label class="form-label">名額限制</label>
                <input class="form-input" type="number" name="max_participants" min="0" />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">任務名稱</label>
              <input class="form-input" type="text" name="name" required />
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">緯度</label>
                <input class="form-input" type="number" name="lat" step="any" required />
              </div>
              <div class="form-group">
                <label class="form-label">經度</label>
                <input class="form-input" type="number" name="lng" step="any" required />
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">觸發半徑</label>
                <input class="form-input" type="number" name="radius" required />
              </div>
              <div class="form-group">
                <label class="form-label">積分</label>
                <input class="form-input" type="number" name="points" min="0" step="1" required />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">任務類型</label>
              <select name="task_type" id="editTaskTypeSelect" class="form-select">
                <option value="qa">問答題 (人工審核)</option>
                <option value="multiple_choice">選擇題 (自動驗證)</option>
                <option value="photo">拍照/上傳照片 (人工審核)</option>
                <option value="number">數字解謎 (自動驗證)</option>
                <option value="keyword">關鍵字解碼 (自動驗證)</option>
                <option value="location">地理圍欄打卡 (自動驗證)</option>
              </select>
            </div>

            <div id="editMultipleChoiceOptions" style="display:none;background:#f9f9f9;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #eee;">
              <div class="form-group">
                 <label class="form-label">選項 A</label>
                 <input class="form-input" type="text" name="optionA" />
              </div>
              <div class="form-group">
                 <label class="form-label">選項 B</label>
                 <input class="form-input" type="text" name="optionB" />
              </div>
              <div class="form-group">
                 <label class="form-label">選項 C</label>
                 <input class="form-input" type="text" name="optionC" />
              </div>
              <div class="form-group">
                 <label class="form-label">選項 D</label>
                 <input class="form-input" type="text" name="optionD" />
              </div>
              <div class="form-group">
                <label class="form-label">正確答案</label>
                <select name="correct_answer_select" class="form-select">
                  <option value="A">選項 A</option>
                  <option value="B">選項 B</option>
                  <option value="C">選項 C</option>
                  <option value="D">選項 D</option>
                </select>
              </div>
            </div>

            <div id="editStandardAnswerBlock" style="display:none;background:#f0f8ff;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #cce5ff;">
              <div class="form-group">
                <label class="form-label">標準答案</label>
                <input class="form-input" type="text" name="correct_answer_text" placeholder="請輸入正確的數字或關鍵字" />
                <small style="color:var(--text-secondary);display:block;margin-top:4px;">系統將精確比對此答案 (不分大小寫)</small>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">任務說明</label>
              <textarea name="description" class="form-textarea" required style="height:100px;"></textarea>
            </div>

            <!-- 道具關聯設定 (編輯) -->
            <div class="form-group" style="background:#fdfdfe; border:1px solid #eaeaea; padding:10px; border-radius:6px;">
              <label class="form-label" style="color:#555;">道具關聯設定 (選填)</label>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                  <label class="form-label" style="font-size:0.85rem;">🔒 解鎖所需道具</label>
                  <select name="required_item_id" id="editRequiredItemSelect" class="form-select item-select">
                    <option value="">-- 無 --</option>
                  </select>
                </div>
                <div>
                  <label class="form-label" style="font-size:0.85rem;">🎁 完成獎勵道具</label>
                  <select name="reward_item_id" id="editRewardItemSelect" class="form-select item-select">
                    <option value="">-- 無 --</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">任務照片網址</label>
              <input class="form-input" type="text" name="photoUrl" required />
            </div>
            
            <div class="form-group">
              <div style="margin-bottom:8px;font-size:0.9rem;color:var(--text-secondary);">或上傳新照片：</div>
              <input type="file" name="editPhoto" id="editPhotoInput" accept="image/*" class="form-input" style="padding:5px;">
              <div class="mt-2"><img id="editPhotoPreview" src="" alt="預覽" style="max-width:100%;max-height:150px;border-radius:8px;display:none;"></div>
            </div>
            
            <!-- AR 內容設定區塊 (編輯) -->
            <div class="form-group" style="background:#f8f9fa; border:1px solid #ddd; padding:15px; border-radius:8px;">
              <label class="form-label" style="font-weight:bold; color:#2c3e50;">AR 內容顯示設定 (多步驟提示)</label>
              <div style="font-size:0.85rem; color:#666; margin-bottom:15px;">設定顯示順序：1=第一步，2=第二步... 留空=不顯示</div>
              
              <!-- 3D 模型 -->
              <div style="margin-bottom:15px; padding:10px; background:white; border-radius:6px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                  <label class="form-label" style="margin:0; flex:1;">🧊 3D 模型</label>
                  <input type="number" name="ar_order_model" min="1" placeholder="順序" style="width:80px; padding:5px; border:1px solid #ccc; border-radius:4px;" />
                </div>
                <select name="ar_model_id" class="form-select" id="editArModelSelect">
                  <option value="">-- 請選擇模型 (選填) --</option>
                </select>
              </div>

              <!-- AR 圖片 -->
              <div style="margin-bottom:15px; padding:10px; background:white; border-radius:6px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                  <label class="form-label" style="margin:0; flex:1;">🖼️ AR 圖片</label>
                  <input type="number" name="ar_order_image" min="1" placeholder="順序" style="width:80px; padding:5px; border:1px solid #ccc; border-radius:4px;" />
                </div>
                <input class="form-input" type="text" name="ar_image_url" placeholder="/images/..." />
                <div style="margin-top:8px;font-size:0.9rem;color:var(--text-secondary);">或上傳新圖片：</div>
                <input type="file" name="editArImage" id="editArImageInput" accept="image/*" class="form-input" style="padding:5px;">
                <div class="mt-2"><img id="editArImagePreview" src="" alt="預覽" style="max-width:100%;max-height:150px;border-radius:8px;display:none;"></div>
                <small style="color:#666;">將在 AR 中懸浮顯示</small>
              </div>

              <!-- YouTube -->
              <div style="padding:10px; background:white; border-radius:6px; border:1px solid #ddd;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                  <label class="form-label" style="margin:0; flex:1;">📺 YouTube</label>
                  <input type="number" name="ar_order_youtube" min="1" placeholder="順序" style="width:80px; padding:5px; border:1px solid #ccc; border-radius:4px;" />
                </div>
                <input class="form-input" type="text" name="youtubeUrl" placeholder="https://youtu.be/..." />
                <small style="color:#666;">將在 AR 中播放影片</small>
              </div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
              <button type="submit" class="btn btn-primary w-100">儲存</button>
              <button type="button" id="cancelEditModal" class="btn btn-secondary w-100">取消</button>
            </div>
            <div id="editTaskMsg" class="mt-2 text-center text-danger"></div>
          </form>
        </div>
      </div>
    </div>
    <div class="task-modal" id="questModal">
      <div class="task-modal-overlay"></div>
      <div class="task-modal-content">
        <div class="task-modal-header">
          <h3>新增劇情任務線</h3>
          <button class="close-btn" id="closeQuestModal">&times;</button>
        </div>
        <div class="task-modal-body">
          <form id="createQuestForm">
            <!-- ... existing fields ... -->
            <div class="form-group">
              <label class="form-label">劇情標題</label>
              <input class="form-input" type="text" name="title" required placeholder="例如：樂樂園勇者試煉" />
            </div>
            <div class="form-group">
              <label class="form-label">劇情描述</label>
              <textarea class="form-textarea" name="description" placeholder="描述這個劇情的背景故事..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">全破獎勵積分</label>
              <input class="form-input" type="number" name="chain_points" min="0" value="100" />
            </div>
            <div class="form-group">
              <label class="form-label">全破獎章名稱</label>
              <input class="form-input" type="text" name="badge_name" placeholder="例如：樂樂園勇者" />
            </div>
            <div class="form-group">
              <label class="form-label">獎章圖片 (選填)</label>
              <input class="form-input" type="file" name="badge_image" accept="image/*" id="questBadgeInput" />
              <div style="margin-top: 10px;">
                <img id="questBadgePreview" src="" style="max-width: 100px; max-height: 100px; display: none; border-radius: 8px; border: 1px solid #ddd;" />
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">建立劇情</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 道具 Modal (新增) -->
    <div class="task-modal" id="itemModal">
      <div class="task-modal-overlay"></div>
      <div class="task-modal-content">
        <div class="task-modal-header">
          <h3>新增道具</h3>
          <button class="close-btn" id="closeItemModal">&times;</button>
        </div>
        <div class="task-modal-body">
          <form id="createItemForm">
            <div class="form-group">
              <label class="form-label">道具名稱</label>
              <input class="form-input" type="text" name="name" required placeholder="例如：古老鑰匙" />
            </div>
            <div class="form-group">
              <label class="form-label">道具描述</label>
              <textarea class="form-textarea" name="description" placeholder="描述這個道具的用途..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">道具圖片</label>
              <input class="form-input" type="file" name="image" accept="image/*" id="itemImageInput" />
              <div style="margin-top: 10px;">
                <img id="itemImagePreview" src="" style="max-width: 100px; max-height: 100px; display: none; border-radius: 8px; border: 1px solid #ddd;" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">連結 3D 模型 (AR 顯示用)</label>
              <select name="model_url" class="form-select ar-model-url-select">
                <option value="">-- 無 --</option>
              </select>
              <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">請先至「3D 模型庫」上傳模型</div>
            </div>
            <button type="submit" class="btn btn-primary w-100">建立道具</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 道具 Modal (編輯) -->
    <div class="task-modal" id="editItemModal">
      <div class="task-modal-overlay"></div>
      <div class="task-modal-content">
        <div class="task-modal-header">
          <h3>編輯道具</h3>
          <button class="close-btn" id="closeEditItemModal">&times;</button>
        </div>
        <div class="task-modal-body">
          <form id="editItemForm">
            <input type="hidden" name="id" />
            <div class="form-group">
              <label class="form-label">道具名稱</label>
              <input class="form-input" type="text" name="name" required />
            </div>
            <div class="form-group">
              <label class="form-label">道具描述</label>
              <textarea class="form-textarea" name="description"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">道具圖片</label>
              <input class="form-input" type="text" name="image_url" placeholder="圖片網址..." />
              <div style="margin: 5px 0; font-size: 0.9rem; color: #666;">或上傳新圖片：</div>
              <input class="form-input" type="file" name="new_image" accept="image/*" id="editItemImageInput" />
              <div style="margin-top: 10px;">
                <img id="editItemImagePreview" src="" style="max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ddd; display:none;" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">連結 3D 模型 (AR 顯示用)</label>
              <select name="model_url" class="form-select ar-model-url-select">
                <option value="">-- 無 --</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">儲存變更</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 發放道具 Modal -->
    <div class="task-modal" id="grantItemModal">
      <div class="task-modal-overlay"></div>
      <div class="task-modal-content">
        <div class="task-modal-header">
          <h3>發放道具</h3>
          <button class="close-btn" id="closeGrantItemModal">&times;</button>
        </div>
        <div class="task-modal-body">
          <form id="grantItemForm">
            <input type="hidden" name="item_id" />
            <div class="form-group" style="background:#fffcf5; padding:10px; border-radius:6px; border:1px solid #ffeeba; margin-bottom:15px;">
              <label class="form-label" style="color:#856404;">發放項目</label>
              <div id="grantItemName" style="font-weight:bold; font-size:1.1rem;"></div>
            </div>
            <div class="form-group">
              <label class="form-label">玩家帳號 (手機號碼)</label>
              <input class="form-input" type="text" name="username" required placeholder="例如：0912345678" />
            </div>
            <div class="form-group">
              <label class="form-label">數量</label>
              <input class="form-input" type="number" name="quantity" min="1" value="1" required />
            </div>
            <button type="submit" class="btn btn-success w-100">確認發放</button>
          </form>
        </div>
      </div>
    </div>
    <!-- 3D 模型上傳 Modal -->
    <div class="task-modal" id="modelModal">
      <div class="task-modal-overlay"></div>
      <div class="task-modal-content">
        <div class="task-modal-header">
          <h3>上傳 3D 模型 (.glb)</h3>
          <button class="close-btn" id="closeModelModal">&times;</button>
        </div>
        <div class="task-modal-body">
          <form id="uploadModelForm">
            <div class="form-group">
              <label class="form-label">模型名稱</label>
              <input class="form-input" type="text" name="name" required placeholder="例如：寶箱、紅旗、飛龍" />
            </div>
            <div class="form-group">
              <label class="form-label">選擇檔案 (.glb / .gltf)</label>
              <input class="form-input" type="file" name="modelFile" accept=".glb,.gltf" required />
              <small style="color:#666;">建議大小：100MB 以內</small>
            </div>
            <div class="form-group">
              <label class="form-label">預設縮放比例 (Scale)</label>
              <input class="form-input" type="number" name="scale" step="0.1" value="1.0" />
              <small style="color:#666;">如果模型太大或太小，可在此設定預設值</small>
            </div>
            <button type="submit" class="btn btn-primary w-100">開始上傳</button>
            <div id="uploadModelMsg" class="mt-2 text-center" style="min-height: 20px;"></div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 GPS 任務系統 - 地方開箱任務遊戲
  </footer>
  <script src="/js/staff-dashboard.js?v=2"></script>
  <script>
    // Header功能
    window.loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');

    // 權限檢查
    if (!window.loginUser || (window.loginUser.role !== 'admin' && window.loginUser.role !== 'shop')) {
      alert('僅限管理員或工作人員使用');
      window.location.href = '/index.html';
    }

    if (window.loginUser) {
      const userInfoSpan = document.getElementById('loginUserInfo');
      userInfoSpan.style.display = 'inline-block';
      userInfoSpan.textContent = getUserDisplayName(window.loginUser);
      
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = function() {
        localStorage.removeItem('loginUser');
        window.location.href = '/login.html';
      };

      if (window.loginUser.role === 'user') {
        const navUserTasks = document.getElementById('navUserTasks');
        if (navUserTasks) navUserTasks.style.display = '';
      }
      
      if (window.loginUser && (window.loginUser.role === 'shop' || window.loginUser.role === 'admin')) {
        const navTasksList = document.getElementById('navTasksList');
        if (navTasksList) navTasksList.style.display = 'none';
      }
    }

    function getUserDisplayName(loginUser) {
      switch(loginUser.role) {
        case 'admin': return `管理員：${loginUser.username}`;
        case 'shop': return `商店：${loginUser.username}`;
        case 'user': return `用戶：${loginUser.username}`;
        default: return loginUser.username;
      }
    }

    document.getElementById('hamburgerBtn').onclick = function() {
      document.getElementById('headerContent').classList.toggle('open');
    };

    document.querySelectorAll('.main-nav a, .main-nav button').forEach(element => {
      element.addEventListener('click', function() {
        document.getElementById('headerContent').classList.remove('open');
      });
    });
  </script>
  <script src="/js/nav-access.js"></script>
</body>
</html>
