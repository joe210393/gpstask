<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .ui-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #start-sensor-btn {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            padding: 15px 30px;
            background: #28a745;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: none; /* é è¨­éš±è—ï¼Œéœ€è¦æ™‚æ‰é¡¯ç¤º */
        }

        .info-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            pointer-events: auto;
        }

        .btn-back {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: auto;
            cursor: pointer;
            z-index: 20;
        }

        /* è™›æ“¬ä¸–ç•Œå±¤ */
        #ar-world {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5;
            perspective: 800px;
            pointer-events: none;
            overflow: hidden;
        }

        /* é–å®šç‹€æ…‹ç‰©ä»¶ (å•è™Ÿ/é–é ­) */
        #locked-obj {
            position: absolute;
            top: 50%; left: 50%;
            width: 200px; height: 200px;
            margin-left: -100px; margin-top: -100px;
            transform-style: preserve-3d;
            display: none;
            cursor: pointer;
            pointer-events: auto;
            text-align: center;
            color: white;
            animation: float 3s ease-in-out infinite;
        }
        #locked-icon {
            font-size: 100px;
            text-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
        }
        #locked-text {
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* æ‰“å¡åœ°æ¨™ç‰©ä»¶ */
        #location-obj {
            position: absolute;
            top: 50%; left: 50%;
            width: 200px; height: 200px;
            margin-left: -100px; margin-top: -100px;
            transform-style: preserve-3d;
            display: none;
            cursor: pointer;
            pointer-events: auto;
            text-align: center;
            color: #ff3b30;
            animation: bounce 2s infinite;
        }
        #location-icon {
            font-size: 100px;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }
        #location-label {
            background: rgba(255, 59, 48, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }

        /* å¯¶ç®±ç‰©ä»¶å®¹å™¨ */
        #chest-obj {
            position: absolute;
            top: 50%; left: 50%;
            width: 350px;
            margin-left: -175px; margin-top: -100px;
            transform-style: preserve-3d;
            display: none;
            cursor: pointer;
            pointer-events: auto;
        }
        
        /* AR å…§å®¹å®¹å™¨ï¼ˆåœ–ç‰‡å’Œå½±ç‰‡ä¸¦æ’ï¼‰ */
        .ar-content-row {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        
        /* é è¨­å¯¶ç®±åœ–ç‰‡ */
        #chest-img {
            width: 150px; height: 150px;
            object-fit: contain;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            animation: float 3s ease-in-out infinite;
        }

        /* YouTube å½±ç‰‡æ¡† - é›»è¦–å¤–è§€ */
        #video-frame {
            width: 240px; height: 160px;
            background: #000;
            border: 12px solid #222; /* é›»è¦–é»‘é‚Šæ¡† */
            border-bottom-width: 25px; /* ä¸‹å·´åŠ åš */
            border-radius: 8px;
            box-shadow: 
                0 0 0 2px #444, /* ç´°å¾®åå…‰é‚Šç·£ */
                0 10px 20px rgba(0,0,0,0.6), /* æ‡¸æµ®é™°å½± */
                inset 0 0 20px rgba(0,0,0,0.8); /* è¢å¹•å…§å‡¹æ„Ÿ */
            display: none;
            animation: float 3s ease-in-out infinite;
            position: relative;
        }

        /* é›»è¦–å“ç‰Œ Logo æ¨¡æ“¬ */
        #video-frame::after {
            content: 'GPS TASK';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #555;
            font-size: 8px;
            font-weight: bold;
            letter-spacing: 1px;
            pointer-events: none;
        }

        /* é›»è¦–é›»æºç‡ˆ */
        #video-frame::before {
            content: '';
            position: absolute;
            bottom: -16px;
            right: 15px;
            width: 4px; height: 4px;
            background: #0f0;
            border-radius: 50%;
            box-shadow: 0 0 4px #0f0;
            pointer-events: none;
        }

        /* æ”¾å¤§æª¢è¦– Modal */
        #ar-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        #ar-modal .modal-content {
            background: rgba(30,30,30,0.95);
            border-radius: 16px;
            padding: 20px;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #ar-modal img, #ar-modal iframe {
            max-width: 100%;
            max-height: 50vh;
            border-radius: 8px;
        }
        #ar-modal .modal-actions {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }
        #ar-modal button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        #ar-modal button:active { transform: scale(0.95); }
        .btn-close { background: #6c757d; color: white; }
        .btn-reply { background: #28a745; color: white; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4); }

        /* å¯†ç¢¼é–æŒ‰éˆ• */
        #btn-open-lock {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: white;
            padding: 12px 22px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 999px;
            font-size: 15px;
            font-weight: 800;
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
            pointer-events: auto;
            cursor: pointer;
            z-index: 2100;
            display: none; /* åªæœ‰ number é¡Œå‹æ‰é¡¯ç¤º */
        }

        /* å¯†ç¢¼é– Overlay */
        #lock-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.86);
            display: none;
            z-index: 3500;
            pointer-events: auto;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }
        #lock-overlay .lock-card {
            width: min(520px, 92vw);
            background: rgba(20,20,20,0.96);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 18px 50px rgba(0,0,0,0.6);
            color: white;
        }
        #lock-overlay .lock-title {
            font-size: 18px;
            font-weight: 900;
            margin-bottom: 6px;
        }
        #lock-overlay .lock-subtitle {
            color: rgba(255,255,255,0.75);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 14px;
        }
        #lock-overlay .wheels {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 12px 0 16px;
            flex-wrap: wrap;
        }
        .wheel {
            width: 62px;
            background: #0b1220;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
        }
        .wheel .btn-up, .wheel .btn-down {
            width: 100%;
            border: none;
            background: rgba(255,255,255,0.08);
            color: white;
            border-radius: 8px;
            padding: 8px 0;
            font-weight: 900;
            cursor: pointer;
        }
        .wheel .digit {
            font-size: 28px;
            font-weight: 900;
            margin: 10px 0;
            letter-spacing: 1px;
            background: rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 10px 0;
            border: 1px solid rgba(255,255,255,0.08);
        }
        #lock-overlay .lock-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 8px;
        }
        #lock-overlay .lock-actions button {
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 900;
            cursor: pointer;
        }
        #btn-lock-cancel { background: #6c757d; color: #fff; }
        #btn-lock-submit { background: #2563eb; color: #fff; box-shadow: 0 6px 18px rgba(37,99,235,0.35); }
        #lock-msg {
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            min-height: 18px;
        }

        /* åªæœ‰åœ–ç‰‡æ™‚ï¼Œè®“å®ƒå±…ä¸­ */
        #chest-obj.only-image .ar-content-row {
            justify-content: center;
        }
        #chest-obj.only-image #chest-img {
            width: 200px; height: 200px;
        }
        
        /* åªæœ‰å½±ç‰‡æ™‚ï¼Œè®“å®ƒå±…ä¸­ */
        #chest-obj.only-video .ar-content-row {
            justify-content: center;
        }
        #chest-obj.only-video #video-frame {
            width: 300px; height: 200px;
        }
        
        iframe {
            width: 100%; height: 100%;
            border: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        #guide-arrow {
            position: absolute;
            top: 50%; left: 50%;
            width: 60px; height: 60px;
            margin-left: -30px; margin-top: -30px;
            display: none;
        }
        #guide-arrow::after {
            content: '';
            display: block;
            width: 100%; height: 100%;
            border-top: 10px solid #ff3b30;
            border-right: 10px solid #ff3b30;
            transform: rotate(45deg);
            box-shadow: 2px -2px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>

    <div id="ar-world">
        <!-- é–å®šç‹€æ…‹ç‰©ä»¶ -->
        <div id="locked-obj">
            <div id="locked-icon">â“</div>
            <div id="locked-text">é»æ“ŠæŸ¥çœ‹ç·šç´¢</div>
        </div>

        <!-- æ‰“å¡åœ°æ¨™ç‰©ä»¶ -->
        <div id="location-obj">
            <div id="location-icon">ğŸ“</div>
            <div id="location-label">é»æ“Šæ‰“å¡</div>
        </div>

        <!-- å®¹å™¨ï¼šå¯èƒ½æ˜¯åœ–ç‰‡ã€å½±ç‰‡ï¼Œæˆ–å…©è€…éƒ½æœ‰ -->
        <div id="chest-obj">
            <div class="ar-content-row">
                <!-- 1. AR å°ˆç”¨åœ–ç‰‡ -->
                <img id="chest-img" src="/images/mascot.png" alt="AR åœ–ç‰‡" style="display:none;">
                
                <!-- 2. YouTube å½±ç‰‡ -->
                <div id="video-frame" style="display:none;">
                    <iframe id="yt-player" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
            </div>

            <div id="tap-hint" style="color:white; text-align:center; text-shadow:0 2px 2px black; font-weight:bold; margin-top:10px;">é»æ“ŠæŸ¥çœ‹è©³æƒ…</div>
        </div>
        
        <div id="guide-arrow"></div>
    </div>

    <!-- æ”¾å¤§æª¢è¦– Modal -->
    <div id="ar-modal">
        <div class="modal-content">
            <div id="modal-body" style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%;">
                <!-- å…§å®¹å‹•æ…‹æ’å…¥ -->
            </div>
            <div class="modal-actions">
                <button class="btn-close" id="modal-close">é—œé–‰</button>
                <button class="btn-reply" id="modal-submit">âœï¸ é»æ“Šå›è¦†å•é¡Œ</button>
            </div>
        </div>
    </div>

    <!-- å¯†ç¢¼é– Overlayï¼ˆåªçµ¦æ•¸å­—è§£è¬ä½¿ç”¨ï¼‰ -->
    <div id="lock-overlay">
        <div class="lock-card">
            <div class="lock-title">ğŸ”’ æ—‹è½‰å¯†ç¢¼é–</div>
            <div class="lock-subtitle">è½‰å‹•æ•¸å­—è¼ªç›¤å¾ŒæŒ‰ã€Œç¢ºå®šè§£é–ã€ã€‚<br>æé†’ï¼šéœ€è¦å®Œå…¨æ­£ç¢ºï¼Œæ‰èƒ½é€šé—œã€‚</div>
            <div class="wheels" id="lock-wheels"></div>
            <div class="lock-actions">
                <button id="btn-lock-cancel" type="button">é—œé–‰</button>
                <button id="btn-lock-submit" type="button">ç¢ºå®šè§£é–</button>
            </div>
            <div id="lock-msg"></div>
        </div>
    </div>

    <div class="ui-layer">
        <!-- å•Ÿå‹•è“‹æ¿ -->
        <div id="start-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; pointer-events:auto;">
            <div style="font-size:1.5rem; font-weight:bold; margin-bottom:20px; text-align:center;">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
            <div style="margin-bottom:30px; color:#ccc; text-align:center; max-width:80%;">éœ€è¦æ‚¨çš„ç›¸æ©Ÿèˆ‡æ–¹å‘æ„Ÿæ¸¬å™¨æ¬Šé™<br>ä»¥é€²è¡Œ AR å°èˆª</div>
            <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#007bff; color:white; border:none; border-radius:50px; font-weight:bold; box-shadow:0 0 20px rgba(0,123,255,0.5);">
                ğŸš€ é–‹å§‹æœå°‹
            </button>
        </div>

        <div class="info-box">
            <div id="status">ç­‰å¾…å•Ÿå‹•...</div>
            <div id="debug-info" style="font-size:0.8em; color:#ffeb3b; margin-top:5px;"></div>
        </div>
        <button id="btn-back" class="btn-back">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
        <button id="btn-open-lock" type="button">ğŸ”’ è¼¸å…¥å¯†ç¢¼</button>
    </div>

    <script>
        const API_BASE = ''; // æœ¬åœ°ç”¨ç©ºå­—ä¸²
        const video = document.getElementById('camera-feed');
        
        // ç§»é™¤è‡ªå‹•å•Ÿå‹•ç›¸æ©Ÿï¼Œæ”¹ç‚ºåœ¨ startBtn.onclick ä¸­å•Ÿå‹•
        
        // 2. å–å¾—ä»»å‹™è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘ä¸»è¦ä¾è³´ API å›å‚³çš„åº§æ¨™ï¼Œä½†å¦‚æœç¶²å€æœ‰å‚³ lat/lng ä¹Ÿæœƒå…ˆç”¨
        let targetLat = parseFloat(urlParams.get('lat'));
        let targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');
        let currentTask = null;
        let isNumberTask = false;
        let isLocationTask = false;
        let lockDigits = 4;
        let currentUserTaskId = null; // user_tasks.id
        let requiredItem = null; // ä»»å‹™éœ€è¦çš„é“å…·è³‡è¨Š
        let hasRequiredItem = false; // ç©å®¶æ˜¯å¦æ“æœ‰è©²é“å…·

        // è¼‰å…¥ä»»å‹™è©³æƒ… (ç‚ºäº†æ‹¿ YouTube é€£çµ)
        if (taskId) {
            fetch(`${API_BASE}/api/tasks/${taskId}`)
                .then(res => res.json())
                .then(async data => {
                    if (data.success && data.task) {
                        const task = data.task;
                        currentTask = task;
                        
                        // æª¢æŸ¥é“å…·éœ€æ±‚
                        if (task.required_item_id) {
                            requiredItem = {
                                id: task.required_item_id,
                                name: task.required_item_name,
                                image: task.required_item_image
                            };
                            // æª¢æŸ¥èƒŒåŒ…
                            const loginUser = getLoginUser();
                            if (loginUser) {
                                try {
                                    const invRes = await fetch(`${API_BASE}/api/user/inventory`, {
                                        headers: { 'x-username': loginUser.username }
                                    });
                                    const invData = await invRes.json();
                                    if (invData.success) {
                                        hasRequiredItem = invData.inventory.some(i => i.item_id === task.required_item_id);
                                    }
                                } catch (e) {
                                    console.error('æª¢æŸ¥èƒŒåŒ…å¤±æ•—', e);
                                }
                            }
                        }

                        isNumberTask = (task.task_type === 'number');
                        isLocationTask = (task.task_type === 'location');
                        
                        // å¦‚æœæ˜¯æ‰“å¡ä»»å‹™ï¼Œé å…ˆæŠ“ user_task_id
                        if (isLocationTask) fetchCurrentUserTaskId();

                        // ä¾ç­”æ¡ˆé•·åº¦æ±ºå®šä½æ•¸ï¼ˆä¸æš´éœ²ç­”æ¡ˆå…§å®¹ï¼›è‹¥ç„¡å‰‡é è¨­ 4ï¼‰
                        if (typeof task.correct_answer === 'string') {
                            const len = task.correct_answer.trim().length;
                            if (len >= 2 && len <= 8) lockDigits = len;
                        }
                        
                        // æ›´æ–°åº§æ¨™ (ä»¥è³‡æ–™åº«ç‚ºæº–)
                        if (task.lat && task.lng) {
                            targetLat = task.lat;
                            targetLng = task.lng;
                        }

                        const chestObj = document.getElementById('chest-obj');
                        const chestImg = document.getElementById('chest-img');
                        const videoFrame = document.getElementById('video-frame');
                        let hasImage = false;
                        let hasVideo = false;

                        // æª¢æŸ¥æ˜¯å¦æœ‰ AR å°ˆç”¨åœ–ç‰‡
                        if (task.ar_image_url) {
                            chestImg.src = task.ar_image_url;
                            chestImg.style.display = 'block';
                            hasImage = true;
                        }

                        // æª¢æŸ¥æ˜¯å¦æœ‰ YouTube é€£çµ
                        if (task.youtubeUrl) {
                            const ytId = extractYouTubeId(task.youtubeUrl);
                            if (ytId) {
                                videoFrame.style.display = 'block';
                                document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                                hasVideo = true;
                            }
                        }

                        // å¦‚æœéƒ½æ²’æœ‰ï¼Œé¡¯ç¤ºé è¨­å¯¶ç®±
                        if (!hasImage && !hasVideo) {
                            chestImg.src = '/images/mascot.png';
                            chestImg.style.display = 'block';
                            hasImage = true;
                        }

                        // è¨­å®šå®¹å™¨é¡åˆ¥ï¼ˆç”¨æ–¼æ¨£å¼èª¿æ•´ï¼‰
                        if (hasImage && hasVideo) {
                            chestObj.className = 'has-both';
                        } else if (hasImage) {
                            chestObj.className = 'only-image';
                        } else if (hasVideo) {
                            chestObj.className = 'only-video';
                        }

                        // è‹¥æ˜¯æ•¸å­—è§£è¬ï¼Œé¡¯ç¤ºå¯†ç¢¼é–æŒ‰éˆ•
                        const btnOpenLock = document.getElementById('btn-open-lock');
                        if (isNumberTask) {
                            btnOpenLock.style.display = 'block';
                            initLockWheels(lockDigits);
                            // é å…ˆæŠ“ä¸€æ¬¡ user_task_id
                            fetchCurrentUserTaskId();
                        } else {
                            btnOpenLock.style.display = 'none';
                        }
                    }
                })
                .catch(err => console.error("ç„¡æ³•è¼‰å…¥ä»»å‹™è©³æƒ…:", err));
        }

        document.getElementById('btn-back').onclick = () => {
            if (taskId) window.location.href = `/task-detail.html?id=${taskId}`;
            else window.history.back();
        };

        // 3. æ„Ÿæ¸¬å™¨èˆ‡ AR é‚è¼¯
        const chest = document.getElementById('chest-obj');
        const lockedObj = document.getElementById('locked-obj');
        const locationObj = document.getElementById('location-obj');
        const arrow = document.getElementById('guide-arrow');
        const debug = document.getElementById('debug-info');
        const status = document.getElementById('status');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const arModal = document.getElementById('ar-modal');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const modalSubmit = document.getElementById('modal-submit');
        const btnOpenLock = document.getElementById('btn-open-lock');
        const lockOverlay = document.getElementById('lock-overlay');
        const lockWheels = document.getElementById('lock-wheels');
        const lockMsg = document.getElementById('lock-msg');
        const btnLockCancel = document.getElementById('btn-lock-cancel');
        const btnLockSubmit = document.getElementById('btn-lock-submit');
        
        let userLat = null, userLng = null;
        let deviceHeading = 0;
        let lastHeading = 0; // å¹³æ»‘åŒ–ç”¨ï¼šä¸Šä¸€æ¬¡çš„è§’åº¦
        let smoothedHeading = 0; // å¹³æ»‘åŒ–ç”¨ï¼šè¨ˆç®—å¾Œçš„è§’åº¦
        let isObjectVisible = false; // ç£æ»¯é–å®šç”¨ï¼šç›®å‰ç‰©é«”æ˜¯å¦å¯è¦‹

        // é»æ“Šæ‰“å¡åœ°æ¨™
        locationObj.onclick = async () => {
            if (!currentUserTaskId) currentUserTaskId = await fetchCurrentUserTaskId();
            if (!currentUserTaskId) {
                alert('æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„');
                return;
            }

            if (confirm('ğŸ“ ç¢ºå®šè¦åœ¨æ­¤è™•æ‰“å¡å—ï¼Ÿ')) {
                try {
                    const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ answer: 'checked_in' }) // å…§å®¹ä¸é‡è¦ï¼Œå¾Œç«¯åªçœ‹é¡å‹
                    });
                    const data = await res.json();
                    if (data.success && data.isCompleted) {
                        alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${data.message}`);
                        window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                    } else {
                        alert(data.message || 'æ‰“å¡å¤±æ•—');
                    }
                } catch (e) {
                    console.error(e);
                    alert('é€£ç·šéŒ¯èª¤');
                }
            }
        };

        // é»æ“Šé–å®šç‰©ä»¶ï¼šæª¢æŸ¥é“å…·
        document.getElementById('locked-obj').onclick = () => {
            if (!requiredItem) return; // ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿ

            if (hasRequiredItem) {
                // æœ‰é“å…·ï¼Œè§£é–
                alert(`ğŸ’ ä½¿ç”¨äº†ã€${requiredItem.name}ã€‘ï¼\nè¬é¡Œå·²è§£é–‹ï¼`);
                lockedObj.style.display = 'none';
                chest.style.display = 'block';
                // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦å°‡ã€Œå·²è§£é–ã€ç‹€æ…‹å­˜å›å¾Œç«¯ï¼Œ
                // ä½†ç‚ºäº†ç°¡åŒ–ï¼Œç›®å‰åƒ…åšå‰ç«¯é¡¯ç¤ºåˆ‡æ›ï¼ˆåæ­£é‡é»æ˜¯è§£é¡Œæ‹¿ç©åˆ†ï¼‰
                // è‹¥ä¸‹æ¬¡é€²ä¾†é‚„æ˜¯æœƒæª¢æŸ¥ä¸€æ¬¡èƒŒåŒ…ï¼Œåªè¦é“å…·é‚„åœ¨å°±æ²’å•é¡Œ
                
                // å°‡ç‹€æ…‹è¨­ç‚º nullï¼Œé¿å… updateAR å†æ¬¡å°‡å…¶éš±è—
                requiredItem = null; 
            } else {
                // æ²’é“å…·ï¼Œæç¤º
                alert(`ğŸ”’ é€™è£¡ä¼¼ä¹è—è‘—ä»€éº¼...\n\néœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘\nè«‹å…ˆå»å°‹æ‰¾é“å…·å†ä¾†å§ï¼`);
            }
        };

        // é»æ“Šäº‹ä»¶ï¼šé–‹å•Ÿæ”¾å¤§æª¢è¦–
        document.getElementById('chest-obj').onclick = () => {
            const chestImg = document.getElementById('chest-img');
            const videoFrame = document.getElementById('video-frame');
            const ytPlayer = document.getElementById('yt-player');

            modalBody.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

            // å¦‚æœæœ‰åœ–ç‰‡ï¼Œè¤‡è£½é€² Modal
            if (chestImg.style.display !== 'none') {
                const img = document.createElement('img');
                img.src = chestImg.src;
                modalBody.appendChild(img);
            }

            // å¦‚æœæœ‰å½±ç‰‡ï¼Œè¤‡è£½é€² Modal
            if (videoFrame.style.display !== 'none') {
                const iframe = document.createElement('iframe');
                iframe.src = ytPlayer.src;
                iframe.style.width = '100%';
                iframe.style.height = '200px'; // Modal å…§çš„é«˜åº¦
                iframe.style.border = 'none';
                iframe.allow = 'autoplay; encrypted-media';
                iframe.allowFullscreen = true;
                modalBody.appendChild(iframe);
            }

            arModal.style.display = 'flex';
        };

        // Modal é—œé–‰
        modalClose.onclick = () => {
            arModal.style.display = 'none';
            modalBody.innerHTML = ''; // æ¸…ç©ºä»¥åœæ­¢å½±ç‰‡æ’­æ”¾
        };

        // Modal å›è¦†å•é¡Œ
        modalSubmit.onclick = () => {
            if (taskId) {
                window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
            } else {
                alert("æ¸¬è©¦æ¨¡å¼ï¼šç›®æ¨™å·²æ‰¾åˆ°ï¼");
            }
        };

        // ====== å¯†ç¢¼é–é‚è¼¯ï¼ˆnumber é¡Œå‹ï¼‰ ======
        function getLoginUser() {
            try {
                const lu = JSON.parse(localStorage.getItem('loginUser') || 'null');
                if (lu && lu.username) return lu;
            } catch {}
            try {
                const u = JSON.parse(localStorage.getItem('user') || 'null');
                if (u && u.username) return u;
            } catch {}
            return null;
        }

        async function fetchCurrentUserTaskId() {
            if (!taskId) return null;
            const loginUser = getLoginUser();
            if (!loginUser || !loginUser.username) return null;
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks?username=${encodeURIComponent(loginUser.username)}`);
                const data = await res.json();
                if (!data.success || !Array.isArray(data.tasks)) return null;
                const t = data.tasks.find(x => String(x.id) === String(taskId));
                if (!t) return null;
                currentUserTaskId = t.user_task_id;
                return currentUserTaskId;
            } catch (e) {
                console.error('fetchCurrentUserTaskId error', e);
                return null;
            }
        }

        function initLockWheels(digits = 4) {
            if (!lockWheels) return;
            lockWheels.innerHTML = '';
            for (let i = 0; i < digits; i++) {
                const wheel = document.createElement('div');
                wheel.className = 'wheel';
                wheel.dataset.value = '0';
                wheel.innerHTML = `
                    <button class="btn-up" type="button">â–²</button>
                    <div class="digit">0</div>
                    <button class="btn-down" type="button">â–¼</button>
                `;
                const digitEl = wheel.querySelector('.digit');
                const btnUp = wheel.querySelector('.btn-up');
                const btnDown = wheel.querySelector('.btn-down');
                const setVal = (v) => {
                    const nv = (v + 10) % 10;
                    wheel.dataset.value = String(nv);
                    digitEl.textContent = String(nv);
                };
                btnUp.onclick = () => setVal(Number(wheel.dataset.value) + 1);
                btnDown.onclick = () => setVal(Number(wheel.dataset.value) - 1);

                // è§¸æ§/æ»‘å‹•ï¼šä¸Šä¸‹æ»‘å‹•æ”¹è®Šæ•¸å­—ï¼ˆç°¡æ˜“æ—‹è½‰æ„Ÿï¼‰
                let startY = null;
                wheel.addEventListener('pointerdown', (ev) => {
                    startY = ev.clientY;
                    wheel.setPointerCapture(ev.pointerId);
                });
                wheel.addEventListener('pointermove', (ev) => {
                    if (startY == null) return;
                    const dy = ev.clientY - startY;
                    if (Math.abs(dy) > 18) {
                        setVal(Number(wheel.dataset.value) + (dy < 0 ? 1 : -1));
                        startY = ev.clientY;
                    }
                });
                wheel.addEventListener('pointerup', () => { startY = null; });
                wheel.addEventListener('pointercancel', () => { startY = null; });

                lockWheels.appendChild(wheel);
            }
        }

        function getLockCode() {
            const wheels = Array.from(lockWheels.querySelectorAll('.wheel'));
            return wheels.map(w => w.dataset.value || '0').join('');
        }

        async function submitLockCode() {
            lockMsg.style.color = 'rgba(255,255,255,0.85)';
            lockMsg.textContent = 'é©—è­‰ä¸­...';
            btnLockSubmit.disabled = true;
            btnLockCancel.disabled = true;

            const code = getLockCode();
            const userTaskId = currentUserTaskId || await fetchCurrentUserTaskId();
            if (!userTaskId) {
                lockMsg.style.color = '#fca5a5';
                lockMsg.textContent = 'æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„ï¼Œè«‹å…ˆå›åˆ°é¡Œç›®é æŒ‰ã€Œé–‹å§‹ä»»å‹™ã€å¾Œå†é€²å…¥ ARã€‚';
                btnLockSubmit.disabled = false;
                btnLockCancel.disabled = false;
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/user-tasks/${userTaskId}/answer`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer: code })
                });
                const data = await res.json();
                if (!data.success) {
                    lockMsg.style.color = '#fca5a5';
                    lockMsg.textContent = data.message || 'é©—è­‰å¤±æ•—';
                } else if (data.isCompleted) {
                    lockMsg.style.color = '#86efac';
                    lockMsg.textContent = 'ç­”å°äº†ï¼ä»»å‹™å®Œæˆï¼Œè¿”å›é¡Œç›®é ...';
                    setTimeout(() => {
                        window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                    }, 900);
                    return;
                } else {
                    lockMsg.style.color = '#fde68a';
                    lockMsg.textContent = data.message || 'ç­”æ¡ˆä¸æ­£ç¢ºï¼Œè«‹å†è©¦ä¸€æ¬¡';
                }
            } catch (e) {
                console.error(e);
                lockMsg.style.color = '#fca5a5';
                lockMsg.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            } finally {
                btnLockSubmit.disabled = false;
                btnLockCancel.disabled = false;
            }
        }

        btnOpenLock.onclick = async () => {
            if (!isNumberTask) return;
            if (lockWheels && !lockWheels.children.length) initLockWheels(lockDigits || 4);
            lockMsg.textContent = '';
            lockOverlay.style.display = 'flex';
            fetchCurrentUserTaskId();
        };
        btnLockCancel.onclick = () => {
            lockOverlay.style.display = 'none';
            lockMsg.textContent = '';
        };
        btnLockSubmit.onclick = submitLockCode;
        lockOverlay.addEventListener('click', (e) => {
            if (e.target === lockOverlay) btnLockCancel.click();
        });

        startBtn.onclick = async () => {
            // 1. è«‹æ±‚æ„Ÿæ¸¬å™¨æ¬Šé™ (iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert('éœ€è¦æ„Ÿæ¸¬å™¨æ¬Šé™æ‰èƒ½é¡¯ç¤ºå°èˆªç®­é ­');
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            // 2. å•Ÿå‹•ç›¸æ©Ÿ
            startCamera();

            // 3. éš±è—è“‹æ¿
            startOverlay.style.display = 'none';
            initSensors();
        };

        function startCamera() {
            status.innerText = 'å•Ÿå‹•ç›¸æ©Ÿä¸­...';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => { video.srcObject = stream; })
                .catch(err => { document.getElementById('status').innerText = "ç›¸æ©ŸéŒ¯èª¤: " + err.message; });
        }

        function initSensors() {
            // å•Ÿå‹• GPS
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    pos => {
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        updateAR();
                    },
                    err => {
                        status.innerText = "GPS éŒ¯èª¤: " + err.message;
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
            }

            // å•Ÿå‹•ç¾…ç›¤
            window.addEventListener('deviceorientation', event => {
                let currentHeading = 0;
                if (event.webkitCompassHeading) {
                    currentHeading = event.webkitCompassHeading;
                } else if (event.alpha) {
                    currentHeading = 360 - event.alpha;
                }
                
                // === ç¾…ç›¤å¹³æ»‘åŒ– (Weighted Smoothing) ===
                // è™•ç† 0/360 åº¦äº¤ç•Œå•é¡Œ (ä¾‹å¦‚ 359 -> 1 åº¦)
                let diff = currentHeading - lastHeading;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                
                // alpha ä¿‚æ•¸ï¼šè¶Šå°è¶Šå¹³æ»‘ä½†åæ‡‰è¶Šæ…¢ï¼Œè¶Šå¤§è¶Šéˆæ•ä½†è¶ŠæŠ–
                // 0.15 æ˜¯ä¸€å€‹ä¸éŒ¯çš„å¹³è¡¡é»
                const alpha = 0.15; 
                lastHeading += diff * alpha;
                
                // æ­£è¦åŒ–å› 0-360
                deviceHeading = (lastHeading + 360) % 360;
                
                updateAR();
            }, true);
        }

        // ç§»é™¤åŸæœ‰çš„è‡ªå‹•å•Ÿå‹•é‚è¼¯ï¼Œæ”¹ç”±æŒ‰éˆ•è§¸ç™¼

        function updateAR() {
            if (!userLat || !targetLat) {
                status.innerText = `GPS å®šä½ä¸­... (ç›®æ¨™:${targetLat},${targetLng})`;
                return;
            }

            const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
            const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            
            status.innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
            
            let delta = bearing - deviceHeading;
            while (delta < -180) delta += 360;
            while (delta > 180) delta -= 360;

            debug.innerText = `æ–¹ä½:${bearing.toFixed(0)}Â° æ‰‹æ©Ÿ:${deviceHeading.toFixed(0)}Â° å·®:${delta.toFixed(0)}Â°\nGPS: ${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

            // === 3. è·é›¢åˆ¤æ–· ===
            // åªæœ‰è·é›¢å¤ è¿‘ (ä¾‹å¦‚ 15m å…§) æ‰é¡¯ç¤ºå¯¶ç®±ï¼Œå¦å‰‡å¼·åˆ¶é¡¯ç¤ºç®­é ­
            const VISIBLE_DISTANCE = 15; 

            // å¦‚æœå¤ªé ï¼Œå¼·åˆ¶é¡¯ç¤ºå°èˆªç®­é ­
            if (dist > VISIBLE_DISTANCE) {
                if (isObjectVisible) {
                    isObjectVisible = false;
                    chest.style.display = 'none';
                    lockedObj.style.display = 'none';
                    locationObj.style.display = 'none';
                }
                arrow.style.display = 'block';
                // ç®­é ­æŒ‡å‘ç›®æ¨™
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`;
                return; // ç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œä¸‹æ–¹çš„è¦–é‡åˆ¤å®š
            }

            // === 2. è¦–è§’ç£æ»¯é–å®š (Hysteresis) ===
            // å¦‚æœå·²ç¶“çœ‹è¦‹ï¼Œå‰‡æ”¾å¯¬è¦–é‡ (50åº¦)ï¼›å¦‚æœæ²’çœ‹è¦‹ï¼Œå‰‡æ”¶ç·Šè¦–é‡ (30åº¦)
            const fov = isObjectVisible ? 50 : 30; 

            if (Math.abs(delta) < fov) {
                // é€²å…¥è¦–é‡
                if (!isObjectVisible) {
                    isObjectVisible = true;
                    arrow.style.display = 'none';
                    
                    // æ ¹æ“šä»»å‹™é¡å‹æ±ºå®šé¡¯ç¤ºå“ªå€‹ç‰©ä»¶
                    if (isLocationTask) {
                        // åœ°ç†åœæ¬„ä»»å‹™ï¼šé¡¯ç¤ºæ‰“å¡åœ°æ¨™
                        locationObj.style.display = 'block';
                        chest.style.display = 'none';
                        lockedObj.style.display = 'none';
                    } else if (requiredItem) {
                        // æœ‰é“å…·éœ€æ±‚ä¸”æœªè§£é–ï¼šé¡¯ç¤ºå•è™Ÿ
                        lockedObj.style.display = 'block';
                        chest.style.display = 'none';
                        locationObj.style.display = 'none';
                    } else {
                        // ä¸€èˆ¬ä»»å‹™æˆ–å·²è§£é–ï¼šé¡¯ç¤ºå…§å®¹
                        lockedObj.style.display = 'none';
                        locationObj.style.display = 'none';
                        chest.style.display = 'block';
                    }
                }

                const screenWidth = window.innerWidth;
                const xOffset = (delta / 40) * (screenWidth / 2); // åˆ†æ¯å›ºå®šç‚º 40ï¼Œé¿å…ç§»å‹•é€Ÿåº¦éš¨ fov æ”¹è®Š
                
                // è·é›¢ç¸®æ”¾
                let scale = 1.2 - (Math.min(dist, 50) / 60); 
                if (scale < 0.4) scale = 0.4;

                const transformStyle = `translate(${xOffset}px, 0) scale(${scale})`;
                chest.style.transform = transformStyle;
                lockedObj.style.transform = transformStyle;
                locationObj.style.transform = transformStyle;

            } else {
                // é›¢é–‹è¦–é‡
                if (isObjectVisible) {
                    isObjectVisible = false;
                    chest.style.display = 'none';
                    lockedObj.style.display = 'none';
                    locationObj.style.display = 'none';
                    arrow.style.display = 'block';
                }
                
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`; 
            }
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin((destLng-startLng) * Math.PI/180) * Math.cos(destLat * Math.PI/180);
            const x = Math.cos(startLat * Math.PI/180) * Math.sin(destLat * Math.PI/180) -
                    Math.sin(startLat * Math.PI/180) * Math.cos(destLat * Math.PI/180) * Math.cos((destLng-startLng) * Math.PI/180);
            const brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : null;
        }
    </script>
</body>
</html>