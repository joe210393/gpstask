<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        #aframe-scene-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            display: none;
        }
        
        .a-enter-vr { display: none; }
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        /* Modal æ¨£å¼ä¿®æ­£ï¼šå…è¨±å…§éƒ¨æ²å‹• */
        #ar-modal .modal-content {
            background: rgba(30,30,30,0.95);
            border-radius: 16px;
            padding: 20px;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow-y: auto; /* é—œéµä¿®æ­£ï¼šè®“å…§å®¹å¤ªé•·æ™‚å¯ä»¥æ²å‹• */
        }
        /* å¯†ç¢¼é–æ¨£å¼ä¿®æ­£ */
        .wheel {
            width: 62px;
            background: #0b1220;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            touch-action: none; /* é—œéµä¿®æ­£ï¼šè§£æ±ºã€Œæ»‘ä¸å‹•ã€çš„å•é¡Œï¼Œç¦æ­¢ç€è¦½å™¨æ””æˆªæ»‘å‹• */
        }
        /* å…¶ä»–åŸæœ‰æ¨£å¼ä¿ç•™ */
        #start-sensor-btn {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            padding: 15px 30px;
            background: #28a745;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: none;
        }
        .info-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; text-align: center; pointer-events: auto;
        }
        #toast-message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85); color: white; padding: 20px 30px;
            border-radius: 16px; text-align: center; z-index: 5000; display: none;
            pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            font-size: 16px; font-weight: bold; max-width: 80%;
            animation: toastFadeIn 0.3s ease-out;
        }
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .btn-back {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #007bff; color: white; padding: 12px 30px;
            border: none; border-radius: 50px; font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; z-index: 20;
        }
        #ar-world {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; perspective: 800px; pointer-events: none; overflow: hidden;
        }
        #locked-obj, #item-use-obj, #location-obj, #chest-obj {
            position: absolute; top: 50%; left: 50%; display: none; cursor: pointer; pointer-events: auto;
        }
        
        #locked-obj { width: 200px; height: 200px; margin-left: -100px; margin-top: -100px; text-align: center; color: white; animation: float 3s infinite; }
        #locked-icon { font-size: 100px; text-shadow: 0 0 20px rgba(255, 255, 0, 0.8); }
        #locked-text { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 10px; margin-top: 10px; font-weight: bold; }
        #ar-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 20px;
        }
        #ar-modal img, #ar-modal iframe { max-width: 100%; max-height: 50vh; border-radius: 8px; }
        #ar-modal .modal-actions { display: flex; gap: 15px; width: 100%; justify-content: center; }
        #ar-modal button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-close { background: #6c757d; color: white; }
        .btn-reply { background: #28a745; color: white; }
        #btn-open-lock {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: #111827; color: white; padding: 12px 22px;
            border: 1px solid rgba(255,255,255,0.2); border-radius: 999px;
            font-size: 15px; font-weight: 800; pointer-events: auto; cursor: pointer; z-index: 2100; display: none;
        }
        #lock-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.86); display: none;
            z-index: 3500; pointer-events: auto; align-items: center; justify-content: center; padding: 18px;
        }
        .lock-card { width: min(520px, 92vw); background: rgba(20,20,20,0.96); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 18px; color: white; }
        .wheels { display: flex; gap: 10px; justify-content: center; align-items: center; margin: 12px 0 16px; flex-wrap: wrap; }
        .wheel .btn-up, .wheel .btn-down { width: 100%; border: none; background: rgba(255,255,255,0.08); color: white; border-radius: 8px; padding: 8px 0; font-weight: 900; cursor: pointer; }
        .wheel .digit { font-size: 28px; font-weight: 900; margin: 10px 0; letter-spacing: 1px; background: rgba(255,255,255,0.06); border-radius: 10px; padding: 10px 0; border: 1px solid rgba(255,255,255,0.08); }
        .lock-actions { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
        .lock-actions button { border: none; border-radius: 10px; padding: 12px 16px; font-size: 15px; font-weight: 900; cursor: pointer; }
        #btn-lock-cancel { background: #6c757d; color: #fff; }
        #btn-lock-submit { background: #2563eb; color: #fff; }
        #lock-msg { text-align: center; margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.8); min-height: 18px; }
        
        /* ç­”é¡Œ Modal */
        #answer-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none;
            align-items: center; justify-content: center; z-index: 3500; padding: 20px;
        }
        .answer-card {
            width: min(500px, 90vw); background: rgba(20,20,20,0.98); 
            border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; 
            padding: 24px; color: white; max-height: 85vh; overflow-y: auto;
        }
        .answer-title {
            font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #fff;
        }
        .answer-description {
            font-size: 0.95rem; color: rgba(255,255,255,0.7); margin-bottom: 20px; line-height: 1.5;
        }
        .answer-input-group {
            margin-bottom: 20px;
        }
        .answer-input-group label {
            display: block; font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 8px;
        }
        .answer-input-group input[type="text"],
        .answer-input-group textarea {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; 
            color: white; font-size: 1rem;
        }
        .answer-input-group textarea {
            min-height: 100px; resize: vertical;
        }
        .answer-choices {
            display: flex; flex-direction: column; gap: 10px;
        }
        .answer-choice {
            background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.2s;
            font-size: 1rem; text-align: left;
        }
        .answer-choice:hover {
            background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4);
        }
        .answer-choice.selected {
            background: rgba(34, 197, 94, 0.3); border-color: #22c55e;
        }
        .answer-actions {
            display: flex; gap: 12px; margin-top: 20px;
        }
        .answer-actions button {
            flex: 1; padding: 14px; border: none; border-radius: 10px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s;
        }
        .btn-answer-cancel {
            background: #6c757d; color: white;
        }
        .btn-answer-submit {
            background: #22c55e; color: white;
        }
        .btn-answer-submit:disabled {
            background: #4b5563; cursor: not-allowed; opacity: 0.5;
        }
        #answer-message {
            text-align: center; margin-top: 12px; font-size: 0.9rem; min-height: 20px;
        }
        
        /* å®Œæˆä»»å‹™ Modal */
        #completion-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none;
            align-items: center; justify-content: center; z-index: 3600; padding: 20px;
        }
        .completion-card {
            width: min(450px, 90vw); background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(20,20,20,0.98));
            border: 2px solid rgba(34, 197, 94, 0.5); border-radius: 20px; 
            padding: 30px; color: white; text-align: center;
        }
        .completion-icon {
            font-size: 4rem; margin-bottom: 15px;
        }
        .completion-title {
            font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #22c55e;
        }
        .completion-reward {
            font-size: 1.1rem; color: #fbbf24; margin-bottom: 20px;
        }
        .completion-next-info {
            background: rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .completion-next-title {
            font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;
        }
        .completion-next-name {
            font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;
        }
        .completion-next-distance {
            font-size: 1rem; color: #fbbf24;
        }
        .completion-actions {
            display: flex; flex-direction: column; gap: 12px;
        }
        .completion-actions button {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s;
        }
        .btn-continue-quest {
            background: linear-gradient(135deg, #22c55e, #16a34a); color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }
        .btn-continue-quest:hover {
            transform: translateY(-2px); box-shadow: 0 6px 16px rgba(34, 197, 94, 0.6);
        }
        .btn-back-home {
            background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);
        }
        
        /* å¯¶ç®±/é“å…·ç­‰ 3D Transform ç›¸é—œ */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        #guide-arrow { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; margin-left: -30px; margin-top: -30px; display: none; }
        #guide-arrow::after { content: ''; display: block; width: 100%; height: 100%; border-top: 10px solid #ff3b30; border-right: 10px solid #ff3b30; transform: rotate(45deg); box-shadow: 2px -2px 2px rgba(0,0,0,0.2); }
        
        /* èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ */
        #bgm-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
            pointer-events: auto;
        }
        #bgm-toggle-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        #bgm-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        #bgm-toggle-btn.playing {
            background: rgba(34, 197, 94, 0.8);
        }
        #bgm-volume-control {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        #bgm-volume-control.show {
            display: flex;
        }
        #bgm-volume-slider {
            width: 100px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        #bgm-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        #bgm-volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        #bgm-volume-label {
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        #bgm-audio {
            display: none;
        }
    </style>
</head>
<body>
    <video id="camera-feed" autoplay playsinline muted></video>
    <div id="aframe-scene-container"></div>
    <div id="ar-world">
        <div id="locked-obj"><div id="locked-icon">â“</div><div id="locked-text">é»æ“ŠæŸ¥çœ‹ç·šç´¢</div></div>
        <div id="item-use-obj" style="display:none; width: 250px; margin-left: -125px; margin-top: -150px; text-align: center;">
            <div style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.8);">
                <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">ğŸ’ ä½¿ç”¨é“å…·</div>
                <div id="item-use-media-container" style="width:150px; height:150px; margin: 0 auto 10px auto; position: relative;">
                    <img id="item-use-image" src="" alt="é“å…·åœ–ç‰‡" style="width:100%; height:100%; object-fit:contain; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.5); cursor:pointer;" />
                    <model-viewer id="item-use-model" src="" style="width:100%; height:100%; display:none; border-radius:12px;" auto-rotate camera-controls disable-zoom></model-viewer>
                </div>
                <div id="item-use-name" style="font-size:16px; font-weight:bold; margin-bottom:8px;"></div>
                <div style="font-size:14px; color:#ffeb3b;">é»æ“Šé“å…·ä½¿ç”¨</div>
            </div>
        </div>
        <div id="location-obj"><div id="location-icon">ğŸ“</div><div id="location-label">é»æ“Šæ‰“å¡</div></div>
        <div id="chest-obj" style="width: 350px; margin-left: -175px; margin-top: -100px;">
            <div class="ar-content-row" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                <img id="chest-img" src="/images/mascot.png" alt="AR åœ–ç‰‡" style="display:none; width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); animation: float 3s ease-in-out infinite;">
                <div id="video-frame" style="display:none; width: 240px; height: 160px; background: #000; border: 12px solid #222; border-bottom-width: 25px; border-radius: 8px;">
                    <iframe id="yt-player" src="" allow="autoplay; encrypted-media" allowfullscreen style="width:100%; height:100%; border:none;"></iframe>
                </div>
            </div>
            <div id="tap-hint" style="color:white; text-align:center; text-shadow:0 2px 2px black; font-weight:bold; margin-top:10px;">é»æ“ŠæŸ¥çœ‹è©³æƒ…</div>
        </div>
        <div id="guide-arrow"></div>
    </div>
    <div id="ar-modal"><div class="modal-content"><div id="modal-body" style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%;"></div><div class="modal-actions"><button class="btn-close" id="modal-close">é—œé–‰</button><button class="btn-reply" id="modal-submit">âœï¸ é»æ“Šå›è¦†å•é¡Œ</button></div></div></div>
    <div id="lock-overlay"><div class="lock-card"><div class="lock-title">ğŸ”’ æ—‹è½‰å¯†ç¢¼é–</div><div class="lock-subtitle">è½‰å‹•æ•¸å­—è¼ªç›¤å¾ŒæŒ‰ã€Œç¢ºå®šè§£é–ã€ã€‚<br>æé†’ï¼šéœ€è¦å®Œå…¨æ­£ç¢ºï¼Œæ‰èƒ½é€šé—œã€‚</div><div class="wheels" id="lock-wheels"></div><div class="lock-actions"><button id="btn-lock-cancel" type="button">é—œé–‰</button><button id="btn-lock-submit" type="button">ç¢ºå®šè§£é–</button></div><div id="lock-msg"></div></div></div>
    
    <!-- ç­”é¡Œ Modal -->
    <div id="answer-modal">
        <div class="answer-card">
            <div class="answer-title" id="answer-task-name">ä»»å‹™æ¨™é¡Œ</div>
            <div class="answer-description" id="answer-task-description">ä»»å‹™æè¿°</div>
            <div id="answer-input-container"></div>
            <div class="answer-actions">
                <button class="btn-answer-cancel" id="btn-answer-cancel">å–æ¶ˆ</button>
                <button class="btn-answer-submit" id="btn-answer-submit">é€å‡ºç­”æ¡ˆ</button>
            </div>
            <div id="answer-message"></div>
        </div>
    </div>
    
    <!-- å®Œæˆä»»å‹™ Modal -->
    <div id="completion-modal">
        <div class="completion-card">
            <div class="completion-icon">ğŸ‰</div>
            <div class="completion-title" id="completion-title">ä»»å‹™å®Œæˆï¼</div>
            <div class="completion-reward" id="completion-reward"></div>
            <div class="completion-next-info" id="completion-next-info" style="display:none;">
                <div class="completion-next-title">ğŸ“ ä¸‹ä¸€é—œ</div>
                <div class="completion-next-name" id="completion-next-name"></div>
                <div class="completion-next-distance" id="completion-next-distance"></div>
            </div>
            <div class="completion-actions">
                <button class="btn-continue-quest" id="btn-continue-quest" style="display:none;">ğŸš€ ç¹¼çºŒå†’éšª</button>
                <button class="btn-back-home" id="btn-back-home">ğŸ“‹ è¿”å›æŸ¥çœ‹</button>
            </div>
        </div>
    </div>
    
    <!-- èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ -->
    <div id="bgm-controls">
        <button id="bgm-toggle-btn" title="èƒŒæ™¯éŸ³æ¨‚">ğŸµ</button>
        <div id="bgm-volume-control">
            <input type="range" id="bgm-volume-slider" min="0" max="100" value="50">
            <div id="bgm-volume-label">éŸ³é‡: 50%</div>
        </div>
    </div>
    <audio id="bgm-audio" loop preload="auto"></audio>
    
    <div class="ui-layer">
        <div id="start-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; pointer-events:auto;">
            <div style="font-size:1.5rem; font-weight:bold; margin-bottom:20px; text-align:center;">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
            <div style="margin-bottom:30px; color:#ccc; text-align:center; max-width:80%;">éœ€è¦æ‚¨çš„ç›¸æ©Ÿèˆ‡æ–¹å‘æ„Ÿæ¸¬å™¨æ¬Šé™<br>ä»¥é€²è¡Œ AR å°èˆª</div>
            <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#007bff; color:white; border:none; border-radius:50px; font-weight:bold; box-shadow:0 0 20px rgba(0,123,255,0.5);">ğŸš€ é–‹å§‹æœå°‹</button>
        </div>
        <div class="info-box"><div id="status">ç­‰å¾…å•Ÿå‹•...</div><div id="debug-info" style="font-size:0.8em; color:#ffeb3b; margin-top:5px;"></div></div>
        <button id="btn-back" class="btn-back">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
        <button id="btn-open-lock" type="button">ğŸ”’ è¼¸å…¥å¯†ç¢¼</button>
        <button id="btn-rotation-mode" type="button" style="position:fixed; bottom:90px; right:20px; background:#28a745; color:white; padding:12px 20px; border:none; border-radius:50px; font-size:14px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.3); pointer-events:auto; cursor:pointer; z-index:20; display:none;">ğŸ”„ æ—‹è½‰æ¨¡å¼</button>
    </div>
    <div id="toast-message"></div>
    <script>
        const API_BASE = ''; 
        const video = document.getElementById('camera-feed');
        const aframeContainer = document.getElementById('aframe-scene-container');
        const arWorld = document.getElementById('ar-world');
        const debug = document.getElementById('debug-info');
        const status = document.getElementById('status');
        
        let is3DMode = false;
        let gpsLocked = false;
        window.rotationMode = false; // æ—‹è½‰æ¨¡å¼é–‹é—œï¼ˆå…¨å±€è®Šé‡ï¼Œä¾›çµ„ä»¶ä½¿ç”¨ï¼‰
        
        // === èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ ===
        const bgmAudio = document.getElementById('bgm-audio');
        const bgmToggleBtn = document.getElementById('bgm-toggle-btn');
        const bgmVolumeControl = document.getElementById('bgm-volume-control');
        const bgmVolumeSlider = document.getElementById('bgm-volume-slider');
        const bgmVolumeLabel = document.getElementById('bgm-volume-label');
        let bgmIsPlaying = false;
        
        // åˆå§‹åŒ–éŸ³æ¨‚éŸ³é‡
        bgmAudio.volume = 0.5; // é è¨­ 50% éŸ³é‡
        bgmVolumeSlider.value = 50;
        
        // éŸ³æ¨‚æ’­æ”¾/æš«åœåˆ‡æ›
        bgmToggleBtn.addEventListener('click', () => {
            if (bgmIsPlaying) {
                bgmAudio.pause();
                bgmToggleBtn.textContent = 'ğŸµ';
                bgmToggleBtn.classList.remove('playing');
                bgmIsPlaying = false;
            } else {
                // å¦‚æœéŸ³æ¨‚ URL å­˜åœ¨ï¼Œå˜—è©¦æ’­æ”¾
                if (bgmAudio.src) {
                    bgmAudio.play().catch(err => {
                        console.warn('éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', err);
                        // æŸäº›ç€è¦½å™¨éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³é »
                        showToast('è«‹é»æ“Šé é¢ä»»æ„ä½ç½®ä»¥å•Ÿç”¨éŸ³æ¨‚æ’­æ”¾', 3000);
                    });
                    bgmToggleBtn.textContent = 'ğŸ”Š';
                    bgmToggleBtn.classList.add('playing');
                    bgmIsPlaying = true;
                } else {
                    showToast('æ­¤ä»»å‹™æ²’æœ‰èƒŒæ™¯éŸ³æ¨‚', 2000);
                }
            }
        });
        
        // éŸ³é‡æ§åˆ¶
        bgmVolumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            bgmAudio.volume = volume;
            bgmVolumeLabel.textContent = `éŸ³é‡: ${e.target.value}%`;
        });
        
        // é¡¯ç¤º/éš±è—éŸ³é‡æ§åˆ¶
        bgmToggleBtn.addEventListener('longpress', () => {
            bgmVolumeControl.classList.toggle('show');
        });
        
        // é•·æŒ‰æª¢æ¸¬ï¼ˆç”¨æ–¼é¡¯ç¤ºéŸ³é‡æ§åˆ¶ï¼‰
        let longPressTimer;
        bgmToggleBtn.addEventListener('mousedown', () => {
            longPressTimer = setTimeout(() => {
                bgmVolumeControl.classList.toggle('show');
            }, 500);
        });
        bgmToggleBtn.addEventListener('mouseup', () => {
            clearTimeout(longPressTimer);
        });
        bgmToggleBtn.addEventListener('mouseleave', () => {
            clearTimeout(longPressTimer);
        });
        bgmToggleBtn.addEventListener('touchstart', () => {
            longPressTimer = setTimeout(() => {
                bgmVolumeControl.classList.toggle('show');
            }, 500);
        });
        bgmToggleBtn.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });
        
        // è¼‰å…¥ä»»å‹™éŸ³æ¨‚ï¼ˆå¦‚æœä»»å‹™æœ‰é…ç½®éŸ³æ¨‚ URLï¼‰
        function loadTaskBGM(task) {
            // å„ªå…ˆä½¿ç”¨ä»»å‹™é…ç½®çš„éŸ³æ¨‚ URLï¼ˆå¦‚æœæœªä¾†æ·»åŠ æ­¤æ¬„ä½ï¼‰
            // ä¾‹å¦‚ï¼štask.bgm_url æˆ– task.audio_url
            const musicUrl = task?.bgm_url || task?.audio_url || null;
            
            if (musicUrl) {
                bgmAudio.src = musicUrl;
                bgmAudio.load();
                console.log('âœ… å·²è¼‰å…¥ä»»å‹™èƒŒæ™¯éŸ³æ¨‚:', musicUrl);
            } else {
                // å¦‚æœæ²’æœ‰é…ç½®éŸ³æ¨‚ï¼Œå¯ä»¥è¨­ç½®é»˜èªéŸ³æ¨‚æˆ–ä¿æŒéœéŸ³
                // é€™è£¡å…ˆæ¸…ç©ºï¼Œç”¨æˆ¶å¯ä»¥æ‰‹å‹•æ·»åŠ éŸ³æ¨‚
                bgmAudio.src = '';
                console.log('â„¹ï¸ æ­¤ä»»å‹™æ²’æœ‰é…ç½®èƒŒæ™¯éŸ³æ¨‚');
            }
        }
        
        // éŸ³æ¨‚æ’­æ”¾ç‹€æ…‹ç›£è½
        bgmAudio.addEventListener('play', () => {
            bgmIsPlaying = true;
            bgmToggleBtn.textContent = 'ğŸ”Š';
            bgmToggleBtn.classList.add('playing');
        });
        
        bgmAudio.addEventListener('pause', () => {
            bgmIsPlaying = false;
            bgmToggleBtn.textContent = 'ğŸµ';
            bgmToggleBtn.classList.remove('playing');
        });
        
        bgmAudio.addEventListener('ended', () => {
            // å¦‚æœè¨­ç½®äº† loopï¼Œé€™å€‹äº‹ä»¶ä¸æœƒè§¸ç™¼
            bgmIsPlaying = false;
            bgmToggleBtn.textContent = 'ğŸµ';
            bgmToggleBtn.classList.remove('playing');
        });
        
        bgmAudio.addEventListener('error', (e) => {
            console.error('éŸ³æ¨‚è¼‰å…¥éŒ¯èª¤:', e);
            showToast('éŸ³æ¨‚è¼‰å…¥å¤±æ•—', 2000);
        });
        
        // === è‡ªå®šç¾©æ—‹è½‰æ§åˆ¶çµ„ä»¶ ===
        AFRAME.registerComponent('rotation-control', {
            init: function() {
                this.isDragging = false;
                this.lastTouchX = 0;
                this.lastTouchY = 0;
                this.rotationX = 0;
                this.rotationY = 0;
                
                // è§¸æ‘¸é–‹å§‹
                this.onTouchStart = (e) => {
                    if (!window.rotationMode) return;
                    this.isDragging = true;
                    const touch = e.touches ? e.touches[0] : e;
                    this.lastTouchX = touch.clientX || touch.pageX;
                    this.lastTouchY = touch.clientY || touch.pageY;
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                // è§¸æ‘¸ç§»å‹•
                this.onTouchMove = (e) => {
                    if (!this.isDragging || !window.rotationMode) return;
                    const touch = e.touches ? e.touches[0] : e;
                    const currentX = touch.clientX || touch.pageX;
                    const currentY = touch.clientY || touch.pageY;
                    const deltaX = currentX - this.lastTouchX;
                    const deltaY = currentY - this.lastTouchY;
                    
                    // æ—‹è½‰æ¨¡å‹
                    this.rotationY += deltaX * 0.5; // æ°´å¹³æ—‹è½‰
                    this.rotationX -= deltaY * 0.5; // å‚ç›´æ—‹è½‰
                    this.rotationX = Math.max(-90, Math.min(90, this.rotationX)); // é™åˆ¶å‚ç›´è§’åº¦
                    
                    this.el.setAttribute('rotation', `${this.rotationX} ${this.rotationY} 0`);
                    
                    this.lastTouchX = currentX;
                    this.lastTouchY = currentY;
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                // è§¸æ‘¸çµæŸ
                this.onTouchEnd = (e) => {
                    this.isDragging = false;
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                // ç¶å®šäº‹ä»¶åˆ°å ´æ™¯å®¹å™¨ï¼ˆç¢ºä¿èƒ½æ•ç²æ‰€æœ‰è§¸æ‘¸äº‹ä»¶ï¼‰
                const scene = this.el.sceneEl;
                if (scene) {
                    scene.addEventListener('mousedown', this.onTouchStart);
                    scene.addEventListener('touchstart', this.onTouchStart, { passive: false });
                    scene.addEventListener('mousemove', this.onTouchMove);
                    scene.addEventListener('touchmove', this.onTouchMove, { passive: false });
                    scene.addEventListener('mouseup', this.onTouchEnd);
                    scene.addEventListener('touchend', this.onTouchEnd);
                }
            },
            remove: function() {
                const scene = this.el.sceneEl;
                if (scene) {
                    scene.removeEventListener('mousedown', this.onTouchStart);
                    scene.removeEventListener('touchstart', this.onTouchStart);
                    scene.removeEventListener('mousemove', this.onTouchMove);
                    scene.removeEventListener('touchmove', this.onTouchMove);
                    scene.removeEventListener('mouseup', this.onTouchEnd);
                    scene.removeEventListener('touchend', this.onTouchEnd);
                }
            }
        });
        
        // === å‹•æ…‹å»ºç«‹ 3D å ´æ™¯ ===
        function init3DScene(modelUrl, scale = 1) {
            const container = document.getElementById('aframe-scene-container');
            
            // ä¿®æ­£ 1: å¢åŠ  cursor="rayOrigin: mouse" è®“æ‰‹æŒ‡é»æ“Šæœ‰æ•ˆ
            // ä¿®æ­£ 2: é»æ“Šå€ ar-model-click-zone è¨­ç‚ºé€æ˜ä½† visibleï¼Œå¦å‰‡ç„¡æ³•é»æ“Š
            container.innerHTML = `
                <a-scene 
                    vr-mode-ui="enabled: false"
                    embedded
                    arjs='sourceType: webcam; debugUIEnabled: false;'
                    renderer="logarithmicDepthBuffer: true; colorManagement: true; alpha: true;"
                    cursor="rayOrigin: mouse">
                    
                    <a-camera gps-camera="minDistance: 0; maxDistance: 2000;" rotation-reader></a-camera>
                    <a-assets>
                        <a-asset-item id="animated-model-asset" src="${modelUrl}"></a-asset-item>
                    </a-assets>
                    
                    <a-entity 
                        id="ar-model-entity"
                        gps-entity-place=""
                        visible="false"
                        rotation-control
                        cursor-listener>
                        
                        <!-- 3D Model -->
                        <a-entity 
                            id="ar-model-inner"
                            gltf-model="#animated-model-asset"
                            animation-mixer
                            scale="${scale} ${scale} ${scale}" 
                            position="0 0 0">
                        </a-entity>

                        <!-- Label to help finding the object -->
                        <a-text 
                            id="ar-model-label"
                            value="ğŸ”» HERE ğŸ”»" 
                            align="center" 
                            color="#FFFF00" 
                            position="0 ${scale * 1.5 + 1} 0" 
                            scale="5 5 5"
                            look-at="[gps-camera]">
                        </a-text>
                        
                        <!-- Hint: Click to view -->
                        <a-text 
                            id="ar-model-hint"
                            value="é»æ“ŠæŸ¥çœ‹è©³æƒ…" 
                            align="center" 
                            color="#FFFFFF" 
                            position="0 ${scale * 1.5 + 2.5} 0" 
                            scale="3 3 3"
                            look-at="[gps-camera]"
                            background-color="rgba(0,0,0,0.6)">
                        </a-text>
                    </a-entity>
                    
                    <!-- Click Zone -->
                    <a-box 
                        id="ar-model-click-zone" 
                        visible="false" 
                        material="opacity: 0.1; transparent: true; color: yellow;"
                        position="0 1 0" 
                        scale="2 2 2"
                        gps-entity-place="">
                    </a-box>
                </a-scene>
            `;
            setTimeout(() => {
                const modelEntity = document.querySelector('#ar-model-entity');
                const clickZone = document.querySelector('#ar-model-click-zone');
                
                const clickHandler = () => {
                    console.log("3D Model Clicked!");
                    if(window.currentTask) {
                        // å¦‚æœç•¶å‰æ­¥é©Ÿæ˜¯ 3D æ¨¡å‹ï¼Œç›´æ¥é¡¯ç¤ºå¯äº’å‹•æª¢è¦–
                        const currentStep = arSteps.length > 0 && currentArStep < arSteps.length ? arSteps[currentArStep] : null;
                        if (currentStep && currentStep.type === '3d') {
                            // ç›´æ¥é¡¯ç¤ºç•¶å‰æ­¥é©Ÿï¼ˆæœƒåŒ…å«å¯äº’å‹•çš„ model-viewerï¼‰
                            showArModal(window.currentTask);
                        } else {
                            // å¦å‰‡é¡¯ç¤ºå®Œæ•´çš„æ­¥é©Ÿæµç¨‹
                            showArModal(window.currentTask);
                        }
                    }
                };
                // ç¶å®šé»æ“Šäº‹ä»¶
                if(modelEntity) {
                    modelEntity.addEventListener('click', clickHandler);
                    // å‚™ç”¨ï¼šå¦‚æœæœ‰é»ä¸åˆ°æ¨¡å‹çš„æƒ…æ³ï¼Œé»æ“Šé€æ˜ç›’å­ä¹Ÿå¯ä»¥
                    if(clickZone) clickZone.addEventListener('click', clickHandler);
                }
                
                // ç¶å®š GPS é–å®šäº‹ä»¶
                window.addEventListener('gps-camera-update-position', (e) => {
                    // æŒçºŒæ›´æ–°è·é›¢èˆ‡æ–¹ä½è³‡è¨Š (ç„¡è«–æ˜¯å¦é–å®š)
                    userLat = e.detail.position.latitude;
                    userLng = e.detail.position.longitude;
                    
                    if (targetLat && targetLng) {
                        const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
                        const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
                        document.getElementById('status').innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m (GPSç²¾åº¦: ${e.detail.position.accuracy?.toFixed(0)}m)`;
                        document.getElementById('debug-info').innerText = `ç›®æ¨™æ–¹ä½: ${bearing.toFixed(0)}Â°`;
                    }

                    if (!gpsLocked && !window.rotationMode) {
                        if(modelEntity && targetLat && targetLng) {
                            modelEntity.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            modelEntity.setAttribute('visible', 'true');
                            
                            // è®“é»æ“Šå€ä¹Ÿè·Ÿè‘—ç§»å‹•
                            if(clickZone) {
                                clickZone.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                                clickZone.setAttribute('visible', 'true'); 
                            }
                            console.log(`ğŸ“ æ¨¡å‹å·²æ”¾ç½®æ–¼ ${targetLat}, ${targetLng}`);
                        }
                        gpsLocked = true;
                    }
                });
                
                // åˆå§‹åŒ–æ—‹è½‰æ¨¡å¼åˆ‡æ›
                window.toggleRotationMode = function() {
                    // æª¢æŸ¥æ¨¡å‹æ˜¯å¦å·²åˆå§‹åŒ–
                    if (!modelEntity || !modelEntity.getAttribute('visible')) {
                        showToast('â³ è«‹ç­‰å¾…æ¨¡å‹è¼‰å…¥å®Œæˆ', 2000);
                        return;
                    }
                    
                    window.rotationMode = !window.rotationMode;
                    const btn = document.getElementById('btn-rotation-mode');
                    const label = document.querySelector('#ar-model-label');
                    const hint = document.querySelector('#ar-model-hint');
                    
                    if (window.rotationMode) {
                        // === åˆ‡æ›åˆ° [æ—‹è½‰æ¨¡å¼] ===
                        if (modelEntity) {
                            // å…ˆç¢ºä¿æ¨¡å‹å¯è¦‹
                            modelEntity.setAttribute('visible', 'true');
                            
                            // ç§»é™¤ GPS ç›¸é—œå±¬æ€§
                            modelEntity.removeAttribute('gps-entity-place');
                            modelEntity.removeAttribute('look-at');
                            
                            // å°‡æ¨¡å‹ä½œç‚ºç›¸æ©Ÿçš„å­å…ƒç´ ï¼Œå›ºå®šåœ¨ç›¸æ©Ÿå‰æ–¹
                            const camera = document.querySelector('a-camera');
                            const scene = document.querySelector('a-scene');
                            if (camera) {
                                // å…ˆå°‡æ¨¡å‹å¾å ´æ™¯ç§»é™¤ï¼ˆå¦‚æœå·²ç¶“åœ¨å ´æ™¯ä¸­ï¼‰
                                if (scene && modelEntity.parentNode === scene) {
                                    scene.removeChild(modelEntity);
                                }
                                
                                // ğŸ”¥ é—œéµä¿®æ”¹ 1ï¼šè¨­å®šä½ç½®èˆ‡ã€Œç¸®å°ã€
                                // åŸæœ¬æ˜¯ 0 0 -2ï¼Œä½†æ¨¡å‹ scale æ˜¯ 3ï¼Œæœƒç©¿æ¨¡
                                // æˆ‘å€‘é€™è£¡æŠŠçˆ¶å±¤ç´š scale ç¸®å°ï¼Œè®“å®ƒè®Šæˆé©åˆæ‰‹æŒæª¢è¦–çš„å¤§å°
                                modelEntity.setAttribute('position', '0 0 -4'); // æ‹‰é ä¸€é»åˆ° 4 ç±³
                                modelEntity.setAttribute('scale', '0.2 0.2 0.2'); // ğŸ”¥ å¼·åˆ¶ç¸®å° (åŸæœ¬æ˜¯ 1)
                                modelEntity.setAttribute('rotation', '0 0 0'); // é‡ç½®æ—‹è½‰
                                
                                // å°‡æ¨¡å‹é™„åŠ åˆ°ç›¸æ©Ÿ
                                camera.appendChild(modelEntity);
                                
                                // ç¢ºä¿å…§éƒ¨æ¨¡å‹å¯è¦‹
                                if (innerModel) {
                                    innerModel.setAttribute('visible', 'true');
                                }
                                
                                // å¼·åˆ¶æ›´æ–°
                                setTimeout(() => {
                                    modelEntity.setAttribute('visible', 'true');
                                    if (innerModel) innerModel.setAttribute('visible', 'true');
                                    console.log('âœ… æ¨¡å‹å·²åˆ‡æ›åˆ°æ—‹è½‰æ¨¡å¼ (ç¸®å°ç‰ˆ)');
                                }, 100);
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°ç›¸æ©Ÿï¼Œä½¿ç”¨å ´æ™¯åæ¨™
                                modelEntity.setAttribute('position', '0 1.6 -4');
                                modelEntity.setAttribute('scale', '0.2 0.2 0.2');
                                modelEntity.setAttribute('rotation', '0 0 0');
                            }
                        }
                        if (clickZone) {
                            clickZone.setAttribute('visible', 'true');
                            clickZone.removeAttribute('gps-entity-place');
                            const camera = document.querySelector('a-camera');
                            if (camera) {
                                const scene = document.querySelector('a-scene');
                                if (scene && clickZone.parentNode === scene) {
                                    scene.removeChild(clickZone);
                                }
                                clickZone.setAttribute('position', '0 0 -4');
                                clickZone.setAttribute('scale', '0.2 0.2 0.2');
                                camera.appendChild(clickZone);
                            }
                        }
                        // æ—‹è½‰æ™‚éš±è—æ¨™ç±¤æ¯”è¼ƒä¹¾æ·¨
                        if (label) {
                            label.setAttribute('visible', 'false');
                        }
                        if (hint) {
                            hint.setAttribute('visible', 'false');
                        }
                        if (btn) {
                            btn.textContent = 'ğŸ“ çµæŸæ—‹è½‰';
                            btn.style.background = '#ffc107'; // é»ƒè‰²æé†’
                        }
                        showToast('ğŸ”„ æ—‹è½‰æ¨¡å¼ï¼šè«‹æ»‘å‹•è¢å¹•æ—‹è½‰æ¨¡å‹', 2000);
                    } else {
                        // === åˆ‡æ›å› [GPS æ¨¡å¼] ===
                        const scene = document.querySelector('a-scene');
                        const camera = document.querySelector('a-camera');
                        if (modelEntity && targetLat && targetLng && scene) {
                            // å°‡æ¨¡å‹å¾ç›¸æ©Ÿç§»é™¤ï¼Œæ”¾å›å ´æ™¯
                            if (camera && modelEntity.parentNode === camera) {
                                camera.removeChild(modelEntity);
                            }
                            
                            // ç¢ºä¿æ¨¡å‹åœ¨å ´æ™¯ä¸­
                            if (modelEntity.parentNode !== scene) {
                                scene.appendChild(modelEntity);
                            }
                            
                            // ğŸ”¥ é—œéµä¿®æ”¹ 2ï¼šæ¢å¾© GPS è¨­å®šèˆ‡åŸå§‹å¤§å°
                            modelEntity.removeAttribute('position'); // ç§»é™¤ç›¸å°åº§æ¨™
                            modelEntity.setAttribute('scale', '1 1 1'); // ğŸ”¥ æ¢å¾©åŸæœ¬å¤§å° (è®“ innerModel çš„ scale 3 ç”Ÿæ•ˆ)
                            modelEntity.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            modelEntity.setAttribute('look-at', '[gps-camera]'); // åŠ å›é¢å‘ç›¸æ©Ÿ
                            modelEntity.setAttribute('rotation', '0 0 0'); // é‡ç½®æ—‹è½‰
                            modelEntity.setAttribute('visible', 'true');
                            
                            // ç¢ºä¿å…§éƒ¨æ¨¡å‹å¯è¦‹
                            const innerModel = document.querySelector('#ar-model-inner');
                            if (innerModel) {
                                innerModel.setAttribute('visible', 'true');
                            }
                            
                            // å¼·åˆ¶æ›´æ–°
                            setTimeout(() => {
                                modelEntity.setAttribute('visible', 'true');
                                if (innerModel) innerModel.setAttribute('visible', 'true');
                                console.log('âœ… æ¨¡å‹å·²åˆ‡æ›å› GPS æ¨¡å¼');
                            }, 100);
                        }
                        if (clickZone && targetLat && targetLng && scene) {
                            if (camera && clickZone.parentNode === camera) {
                                camera.removeChild(clickZone);
                            }
                            if (clickZone.parentNode !== scene) {
                                scene.appendChild(clickZone);
                            }
                            clickZone.removeAttribute('position');
                            clickZone.setAttribute('scale', '1 1 1'); // æ¢å¾©åŸå§‹å¤§å°
                            clickZone.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            clickZone.setAttribute('visible', 'true');
                        }
                        if (label) {
                            label.setAttribute('look-at', '[gps-camera]');
                            label.setAttribute('value', 'ğŸ”» HERE ğŸ”»');
                            label.setAttribute('visible', 'true');
                        }
                        if (hint) {
                            hint.setAttribute('look-at', '[gps-camera]');
                            hint.setAttribute('value', 'é»æ“ŠæŸ¥çœ‹è©³æƒ…');
                            hint.setAttribute('visible', 'true');
                        }
                        if (btn) {
                            btn.textContent = 'ğŸ”„ æ—‹è½‰æ¨¡å¼';
                            btn.style.background = '#28a745';
                        }
                        showToast('ğŸ“ å·²å›åˆ° GPS å®šä½æ¨¡å¼', 2000);
                    }
                };
                
                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                const btnRotation = document.getElementById('btn-rotation-mode');
                if (btnRotation) {
                    btnRotation.onclick = window.toggleRotationMode;
                    btnRotation.style.display = 'block';
                }
            }, 100); 
        }
        // 2. å–å¾—ä»»å‹™è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        let targetLat = parseFloat(urlParams.get('lat'));
        let targetLng = parseFloat(urlParams.get('lng'));
        let taskId = urlParams.get('taskId'); // Changed to let for dynamic updates
        
        let currentTask = null;
        let isNumberTask = false;
        let isLocationTask = false;
        let lockDigits = 4;
        let currentUserTaskId = null;
        let requiredItem = null;
        let hasRequiredItem = false;
        let arSteps = []; // å¤šæ­¥é©Ÿ AR æç¤ºé™£åˆ—
        let currentArStep = 0; // ç•¶å‰æ­¥é©Ÿç´¢å¼•
        if (taskId) {
            fetch(`${API_BASE}/api/tasks/${taskId}`)
                .then(res => res.json())
                .then(async data => {
                    if (data.success && data.task) {
                        const task = data.task;
                        currentTask = task;
                        window.currentTask = task;
                        // è¼‰å…¥ä»»å‹™èƒŒæ™¯éŸ³æ¨‚
                        loadTaskBGM(task);
                        
                        // è§£æ AR å¤šæ­¥é©Ÿé †åº
                        arSteps = [];
                        const steps = [];
                        
                        // 3D æ¨¡å‹ (å…¼å®¹èˆŠæ•¸æ“šï¼šå¦‚æœæœ‰ URL ä½†æ²’é †åºï¼Œé»˜èªç‚ºæ­¥é©Ÿ 1)
                        if (task.ar_model_url) {
                            steps.push({ 
                                type: '3d', 
                                order: task.ar_order_model || 1, 
                                url: task.ar_model_url, 
                                scale: task.ar_model_scale || 3.0 
                            });
                        }
                        
                        // åœ–ç‰‡
                        if (task.ar_image_url) {
                            steps.push({ 
                                type: 'image', 
                                order: task.ar_order_image || (task.ar_model_url ? 2 : 1), 
                                url: task.ar_image_url 
                            });
                        }
                        
                        // YouTube (å…¼å®¹èˆŠæ•¸æ“šï¼šå¦‚æœæœ‰ URL ä½†æ²’é †åºï¼Œè‡ªå‹•æ’åœ¨å¾Œé¢)
                        if (task.youtubeUrl) {
                            steps.push({ 
                                type: 'youtube', 
                                order: task.ar_order_youtube || (steps.length + 1), 
                                url: task.youtubeUrl 
                            });
                        }
                        
                        // å¦‚æœæ­¥é©Ÿéƒ½è¢«è¨­ç‚º 0 æˆ– nullï¼Œé‡æ–°åˆ†é…é †åº
                        if (steps.length > 0 && steps.every(s => !s.order)) {
                            steps.forEach((s, i) => s.order = i + 1);
                        }
                        
                        arSteps = steps.sort((a, b) => (a.order || 99) - (b.order || 99));
                        currentArStep = 0;
                        console.log('ğŸ“‹ AR æ­¥é©Ÿ:', arSteps);
                        
                        // åˆ¤æ–·æ˜¯å¦ä½¿ç”¨ 3D æ¨¡å¼ï¼ˆç¬¬ä¸€æ­¥æ˜¯ 3D æ¨¡å‹ï¼‰
                        const firstStep = arSteps.length > 0 && arSteps[0].type === '3d';
                        if (firstStep) {
                            is3DMode = true;
                            console.log('ğŸš€ åµæ¸¬åˆ° 3D ä»»å‹™ï¼Œæº–å‚™é€²å…¥ 3D æ¨¡å¼');
                        } else {
                            console.log('ğŸ–¼ï¸ ä½¿ç”¨ CSS AR æ¨¡å¼');
                            is3DMode = false;
                            aframeContainer.innerHTML = ''; 
                            aframeContainer.style.display = 'none';
                            arWorld.style.display = 'block';
                            video.style.display = 'block';
                            setupCssArContent(task);
                        }
                        if (task.required_item_id) {
                            requiredItem = { 
                                id: task.required_item_id, 
                                name: task.required_item_name, 
                                image: task.required_item_image,
                                model: task.required_item_model // æ–°å¢
                            };
                            const loginUser = getLoginUser();
                            if (loginUser) {
                                try {
                                    const invRes = await fetch(`${API_BASE}/api/user/inventory`, { headers: { 'x-username': loginUser.username } });
                                    const invData = await invRes.json();
                                    if (invData.success) hasRequiredItem = invData.inventory.some(i => i.item_id === task.required_item_id);
                                } catch (e) { console.error(e); }
                            }
                        }
                        isNumberTask = (task.task_type === 'number');
                        isLocationTask = (task.task_type === 'location');
                        if (isLocationTask) fetchCurrentUserTaskId();
                        if (typeof task.correct_answer === 'string') {
                            const len = task.correct_answer.trim().length;
                            if (len >= 2 && len <= 8) lockDigits = len;
                        }
                        
                        if (task.lat && task.lng) { targetLat = task.lat; targetLng = task.lng; }
                        
                        const btnOpenLock = document.getElementById('btn-open-lock');
                        if (isNumberTask) {
                            btnOpenLock.style.display = 'block';
                            initLockWheels(lockDigits);
                            fetchCurrentUserTaskId();
                        } else {
                            btnOpenLock.style.display = 'none';
                        }
                    }
                })
                .catch(err => { console.error("ç„¡æ³•è¼‰å…¥ä»»å‹™:", err); showToast("è¼‰å…¥ä»»å‹™å¤±æ•—"); });
        }
        function setupCssArContent(task) {
            const chestObj = document.getElementById('chest-obj');
            const chestImg = document.getElementById('chest-img');
            const videoFrame = document.getElementById('video-frame');
            
            // åªé¡¯ç¤ºç¬¬ä¸€æ­¥ï¼ˆå¦‚æœç¬¬ä¸€æ­¥ä¸æ˜¯ 3D æ¨¡å‹ï¼‰
            const firstStep = arSteps.length > 0 ? arSteps[0] : null;
            let hasImage = false, hasVideo = false;
            
            if (firstStep && firstStep.type !== '3d') {
                if (firstStep.type === 'image') {
                    chestImg.src = firstStep.url;
                    chestImg.style.display = 'block';
                    hasImage = true;
                } else if (firstStep.type === 'youtube') {
                    const ytId = extractYouTubeId(firstStep.url);
                    if (ytId) {
                        videoFrame.style.display = 'block';
                        document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        hasVideo = true;
                    }
                }
            } else if (!firstStep) {
                // æ²’æœ‰æ­¥é©Ÿè¨­å®šï¼Œä½¿ç”¨èˆŠé‚è¼¯ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                if (task.ar_image_url) { chestImg.src = task.ar_image_url; chestImg.style.display = 'block'; hasImage = true; }
                if (task.youtubeUrl) {
                    const ytId = extractYouTubeId(task.youtubeUrl);
                    if (ytId) {
                        videoFrame.style.display = 'block';
                        document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        hasVideo = true;
                    }
                }
                if (!hasImage && !hasVideo) { chestImg.src = '/images/mascot.png'; chestImg.style.display = 'block'; hasImage = true; }
            }
            
            if (hasImage && hasVideo) chestObj.className = 'has-both';
            else if (hasImage) chestObj.className = 'only-image';
            else if (hasVideo) chestObj.className = 'only-video';
            else { chestObj.style.display = 'none'; }
        }
        function showArModal(task) {
            const modalBody = document.getElementById('modal-body');
            const arModal = document.getElementById('ar-modal');
            const modalSubmitBtn = document.getElementById('modal-submit');
            
            // 1. æª¢æŸ¥æ˜¯å¦éœ€è¦é“å…·ä¸”å°šæœªè§£é–
            if (requiredItem) {
                if (!hasRequiredItem) { 
                    showToast(`ğŸ”’ éœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘`, 3000); 
                    return; 
                }
                
                // æœ‰é“å…·ï¼Œé¡¯ç¤ºã€Œä½¿ç”¨é“å…·ã€ç¢ºèªè¦–çª—
                modalBody.innerHTML = '';
                
                const title = document.createElement('div');
                title.innerHTML = `<div style="font-size:1.2rem; font-weight:bold; color:white; margin-bottom:10px;">ğŸ’ ä½¿ç”¨é“å…·è§£é–</div>`;
                modalBody.appendChild(title);

                if (requiredItem.model) {
                     const mv = document.createElement('model-viewer');
                     mv.src = requiredItem.model;
                     mv.style.width = '100%';
                     mv.style.height = '400px';
                     mv.style.backgroundColor = 'rgba(0,0,0,0.2)';
                     mv.style.borderRadius = '8px';
                     mv.setAttribute('auto-rotate', '');
                     mv.setAttribute('camera-controls', '');
                     mv.setAttribute('disable-zoom', 'false'); // å…è¨±ç¸®æ”¾
                     mv.setAttribute('shadow-intensity', '1');
                     modalBody.appendChild(mv);
                } else {
                     const img = document.createElement('img');
                     img.src = requiredItem.image || '/images/mascot.png';
                     modalBody.appendChild(img);
                }
                
                const name = document.createElement('div');
                name.innerHTML = `<div style="font-size:1rem; color:#ffeb3b; margin-top:10px;">${requiredItem.name}</div>`;
                modalBody.appendChild(name);

                modalSubmitBtn.textContent = 'âœ¨ ç¢ºèªä½¿ç”¨';
                modalSubmitBtn.onclick = () => {
                     showToast(`ğŸ’ ä½¿ç”¨äº†ã€${requiredItem.name}ã€‘ï¼`, 2000);
                     requiredItem = null; // æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
                     currentArStep = 0; // é‡ç½®æ­¥é©Ÿ
                     showArModal(task); // é‡æ–°å‘¼å«ä»¥é¡¯ç¤ºç¬¬ä¸€æ­¥é©Ÿ
                };
                
                arModal.style.display = 'flex';
                return;
            }

            // 2. é¡¯ç¤º AR å¤šæ­¥é©Ÿæç¤º
            modalBody.innerHTML = '';
            
            // å¦‚æœé‚„æœ‰æ­¥é©Ÿæœªé¡¯ç¤º
            if (currentArStep < arSteps.length) {
                const step = arSteps[currentArStep];
                const stepNum = currentArStep + 1;
                const totalSteps = arSteps.length;
                
                const title = document.createElement('div');
                title.innerHTML = `<div style="font-size:1rem; color:#ccc; margin-bottom:10px;">æç¤º ${stepNum}/${totalSteps}</div>`;
                modalBody.appendChild(title);
                
                if (step.type === '3d') {
                    // 3D æ¨¡å‹é¡¯ç¤ºï¼ˆå¯äº’å‹•æª¢è¦–ï¼‰
                    const hint = document.createElement('div');
                    hint.innerHTML = `<div style="font-size:1.1rem; color:white; margin-bottom:15px;">ğŸ§Š 3D æ¨¡å‹æç¤ºï¼ˆå¯æ—‹è½‰æŸ¥çœ‹ï¼‰</div>`;
                    modalBody.appendChild(hint);
                    
                    const mv = document.createElement('model-viewer');
                    mv.src = step.url;
                    mv.style.width = '100%';
                    mv.style.height = '400px';
                    mv.style.backgroundColor = 'rgba(0,0,0,0.3)';
                    mv.style.borderRadius = '12px';
                    mv.style.marginTop = '10px';
                    mv.setAttribute('auto-rotate', '');
                    mv.setAttribute('camera-controls', '');
                    mv.setAttribute('disable-zoom', 'false'); // å…è¨±ç¸®æ”¾
                    mv.setAttribute('shadow-intensity', '1');
                    mv.setAttribute('exposure', '1.2');
                    modalBody.appendChild(mv);
                } else if (step.type === 'image') {
                    const img = document.createElement('img');
                    img.src = step.url;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '50vh';
                    img.style.borderRadius = '8px';
                    modalBody.appendChild(img);
                } else if (step.type === 'youtube') {
                    const ytId = extractYouTubeId(step.url);
                    if (ytId) {
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        iframe.style.width = '100%';
                        iframe.style.height = '200px';
                        iframe.style.border = 'none';
                        modalBody.appendChild(iframe);
                    }
                }
                
                modalSubmitBtn.textContent = stepNum < totalSteps ? 'â¡ï¸ ä¸‹ä¸€æ­¥' : 'âœï¸ é–‹å§‹ç­”é¡Œ';
                modalSubmitBtn.onclick = () => {
                    currentArStep++;
                    if (currentArStep < arSteps.length) {
                        showArModal(task); // é¡¯ç¤ºä¸‹ä¸€æ­¥
                    } else {
                        // æ‰€æœ‰æ­¥é©Ÿå®Œæˆï¼Œå‰å¾€ç­”é¡Œ
                        arModal.style.display = 'none';
                        if (task.task_type === 'location') {
                            // åœ°é»ä»»å‹™ç›´æ¥å®Œæˆ
                            locationObj.click();
                        } else if (task.task_type === 'number') {
                            // æ•¸å­—ä»»å‹™ä½¿ç”¨å¯†ç¢¼é–
                            document.getElementById('btn-open-lock').click();
                        } else {
                            // å…¶ä»–ä»»å‹™åœ¨ AR æ¨¡å¼ä¸‹é¡¯ç¤ºç­”é¡Œç•Œé¢
                            showAnswerModal(task);
                        }
                    }
                };
                
                arModal.style.display = 'flex';
                return;
            }
            
            // 3. æ‰€æœ‰æ­¥é©Ÿå®Œæˆï¼Œæ ¹æ“šä»»å‹™é¡å‹è™•ç†
            if (task.task_type === 'location') {
                modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                modalSubmitBtn.onclick = async () => {
                    modalSubmitBtn.disabled = true;
                    modalSubmitBtn.textContent = 'æ‰“å¡ä¸­...';
                    
                    if (!currentUserTaskId) currentUserTaskId = await fetchCurrentUserTaskId();
                    if (!currentUserTaskId) { 
                        alert('æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„'); 
                        modalSubmitBtn.disabled = false;
                        modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                        return; 
                    }

                    try {
                        const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, { 
                            method: 'PATCH', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ answer: 'checked_in' }) 
                        });
                        const data = await res.json();
                        if (data.success && data.isCompleted) {
                            arModal.style.display = 'none';
                            showCompletionModal(data.earnedItemName, data.questChainCompleted, data.questChainReward);
                        } else { 
                            alert(data.message || 'æ‰“å¡å¤±æ•—'); 
                            modalSubmitBtn.disabled = false;
                            modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                        }
                    } catch (e) { 
                        console.error(e); 
                        alert('é€£ç·šéŒ¯èª¤'); 
                        modalSubmitBtn.disabled = false;
                        modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                    }
                };
            } else {
                // å…¶ä»–ä»»å‹™é¡å‹ï¼šåœ¨ AR æ¨¡å¼ä¸‹é¡¯ç¤ºç­”é¡Œç•Œé¢
                if (task.task_type === 'number') {
                    // æ•¸å­—ä»»å‹™ä½¿ç”¨å¯†ç¢¼é–
                    modalSubmitBtn.textContent = 'ğŸ”’ è¼¸å…¥å¯†ç¢¼';
                    modalSubmitBtn.onclick = () => {
                        arModal.style.display = 'none';
                        document.getElementById('btn-open-lock').click();
                    };
                } else {
                    // å…¶ä»–ä»»å‹™ï¼ˆæ–‡å­—ã€é¸æ“‡ã€æ‹ç…§ï¼‰åœ¨ AR æ¨¡å¼ä¸‹ç­”é¡Œ
                    modalSubmitBtn.textContent = 'âœï¸ é–‹å§‹ç­”é¡Œ';
                    modalSubmitBtn.onclick = () => {
                        arModal.style.display = 'none';
                        showAnswerModal(task);
                    };
                }
            }

            if (is3DMode) {
                const img = document.createElement('img');
                img.src = task.ar_image_url || task.photoUrl || '/images/mascot.png';
                modalBody.appendChild(img);
                if (task.youtubeUrl) {
                    const ytId = extractYouTubeId(task.youtubeUrl);
                    if (ytId) {
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        iframe.style.width = '100%'; iframe.style.height = '200px'; iframe.style.border = 'none';
                        modalBody.appendChild(iframe);
                    }
                }
            } else {
                const chestImg = document.getElementById('chest-img');
                const videoFrame = document.getElementById('video-frame');
                const ytPlayer = document.getElementById('yt-player');
                if (chestImg.style.display !== 'none') { const img = document.createElement('img'); img.src = chestImg.src; modalBody.appendChild(img); }
                if (videoFrame.style.display !== 'none') {
                    const iframe = document.createElement('iframe'); iframe.src = ytPlayer.src;
                    iframe.style.width = '100%'; iframe.style.height = '200px'; iframe.style.border = 'none';
                    modalBody.appendChild(iframe);
                }
            }
            arModal.style.display = 'flex';
        }
        function showRewardModal(itemName, itemImage, itemModel, callback) {
            const modalBody = document.getElementById('modal-body');
            const arModal = document.getElementById('ar-modal');
            const modalSubmitBtn = document.getElementById('modal-submit');
            
            modalBody.innerHTML = '';
            
            const title = document.createElement('div');
            title.innerHTML = `<div style="font-size:1.5rem; font-weight:bold; color:#4ade80; margin-bottom:15px; text-shadow:0 2px 4px rgba(0,0,0,0.5);">ğŸ‰ ç²å¾—çå‹µï¼</div>`;
            modalBody.appendChild(title);

            if (itemModel) {
                const mv = document.createElement('model-viewer');
                mv.src = itemModel;
                mv.style.width = '100%';
                mv.style.height = '400px';
                mv.style.backgroundColor = 'rgba(255,255,255,0.1)';
                mv.style.borderRadius = '12px';
                mv.setAttribute('auto-rotate', '');
                mv.setAttribute('camera-controls', '');
                mv.setAttribute('disable-zoom', 'false'); // å…è¨±ç¸®æ”¾
                mv.setAttribute('shadow-intensity', '1');
                mv.setAttribute('exposure', '1.2');
                modalBody.appendChild(mv);
            } else if (itemImage) {
                const img = document.createElement('img');
                img.src = itemImage;
                img.style.maxHeight = '250px';
                img.style.objectFit = 'contain';
                modalBody.appendChild(img);
            } else {
                 const placeholder = document.createElement('div');
                 placeholder.style.fontSize = '4rem';
                 placeholder.textContent = 'ğŸ';
                 modalBody.appendChild(placeholder);
            }
            
            const name = document.createElement('div');
            name.innerHTML = `<div style="font-size:1.2rem; color:white; margin-top:15px; font-weight:bold;">${itemName}</div>`;
            modalBody.appendChild(name);

            modalSubmitBtn.textContent = 'ğŸ“¥ æ”¶ä¸‹çå‹µ';
            modalSubmitBtn.onclick = () => {
                if (callback) callback();
                else arModal.style.display = 'none';
            };
            
            arModal.style.display = 'flex';
        }

        document.getElementById('btn-back').onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}`; else window.history.back(); };
        const chest = document.getElementById('chest-obj');
        const lockedObj = document.getElementById('locked-obj');
        const itemUseObj = document.getElementById('item-use-obj');
        const locationObj = document.getElementById('location-obj');
        const arrow = document.getElementById('guide-arrow');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const arModal = document.getElementById('ar-modal');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const modalSubmit = document.getElementById('modal-submit');
        const lockOverlay = document.getElementById('lock-overlay');
        const lockWheels = document.getElementById('lock-wheels');
        const lockMsg = document.getElementById('lock-msg');
        const btnLockCancel = document.getElementById('btn-lock-cancel');
        const btnLockSubmit = document.getElementById('btn-lock-submit');
        
        let userLat = null, userLng = null, deviceHeading = 0, lastHeading = 0, isObjectVisible = false;
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast-message'); if (!toast) return;
            toast.textContent = message; toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, duration);
        }
        locationObj.onclick = async () => {
            if (!currentUserTaskId) currentUserTaskId = await fetchCurrentUserTaskId();
            if (!currentUserTaskId) { alert('æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„'); return; }
            if (confirm('ğŸ“ ç¢ºå®šè¦åœ¨æ­¤è™•æ‰“å¡å—ï¼Ÿ')) {
                try {
                    const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: 'checked_in' }) });
                    const data = await res.json();
                    if (data.success && data.isCompleted) {
                        showCompletionModal(data.earnedItemName, data.questChainCompleted, data.questChainReward);
                    } else { alert(data.message || 'æ‰“å¡å¤±æ•—'); }
                } catch (e) { console.error(e); alert('é€£ç·šéŒ¯èª¤'); }
            }
        };
        document.getElementById('locked-obj').onclick = () => { if (requiredItem) showToast(`ğŸ”’ éœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘`, 3000); };
        const itemUseImage = document.getElementById('item-use-image');
        itemUseObj.onclick = () => { if (!requiredItem || !hasRequiredItem) return; showToast(`ğŸ’ ä½¿ç”¨äº†ã€${requiredItem.name}ã€‘ï¼`, 2500); itemUseObj.style.display = 'none'; chest.style.display = 'block'; requiredItem = null; };
        if (itemUseImage) itemUseImage.onclick = (e) => { e.stopPropagation(); itemUseObj.click(); };
        document.getElementById('chest-obj').onclick = () => { showArModal(window.currentTask || {}); };
        modalClose.onclick = () => { arModal.style.display = 'none'; modalBody.innerHTML = ''; };
        modalSubmit.onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`; else alert("æ¸¬è©¦æ¨¡å¼ï¼šç›®æ¨™å·²æ‰¾åˆ°ï¼"); };
        function getLoginUser() {
            try { return JSON.parse(localStorage.getItem('loginUser') || 'null'); } catch {}
            try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch {}
            return null;
        }
        async function fetchCurrentUserTaskId() {
            if (!taskId) return null;
            const loginUser = getLoginUser(); if (!loginUser || !loginUser.username) return null;
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks?username=${encodeURIComponent(loginUser.username)}`);
                const data = await res.json();
                if (!data.success || !Array.isArray(data.tasks)) return null;
                const t = data.tasks.find(x => String(x.id) === String(taskId));
                if (!t) return null; currentUserTaskId = t.user_task_id; return currentUserTaskId;
            } catch (e) { return null; }
        }
        function initLockWheels(digits = 4) {
            if (!lockWheels) return;
            lockWheels.innerHTML = '';
            for (let i = 0; i < digits; i++) {
                const wheel = document.createElement('div'); wheel.className = 'wheel'; wheel.dataset.value = '0';
                wheel.innerHTML = `<button class="btn-up" type="button">â–²</button><div class="digit">0</div><button class="btn-down" type="button">â–¼</button>`;
                const digitEl = wheel.querySelector('.digit');
                const setVal = (v) => { const nv = (v + 10) % 10; wheel.dataset.value = String(nv); digitEl.textContent = String(nv); };
                wheel.querySelector('.btn-up').onclick = () => setVal(Number(wheel.dataset.value) + 1);
                wheel.querySelector('.btn-down').onclick = () => setVal(Number(wheel.dataset.value) - 1);
                let startY = null;
                wheel.addEventListener('pointerdown', (ev) => { startY = ev.clientY; wheel.setPointerCapture(ev.pointerId); });
                wheel.addEventListener('pointermove', (ev) => { if (startY == null) return; const dy = ev.clientY - startY; if (Math.abs(dy) > 18) { setVal(Number(wheel.dataset.value) + (dy < 0 ? 1 : -1)); startY = ev.clientY; } });
                wheel.addEventListener('pointerup', () => { startY = null; }); wheel.addEventListener('pointercancel', () => { startY = null; });
                lockWheels.appendChild(wheel);
            }
        }
        function getLockCode() { return Array.from(lockWheels.querySelectorAll('.wheel')).map(w => w.dataset.value || '0').join(''); }
        async function submitLockCode() {
            lockMsg.style.color = 'rgba(255,255,255,0.85)'; lockMsg.textContent = 'é©—è­‰ä¸­...';
            btnLockSubmit.disabled = true; btnLockCancel.disabled = true;
            const code = getLockCode();
            const userTaskId = currentUserTaskId || await fetchCurrentUserTaskId();
            if (!userTaskId) { lockMsg.style.color = '#fca5a5'; lockMsg.textContent = 'æ‰¾ä¸åˆ°ä»»å‹™ç´€éŒ„'; btnLockSubmit.disabled = false; btnLockCancel.disabled = false; return; }
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks/${userTaskId}/answer`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: code }) });
                const data = await res.json();
                if (!data.success) { lockMsg.style.color = '#fca5a5'; lockMsg.textContent = data.message || 'é©—è­‰å¤±æ•—'; }
                else if (data.isCompleted) {
                    lockMsg.style.color = '#86efac'; lockMsg.textContent = data.earnedItemName ? `ç­”å°ï¼ç²å¾—ï¼š${data.earnedItemName}` : 'ç­”å°äº†ï¼';
                    
                    setTimeout(() => {
                        lockOverlay.style.display = 'none';
                        showCompletionModal(data.earnedItemName, data.questChainCompleted, data.questChainReward);
                    }, 1500);
                    return;
                } else { lockMsg.style.color = '#fde68a'; lockMsg.textContent = 'ç­”æ¡ˆéŒ¯èª¤'; }
            } catch (e) { lockMsg.textContent = 'é€£ç·šå¤±æ•—'; } finally { btnLockSubmit.disabled = false; btnLockCancel.disabled = false; }
        }
        async function loadNextTask(completedTask) {
            if (!completedTask.quest_chain_id || !completedTask.quest_order) return false;

            showToast('æ­£åœ¨æœå°‹ä¸‹ä¸€é—œ...', 3000);

            try {
                // Fetch all tasks to find the next one
                const res = await fetch(`${API_BASE}/api/tasks`);
                const data = await res.json();
                if (!data.success) throw new Error("Failed to fetch tasks");

                const nextTask = data.tasks.find(t => 
                    t.quest_chain_id === completedTask.quest_chain_id && 
                    t.quest_order === completedTask.quest_order + 1 &&
                    t.type === 'quest' // ğŸ”¥ ä¿®æ­£ï¼šæ­£ç¢ºæ¬„ä½æ˜¯ type (single/quest)ï¼Œè€Œé task_type (qa/photo)
                );

                if (!nextTask) return false; // No next task found

                // Start the next task
                const loginUser = getLoginUser();
                if (!loginUser) return false;

                const startRes = await fetch(`${API_BASE}/api/user-tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: loginUser.username, task_id: nextTask.id })
                });
                const startData = await startRes.json();
                
                // Note: If startData.message is 'å·²åœ¨é€²è¡Œä¸­' it's fine.
                if (!startData.success && startData.message !== 'å·²åœ¨é€²è¡Œä¸­') {
                    console.error("Failed to start next task:", startData.message);
                    return false;
                }

                // Update Global State
                taskId = String(nextTask.id);
                window.currentTask = nextTask;
                currentTask = nextTask;
                
                // Update URL without reload
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('taskId', nextTask.id);
                newUrl.searchParams.set('lat', nextTask.lat);
                newUrl.searchParams.set('lng', nextTask.lng);
                window.history.pushState({}, '', newUrl);

                // Reset AR State
                targetLat = nextTask.lat;
                targetLng = nextTask.lng;
                currentUserTaskId = null; // Will be refetched if needed
                
                // Reset variables
                requiredItem = null;
                hasRequiredItem = false;
                isNumberTask = (nextTask.task_type === 'number');
                isLocationTask = (nextTask.task_type === 'location');
                lockDigits = 4;
                if (typeof nextTask.correct_answer === 'string') {
                    const len = nextTask.correct_answer.trim().length;
                    if (len >= 2 && len <= 8) lockDigits = len;
                }

                // Reset AR Steps (ä½¿ç”¨èˆ‡åˆå§‹åŒ–ç›¸åŒçš„å…¼å®¹é‚è¼¯)
                arSteps = [];
                const steps = [];
                
                // 3D æ¨¡å‹
                if (nextTask.ar_model_url) {
                    steps.push({ 
                        type: '3d', 
                        order: nextTask.ar_order_model || 1, 
                        url: nextTask.ar_model_url, 
                        scale: nextTask.ar_model_scale || 3.0 
                    });
                }
                
                // åœ–ç‰‡
                if (nextTask.ar_image_url) {
                    steps.push({ 
                        type: 'image', 
                        order: nextTask.ar_order_image || (nextTask.ar_model_url ? 2 : 1), 
                        url: nextTask.ar_image_url 
                    });
                }
                
                // YouTube
                if (nextTask.youtubeUrl) {
                    steps.push({ 
                        type: 'youtube', 
                        order: nextTask.ar_order_youtube || (steps.length + 1), 
                        url: nextTask.youtubeUrl 
                    });
                }

                // å¦‚æœæ­¥é©Ÿéƒ½è¢«è¨­ç‚º 0 æˆ– nullï¼Œé‡æ–°åˆ†é…é †åº
                if (steps.length > 0 && steps.every(s => !s.order)) {
                    steps.forEach((s, i) => s.order = i + 1);
                }
                
                arSteps = steps.sort((a, b) => (a.order || 99) - (b.order || 99));
                currentArStep = 0;

                // Check required item
                if (nextTask.required_item_id) {
                    requiredItem = { 
                        id: nextTask.required_item_id, 
                        name: nextTask.required_item_name, 
                        image: nextTask.required_item_image,
                        model: nextTask.required_item_model 
                    };
                    const loginUser = getLoginUser();
                    if (loginUser) {
                        try {
                            const invRes = await fetch(`${API_BASE}/api/user/inventory`, { headers: { 'x-username': loginUser.username } });
                            const invData = await invRes.json();
                            if (invData.success) hasRequiredItem = invData.inventory.some(i => i.item_id === nextTask.required_item_id);
                        } catch (e) { console.error(e); }
                    }
                }

                // UI Updates
                showToast(`ğŸ‰ ä¸‹ä¸€é—œï¼š${nextTask.name}`, 4000);
                document.getElementById('status').innerText = `ç›®æ¨™æ›´æ–°ï¼š${nextTask.name}`;
                
                // Handle Scene Transition
                const container = document.getElementById('aframe-scene-container');
                container.innerHTML = ''; // æ¸…ç©ºèˆŠå ´æ™¯
                
                // å¼·åˆ¶æ¸…ç† AR.js å¯èƒ½æ®˜ç•™çš„ video å…ƒç´  (IDé€šå¸¸æ˜¯ arjs-video)
                const arjsVideo = document.getElementById('arjs-video');
                if (arjsVideo) {
                    arjsVideo.srcObject = null;
                    arjsVideo.remove();
                }

                // åˆ¤æ–·æ˜¯å¦é€²å…¥ 3D æ¨¡å¼ (ç¬¬ä¸€æ­¥æ˜¯ 3D)
                const firstStep = arSteps.length > 0 && arSteps[0].type === '3d';
                
                if (firstStep) {
                    // === é€²å…¥ 3D æ¨¡å¼ ===
                    is3DMode = true;
                    document.getElementById('ar-world').style.display = 'none';
                    video.style.display = 'none';
                    container.style.display = 'block';
                    const btnRotation = document.getElementById('btn-rotation-mode');
                    if (btnRotation) btnRotation.style.display = 'block';
                    
                    // åœæ­¢ 2D ç›¸æ©Ÿæµä»¥é‡‹æ”¾è³‡æºçµ¦ AR.js
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }

                    // å»¶é²ä¸€é»é»å†å•Ÿå‹•ï¼Œç¢ºä¿ DOM ä¹¾æ·¨
                    setTimeout(() => {
                        init3DScene(arSteps[0].url, arSteps[0].scale);
                    }, 100);
                    
                } else {
                    // === é€²å…¥ 2D æ¨¡å¼ ===
                    is3DMode = false;
                    container.style.display = 'none';
                    document.getElementById('ar-world').style.display = 'block';
                    video.style.display = 'block';
                    const btnRotation = document.getElementById('btn-rotation-mode');
                    if (btnRotation) btnRotation.style.display = 'none';
                    
                    // ç¢ºä¿ç›¸æ©Ÿæµæ­£åœ¨é‹è¡Œ
                    if (!video.srcObject || !video.srcObject.active) {
                        console.log('ğŸ¥ é‡æ–°å•Ÿå‹•ç›¸æ©Ÿæµ');
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ 
                                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, 
                                audio: false 
                            });
                            video.srcObject = stream;
                            video.onloadedmetadata = () => { video.play(); };
                        } catch (err) {
                            console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:", err);
                            showToast("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢", 3000);
                        }
                    } else {
                        // ç›¸æ©Ÿæµé‚„åœ¨é‹è¡Œï¼Œç¢ºä¿ video æ­£åœ¨æ’­æ”¾
                        video.play();
                    }
                    
                    setupCssArContent(nextTask);
                }

                // Reset Object Visibility
                isObjectVisible = false;
                gpsLocked = false;
                document.getElementById('guide-arrow').style.display = 'block';
                document.getElementById('chest-obj').style.display = 'none';
                document.getElementById('locked-obj').style.display = 'none';
                document.getElementById('item-use-obj').style.display = 'none';
                document.getElementById('location-obj').style.display = 'none';

                // Update Lock Button
                const btnOpenLock = document.getElementById('btn-open-lock');
                if (isNumberTask) {
                    btnOpenLock.style.display = 'block';
                    initLockWheels(lockDigits);
                } else {
                    btnOpenLock.style.display = 'none';
                }
                
                return true;

            } catch (e) {
                console.error("Error loading next task:", e);
                return false;
            }
        }

        // === ç­”é¡Œ Modal åŠŸèƒ½ ===
        function showAnswerModal(task) {
            const answerModal = document.getElementById('answer-modal');
            const answerTaskName = document.getElementById('answer-task-name');
            const answerTaskDescription = document.getElementById('answer-task-description');
            const answerInputContainer = document.getElementById('answer-input-container');
            const answerMessage = document.getElementById('answer-message');
            const btnAnswerSubmit = document.getElementById('btn-answer-submit');

            // è¨­å®šä»»å‹™è³‡è¨Š
            answerTaskName.textContent = task.name;
            answerTaskDescription.textContent = task.description || 'è«‹æ ¹æ“šæç¤ºå›ç­”å•é¡Œ';
            answerMessage.textContent = '';
            answerInputContainer.innerHTML = '';

            // æ ¹æ“šä»»å‹™é¡å‹é¡¯ç¤ºä¸åŒçš„è¼¸å…¥ç•Œé¢
            if (task.task_type === 'multiple_choice') {
                // é¸æ“‡é¡Œ
                const choices = task.options || [];
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'answer-choices';
                
                choices.forEach((choice, index) => {
                    const choiceBtn = document.createElement('div');
                    choiceBtn.className = 'answer-choice';
                    choiceBtn.textContent = choice;
                    choiceBtn.dataset.value = choice;
                    choiceBtn.onclick = () => {
                        // æ¸…é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
                        choicesDiv.querySelectorAll('.answer-choice').forEach(c => c.classList.remove('selected'));
                        // é¸ä¸­ç•¶å‰é¸é …
                        choiceBtn.classList.add('selected');
                        btnAnswerSubmit.disabled = false;
                    };
                    choicesDiv.appendChild(choiceBtn);
                });
                
                answerInputContainer.appendChild(choicesDiv);
                btnAnswerSubmit.disabled = true;

            } else if (task.task_type === 'photo') {
                // æ‹ç…§é¡Œ
                const photoGroup = document.createElement('div');
                photoGroup.className = 'answer-input-group';
                photoGroup.innerHTML = `
                    <label>ğŸ“¸ ä¸Šå‚³ç…§ç‰‡</label>
                    <input type="file" id="answer-photo-input" accept="image/*" capture="environment" style="width:100%; padding:12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white;">
                    <img id="answer-photo-preview" style="display:none; max-width:100%; margin-top:10px; border-radius:8px;">
                `;
                answerInputContainer.appendChild(photoGroup);
                
                const photoInput = document.getElementById('answer-photo-input');
                const photoPreview = document.getElementById('answer-photo-preview');
                photoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            photoPreview.src = e.target.result;
                            photoPreview.style.display = 'block';
                            btnAnswerSubmit.disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                btnAnswerSubmit.disabled = true;

            } else {
                // æ–‡å­—é¡Œ (qa, keyword)
                const textGroup = document.createElement('div');
                textGroup.className = 'answer-input-group';
                textGroup.innerHTML = `
                    <label>âœï¸ è«‹è¼¸å…¥ç­”æ¡ˆ</label>
                    <input type="text" id="answer-text-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..." autocomplete="off">
                `;
                answerInputContainer.appendChild(textGroup);
                
                const textInput = document.getElementById('answer-text-input');
                textInput.addEventListener('input', () => {
                    btnAnswerSubmit.disabled = textInput.value.trim() === '';
                });
                btnAnswerSubmit.disabled = true;
                
                // è‡ªå‹•èšç„¦
                setTimeout(() => textInput.focus(), 300);
            }

            // é¡¯ç¤º Modal
            answerModal.style.display = 'flex';
        }

        // æäº¤ç­”æ¡ˆ
        async function submitAnswer() {
            const task = window.currentTask;
            const btnAnswerSubmit = document.getElementById('btn-answer-submit');
            const answerMessage = document.getElementById('answer-message');
            const answerModal = document.getElementById('answer-modal');
            
            // ç²å–ç­”æ¡ˆ
            let answer = '';
            if (task.task_type === 'multiple_choice') {
                const selected = document.querySelector('.answer-choice.selected');
                if (!selected) {
                    answerMessage.textContent = 'âŒ è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆ';
                    answerMessage.style.color = '#fca5a5';
                    return;
                }
                answer = selected.dataset.value;
            } else if (task.task_type === 'photo') {
                const photoInput = document.getElementById('answer-photo-input');
                if (!photoInput.files[0]) {
                    answerMessage.textContent = 'âŒ è«‹ä¸Šå‚³ç…§ç‰‡';
                    answerMessage.style.color = '#fca5a5';
                    return;
                }
                // ä¸Šå‚³ç…§ç‰‡ä¸¦ç²å– URL
                const formData = new FormData();
                formData.append('photo', photoInput.files[0]);
                try {
                    btnAnswerSubmit.disabled = true;
                    answerMessage.textContent = 'ğŸ“¤ ä¸Šå‚³ç…§ç‰‡ä¸­...';
                    answerMessage.style.color = 'rgba(255,255,255,0.8)';
                    
                    const uploadRes = await fetch(`${API_BASE}/api/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadRes.json();
                    if (!uploadData.success) throw new Error('ä¸Šå‚³å¤±æ•—');
                    answer = uploadData.url;
                } catch (e) {
                    answerMessage.textContent = 'âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦';
                    answerMessage.style.color = '#fca5a5';
                    btnAnswerSubmit.disabled = false;
                    return;
                }
            } else {
                const textInput = document.getElementById('answer-text-input');
                answer = textInput.value.trim();
                if (!answer) {
                    answerMessage.textContent = 'âŒ è«‹è¼¸å…¥ç­”æ¡ˆ';
                    answerMessage.style.color = '#fca5a5';
                    return;
                }
            }

            // æäº¤ç­”æ¡ˆ
            try {
                btnAnswerSubmit.disabled = true;
                answerMessage.textContent = 'â³ é©—è­‰ä¸­...';
                answerMessage.style.color = 'rgba(255,255,255,0.8)';

                // ç²å– user_task_id
                if (!currentUserTaskId) await fetchCurrentUserTaskId();
                if (!currentUserTaskId) {
                    throw new Error('æ‰¾ä¸åˆ°ä»»å‹™è¨˜éŒ„');
                }

                const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer })
                });
                const data = await res.json();

                if (data.success && data.isCompleted) {
                    // ç­”å°äº†ï¼
                    answerModal.style.display = 'none';
                    showCompletionModal(data.earnedItemName, data.questChainCompleted, data.questChainReward);
                } else if (data.success && data.message && data.message.includes('å·²å®Œæˆ')) {
                    // ä»»å‹™å·²ç¶“å®Œæˆï¼ˆå¯èƒ½æ˜¯é‡è¤‡æäº¤ï¼‰
                    answerModal.style.display = 'none';
                    showToast('âœ… ä»»å‹™å·²å®Œæˆ', 2000);
                    // é‡æ–°è¼‰å…¥ä»»å‹™ç‹€æ…‹
                    if (taskId) {
                        setTimeout(() => {
                            window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                        }, 2000);
                    }
                } else {
                    // ç­”éŒ¯äº†
                    answerMessage.textContent = 'âŒ ' + (data.message || 'ç­”æ¡ˆéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                    answerMessage.style.color = '#fca5a5';
                    btnAnswerSubmit.disabled = false;
                }
            } catch (e) {
                console.error(e);
                answerMessage.textContent = 'âŒ é€£ç·šå¤±æ•—';
                answerMessage.style.color = '#fca5a5';
                btnAnswerSubmit.disabled = false;
            }
        }

        // é¡¯ç¤ºå®Œæˆä»»å‹™ Modal
        async function showCompletionModal(earnedItemName, questChainCompleted, questChainReward) {
            // è¨­ç½®é»˜èªå€¼ï¼Œé¿å… undefined éŒ¯èª¤
            questChainCompleted = questChainCompleted || false;
            questChainReward = questChainReward || null;
            
            const completionModal = document.getElementById('completion-modal');
            const completionReward = document.getElementById('completion-reward');
            const completionNextInfo = document.getElementById('completion-next-info');
            const completionNextName = document.getElementById('completion-next-name');
            const completionNextDistance = document.getElementById('completion-next-distance');
            const btnContinueQuest = document.getElementById('btn-continue-quest');
            const btnBackHome = document.getElementById('btn-back-home');

            // é˜²ç¦¦æ€§æª¢æŸ¥
            if (!completionModal) {
                console.error('completion-modal not found');
                return;
            }

            // é¡¯ç¤ºçå‹µ
            let rewardText = '';
            if (earnedItemName) {
                rewardText = `ğŸ ç²å¾—ï¼š${earnedItemName}`;
            }
            
            // é¡¯ç¤ºåŠ‡æƒ…å®Œæˆçå‹µ
            if (questChainCompleted && questChainReward) {
                if (rewardText) rewardText += '\n';
                if (questChainReward.chain_points > 0) {
                    rewardText += `\nğŸŠ åŠ‡æƒ…å®Œæˆçå‹µï¼š${questChainReward.chain_points} ç©åˆ†`;
                }
                if (questChainReward.badge_name) {
                    rewardText += `\nğŸ† ç²å¾—ç¨±è™Ÿï¼š${questChainReward.badge_name}`;
                }
            }
            
            if (rewardText) {
                completionReward.innerHTML = rewardText.split('\n').join('<br>');
                completionReward.style.display = 'block';
            } else {
                completionReward.style.display = 'none';
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€é—œ
            const task = window.currentTask;
            
            // å¦‚æœå®Œæˆäº†åŠ‡æƒ…ç·šï¼Œä¸é¡¯ç¤ºä¸‹ä¸€é—œé¸é …
            if (questChainCompleted) {
                completionNextInfo.style.display = 'none';
                btnContinueQuest.style.display = 'none';
            } else if (task && task.type === 'quest' && task.quest_chain_id && task.quest_order) {
                // å°‹æ‰¾ä¸‹ä¸€é—œ
                try {
                    const res = await fetch(`${API_BASE}/api/tasks`);
                    const data = await res.json();
                    if (data.success) {
                        const nextTask = data.tasks.find(t => 
                            t.quest_chain_id === task.quest_chain_id && 
                            t.quest_order === task.quest_order + 1 &&
                            t.type === 'quest' // ğŸ”¥ ä¿®æ­£ï¼šæ­£ç¢ºæ¬„ä½æ˜¯ type (single/quest)ï¼Œè€Œé task_type (qa/photo)
                        );
                        
                        if (nextTask) {
                            // æœ‰ä¸‹ä¸€é—œ
                            completionNextInfo.style.display = 'block';
                            btnContinueQuest.style.display = 'block';
                            completionNextName.textContent = nextTask.name;
                            
                            // è¨ˆç®—è·é›¢
                            if (userLat && userLng) {
                                const dist = haversineDistance(userLat, userLng, nextTask.lat, nextTask.lng);
                                completionNextDistance.textContent = `ğŸ“ è·é›¢ï¼šç´„ ${Math.round(dist)} å…¬å°º`;
                            } else {
                                completionNextDistance.textContent = '';
                            }
                            
                            btnContinueQuest.onclick = async () => {
                                // ğŸ”¥ é—œéµä¿®æ­£ï¼šåœ¨ä»»ä½• fetch ä¹‹å‰å…ˆè«‹æ±‚ç›¸æ©Ÿï¼Œä¿ç•™ User Gesture
                                // é€™èƒ½è§£æ±º iOS/Android ç€è¦½å™¨åœ¨ await fetch å¾Œç¦æ­¢å•Ÿå‹•ç›¸æ©Ÿçš„å•é¡Œ
                                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                                    try {
                                        console.log("ğŸ‘† ç”¨æˆ¶é»æ“Šç¹¼çºŒï¼Œé å…ˆç¢ºä¿ç›¸æ©Ÿæ¬Šé™...");
                                        const video = document.getElementById('camera-feed');
                                        // åªæœ‰åœ¨æ²’æœ‰æ´»èºæµçš„æ™‚å€™æ‰è«‹æ±‚
                                        if (!video.srcObject || !video.srcObject.active) {
                                            const stream = await navigator.mediaDevices.getUserMedia({ 
                                                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, 
                                                audio: false 
                                            });
                                            if (video) {
                                                video.srcObject = stream;
                                                video.play();
                                            }
                                        }
                                    } catch (e) {
                                        console.warn("é å…ˆè«‹æ±‚ç›¸æ©Ÿå¤±æ•—:", e);
                                    }
                                }

                                try {
                                    completionModal.style.display = 'none';
                                    const hasNext = await loadNextTask(task);
                                    if (!hasNext) {
                                        showToast('âš ï¸ ç„¡æ³•è¼‰å…¥ä¸‹ä¸€é—œ', 2000);
                                        // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œé‡æ–°é¡¯ç¤ºå®Œæˆç•«é¢
                                        setTimeout(() => {
                                            completionModal.style.display = 'flex';
                                        }, 2000);
                                    }
                                } catch (e) {
                                    console.error('è¼‰å…¥ä¸‹ä¸€é—œå¤±æ•—:', e);
                                    showToast('âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦', 2000);
                                    completionModal.style.display = 'flex';
                                }
                            };
                        } else {
                            // æ²’æœ‰ä¸‹ä¸€é—œï¼ˆåŠ‡æƒ…çµæŸï¼‰
                            completionNextInfo.style.display = 'none';
                            btnContinueQuest.style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.error(e);
                    completionNextInfo.style.display = 'none';
                    btnContinueQuest.style.display = 'none';
                }
            } else {
                // ä¸æ˜¯åŠ‡æƒ…ä»»å‹™ï¼Œä¸é¡¯ç¤ºä¸‹ä¸€é—œ
                completionNextInfo.style.display = 'none';
                btnContinueQuest.style.display = 'none';
            }

            btnBackHome.onclick = () => {
                window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
            };

            // é¡¯ç¤º Modal
            try {
                completionModal.style.display = 'flex';
                console.log('âœ… å®Œæˆç•«é¢å·²é¡¯ç¤º', { earnedItemName, questChainCompleted, questChainReward });
            } catch (e) {
                console.error('âŒ é¡¯ç¤ºå®Œæˆç•«é¢å¤±æ•—:', e);
                // å¦‚æœé¡¯ç¤ºå¤±æ•—ï¼Œè‡³å°‘é¡¯ç¤ºä¸€å€‹æç¤º
                showToast('âœ… ä»»å‹™å®Œæˆï¼', 3000);
            }
        }

        // ç¶å®šç­”é¡Œ Modal æŒ‰éˆ•
        document.getElementById('btn-answer-cancel').onclick = () => {
            document.getElementById('answer-modal').style.display = 'none';
        };
        document.getElementById('btn-answer-submit').onclick = submitAnswer;

        const btnLock = document.getElementById('btn-open-lock');
        btnLock.onclick = () => { if (!isNumberTask) return; if (!lockWheels.children.length) initLockWheels(lockDigits || 4); lockMsg.textContent = ''; lockOverlay.style.display = 'flex'; fetchCurrentUserTaskId(); };
        btnLockCancel.onclick = () => { lockOverlay.style.display = 'none'; lockMsg.textContent = ''; };
        btnLockSubmit.onclick = submitLockCode;
        lockOverlay.addEventListener('click', (e) => { if (e.target === lockOverlay) btnLockCancel.click(); });
        startBtn.onclick = async () => {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
                }
                startCamera();
                startOverlay.style.display = 'none';
                initSensors();
                showToast(is3DMode ? 'é€²å…¥ 3D AR æ¨¡å¼' : 'é€²å…¥ AR å°èˆªæ¨¡å¼');
            } catch (err) { alert('å•Ÿå‹•éŒ¯èª¤: ' + err.message); startOverlay.style.display = 'none'; }
        };
        function startCamera() {
            status.innerText = 'è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ä¸­...';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false })
            .then(stream => { 
                console.log("âœ… ç›¸æ©Ÿæ¬Šé™å·²å–å¾—");
                if (is3DMode) {
                    // é€™è£¡æ‰åˆ‡æ› UI
                    arWorld.style.display = 'none';
                    video.style.display = 'none';
                    aframeContainer.style.display = 'block';

                    stream.getTracks().forEach(track => track.stop());
                    status.innerText = 'å•Ÿå‹• 3D å¼•æ“...';
                    // ä½¿ç”¨ç¬¬ä¸€æ­¥çš„ 3D æ¨¡å‹ï¼ˆå¦‚æœç¬¬ä¸€æ­¥æ˜¯ 3Dï¼‰
                    const firstStep = arSteps.length > 0 && arSteps[0].type === '3d' ? arSteps[0] : null;
                    if (firstStep) {
                        init3DScene(firstStep.url, firstStep.scale);
                    } else if (window.currentTask && window.currentTask.ar_model_url) {
                        // å‘å¾Œå…¼å®¹ï¼šå¦‚æœæ²’æœ‰æ­¥é©Ÿè¨­å®šï¼Œä½¿ç”¨èˆŠé‚è¼¯
                        const scale = window.currentTask.ar_model_scale || 3.0;
                        init3DScene(window.currentTask.ar_model_url, scale);
                    } else { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 3D æ¨¡å‹è¨­å®š"); }
                    
                    // é¡¯ç¤ºæ—‹è½‰æ¨¡å¼æŒ‰éˆ•
                    const btnRotation = document.getElementById('btn-rotation-mode');
                    if (btnRotation) {
                        btnRotation.style.display = 'block';
                    }
                    
                    // AR å•Ÿå‹•å¾Œï¼Œå¦‚æœéŸ³æ¨‚å·²è¼‰å…¥ï¼Œè‡ªå‹•å˜—è©¦æ’­æ”¾ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰
                    if (bgmAudio.src && !bgmIsPlaying) {
                        setTimeout(() => {
                            bgmAudio.play().catch(err => {
                                // å¦‚æœè‡ªå‹•æ’­æ”¾å¤±æ•—ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤
                                console.log('éŸ³æ¨‚éœ€è¦ç”¨æˆ¶æ‰‹å‹•æ’­æ”¾');
                            });
                        }, 500);
                    }
                } else {
                    // éš±è—æ—‹è½‰æ¨¡å¼æŒ‰éˆ•ï¼ˆé 3D æ¨¡å¼ï¼‰
                    const btnRotation = document.getElementById('btn-rotation-mode');
                    if (btnRotation) {
                        btnRotation.style.display = 'none';
                    }
                    status.innerText = 'å•Ÿå‹•ç›¸æ©Ÿç•«é¢...';
                    video.srcObject = stream;
                    video.onloadedmetadata = () => { 
                        video.play();
                        // AR å•Ÿå‹•å¾Œï¼Œå¦‚æœéŸ³æ¨‚å·²è¼‰å…¥ï¼Œè‡ªå‹•å˜—è©¦æ’­æ”¾ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰
                        if (bgmAudio.src && !bgmIsPlaying) {
                            // å»¶é²ä¸€é»æ’­æ”¾ï¼Œç¢ºä¿ç”¨æˆ¶äº¤äº’å·²å®Œæˆ
                            setTimeout(() => {
                                bgmAudio.play().catch(err => {
                                    // å¦‚æœè‡ªå‹•æ’­æ”¾å¤±æ•—ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤
                                    console.log('éŸ³æ¨‚éœ€è¦ç”¨æˆ¶æ‰‹å‹•æ’­æ”¾');
                                });
                            }, 500);
                        }
                    };
                }
            })
            .catch(err => { 
                console.error("ç›¸æ©Ÿæ¬Šé™è«‹æ±‚å¤±æ•—:", err);
                status.innerText = "ç›¸æ©ŸéŒ¯èª¤: " + err.message; 
                if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') alert("âŒ æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ã€‚");
            });
        }
        function initSensors() {
            // ğŸ”¥ é—œéµä¿®æ­£ï¼šç„¡è«– 3D æˆ– 2D æ¨¡å¼ï¼Œéƒ½è¦å•Ÿå‹•å‚³æ„Ÿå™¨ç›£è½
            // é€™æ¨£åœ¨å¾ 3D åˆ‡æ›å› 2D æ™‚ï¼ŒupdateAR æ‰èƒ½æ­£å¸¸é‹ä½œ
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    pos => { userLat = pos.coords.latitude; userLng = pos.coords.longitude; updateAR(); },
                    err => { console.error("GPS Error:", err); },
                    { enableHighAccuracy: true, maximumAge: 1000, timeout: 20000 }
                );
            }
            window.addEventListener('deviceorientation', event => {
                let currentHeading = event.webkitCompassHeading || (360 - event.alpha);
                if (currentHeading === undefined || currentHeading === null) return;
                
                let diff = currentHeading - lastHeading;
                if (diff > 180) diff -= 360; if (diff < -180) diff += 360;
                lastHeading += diff * 0.15; deviceHeading = (lastHeading + 360) % 360;
                updateAR();
            }, true);
        }
        function updateAR() {
            if (!userLat || !targetLat) { status.innerText = `GPS å®šä½ä¸­...`; return; }
            
            // 1. ç„¡è«– 3D/2D æ¨¡å¼ï¼Œå§‹çµ‚æ›´æ–°é ‚éƒ¨æ•¸æ“š
            const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
            const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            status.innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
            
            let delta = bearing - deviceHeading;
            while (delta < -180) delta += 360; while (delta > 180) delta -= 360;
            debug.innerText = `æ–¹ä½:${bearing.toFixed(0)}Â° æ‰‹æ©Ÿ:${deviceHeading.toFixed(0)}Â° å·®:${delta.toFixed(0)}Â°`;
            
            // 2. å¦‚æœæ˜¯ 3D æ¨¡å¼ï¼Œåœæ­¢æ›´æ–° 2D DOM å…ƒç´ ï¼ˆå¯¶ç®±ã€ç®­é ­ç­‰ï¼‰ï¼Œé¿å…å¹²æ“¾ A-Frame
            if (is3DMode) return; 

            const VISIBLE_DISTANCE = 15; 
            if (dist > VISIBLE_DISTANCE) {
                if (isObjectVisible) { isObjectVisible = false; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; }
                arrow.style.display = 'block'; arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`;
                return; 
            }
            const fov = isObjectVisible ? 50 : 30; 
            if (Math.abs(delta) < fov) {
                if (!isObjectVisible) {
                    isObjectVisible = true; arrow.style.display = 'none';
                    
                    // åˆ°é”ä»»å‹™åœ°é»æ™‚ï¼Œè‡ªå‹•æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼ˆå¦‚æœä»»å‹™æœ‰é…ç½®ï¼‰
                    if (bgmAudio.src && !bgmIsPlaying) {
                        bgmAudio.play().catch(err => {
                            // å¦‚æœè‡ªå‹•æ’­æ”¾å¤±æ•—ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰ï¼Œéœé»˜è™•ç†
                            console.log('éŸ³æ¨‚è‡ªå‹•æ’­æ”¾éœ€è¦ç”¨æˆ¶äº¤äº’');
                        });
                    }
                    
                    if (isLocationTask) { locationObj.style.display = 'block'; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; }
                    else if (requiredItem) {
                        if (hasRequiredItem) { 
                            itemUseObj.style.display = 'block'; 
                            lockedObj.style.display = 'none'; 
                            chest.style.display = 'none'; 
                            locationObj.style.display = 'none';
                            
                            // æ›´æ–°é“å…·é¡¯ç¤º (2D/3D)
                            const itemImg = document.getElementById('item-use-image');
                            const itemModel = document.getElementById('item-use-model');
                            document.getElementById('item-use-name').textContent = requiredItem.name;
                            
                            if (requiredItem.model) {
                                itemImg.style.display = 'none';
                                itemModel.style.display = 'block';
                                itemModel.src = requiredItem.model;
                            } else {
                                itemModel.style.display = 'none';
                                itemImg.style.display = 'block';
                                itemImg.src = requiredItem.image || '/images/mascot.png';
                            }
                        }
                        else { lockedObj.style.display = 'block'; itemUseObj.style.display = 'none'; chest.style.display = 'none'; locationObj.style.display = 'none'; }
                    } else { lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; chest.style.display = 'block'; }
                }
                const screenWidth = window.innerWidth;
                const xOffset = (delta / 40) * (screenWidth / 2);
                let scale = 1.2 - (Math.min(dist, 50) / 60); if (scale < 0.4) scale = 0.4;
                const transformStyle = `translate(${xOffset}px, 0) scale(${scale})`;
                chest.style.transform = transformStyle; lockedObj.style.transform = transformStyle; itemUseObj.style.transform = transformStyle; locationObj.style.transform = transformStyle;
            } else {
                if (isObjectVisible) { isObjectVisible = false; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; arrow.style.display = 'block'; }
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`; 
            }
        }
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin((destLng-startLng) * Math.PI/180) * Math.cos(destLat * Math.PI/180);
            const x = Math.cos(startLat * Math.PI/180) * Math.sin(destLat * Math.PI/180) - Math.sin(startLat * Math.PI/180) * Math.cos(destLat * Math.PI/180) * Math.cos((destLng-startLng) * Math.PI/180);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
        function extractYouTubeId(url) {
            if (!url) return null;
            try {
                const match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
                return (match && match[7].length == 11) ? match[7] : null;
            } catch (e) {
                console.warn('YouTube URL è§£æå¤±æ•—:', url);
                return null;
            }
        }
    </script>
</body>
</html>