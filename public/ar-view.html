<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        #aframe-scene-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            display: none;
        }
        
        .a-enter-vr { display: none; }
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        /* Modal æ¨£å¼ä¿®æ­£ï¼šå…è¨±å…§éƒ¨æ²å‹• */
        #ar-modal .modal-content {
            background: rgba(30,30,30,0.95);
            border-radius: 16px;
            padding: 20px;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow-y: auto; /* é—œéµä¿®æ­£ï¼šè®“å…§å®¹å¤ªé•·æ™‚å¯ä»¥æ²å‹• */
        }
        /* å¯†ç¢¼é–æ¨£å¼ä¿®æ­£ */
        .wheel {
            width: 62px;
            background: #0b1220;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            touch-action: none; /* é—œéµä¿®æ­£ï¼šè§£æ±ºã€Œæ»‘ä¸å‹•ã€çš„å•é¡Œï¼Œç¦æ­¢ç€è¦½å™¨æ””æˆªæ»‘å‹• */
        }
        /* å…¶ä»–åŸæœ‰æ¨£å¼ä¿ç•™ */
        #start-sensor-btn {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            padding: 15px 30px;
            background: #28a745;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: none;
        }
        .info-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; text-align: center; pointer-events: auto;
        }
        #toast-message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85); color: white; padding: 20px 30px;
            border-radius: 16px; text-align: center; z-index: 5000; display: none;
            pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            font-size: 16px; font-weight: bold; max-width: 80%;
            animation: toastFadeIn 0.3s ease-out;
        }
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .btn-back {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #007bff; color: white; padding: 12px 30px;
            border: none; border-radius: 50px; font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; z-index: 20;
        }
        #ar-world {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; perspective: 800px; pointer-events: none; overflow: hidden;
        }
        #locked-obj, #item-use-obj, #location-obj, #chest-obj {
            position: absolute; top: 50%; left: 50%; display: none; cursor: pointer; pointer-events: auto;
        }
        
        #locked-obj { width: 200px; height: 200px; margin-left: -100px; margin-top: -100px; text-align: center; color: white; animation: float 3s infinite; }
        #locked-icon { font-size: 100px; text-shadow: 0 0 20px rgba(255, 255, 0, 0.8); }
        #locked-text { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 10px; margin-top: 10px; font-weight: bold; }
        #ar-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 20px;
        }
        #ar-modal img, #ar-modal iframe { max-width: 100%; max-height: 50vh; border-radius: 8px; }
        #ar-modal .modal-actions { display: flex; gap: 15px; width: 100%; justify-content: center; }
        #ar-modal button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-close { background: #6c757d; color: white; }
        .btn-reply { background: #28a745; color: white; }
        #btn-open-lock {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: #111827; color: white; padding: 12px 22px;
            border: 1px solid rgba(255,255,255,0.2); border-radius: 999px;
            font-size: 15px; font-weight: 800; pointer-events: auto; cursor: pointer; z-index: 2100; display: none;
        }
        #lock-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.86); display: none;
            z-index: 3500; pointer-events: auto; align-items: center; justify-content: center; padding: 18px;
        }
        .lock-card { width: min(520px, 92vw); background: rgba(20,20,20,0.96); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 18px; color: white; }
        .wheels { display: flex; gap: 10px; justify-content: center; align-items: center; margin: 12px 0 16px; flex-wrap: wrap; }
        .wheel .btn-up, .wheel .btn-down { width: 100%; border: none; background: rgba(255,255,255,0.08); color: white; border-radius: 8px; padding: 8px 0; font-weight: 900; cursor: pointer; }
        .wheel .digit { font-size: 28px; font-weight: 900; margin: 10px 0; letter-spacing: 1px; background: rgba(255,255,255,0.06); border-radius: 10px; padding: 10px 0; border: 1px solid rgba(255,255,255,0.08); }
        .lock-actions { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
        .lock-actions button { border: none; border-radius: 10px; padding: 12px 16px; font-size: 15px; font-weight: 900; cursor: pointer; }
        #btn-lock-cancel { background: #6c757d; color: #fff; }
        #btn-lock-submit { background: #2563eb; color: #fff; }
        #lock-msg { text-align: center; margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.8); min-height: 18px; }
        /* å¯¶ç®±/é“å…·ç­‰ 3D Transform ç›¸é—œ */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        #guide-arrow { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; margin-left: -30px; margin-top: -30px; display: none; }
        #guide-arrow::after { content: ''; display: block; width: 100%; height: 100%; border-top: 10px solid #ff3b30; border-right: 10px solid #ff3b30; transform: rotate(45deg); box-shadow: 2px -2px 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <video id="camera-feed" autoplay playsinline muted></video>
    <div id="aframe-scene-container"></div>
    <div id="ar-world">
        <div id="locked-obj"><div id="locked-icon">â“</div><div id="locked-text">é»æ“ŠæŸ¥çœ‹ç·šç´¢</div></div>
        <div id="item-use-obj" style="display:none; width: 250px; margin-left: -125px; margin-top: -150px; text-align: center;">
            <div style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.8);">
                <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">ğŸ’ ä½¿ç”¨é“å…·</div>
                <div id="item-use-media-container" style="width:150px; height:150px; margin: 0 auto 10px auto; position: relative;">
                    <img id="item-use-image" src="" alt="é“å…·åœ–ç‰‡" style="width:100%; height:100%; object-fit:contain; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.5); cursor:pointer;" />
                    <model-viewer id="item-use-model" src="" style="width:100%; height:100%; display:none; border-radius:12px;" auto-rotate camera-controls disable-zoom></model-viewer>
                </div>
                <div id="item-use-name" style="font-size:16px; font-weight:bold; margin-bottom:8px;"></div>
                <div style="font-size:14px; color:#ffeb3b;">é»æ“Šé“å…·ä½¿ç”¨</div>
            </div>
        </div>
        <div id="location-obj"><div id="location-icon">ğŸ“</div><div id="location-label">é»æ“Šæ‰“å¡</div></div>
        <div id="chest-obj" style="width: 350px; margin-left: -175px; margin-top: -100px;">
            <div class="ar-content-row" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                <img id="chest-img" src="/images/mascot.png" alt="AR åœ–ç‰‡" style="display:none; width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); animation: float 3s ease-in-out infinite;">
                <div id="video-frame" style="display:none; width: 240px; height: 160px; background: #000; border: 12px solid #222; border-bottom-width: 25px; border-radius: 8px;">
                    <iframe id="yt-player" src="" allow="autoplay; encrypted-media" allowfullscreen style="width:100%; height:100%; border:none;"></iframe>
                </div>
            </div>
            <div id="tap-hint" style="color:white; text-align:center; text-shadow:0 2px 2px black; font-weight:bold; margin-top:10px;">é»æ“ŠæŸ¥çœ‹è©³æƒ…</div>
        </div>
        <div id="guide-arrow"></div>
    </div>
    <div id="ar-modal"><div class="modal-content"><div id="modal-body" style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%;"></div><div class="modal-actions"><button class="btn-close" id="modal-close">é—œé–‰</button><button class="btn-reply" id="modal-submit">âœï¸ é»æ“Šå›è¦†å•é¡Œ</button></div></div></div>
    <div id="lock-overlay"><div class="lock-card"><div class="lock-title">ğŸ”’ æ—‹è½‰å¯†ç¢¼é–</div><div class="lock-subtitle">è½‰å‹•æ•¸å­—è¼ªç›¤å¾ŒæŒ‰ã€Œç¢ºå®šè§£é–ã€ã€‚<br>æé†’ï¼šéœ€è¦å®Œå…¨æ­£ç¢ºï¼Œæ‰èƒ½é€šé—œã€‚</div><div class="wheels" id="lock-wheels"></div><div class="lock-actions"><button id="btn-lock-cancel" type="button">é—œé–‰</button><button id="btn-lock-submit" type="button">ç¢ºå®šè§£é–</button></div><div id="lock-msg"></div></div></div>
    <div class="ui-layer">
        <div id="start-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; pointer-events:auto;">
            <div style="font-size:1.5rem; font-weight:bold; margin-bottom:20px; text-align:center;">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
            <div style="margin-bottom:30px; color:#ccc; text-align:center; max-width:80%;">éœ€è¦æ‚¨çš„ç›¸æ©Ÿèˆ‡æ–¹å‘æ„Ÿæ¸¬å™¨æ¬Šé™<br>ä»¥é€²è¡Œ AR å°èˆª</div>
            <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#007bff; color:white; border:none; border-radius:50px; font-weight:bold; box-shadow:0 0 20px rgba(0,123,255,0.5);">ğŸš€ é–‹å§‹æœå°‹</button>
        </div>
        <div class="info-box"><div id="status">ç­‰å¾…å•Ÿå‹•...</div><div id="debug-info" style="font-size:0.8em; color:#ffeb3b; margin-top:5px;"></div></div>
        <button id="btn-back" class="btn-back">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
        <button id="btn-open-lock" type="button">ğŸ”’ è¼¸å…¥å¯†ç¢¼</button>
        <button id="btn-rotation-mode" type="button" style="position:fixed; bottom:90px; right:20px; background:#28a745; color:white; padding:12px 20px; border:none; border-radius:50px; font-size:14px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.3); pointer-events:auto; cursor:pointer; z-index:20; display:none;">ğŸ”„ æ—‹è½‰æ¨¡å¼</button>
    </div>
    <div id="toast-message"></div>
    <script>
        const API_BASE = ''; 
        const video = document.getElementById('camera-feed');
        const aframeContainer = document.getElementById('aframe-scene-container');
        const arWorld = document.getElementById('ar-world');
        const debug = document.getElementById('debug-info');
        const status = document.getElementById('status');
        
        let is3DMode = false;
        let gpsLocked = false;
        window.rotationMode = false; // æ—‹è½‰æ¨¡å¼é–‹é—œï¼ˆå…¨å±€è®Šé‡ï¼Œä¾›çµ„ä»¶ä½¿ç”¨ï¼‰
        
        // === è‡ªå®šç¾©æ—‹è½‰æ§åˆ¶çµ„ä»¶ ===
        AFRAME.registerComponent('rotation-control', {
            init: function() {
                this.isDragging = false;
                this.lastTouchX = 0;
                this.lastTouchY = 0;
                this.rotationX = 0;
                this.rotationY = 0;
                
                // è§¸æ‘¸é–‹å§‹
                this.onTouchStart = (e) => {
                    if (!window.rotationMode) return;
                    this.isDragging = true;
                    const touch = e.touches ? e.touches[0] : e;
                    this.lastTouchX = touch.clientX || touch.pageX;
                    this.lastTouchY = touch.clientY || touch.pageY;
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                // è§¸æ‘¸ç§»å‹•
                this.onTouchMove = (e) => {
                    if (!this.isDragging || !window.rotationMode) return;
                    const touch = e.touches ? e.touches[0] : e;
                    const currentX = touch.clientX || touch.pageX;
                    const currentY = touch.clientY || touch.pageY;
                    const deltaX = currentX - this.lastTouchX;
                    const deltaY = currentY - this.lastTouchY;
                    
                    // æ—‹è½‰æ¨¡å‹
                    this.rotationY += deltaX * 0.5; // æ°´å¹³æ—‹è½‰
                    this.rotationX -= deltaY * 0.5; // å‚ç›´æ—‹è½‰
                    this.rotationX = Math.max(-90, Math.min(90, this.rotationX)); // é™åˆ¶å‚ç›´è§’åº¦
                    
                    this.el.setAttribute('rotation', `${this.rotationX} ${this.rotationY} 0`);
                    
                    this.lastTouchX = currentX;
                    this.lastTouchY = currentY;
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                // è§¸æ‘¸çµæŸ
                this.onTouchEnd = (e) => {
                    this.isDragging = false;
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                // ç¶å®šäº‹ä»¶åˆ°å ´æ™¯å®¹å™¨ï¼ˆç¢ºä¿èƒ½æ•ç²æ‰€æœ‰è§¸æ‘¸äº‹ä»¶ï¼‰
                const scene = this.el.sceneEl;
                if (scene) {
                    scene.addEventListener('mousedown', this.onTouchStart);
                    scene.addEventListener('touchstart', this.onTouchStart, { passive: false });
                    scene.addEventListener('mousemove', this.onTouchMove);
                    scene.addEventListener('touchmove', this.onTouchMove, { passive: false });
                    scene.addEventListener('mouseup', this.onTouchEnd);
                    scene.addEventListener('touchend', this.onTouchEnd);
                }
            },
            remove: function() {
                const scene = this.el.sceneEl;
                if (scene) {
                    scene.removeEventListener('mousedown', this.onTouchStart);
                    scene.removeEventListener('touchstart', this.onTouchStart);
                    scene.removeEventListener('mousemove', this.onTouchMove);
                    scene.removeEventListener('touchmove', this.onTouchMove);
                    scene.removeEventListener('mouseup', this.onTouchEnd);
                    scene.removeEventListener('touchend', this.onTouchEnd);
                }
            }
        });
        
        // === å‹•æ…‹å»ºç«‹ 3D å ´æ™¯ ===
        function init3DScene(modelUrl, scale = 1) {
            const container = document.getElementById('aframe-scene-container');
            
            // ä¿®æ­£ 1: å¢åŠ  cursor="rayOrigin: mouse" è®“æ‰‹æŒ‡é»æ“Šæœ‰æ•ˆ
            // ä¿®æ­£ 2: é»æ“Šå€ ar-model-click-zone è¨­ç‚ºé€æ˜ä½† visibleï¼Œå¦å‰‡ç„¡æ³•é»æ“Š
            container.innerHTML = `
                <a-scene 
                    vr-mode-ui="enabled: false"
                    embedded
                    arjs='sourceType: webcam; debugUIEnabled: false;'
                    renderer="logarithmicDepthBuffer: true; colorManagement: true; alpha: true;"
                    cursor="rayOrigin: mouse">
                    
                    <a-camera gps-camera="minDistance: 0; maxDistance: 2000;" rotation-reader></a-camera>
                    <a-assets>
                        <a-asset-item id="animated-model-asset" src="${modelUrl}"></a-asset-item>
                    </a-assets>
                    
                    <a-entity 
                        id="ar-model-entity"
                        gps-entity-place=""
                        visible="false"
                        rotation-control
                        cursor-listener>
                        
                        <!-- 3D Model -->
                        <a-entity 
                            id="ar-model-inner"
                            gltf-model="#animated-model-asset"
                            animation-mixer
                            scale="${scale} ${scale} ${scale}" 
                            position="0 0 0">
                        </a-entity>

                        <!-- Label to help finding the object -->
                        <a-text 
                            id="ar-model-label"
                            value="ğŸ”» HERE ğŸ”»" 
                            align="center" 
                            color="#FFFF00" 
                            position="0 ${scale * 1.5 + 1} 0" 
                            scale="5 5 5"
                            look-at="[gps-camera]">
                        </a-text>
                        
                        <!-- Hint: Click to view -->
                        <a-text 
                            id="ar-model-hint"
                            value="é»æ“ŠæŸ¥çœ‹è©³æƒ…" 
                            align="center" 
                            color="#FFFFFF" 
                            position="0 ${scale * 1.5 + 2.5} 0" 
                            scale="3 3 3"
                            look-at="[gps-camera]"
                            background-color="rgba(0,0,0,0.6)">
                        </a-text>
                    </a-entity>
                    
                    <!-- Click Zone -->
                    <a-box 
                        id="ar-model-click-zone" 
                        visible="false" 
                        material="opacity: 0.1; transparent: true; color: yellow;"
                        position="0 1 0" 
                        scale="2 2 2"
                        gps-entity-place="">
                    </a-box>
                </a-scene>
            `;
            setTimeout(() => {
                const modelEntity = document.querySelector('#ar-model-entity');
                const clickZone = document.querySelector('#ar-model-click-zone');
                
                const clickHandler = () => {
                    console.log("3D Model Clicked!");
                    if(window.currentTask) {
                        // å¦‚æœç•¶å‰æ­¥é©Ÿæ˜¯ 3D æ¨¡å‹ï¼Œç›´æ¥é¡¯ç¤ºå¯äº’å‹•æª¢è¦–
                        const currentStep = arSteps.length > 0 && currentArStep < arSteps.length ? arSteps[currentArStep] : null;
                        if (currentStep && currentStep.type === '3d') {
                            // ç›´æ¥é¡¯ç¤ºç•¶å‰æ­¥é©Ÿï¼ˆæœƒåŒ…å«å¯äº’å‹•çš„ model-viewerï¼‰
                            showArModal(window.currentTask);
                        } else {
                            // å¦å‰‡é¡¯ç¤ºå®Œæ•´çš„æ­¥é©Ÿæµç¨‹
                            showArModal(window.currentTask);
                        }
                    }
                };
                // ç¶å®šé»æ“Šäº‹ä»¶
                if(modelEntity) {
                    modelEntity.addEventListener('click', clickHandler);
                    // å‚™ç”¨ï¼šå¦‚æœæœ‰é»ä¸åˆ°æ¨¡å‹çš„æƒ…æ³ï¼Œé»æ“Šé€æ˜ç›’å­ä¹Ÿå¯ä»¥
                    if(clickZone) clickZone.addEventListener('click', clickHandler);
                }
                
                // ç¶å®š GPS é–å®šäº‹ä»¶
                window.addEventListener('gps-camera-update-position', (e) => {
                    // æŒçºŒæ›´æ–°è·é›¢èˆ‡æ–¹ä½è³‡è¨Š (ç„¡è«–æ˜¯å¦é–å®š)
                    userLat = e.detail.position.latitude;
                    userLng = e.detail.position.longitude;
                    
                    if (targetLat && targetLng) {
                        const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
                        const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
                        document.getElementById('status').innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m (GPSç²¾åº¦: ${e.detail.position.accuracy?.toFixed(0)}m)`;
                        document.getElementById('debug-info').innerText = `ç›®æ¨™æ–¹ä½: ${bearing.toFixed(0)}Â°`;
                    }

                    if (!gpsLocked && !window.rotationMode) {
                        if(modelEntity && targetLat && targetLng) {
                            modelEntity.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            modelEntity.setAttribute('visible', 'true');
                            
                            // è®“é»æ“Šå€ä¹Ÿè·Ÿè‘—ç§»å‹•
                            if(clickZone) {
                                clickZone.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                                clickZone.setAttribute('visible', 'true'); 
                            }
                            console.log(`ğŸ“ æ¨¡å‹å·²æ”¾ç½®æ–¼ ${targetLat}, ${targetLng}`);
                        }
                        gpsLocked = true;
                    }
                });
                
                // åˆå§‹åŒ–æ—‹è½‰æ¨¡å¼åˆ‡æ›
                window.toggleRotationMode = function() {
                    // æª¢æŸ¥æ¨¡å‹æ˜¯å¦å·²åˆå§‹åŒ–
                    if (!modelEntity || !modelEntity.getAttribute('visible')) {
                        showToast('â³ è«‹ç­‰å¾…æ¨¡å‹è¼‰å…¥å®Œæˆ', 2000);
                        return;
                    }
                    
                    window.rotationMode = !window.rotationMode;
                    const btn = document.getElementById('btn-rotation-mode');
                    const label = document.querySelector('#ar-model-label');
                    const hint = document.querySelector('#ar-model-hint');
                    
                    if (window.rotationMode) {
                        // åˆ‡æ›åˆ°æ—‹è½‰æ¨¡å¼ï¼šå›ºå®šåœ¨ç›¸æ©Ÿå‰æ–¹
                        if (modelEntity) {
                            // å…ˆç¢ºä¿æ¨¡å‹å¯è¦‹
                            modelEntity.setAttribute('visible', 'true');
                            
                            // ç§»é™¤ GPS ç›¸é—œå±¬æ€§
                            modelEntity.removeAttribute('gps-entity-place');
                            modelEntity.removeAttribute('look-at');
                            
                            // å°‡æ¨¡å‹ä½œç‚ºç›¸æ©Ÿçš„å­å…ƒç´ ï¼Œå›ºå®šåœ¨ç›¸æ©Ÿå‰æ–¹
                            const camera = document.querySelector('a-camera');
                            if (camera) {
                                // å…ˆå°‡æ¨¡å‹å¾å ´æ™¯ç§»é™¤ï¼ˆå¦‚æœå·²ç¶“åœ¨å ´æ™¯ä¸­ï¼‰
                                const scene = document.querySelector('a-scene');
                                if (scene && modelEntity.parentNode === scene) {
                                    scene.removeChild(modelEntity);
                                }
                                
                                // è¨­ç½®ç›¸å°æ–¼ç›¸æ©Ÿçš„ä½ç½®ï¼ˆç›¸æ©Ÿåæ¨™ç³»ï¼šY å‘ä¸Šï¼ŒZ å‘å‰ï¼‰
                                modelEntity.setAttribute('position', '0 0 -2');
                                modelEntity.setAttribute('rotation', '0 0 0'); // é‡ç½®æ—‹è½‰
                                
                                // å°‡æ¨¡å‹é™„åŠ åˆ°ç›¸æ©Ÿ
                                camera.appendChild(modelEntity);
                                
                                // ç¢ºä¿å…§éƒ¨æ¨¡å‹å¯è¦‹
                                if (innerModel) {
                                    innerModel.setAttribute('visible', 'true');
                                }
                                
                                // å¼·åˆ¶æ›´æ–°
                                setTimeout(() => {
                                    modelEntity.setAttribute('visible', 'true');
                                    if (innerModel) innerModel.setAttribute('visible', 'true');
                                    console.log('âœ… æ¨¡å‹å·²åˆ‡æ›åˆ°æ—‹è½‰æ¨¡å¼');
                                }, 100);
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°ç›¸æ©Ÿï¼Œä½¿ç”¨å ´æ™¯åæ¨™
                                modelEntity.setAttribute('position', '0 1.6 -2');
                                modelEntity.setAttribute('rotation', '0 0 0');
                            }
                        }
                        if (clickZone) {
                            clickZone.setAttribute('visible', 'true');
                            clickZone.removeAttribute('gps-entity-place');
                            const camera = document.querySelector('a-camera');
                            if (camera) {
                                const scene = document.querySelector('a-scene');
                                if (scene && clickZone.parentNode === scene) {
                                    scene.removeChild(clickZone);
                                }
                                clickZone.setAttribute('position', '0 0 -2');
                                camera.appendChild(clickZone);
                            }
                        }
                        if (label) {
                            // åœ¨æ—‹è½‰æ¨¡å¼ä¸‹ï¼Œæ¨™ç±¤æ‡‰è©²é¢å‘ç›¸æ©Ÿï¼ˆä½†ä½¿ç”¨ç›¸æ©Ÿå¼•ç”¨è€Œä¸æ˜¯ gps-cameraï¼‰
                            label.setAttribute('look-at', '[camera]');
                            label.setAttribute('value', 'ğŸ”„ æ‹–å‹•æ—‹è½‰');
                            label.setAttribute('visible', 'true');
                        }
                        if (hint) {
                            hint.setAttribute('look-at', '[camera]');
                            hint.setAttribute('value', 'æ—‹è½‰æ¨¡å¼ï¼šå¯æ‹–å‹•æŸ¥çœ‹');
                            hint.setAttribute('visible', 'true');
                        }
                        if (btn) btn.textContent = 'ğŸ“ GPS æ¨¡å¼';
                        if (btn) btn.style.background = '#ffc107';
                        showToast('ğŸ”„ å·²åˆ‡æ›åˆ°æ—‹è½‰æ¨¡å¼ï¼Œå¯æ‹–å‹•æŸ¥çœ‹æ¨¡å‹', 2000);
                    } else {
                        // åˆ‡æ›å› GPS æ¨¡å¼
                        const scene = document.querySelector('a-scene');
                        if (modelEntity && targetLat && targetLng && scene) {
                            // å°‡æ¨¡å‹å¾ç›¸æ©Ÿç§»é™¤ï¼Œæ”¾å›å ´æ™¯
                            const camera = document.querySelector('a-camera');
                            if (camera && modelEntity.parentNode === camera) {
                                camera.removeChild(modelEntity);
                            }
                            
                            // ç¢ºä¿æ¨¡å‹åœ¨å ´æ™¯ä¸­
                            if (modelEntity.parentNode !== scene) {
                                scene.appendChild(modelEntity);
                            }
                            
                            // ç§»é™¤å›ºå®šä½ç½®ï¼Œæ¢å¾© GPS å®šä½
                            modelEntity.removeAttribute('position');
                            modelEntity.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            modelEntity.setAttribute('look-at', '[gps-camera]');
                            modelEntity.setAttribute('rotation', '0 0 0'); // é‡ç½®æ—‹è½‰
                            modelEntity.setAttribute('visible', 'true');
                            
                            // ç¢ºä¿å…§éƒ¨æ¨¡å‹å¯è¦‹
                            const innerModel = document.querySelector('#ar-model-inner');
                            if (innerModel) {
                                innerModel.setAttribute('visible', 'true');
                            }
                            
                            // å¼·åˆ¶æ›´æ–°
                            setTimeout(() => {
                                modelEntity.setAttribute('visible', 'true');
                                if (innerModel) innerModel.setAttribute('visible', 'true');
                                console.log('âœ… æ¨¡å‹å·²åˆ‡æ›å› GPS æ¨¡å¼');
                            }, 100);
                        }
                        if (clickZone && targetLat && targetLng && scene) {
                            const camera = document.querySelector('a-camera');
                            if (camera && clickZone.parentNode === camera) {
                                camera.removeChild(clickZone);
                            }
                            if (clickZone.parentNode !== scene) {
                                scene.appendChild(clickZone);
                            }
                            clickZone.removeAttribute('position');
                            clickZone.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            clickZone.setAttribute('visible', 'true');
                        }
                        if (label) {
                            label.setAttribute('look-at', '[gps-camera]');
                            label.setAttribute('value', 'ğŸ”» HERE ğŸ”»');
                            label.setAttribute('visible', 'true');
                        }
                        if (hint) {
                            hint.setAttribute('look-at', '[gps-camera]');
                            hint.setAttribute('value', 'é»æ“ŠæŸ¥çœ‹è©³æƒ…');
                            hint.setAttribute('visible', 'true');
                        }
                        if (btn) btn.textContent = 'ğŸ”„ æ—‹è½‰æ¨¡å¼';
                        if (btn) btn.style.background = '#28a745';
                        showToast('ğŸ“ å·²åˆ‡æ›åˆ° GPS æ¨¡å¼', 2000);
                    }
                };
                
                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                const btnRotation = document.getElementById('btn-rotation-mode');
                if (btnRotation) {
                    btnRotation.onclick = window.toggleRotationMode;
                    btnRotation.style.display = 'block';
                }
            }, 100); 
        }
        // 2. å–å¾—ä»»å‹™è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        let targetLat = parseFloat(urlParams.get('lat'));
        let targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');
        
        let currentTask = null;
        let isNumberTask = false;
        let isLocationTask = false;
        let lockDigits = 4;
        let currentUserTaskId = null;
        let requiredItem = null;
        let hasRequiredItem = false;
        let arSteps = []; // å¤šæ­¥é©Ÿ AR æç¤ºé™£åˆ—
        let currentArStep = 0; // ç•¶å‰æ­¥é©Ÿç´¢å¼•
        if (taskId) {
            fetch(`${API_BASE}/api/tasks/${taskId}`)
                .then(res => res.json())
                .then(async data => {
                    if (data.success && data.task) {
                        const task = data.task;
                        currentTask = task;
                        window.currentTask = task;
                        
                        // è§£æ AR å¤šæ­¥é©Ÿé †åº
                        arSteps = [];
                        const steps = [];
                        if (task.ar_order_model && task.ar_model_url) {
                            steps.push({ type: '3d', order: task.ar_order_model, url: task.ar_model_url, scale: task.ar_model_scale || 3.0 });
                        }
                        if (task.ar_order_image && task.ar_image_url) {
                            steps.push({ type: 'image', order: task.ar_order_image, url: task.ar_image_url });
                        }
                        if (task.ar_order_youtube && task.youtubeUrl) {
                            steps.push({ type: 'youtube', order: task.ar_order_youtube, url: task.youtubeUrl });
                        }
                        arSteps = steps.sort((a, b) => a.order - b.order);
                        currentArStep = 0;
                        console.log('ğŸ“‹ AR æ­¥é©Ÿ:', arSteps);
                        
                        // åˆ¤æ–·æ˜¯å¦ä½¿ç”¨ 3D æ¨¡å¼ï¼ˆç¬¬ä¸€æ­¥æ˜¯ 3D æ¨¡å‹ï¼‰
                        const firstStep = arSteps.length > 0 && arSteps[0].type === '3d';
                        if (firstStep) {
                            is3DMode = true;
                            console.log('ğŸš€ åµæ¸¬åˆ° 3D ä»»å‹™ï¼Œæº–å‚™é€²å…¥ 3D æ¨¡å¼');
                        } else {
                            console.log('ğŸ–¼ï¸ ä½¿ç”¨ CSS AR æ¨¡å¼');
                            is3DMode = false;
                            aframeContainer.innerHTML = ''; 
                            aframeContainer.style.display = 'none';
                            arWorld.style.display = 'block';
                            video.style.display = 'block';
                            setupCssArContent(task);
                        }
                        if (task.required_item_id) {
                            requiredItem = { 
                                id: task.required_item_id, 
                                name: task.required_item_name, 
                                image: task.required_item_image,
                                model: task.required_item_model // æ–°å¢
                            };
                            const loginUser = getLoginUser();
                            if (loginUser) {
                                try {
                                    const invRes = await fetch(`${API_BASE}/api/user/inventory`, { headers: { 'x-username': loginUser.username } });
                                    const invData = await invRes.json();
                                    if (invData.success) hasRequiredItem = invData.inventory.some(i => i.item_id === task.required_item_id);
                                } catch (e) { console.error(e); }
                            }
                        }
                        isNumberTask = (task.task_type === 'number');
                        isLocationTask = (task.task_type === 'location');
                        if (isLocationTask) fetchCurrentUserTaskId();
                        if (typeof task.correct_answer === 'string') {
                            const len = task.correct_answer.trim().length;
                            if (len >= 2 && len <= 8) lockDigits = len;
                        }
                        
                        if (task.lat && task.lng) { targetLat = task.lat; targetLng = task.lng; }
                        
                        const btnOpenLock = document.getElementById('btn-open-lock');
                        if (isNumberTask) {
                            btnOpenLock.style.display = 'block';
                            initLockWheels(lockDigits);
                            fetchCurrentUserTaskId();
                        } else {
                            btnOpenLock.style.display = 'none';
                        }
                    }
                })
                .catch(err => { console.error("ç„¡æ³•è¼‰å…¥ä»»å‹™:", err); showToast("è¼‰å…¥ä»»å‹™å¤±æ•—"); });
        }
        function setupCssArContent(task) {
            const chestObj = document.getElementById('chest-obj');
            const chestImg = document.getElementById('chest-img');
            const videoFrame = document.getElementById('video-frame');
            
            // åªé¡¯ç¤ºç¬¬ä¸€æ­¥ï¼ˆå¦‚æœç¬¬ä¸€æ­¥ä¸æ˜¯ 3D æ¨¡å‹ï¼‰
            const firstStep = arSteps.length > 0 ? arSteps[0] : null;
            let hasImage = false, hasVideo = false;
            
            if (firstStep && firstStep.type !== '3d') {
                if (firstStep.type === 'image') {
                    chestImg.src = firstStep.url;
                    chestImg.style.display = 'block';
                    hasImage = true;
                } else if (firstStep.type === 'youtube') {
                    const ytId = extractYouTubeId(firstStep.url);
                    if (ytId) {
                        videoFrame.style.display = 'block';
                        document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        hasVideo = true;
                    }
                }
            } else if (!firstStep) {
                // æ²’æœ‰æ­¥é©Ÿè¨­å®šï¼Œä½¿ç”¨èˆŠé‚è¼¯ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                if (task.ar_image_url) { chestImg.src = task.ar_image_url; chestImg.style.display = 'block'; hasImage = true; }
                if (task.youtubeUrl) {
                    const ytId = extractYouTubeId(task.youtubeUrl);
                    if (ytId) {
                        videoFrame.style.display = 'block';
                        document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        hasVideo = true;
                    }
                }
                if (!hasImage && !hasVideo) { chestImg.src = '/images/mascot.png'; chestImg.style.display = 'block'; hasImage = true; }
            }
            
            if (hasImage && hasVideo) chestObj.className = 'has-both';
            else if (hasImage) chestObj.className = 'only-image';
            else if (hasVideo) chestObj.className = 'only-video';
            else { chestObj.style.display = 'none'; }
        }
        function showArModal(task) {
            const modalBody = document.getElementById('modal-body');
            const arModal = document.getElementById('ar-modal');
            const modalSubmitBtn = document.getElementById('modal-submit');
            
            // 1. æª¢æŸ¥æ˜¯å¦éœ€è¦é“å…·ä¸”å°šæœªè§£é–
            if (requiredItem) {
                if (!hasRequiredItem) { 
                    showToast(`ğŸ”’ éœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘`, 3000); 
                    return; 
                }
                
                // æœ‰é“å…·ï¼Œé¡¯ç¤ºã€Œä½¿ç”¨é“å…·ã€ç¢ºèªè¦–çª—
                modalBody.innerHTML = '';
                
                const title = document.createElement('div');
                title.innerHTML = `<div style="font-size:1.2rem; font-weight:bold; color:white; margin-bottom:10px;">ğŸ’ ä½¿ç”¨é“å…·è§£é–</div>`;
                modalBody.appendChild(title);

                if (requiredItem.model) {
                     const mv = document.createElement('model-viewer');
                     mv.src = requiredItem.model;
                     mv.style.width = '100%';
                     mv.style.height = '400px';
                     mv.style.backgroundColor = 'rgba(0,0,0,0.2)';
                     mv.style.borderRadius = '8px';
                     mv.setAttribute('auto-rotate', '');
                     mv.setAttribute('camera-controls', '');
                     mv.setAttribute('disable-zoom', 'false'); // å…è¨±ç¸®æ”¾
                     mv.setAttribute('shadow-intensity', '1');
                     modalBody.appendChild(mv);
                } else {
                     const img = document.createElement('img');
                     img.src = requiredItem.image || '/images/mascot.png';
                     modalBody.appendChild(img);
                }
                
                const name = document.createElement('div');
                name.innerHTML = `<div style="font-size:1rem; color:#ffeb3b; margin-top:10px;">${requiredItem.name}</div>`;
                modalBody.appendChild(name);

                modalSubmitBtn.textContent = 'âœ¨ ç¢ºèªä½¿ç”¨';
                modalSubmitBtn.onclick = () => {
                     showToast(`ğŸ’ ä½¿ç”¨äº†ã€${requiredItem.name}ã€‘ï¼`, 2000);
                     requiredItem = null; // æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
                     currentArStep = 0; // é‡ç½®æ­¥é©Ÿ
                     showArModal(task); // é‡æ–°å‘¼å«ä»¥é¡¯ç¤ºç¬¬ä¸€æ­¥é©Ÿ
                };
                
                arModal.style.display = 'flex';
                return;
            }

            // 2. é¡¯ç¤º AR å¤šæ­¥é©Ÿæç¤º
            modalBody.innerHTML = '';
            
            // å¦‚æœé‚„æœ‰æ­¥é©Ÿæœªé¡¯ç¤º
            if (currentArStep < arSteps.length) {
                const step = arSteps[currentArStep];
                const stepNum = currentArStep + 1;
                const totalSteps = arSteps.length;
                
                const title = document.createElement('div');
                title.innerHTML = `<div style="font-size:1rem; color:#ccc; margin-bottom:10px;">æç¤º ${stepNum}/${totalSteps}</div>`;
                modalBody.appendChild(title);
                
                if (step.type === '3d') {
                    // 3D æ¨¡å‹é¡¯ç¤ºï¼ˆå¯äº’å‹•æª¢è¦–ï¼‰
                    const hint = document.createElement('div');
                    hint.innerHTML = `<div style="font-size:1.1rem; color:white; margin-bottom:15px;">ğŸ§Š 3D æ¨¡å‹æç¤ºï¼ˆå¯æ—‹è½‰æŸ¥çœ‹ï¼‰</div>`;
                    modalBody.appendChild(hint);
                    
                    const mv = document.createElement('model-viewer');
                    mv.src = step.url;
                    mv.style.width = '100%';
                    mv.style.height = '400px';
                    mv.style.backgroundColor = 'rgba(0,0,0,0.3)';
                    mv.style.borderRadius = '12px';
                    mv.style.marginTop = '10px';
                    mv.setAttribute('auto-rotate', '');
                    mv.setAttribute('camera-controls', '');
                    mv.setAttribute('disable-zoom', 'false'); // å…è¨±ç¸®æ”¾
                    mv.setAttribute('shadow-intensity', '1');
                    mv.setAttribute('exposure', '1.2');
                    modalBody.appendChild(mv);
                } else if (step.type === 'image') {
                    const img = document.createElement('img');
                    img.src = step.url;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '50vh';
                    img.style.borderRadius = '8px';
                    modalBody.appendChild(img);
                } else if (step.type === 'youtube') {
                    const ytId = extractYouTubeId(step.url);
                    if (ytId) {
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        iframe.style.width = '100%';
                        iframe.style.height = '200px';
                        iframe.style.border = 'none';
                        modalBody.appendChild(iframe);
                    }
                }
                
                modalSubmitBtn.textContent = stepNum < totalSteps ? 'â¡ï¸ ä¸‹ä¸€æ­¥' : 'âœï¸ å‰å¾€ç­”é¡Œ';
                modalSubmitBtn.onclick = () => {
                    currentArStep++;
                    if (currentArStep < arSteps.length) {
                        showArModal(task); // é¡¯ç¤ºä¸‹ä¸€æ­¥
                    } else {
                        // æ‰€æœ‰æ­¥é©Ÿå®Œæˆï¼Œå‰å¾€ç­”é¡Œ
                        arModal.style.display = 'none';
                        if (task.task_type === 'location') {
                            // åœ°é»ä»»å‹™ç›´æ¥å®Œæˆ
                            locationObj.click();
                        } else {
                            // å…¶ä»–ä»»å‹™å‰å¾€ç­”é¡Œé é¢
                            window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                        }
                    }
                };
                
                arModal.style.display = 'flex';
                return;
            }
            
            // 3. æ‰€æœ‰æ­¥é©Ÿå®Œæˆï¼Œæ ¹æ“šä»»å‹™é¡å‹è™•ç†
            if (task.task_type === 'location') {
                modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                modalSubmitBtn.onclick = async () => {
                    // ç›´æ¥è§¸ç™¼æ‰“å¡ API
                    modalSubmitBtn.disabled = true;
                    modalSubmitBtn.textContent = 'æ‰“å¡ä¸­...';
                    
                    if (!currentUserTaskId) currentUserTaskId = await fetchCurrentUserTaskId();
                    if (!currentUserTaskId) { 
                        alert('æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„'); 
                        modalSubmitBtn.disabled = false;
                        modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                        return; 
                    }

                    try {
                        const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, { 
                            method: 'PATCH', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ answer: 'checked_in' }) 
                        });
                        const data = await res.json();
                        if (data.success && data.isCompleted) {
                            if (data.earnedItemName) {
                                showRewardModal(data.earnedItemName, window.currentTask.reward_item_image, window.currentTask.reward_item_model, () => {
                                    window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                                });
                            } else {
                                let msg = `ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${data.message}`;
                                alert(msg); 
                                window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                            }
                        } else { 
                            alert(data.message || 'æ‰“å¡å¤±æ•—'); 
                            modalSubmitBtn.disabled = false;
                            modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                        }
                    } catch (e) { 
                        console.error(e); 
                        alert('é€£ç·šéŒ¯èª¤'); 
                        modalSubmitBtn.disabled = false;
                        modalSubmitBtn.textContent = 'ğŸ“ ç¢ºèªæ‰“å¡';
                    }
                };
            } else {
                modalSubmitBtn.textContent = 'âœï¸ é»æ“Šå›è¦†å•é¡Œ';
                modalSubmitBtn.onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`; else alert("æ¸¬è©¦æ¨¡å¼ï¼šç›®æ¨™å·²æ‰¾åˆ°ï¼"); };
            }

            if (is3DMode) {
                const img = document.createElement('img');
                img.src = task.ar_image_url || task.photoUrl || '/images/mascot.png';
                modalBody.appendChild(img);
                if (task.youtubeUrl) {
                    const ytId = extractYouTubeId(task.youtubeUrl);
                    if (ytId) {
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        iframe.style.width = '100%'; iframe.style.height = '200px'; iframe.style.border = 'none';
                        modalBody.appendChild(iframe);
                    }
                }
            } else {
                const chestImg = document.getElementById('chest-img');
                const videoFrame = document.getElementById('video-frame');
                const ytPlayer = document.getElementById('yt-player');
                if (chestImg.style.display !== 'none') { const img = document.createElement('img'); img.src = chestImg.src; modalBody.appendChild(img); }
                if (videoFrame.style.display !== 'none') {
                    const iframe = document.createElement('iframe'); iframe.src = ytPlayer.src;
                    iframe.style.width = '100%'; iframe.style.height = '200px'; iframe.style.border = 'none';
                    modalBody.appendChild(iframe);
                }
            }
            arModal.style.display = 'flex';
        }
        function showRewardModal(itemName, itemImage, itemModel, callback) {
            const modalBody = document.getElementById('modal-body');
            const arModal = document.getElementById('ar-modal');
            const modalSubmitBtn = document.getElementById('modal-submit');
            
            modalBody.innerHTML = '';
            
            const title = document.createElement('div');
            title.innerHTML = `<div style="font-size:1.5rem; font-weight:bold; color:#4ade80; margin-bottom:15px; text-shadow:0 2px 4px rgba(0,0,0,0.5);">ğŸ‰ ç²å¾—çå‹µï¼</div>`;
            modalBody.appendChild(title);

            if (itemModel) {
                const mv = document.createElement('model-viewer');
                mv.src = itemModel;
                mv.style.width = '100%';
                mv.style.height = '400px';
                mv.style.backgroundColor = 'rgba(255,255,255,0.1)';
                mv.style.borderRadius = '12px';
                mv.setAttribute('auto-rotate', '');
                mv.setAttribute('camera-controls', '');
                mv.setAttribute('disable-zoom', 'false'); // å…è¨±ç¸®æ”¾
                mv.setAttribute('shadow-intensity', '1');
                mv.setAttribute('exposure', '1.2');
                modalBody.appendChild(mv);
            } else if (itemImage) {
                const img = document.createElement('img');
                img.src = itemImage;
                img.style.maxHeight = '250px';
                img.style.objectFit = 'contain';
                modalBody.appendChild(img);
            } else {
                 const placeholder = document.createElement('div');
                 placeholder.style.fontSize = '4rem';
                 placeholder.textContent = 'ğŸ';
                 modalBody.appendChild(placeholder);
            }
            
            const name = document.createElement('div');
            name.innerHTML = `<div style="font-size:1.2rem; color:white; margin-top:15px; font-weight:bold;">${itemName}</div>`;
            modalBody.appendChild(name);

            modalSubmitBtn.textContent = 'ğŸ“¥ æ”¶ä¸‹çå‹µ';
            modalSubmitBtn.onclick = () => {
                if (callback) callback();
                else arModal.style.display = 'none';
            };
            
            arModal.style.display = 'flex';
        }

        document.getElementById('btn-back').onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}`; else window.history.back(); };
        const chest = document.getElementById('chest-obj');
        const lockedObj = document.getElementById('locked-obj');
        const itemUseObj = document.getElementById('item-use-obj');
        const locationObj = document.getElementById('location-obj');
        const arrow = document.getElementById('guide-arrow');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const arModal = document.getElementById('ar-modal');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const modalSubmit = document.getElementById('modal-submit');
        const lockOverlay = document.getElementById('lock-overlay');
        const lockWheels = document.getElementById('lock-wheels');
        const lockMsg = document.getElementById('lock-msg');
        const btnLockCancel = document.getElementById('btn-lock-cancel');
        const btnLockSubmit = document.getElementById('btn-lock-submit');
        
        let userLat = null, userLng = null, deviceHeading = 0, lastHeading = 0, isObjectVisible = false;
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast-message'); if (!toast) return;
            toast.textContent = message; toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, duration);
        }
        locationObj.onclick = async () => {
            if (!currentUserTaskId) currentUserTaskId = await fetchCurrentUserTaskId();
            if (!currentUserTaskId) { alert('æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„'); return; }
            if (confirm('ğŸ“ ç¢ºå®šè¦åœ¨æ­¤è™•æ‰“å¡å—ï¼Ÿ')) {
                try {
                    const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: 'checked_in' }) });
                    const data = await res.json();
                    if (data.success && data.isCompleted) {
                        if (data.earnedItemName) {
                            showRewardModal(data.earnedItemName, window.currentTask.reward_item_image, window.currentTask.reward_item_model, () => {
                                window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                            });
                        } else {
                            let msg = `ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${data.message}`;
                            alert(msg); 
                            window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                        }
                    } else { alert(data.message || 'æ‰“å¡å¤±æ•—'); }
                } catch (e) { console.error(e); alert('é€£ç·šéŒ¯èª¤'); }
            }
        };
        document.getElementById('locked-obj').onclick = () => { if (requiredItem) showToast(`ğŸ”’ éœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘`, 3000); };
        const itemUseImage = document.getElementById('item-use-image');
        itemUseObj.onclick = () => { if (!requiredItem || !hasRequiredItem) return; showToast(`ğŸ’ ä½¿ç”¨äº†ã€${requiredItem.name}ã€‘ï¼`, 2500); itemUseObj.style.display = 'none'; chest.style.display = 'block'; requiredItem = null; };
        if (itemUseImage) itemUseImage.onclick = (e) => { e.stopPropagation(); itemUseObj.click(); };
        document.getElementById('chest-obj').onclick = () => { showArModal(window.currentTask || {}); };
        modalClose.onclick = () => { arModal.style.display = 'none'; modalBody.innerHTML = ''; };
        modalSubmit.onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`; else alert("æ¸¬è©¦æ¨¡å¼ï¼šç›®æ¨™å·²æ‰¾åˆ°ï¼"); };
        function getLoginUser() {
            try { return JSON.parse(localStorage.getItem('loginUser') || 'null'); } catch {}
            try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch {}
            return null;
        }
        async function fetchCurrentUserTaskId() {
            if (!taskId) return null;
            const loginUser = getLoginUser(); if (!loginUser || !loginUser.username) return null;
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks?username=${encodeURIComponent(loginUser.username)}`);
                const data = await res.json();
                if (!data.success || !Array.isArray(data.tasks)) return null;
                const t = data.tasks.find(x => String(x.id) === String(taskId));
                if (!t) return null; currentUserTaskId = t.user_task_id; return currentUserTaskId;
            } catch (e) { return null; }
        }
        function initLockWheels(digits = 4) {
            if (!lockWheels) return;
            lockWheels.innerHTML = '';
            for (let i = 0; i < digits; i++) {
                const wheel = document.createElement('div'); wheel.className = 'wheel'; wheel.dataset.value = '0';
                wheel.innerHTML = `<button class="btn-up" type="button">â–²</button><div class="digit">0</div><button class="btn-down" type="button">â–¼</button>`;
                const digitEl = wheel.querySelector('.digit');
                const setVal = (v) => { const nv = (v + 10) % 10; wheel.dataset.value = String(nv); digitEl.textContent = String(nv); };
                wheel.querySelector('.btn-up').onclick = () => setVal(Number(wheel.dataset.value) + 1);
                wheel.querySelector('.btn-down').onclick = () => setVal(Number(wheel.dataset.value) - 1);
                let startY = null;
                wheel.addEventListener('pointerdown', (ev) => { startY = ev.clientY; wheel.setPointerCapture(ev.pointerId); });
                wheel.addEventListener('pointermove', (ev) => { if (startY == null) return; const dy = ev.clientY - startY; if (Math.abs(dy) > 18) { setVal(Number(wheel.dataset.value) + (dy < 0 ? 1 : -1)); startY = ev.clientY; } });
                wheel.addEventListener('pointerup', () => { startY = null; }); wheel.addEventListener('pointercancel', () => { startY = null; });
                lockWheels.appendChild(wheel);
            }
        }
        function getLockCode() { return Array.from(lockWheels.querySelectorAll('.wheel')).map(w => w.dataset.value || '0').join(''); }
        async function submitLockCode() {
            lockMsg.style.color = 'rgba(255,255,255,0.85)'; lockMsg.textContent = 'é©—è­‰ä¸­...';
            btnLockSubmit.disabled = true; btnLockCancel.disabled = true;
            const code = getLockCode();
            const userTaskId = currentUserTaskId || await fetchCurrentUserTaskId();
            if (!userTaskId) { lockMsg.style.color = '#fca5a5'; lockMsg.textContent = 'æ‰¾ä¸åˆ°ä»»å‹™ç´€éŒ„'; btnLockSubmit.disabled = false; btnLockCancel.disabled = false; return; }
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks/${userTaskId}/answer`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: code }) });
                const data = await res.json();
                if (!data.success) { lockMsg.style.color = '#fca5a5'; lockMsg.textContent = data.message || 'é©—è­‰å¤±æ•—'; }
                else if (data.isCompleted) {
                    lockMsg.style.color = '#86efac'; lockMsg.textContent = data.earnedItemName ? `ç­”å°ï¼ç²å¾—ï¼š${data.earnedItemName}` : 'ç­”å°äº†ï¼';
                    setTimeout(() => { window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`; }, 1500); return;
                } else { lockMsg.style.color = '#fde68a'; lockMsg.textContent = 'ç­”æ¡ˆéŒ¯èª¤'; }
            } catch (e) { lockMsg.textContent = 'é€£ç·šå¤±æ•—'; } finally { btnLockSubmit.disabled = false; btnLockCancel.disabled = false; }
        }
        const btnLock = document.getElementById('btn-open-lock');
        btnLock.onclick = () => { if (!isNumberTask) return; if (!lockWheels.children.length) initLockWheels(lockDigits || 4); lockMsg.textContent = ''; lockOverlay.style.display = 'flex'; fetchCurrentUserTaskId(); };
        btnLockCancel.onclick = () => { lockOverlay.style.display = 'none'; lockMsg.textContent = ''; };
        btnLockSubmit.onclick = submitLockCode;
        lockOverlay.addEventListener('click', (e) => { if (e.target === lockOverlay) btnLockCancel.click(); });
        startBtn.onclick = async () => {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
                }
                startCamera();
                startOverlay.style.display = 'none';
                initSensors();
                showToast(is3DMode ? 'é€²å…¥ 3D AR æ¨¡å¼' : 'é€²å…¥ AR å°èˆªæ¨¡å¼');
            } catch (err) { alert('å•Ÿå‹•éŒ¯èª¤: ' + err.message); startOverlay.style.display = 'none'; }
        };
        function startCamera() {
            status.innerText = 'è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ä¸­...';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false })
            .then(stream => { 
                console.log("âœ… ç›¸æ©Ÿæ¬Šé™å·²å–å¾—");
                if (is3DMode) {
                    // é€™è£¡æ‰åˆ‡æ› UI
                    arWorld.style.display = 'none';
                    video.style.display = 'none';
                    aframeContainer.style.display = 'block';

                    stream.getTracks().forEach(track => track.stop());
                    status.innerText = 'å•Ÿå‹• 3D å¼•æ“...';
                    // ä½¿ç”¨ç¬¬ä¸€æ­¥çš„ 3D æ¨¡å‹ï¼ˆå¦‚æœç¬¬ä¸€æ­¥æ˜¯ 3Dï¼‰
                    const firstStep = arSteps.length > 0 && arSteps[0].type === '3d' ? arSteps[0] : null;
                    if (firstStep) {
                        init3DScene(firstStep.url, firstStep.scale);
                    } else if (window.currentTask && window.currentTask.ar_model_url) {
                        // å‘å¾Œå…¼å®¹ï¼šå¦‚æœæ²’æœ‰æ­¥é©Ÿè¨­å®šï¼Œä½¿ç”¨èˆŠé‚è¼¯
                        const scale = window.currentTask.ar_model_scale || 3.0;
                        init3DScene(window.currentTask.ar_model_url, scale);
                    } else { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 3D æ¨¡å‹è¨­å®š"); }
                    
                    // é¡¯ç¤ºæ—‹è½‰æ¨¡å¼æŒ‰éˆ•
                    const btnRotation = document.getElementById('btn-rotation-mode');
                    if (btnRotation) {
                        btnRotation.style.display = 'block';
                    }
                } else {
                    // éš±è—æ—‹è½‰æ¨¡å¼æŒ‰éˆ•ï¼ˆé 3D æ¨¡å¼ï¼‰
                    const btnRotation = document.getElementById('btn-rotation-mode');
                    if (btnRotation) {
                        btnRotation.style.display = 'none';
                    }
                    status.innerText = 'å•Ÿå‹•ç›¸æ©Ÿç•«é¢...';
                    video.srcObject = stream;
                    video.onloadedmetadata = () => { video.play(); };
                }
            })
            .catch(err => { 
                console.error("ç›¸æ©Ÿæ¬Šé™è«‹æ±‚å¤±æ•—:", err);
                status.innerText = "ç›¸æ©ŸéŒ¯èª¤: " + err.message; 
                if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') alert("âŒ æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ã€‚");
            });
        }
        function initSensors() {
            if (!is3DMode) {
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(
                        pos => { userLat = pos.coords.latitude; userLng = pos.coords.longitude; updateAR(); },
                        err => { status.innerText = "GPS éŒ¯èª¤: " + err.message; },
                        { enableHighAccuracy: true, maximumAge: 1000, timeout: 20000 }
                    );
                }
                window.addEventListener('deviceorientation', event => {
                    let currentHeading = event.webkitCompassHeading || (360 - event.alpha);
                    let diff = currentHeading - lastHeading;
                    if (diff > 180) diff -= 360; if (diff < -180) diff += 360;
                    lastHeading += diff * 0.15; deviceHeading = (lastHeading + 360) % 360;
                    updateAR();
                }, true);
            }
        }
        function updateAR() {
            if (is3DMode) return; 
            if (!userLat || !targetLat) { status.innerText = `GPS å®šä½ä¸­...`; return; }
            const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
            const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            status.innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
            let delta = bearing - deviceHeading;
            while (delta < -180) delta += 360; while (delta > 180) delta -= 360;
            debug.innerText = `æ–¹ä½:${bearing.toFixed(0)}Â° æ‰‹æ©Ÿ:${deviceHeading.toFixed(0)}Â° å·®:${delta.toFixed(0)}Â°`;
            const VISIBLE_DISTANCE = 15; 
            if (dist > VISIBLE_DISTANCE) {
                if (isObjectVisible) { isObjectVisible = false; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; }
                arrow.style.display = 'block'; arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`;
                return; 
            }
            const fov = isObjectVisible ? 50 : 30; 
            if (Math.abs(delta) < fov) {
                if (!isObjectVisible) {
                    isObjectVisible = true; arrow.style.display = 'none';
                    if (isLocationTask) { locationObj.style.display = 'block'; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; }
                    else if (requiredItem) {
                        if (hasRequiredItem) { 
                            itemUseObj.style.display = 'block'; 
                            lockedObj.style.display = 'none'; 
                            chest.style.display = 'none'; 
                            locationObj.style.display = 'none';
                            
                            // æ›´æ–°é“å…·é¡¯ç¤º (2D/3D)
                            const itemImg = document.getElementById('item-use-image');
                            const itemModel = document.getElementById('item-use-model');
                            document.getElementById('item-use-name').textContent = requiredItem.name;
                            
                            if (requiredItem.model) {
                                itemImg.style.display = 'none';
                                itemModel.style.display = 'block';
                                itemModel.src = requiredItem.model;
                            } else {
                                itemModel.style.display = 'none';
                                itemImg.style.display = 'block';
                                itemImg.src = requiredItem.image || '/images/mascot.png';
                            }
                        }
                        else { lockedObj.style.display = 'block'; itemUseObj.style.display = 'none'; chest.style.display = 'none'; locationObj.style.display = 'none'; }
                    } else { lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; chest.style.display = 'block'; }
                }
                const screenWidth = window.innerWidth;
                const xOffset = (delta / 40) * (screenWidth / 2);
                let scale = 1.2 - (Math.min(dist, 50) / 60); if (scale < 0.4) scale = 0.4;
                const transformStyle = `translate(${xOffset}px, 0) scale(${scale})`;
                chest.style.transform = transformStyle; lockedObj.style.transform = transformStyle; itemUseObj.style.transform = transformStyle; locationObj.style.transform = transformStyle;
            } else {
                if (isObjectVisible) { isObjectVisible = false; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; arrow.style.display = 'block'; }
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`; 
            }
        }
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin((destLng-startLng) * Math.PI/180) * Math.cos(destLat * Math.PI/180);
            const x = Math.cos(startLat * Math.PI/180) * Math.sin(destLat * Math.PI/180) - Math.sin(startLat * Math.PI/180) * Math.cos(destLat * Math.PI/180) * Math.cos((destLng-startLng) * Math.PI/180);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
        function extractYouTubeId(url) {
            const match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
            return (match && match[7].length == 11) ? match[7] : null;
        }
    </script>
</body>
</html>