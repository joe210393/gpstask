<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        .ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 999;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° AR å ´æ™¯ */
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            pointer-events: auto; /* æ¢å¾©æŒ‰éˆ•é»æ“Š */
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .info-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 999;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="info-box">
        <div id="status">æ­£åœ¨å®šä½ä¸­...</div>
        <small id="dist-debug"></small>
    </div>

    <div class="ui-overlay">
        <button id="backBtn" class="btn">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
    </div>

    <!-- 
        vr-mode-ui="enabled: false": éš±è— VR æŒ‰éˆ•
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;": AR.js è¨­å®š
    -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
        <!-- è³‡æºé åŠ è¼‰ -->
        <a-assets>
            <img id="mascot-img" src="/images/mascot.png">
        </a-assets>

        <!-- ç›¸æ©Ÿèˆ‡ GPS -->
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- 
            AR ç‰©ä»¶å°‡ç”± JavaScript å‹•æ…‹åŠ å…¥ 
            æˆ‘å€‘æœƒæ”¾ç½®ä¸€å€‹æ°¸é é¢å‘ç”¨æˆ¶çš„åœ–ç‰‡ (Billboard)
        -->
    </a-scene>

    <script>
        // å–å¾—ç¶²å€åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const targetLat = parseFloat(urlParams.get('lat'));
        const targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');

        // è¿”å›æŒ‰éˆ•åŠŸèƒ½
        document.getElementById('backBtn').onclick = function() {
            if (taskId) {
                window.location.href = `/task-detail.html?id=${taskId}`;
            } else {
                window.history.back();
            }
        };

        // æª¢æŸ¥æ˜¯å¦æœ‰åº§æ¨™
        if (!targetLat || !targetLng) {
            document.getElementById('status').innerText = "éŒ¯èª¤ï¼šç„¡æ•ˆçš„ä»»å‹™åº§æ¨™";
        } else {
            // å‹•æ…‹æ–°å¢ AR ç‰©ä»¶
            const scene = document.querySelector('a-scene');

            // å‰µå»ºä¸€å€‹å¯¦é«” (Entity)
            const entity = document.createElement('a-image');
            entity.setAttribute('src', '#mascot-img');
            entity.setAttribute('scale', '5 5 5'); // èª¿æ•´å¤§å°
            entity.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
            
            // æ·»åŠ ç°¡å–®çš„å‹•ç•« (ä¸Šä¸‹æµ®å‹•)
            entity.setAttribute('animation', 'property: position; to: 0 1 0; dir: alternate; dur: 2000; loop: true');

            // åŠ å…¥å ´æ™¯
            scene.appendChild(entity);

            document.getElementById('status').innerText = "è«‹è½‰å‹•æ‰‹æ©Ÿå°‹æ‰¾ä»»å‹™ç›®æ¨™ï¼";

            // ç›£è½è·é›¢ (é™¤éŒ¯ç”¨)
            entity.addEventListener('gps-entity-place-update-position', (event) => {
                const distance = event.detail.distance;
                document.getElementById('dist-debug').innerText = `è·é›¢ç›®æ¨™: ${distance.toFixed(0)} å…¬å°º`;
            });
        }
    </script>
</body>
</html>
