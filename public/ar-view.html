<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        #aframe-scene-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            display: none;
        }
        
        .a-enter-vr { display: none; }
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        /* Modal æ¨£å¼ä¿®æ­£ï¼šå…è¨±å…§éƒ¨æ²å‹• */
        #ar-modal .modal-content {
            background: rgba(30,30,30,0.95);
            border-radius: 16px;
            padding: 20px;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow-y: auto; /* é—œéµä¿®æ­£ï¼šè®“å…§å®¹å¤ªé•·æ™‚å¯ä»¥æ²å‹• */
        }
        /* å¯†ç¢¼é–æ¨£å¼ä¿®æ­£ */
        .wheel {
            width: 62px;
            background: #0b1220;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            touch-action: none; /* é—œéµä¿®æ­£ï¼šè§£æ±ºã€Œæ»‘ä¸å‹•ã€çš„å•é¡Œï¼Œç¦æ­¢ç€è¦½å™¨æ””æˆªæ»‘å‹• */
        }
        /* å…¶ä»–åŸæœ‰æ¨£å¼ä¿ç•™ */
        #start-sensor-btn {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            padding: 15px 30px;
            background: #28a745;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: none;
        }
        .info-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; text-align: center; pointer-events: auto;
        }
        #toast-message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85); color: white; padding: 20px 30px;
            border-radius: 16px; text-align: center; z-index: 5000; display: none;
            pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            font-size: 16px; font-weight: bold; max-width: 80%;
            animation: toastFadeIn 0.3s ease-out;
        }
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .btn-back {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #007bff; color: white; padding: 12px 30px;
            border: none; border-radius: 50px; font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; z-index: 20;
        }
        #ar-world {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; perspective: 800px; pointer-events: none; overflow: hidden;
        }
        #locked-obj, #item-use-obj, #location-obj, #chest-obj {
            position: absolute; top: 50%; left: 50%; display: none; cursor: pointer; pointer-events: auto;
        }
        
        #locked-obj { width: 200px; height: 200px; margin-left: -100px; margin-top: -100px; text-align: center; color: white; animation: float 3s infinite; }
        #locked-icon { font-size: 100px; text-shadow: 0 0 20px rgba(255, 255, 0, 0.8); }
        #locked-text { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 10px; margin-top: 10px; font-weight: bold; }
        #ar-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 20px;
        }
        #ar-modal img, #ar-modal iframe { max-width: 100%; max-height: 50vh; border-radius: 8px; }
        #ar-modal .modal-actions { display: flex; gap: 15px; width: 100%; justify-content: center; }
        #ar-modal button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-close { background: #6c757d; color: white; }
        .btn-reply { background: #28a745; color: white; }
        #btn-open-lock {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: #111827; color: white; padding: 12px 22px;
            border: 1px solid rgba(255,255,255,0.2); border-radius: 999px;
            font-size: 15px; font-weight: 800; pointer-events: auto; cursor: pointer; z-index: 2100; display: none;
        }
        #lock-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.86); display: none;
            z-index: 3500; pointer-events: auto; align-items: center; justify-content: center; padding: 18px;
        }
        .lock-card { width: min(520px, 92vw); background: rgba(20,20,20,0.96); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 18px; color: white; }
        .wheels { display: flex; gap: 10px; justify-content: center; align-items: center; margin: 12px 0 16px; flex-wrap: wrap; }
        .wheel .btn-up, .wheel .btn-down { width: 100%; border: none; background: rgba(255,255,255,0.08); color: white; border-radius: 8px; padding: 8px 0; font-weight: 900; cursor: pointer; }
        .wheel .digit { font-size: 28px; font-weight: 900; margin: 10px 0; letter-spacing: 1px; background: rgba(255,255,255,0.06); border-radius: 10px; padding: 10px 0; border: 1px solid rgba(255,255,255,0.08); }
        .lock-actions { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
        .lock-actions button { border: none; border-radius: 10px; padding: 12px 16px; font-size: 15px; font-weight: 900; cursor: pointer; }
        #btn-lock-cancel { background: #6c757d; color: #fff; }
        #btn-lock-submit { background: #2563eb; color: #fff; }
        #lock-msg { text-align: center; margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.8); min-height: 18px; }
        /* å¯¶ç®±/é“å…·ç­‰ 3D Transform ç›¸é—œ */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        #guide-arrow { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; margin-left: -30px; margin-top: -30px; display: none; }
        #guide-arrow::after { content: ''; display: block; width: 100%; height: 100%; border-top: 10px solid #ff3b30; border-right: 10px solid #ff3b30; transform: rotate(45deg); box-shadow: 2px -2px 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <video id="camera-feed" autoplay playsinline muted></video>
    <div id="aframe-scene-container"></div>
    <div id="ar-world">
        <div id="locked-obj"><div id="locked-icon">â“</div><div id="locked-text">é»æ“ŠæŸ¥çœ‹ç·šç´¢</div></div>
        <div id="item-use-obj" style="display:none; width: 250px; margin-left: -125px; margin-top: -150px; text-align: center;">
            <div style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.8);">
                <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">ğŸ’ ä½¿ç”¨é“å…·</div>
                <img id="item-use-image" src="" alt="é“å…·åœ–ç‰‡" style="width:150px; height:150px; object-fit:contain; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.5); cursor:pointer; margin-bottom:10px;" />
                <div id="item-use-name" style="font-size:16px; font-weight:bold; margin-bottom:8px;"></div>
                <div style="font-size:14px; color:#ffeb3b;">é»æ“Šé“å…·åœ–ç‰‡ä½¿ç”¨</div>
            </div>
        </div>
        <div id="location-obj"><div id="location-icon">ğŸ“</div><div id="location-label">é»æ“Šæ‰“å¡</div></div>
        <div id="chest-obj" style="width: 350px; margin-left: -175px; margin-top: -100px;">
            <div class="ar-content-row" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                <img id="chest-img" src="/images/mascot.png" alt="AR åœ–ç‰‡" style="display:none; width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); animation: float 3s ease-in-out infinite;">
                <div id="video-frame" style="display:none; width: 240px; height: 160px; background: #000; border: 12px solid #222; border-bottom-width: 25px; border-radius: 8px;">
                    <iframe id="yt-player" src="" allow="autoplay; encrypted-media" allowfullscreen style="width:100%; height:100%; border:none;"></iframe>
                </div>
            </div>
            <div id="tap-hint" style="color:white; text-align:center; text-shadow:0 2px 2px black; font-weight:bold; margin-top:10px;">é»æ“ŠæŸ¥çœ‹è©³æƒ…</div>
        </div>
        <div id="guide-arrow"></div>
    </div>
    <div id="ar-modal"><div class="modal-content"><div id="modal-body" style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%;"></div><div class="modal-actions"><button class="btn-close" id="modal-close">é—œé–‰</button><button class="btn-reply" id="modal-submit">âœï¸ é»æ“Šå›è¦†å•é¡Œ</button></div></div></div>
    <div id="lock-overlay"><div class="lock-card"><div class="lock-title">ğŸ”’ æ—‹è½‰å¯†ç¢¼é–</div><div class="lock-subtitle">è½‰å‹•æ•¸å­—è¼ªç›¤å¾ŒæŒ‰ã€Œç¢ºå®šè§£é–ã€ã€‚<br>æé†’ï¼šéœ€è¦å®Œå…¨æ­£ç¢ºï¼Œæ‰èƒ½é€šé—œã€‚</div><div class="wheels" id="lock-wheels"></div><div class="lock-actions"><button id="btn-lock-cancel" type="button">é—œé–‰</button><button id="btn-lock-submit" type="button">ç¢ºå®šè§£é–</button></div><div id="lock-msg"></div></div></div>
    <div class="ui-layer">
        <div id="start-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; pointer-events:auto;">
            <div style="font-size:1.5rem; font-weight:bold; margin-bottom:20px; text-align:center;">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
            <div style="margin-bottom:30px; color:#ccc; text-align:center; max-width:80%;">éœ€è¦æ‚¨çš„ç›¸æ©Ÿèˆ‡æ–¹å‘æ„Ÿæ¸¬å™¨æ¬Šé™<br>ä»¥é€²è¡Œ AR å°èˆª</div>
            <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#007bff; color:white; border:none; border-radius:50px; font-weight:bold; box-shadow:0 0 20px rgba(0,123,255,0.5);">ğŸš€ é–‹å§‹æœå°‹</button>
        </div>
        <div class="info-box"><div id="status">ç­‰å¾…å•Ÿå‹•...</div><div id="debug-info" style="font-size:0.8em; color:#ffeb3b; margin-top:5px;"></div></div>
        <button id="btn-back" class="btn-back">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
        <button id="btn-open-lock" type="button">ğŸ”’ è¼¸å…¥å¯†ç¢¼</button>
    </div>
    <div id="toast-message"></div>
    <script>
        const API_BASE = ''; 
        const video = document.getElementById('camera-feed');
        const aframeContainer = document.getElementById('aframe-scene-container');
        const arWorld = document.getElementById('ar-world');
        const debug = document.getElementById('debug-info');
        const status = document.getElementById('status');
        
        let is3DMode = false;
        let gpsLocked = false; 
        // === å‹•æ…‹å»ºç«‹ 3D å ´æ™¯ ===
        function init3DScene(modelUrl, scale = 1) {
            const container = document.getElementById('aframe-scene-container');
            
            // ä¿®æ­£ 1: å¢åŠ  cursor="rayOrigin: mouse" è®“æ‰‹æŒ‡é»æ“Šæœ‰æ•ˆ
            // ä¿®æ­£ 2: é»æ“Šå€ ar-model-click-zone è¨­ç‚ºé€æ˜ä½† visibleï¼Œå¦å‰‡ç„¡æ³•é»æ“Š
            container.innerHTML = `
                <a-scene 
                    vr-mode-ui="enabled: false"
                    embedded
                    arjs='sourceType: webcam; debugUIEnabled: false;'
                    renderer="logarithmicDepthBuffer: true; colorManagement: true; alpha: true;"
                    cursor="rayOrigin: mouse">
                    
                    <a-camera gps-camera="minDistance: 0; maxDistance: 2000;" rotation-reader></a-camera>
                    <a-assets>
                        <a-asset-item id="animated-model-asset" src="${modelUrl}"></a-asset-item>
                    </a-assets>
                    
                    <a-entity 
                        id="ar-model-entity"
                        gltf-model="#animated-model-asset"
                        animation-mixer
                        scale="${scale} ${scale} ${scale}" 
                        visible="false"
                        look-at="[gps-camera]"
                        cursor-listener> 
                    </a-entity>
                    <a-box 
                        id="ar-model-click-zone" 
                        visible="false" 
                        material="opacity: 0; transparent: true"
                        position="0 0 0" 
                        scale="2 2 2"
                        gps-entity-place="">
                    </a-box>
                </a-scene>
            `;
            setTimeout(() => {
                const modelEntity = document.querySelector('#ar-model-entity');
                const clickZone = document.querySelector('#ar-model-click-zone');
                
                const clickHandler = () => {
                    console.log("3D Model Clicked!");
                    if(window.currentTask) showArModal(window.currentTask);
                };
                // ç¶å®šé»æ“Šäº‹ä»¶
                if(modelEntity) {
                    modelEntity.addEventListener('click', clickHandler);
                    // å‚™ç”¨ï¼šå¦‚æœæœ‰é»ä¸åˆ°æ¨¡å‹çš„æƒ…æ³ï¼Œé»æ“Šé€æ˜ç›’å­ä¹Ÿå¯ä»¥
                    if(clickZone) clickZone.addEventListener('click', clickHandler);
                }
                
                // ç¶å®š GPS é–å®šäº‹ä»¶
                window.addEventListener('gps-camera-update-position', (e) => {
                    if (!gpsLocked) {
                        userLat = e.detail.position.latitude;
                        userLng = e.detail.position.longitude;
                        document.getElementById('status').innerText = `GPS å·²é–å®š (ç²¾åº¦: ${e.detail.position.accuracy?.toFixed(1) || '?'}m)`;
                        
                        if(modelEntity && targetLat && targetLng) {
                            modelEntity.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                            modelEntity.setAttribute('visible', 'true');
                            
                            // è®“é»æ“Šå€ä¹Ÿè·Ÿè‘—ç§»å‹•
                            if(clickZone) {
                                clickZone.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                                // æ³¨æ„ï¼šclickZone ä¿æŒ visible=false (A-Frame é è¨­ visible=false ä¸å¯é»æ“Š)
                                // æ‰€ä»¥é€™è£¡æˆ‘å€‘ç”¨ material opacity 0 ä¾†éš±è—ï¼Œä½†å±¬æ€§è¨­ç‚º visible
                                clickZone.setAttribute('visible', 'true'); 
                            }
                            console.log(`ğŸ“ æ¨¡å‹å·²æ”¾ç½®æ–¼ ${targetLat}, ${targetLng}`);
                        }
                        gpsLocked = true;
                    }
                });
            }, 100); 
        }
        // 2. å–å¾—ä»»å‹™è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        let targetLat = parseFloat(urlParams.get('lat'));
        let targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');
        
        let currentTask = null;
        let isNumberTask = false;
        let isLocationTask = false;
        let lockDigits = 4;
        let currentUserTaskId = null;
        let requiredItem = null;
        let hasRequiredItem = false;
        if (taskId) {
            fetch(`${API_BASE}/api/tasks/${taskId}`)
                .then(res => res.json())
                .then(async data => {
                    if (data.success && data.task) {
                        const task = data.task;
                        currentTask = task;
                        window.currentTask = task; 
                        if (task.ar_model_url) {
                            is3DMode = true;
                            console.log('ğŸš€ åµæ¸¬åˆ° 3D ä»»å‹™ï¼Œæº–å‚™é€²å…¥ 3D æ¨¡å¼');
                            // ä¸è¦åœ¨é€™è£¡å…ˆéš±è— videoï¼Œç­‰åˆ°çœŸæ­£æŒ‰ä¸‹é–‹å§‹å¾Œå†åˆ‡æ›
                        } else {
                            console.log('ğŸ–¼ï¸ ä½¿ç”¨ CSS AR æ¨¡å¼');
                            is3DMode = false;
                            aframeContainer.innerHTML = ''; 
                            aframeContainer.style.display = 'none';
                            arWorld.style.display = 'block';
                            video.style.display = 'block';
                            setupCssArContent(task);
                        }
                        if (task.required_item_id) {
                            requiredItem = { id: task.required_item_id, name: task.required_item_name, image: task.required_item_image };
                            const loginUser = getLoginUser();
                            if (loginUser) {
                                try {
                                    const invRes = await fetch(`${API_BASE}/api/user/inventory`, { headers: { 'x-username': loginUser.username } });
                                    const invData = await invRes.json();
                                    if (invData.success) hasRequiredItem = invData.inventory.some(i => i.item_id === task.required_item_id);
                                } catch (e) { console.error(e); }
                            }
                        }
                        isNumberTask = (task.task_type === 'number');
                        isLocationTask = (task.task_type === 'location');
                        if (isLocationTask) fetchCurrentUserTaskId();
                        if (typeof task.correct_answer === 'string') {
                            const len = task.correct_answer.trim().length;
                            if (len >= 2 && len <= 8) lockDigits = len;
                        }
                        
                        if (task.lat && task.lng) { targetLat = task.lat; targetLng = task.lng; }
                        const btnOpenLock = document.getElementById('btn-open-lock');
                        if (isNumberTask) {
                            btnOpenLock.style.display = 'block';
                            initLockWheels(lockDigits);
                            fetchCurrentUserTaskId();
                        } else {
                            btnOpenLock.style.display = 'none';
                        }
                    }
                })
                .catch(err => { console.error("ç„¡æ³•è¼‰å…¥ä»»å‹™:", err); showToast("è¼‰å…¥ä»»å‹™å¤±æ•—"); });
        }
        function setupCssArContent(task) {
            const chestObj = document.getElementById('chest-obj');
            const chestImg = document.getElementById('chest-img');
            const videoFrame = document.getElementById('video-frame');
            let hasImage = false, hasVideo = false;
            if (task.ar_image_url) { chestImg.src = task.ar_image_url; chestImg.style.display = 'block'; hasImage = true; }
            if (task.youtubeUrl) {
                const ytId = extractYouTubeId(task.youtubeUrl);
                if (ytId) {
                    videoFrame.style.display = 'block';
                    document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                    hasVideo = true;
                }
            }
            if (!hasImage && !hasVideo) { chestImg.src = '/images/mascot.png'; chestImg.style.display = 'block'; hasImage = true; }
            if (hasImage && hasVideo) chestObj.className = 'has-both';
            else if (hasImage) chestObj.className = 'only-image';
            else if (hasVideo) chestObj.className = 'only-video';
        }
        function showArModal(task) {
            if (requiredItem && !hasRequiredItem) { showToast(`ğŸ”’ éœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘`, 3000); return; }
            const modalBody = document.getElementById('modal-body');
            const arModal = document.getElementById('ar-modal');
            modalBody.innerHTML = '';
            if (is3DMode) {
                const img = document.createElement('img');
                img.src = task.ar_image_url || task.photoUrl || '/images/mascot.png';
                modalBody.appendChild(img);
                if (task.youtubeUrl) {
                    const ytId = extractYouTubeId(task.youtubeUrl);
                    if (ytId) {
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                        iframe.style.width = '100%'; iframe.style.height = '200px'; iframe.style.border = 'none';
                        modalBody.appendChild(iframe);
                    }
                }
            } else {
                const chestImg = document.getElementById('chest-img');
                const videoFrame = document.getElementById('video-frame');
                const ytPlayer = document.getElementById('yt-player');
                if (chestImg.style.display !== 'none') { const img = document.createElement('img'); img.src = chestImg.src; modalBody.appendChild(img); }
                if (videoFrame.style.display !== 'none') {
                    const iframe = document.createElement('iframe'); iframe.src = ytPlayer.src;
                    iframe.style.width = '100%'; iframe.style.height = '200px'; iframe.style.border = 'none';
                    modalBody.appendChild(iframe);
                }
            }
            arModal.style.display = 'flex';
        }
        document.getElementById('btn-back').onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}`; else window.history.back(); };
        const chest = document.getElementById('chest-obj');
        const lockedObj = document.getElementById('locked-obj');
        const itemUseObj = document.getElementById('item-use-obj');
        const locationObj = document.getElementById('location-obj');
        const arrow = document.getElementById('guide-arrow');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const arModal = document.getElementById('ar-modal');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const modalSubmit = document.getElementById('modal-submit');
        const lockOverlay = document.getElementById('lock-overlay');
        const lockWheels = document.getElementById('lock-wheels');
        const lockMsg = document.getElementById('lock-msg');
        const btnLockCancel = document.getElementById('btn-lock-cancel');
        const btnLockSubmit = document.getElementById('btn-lock-submit');
        
        let userLat = null, userLng = null, deviceHeading = 0, lastHeading = 0, isObjectVisible = false;
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast-message'); if (!toast) return;
            toast.textContent = message; toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, duration);
        }
        locationObj.onclick = async () => {
            if (!currentUserTaskId) currentUserTaskId = await fetchCurrentUserTaskId();
            if (!currentUserTaskId) { alert('æ‰¾ä¸åˆ°é€²è¡Œä¸­çš„ä»»å‹™ç´€éŒ„'); return; }
            if (confirm('ğŸ“ ç¢ºå®šè¦åœ¨æ­¤è™•æ‰“å¡å—ï¼Ÿ')) {
                try {
                    const res = await fetch(`${API_BASE}/api/user-tasks/${currentUserTaskId}/answer`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: 'checked_in' }) });
                    const data = await res.json();
                    if (data.success && data.isCompleted) {
                        let msg = `ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${data.message}`;
                        if (data.earnedItemName) msg += `\n\nğŸ ç²å¾—é“å…·ï¼šã€${data.earnedItemName}ã€‘`;
                        alert(msg); window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
                    } else { alert(data.message || 'æ‰“å¡å¤±æ•—'); }
                } catch (e) { console.error(e); alert('é€£ç·šéŒ¯èª¤'); }
            }
        };
        document.getElementById('locked-obj').onclick = () => { if (requiredItem) showToast(`ğŸ”’ éœ€è¦é“å…·ï¼šã€${requiredItem.name}ã€‘`, 3000); };
        const itemUseImage = document.getElementById('item-use-image');
        itemUseObj.onclick = () => { if (!requiredItem || !hasRequiredItem) return; showToast(`ğŸ’ ä½¿ç”¨äº†ã€${requiredItem.name}ã€‘ï¼`, 2500); itemUseObj.style.display = 'none'; chest.style.display = 'block'; requiredItem = null; };
        if (itemUseImage) itemUseImage.onclick = (e) => { e.stopPropagation(); itemUseObj.click(); };
        document.getElementById('chest-obj').onclick = () => { showArModal(window.currentTask || {}); };
        modalClose.onclick = () => { arModal.style.display = 'none'; modalBody.innerHTML = ''; };
        modalSubmit.onclick = () => { if (taskId) window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`; else alert("æ¸¬è©¦æ¨¡å¼ï¼šç›®æ¨™å·²æ‰¾åˆ°ï¼"); };
        function getLoginUser() {
            try { return JSON.parse(localStorage.getItem('loginUser') || 'null'); } catch {}
            try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch {}
            return null;
        }
        async function fetchCurrentUserTaskId() {
            if (!taskId) return null;
            const loginUser = getLoginUser(); if (!loginUser || !loginUser.username) return null;
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks?username=${encodeURIComponent(loginUser.username)}`);
                const data = await res.json();
                if (!data.success || !Array.isArray(data.tasks)) return null;
                const t = data.tasks.find(x => String(x.id) === String(taskId));
                if (!t) return null; currentUserTaskId = t.user_task_id; return currentUserTaskId;
            } catch (e) { return null; }
        }
        function initLockWheels(digits = 4) {
            if (!lockWheels) return;
            lockWheels.innerHTML = '';
            for (let i = 0; i < digits; i++) {
                const wheel = document.createElement('div'); wheel.className = 'wheel'; wheel.dataset.value = '0';
                wheel.innerHTML = `<button class="btn-up" type="button">â–²</button><div class="digit">0</div><button class="btn-down" type="button">â–¼</button>`;
                const digitEl = wheel.querySelector('.digit');
                const setVal = (v) => { const nv = (v + 10) % 10; wheel.dataset.value = String(nv); digitEl.textContent = String(nv); };
                wheel.querySelector('.btn-up').onclick = () => setVal(Number(wheel.dataset.value) + 1);
                wheel.querySelector('.btn-down').onclick = () => setVal(Number(wheel.dataset.value) - 1);
                let startY = null;
                wheel.addEventListener('pointerdown', (ev) => { startY = ev.clientY; wheel.setPointerCapture(ev.pointerId); });
                wheel.addEventListener('pointermove', (ev) => { if (startY == null) return; const dy = ev.clientY - startY; if (Math.abs(dy) > 18) { setVal(Number(wheel.dataset.value) + (dy < 0 ? 1 : -1)); startY = ev.clientY; } });
                wheel.addEventListener('pointerup', () => { startY = null; }); wheel.addEventListener('pointercancel', () => { startY = null; });
                lockWheels.appendChild(wheel);
            }
        }
        function getLockCode() { return Array.from(lockWheels.querySelectorAll('.wheel')).map(w => w.dataset.value || '0').join(''); }
        async function submitLockCode() {
            lockMsg.style.color = 'rgba(255,255,255,0.85)'; lockMsg.textContent = 'é©—è­‰ä¸­...';
            btnLockSubmit.disabled = true; btnLockCancel.disabled = true;
            const code = getLockCode();
            const userTaskId = currentUserTaskId || await fetchCurrentUserTaskId();
            if (!userTaskId) { lockMsg.style.color = '#fca5a5'; lockMsg.textContent = 'æ‰¾ä¸åˆ°ä»»å‹™ç´€éŒ„'; btnLockSubmit.disabled = false; btnLockCancel.disabled = false; return; }
            try {
                const res = await fetch(`${API_BASE}/api/user-tasks/${userTaskId}/answer`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: code }) });
                const data = await res.json();
                if (!data.success) { lockMsg.style.color = '#fca5a5'; lockMsg.textContent = data.message || 'é©—è­‰å¤±æ•—'; }
                else if (data.isCompleted) {
                    lockMsg.style.color = '#86efac'; lockMsg.textContent = data.earnedItemName ? `ç­”å°ï¼ç²å¾—ï¼š${data.earnedItemName}` : 'ç­”å°äº†ï¼';
                    setTimeout(() => { window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`; }, 1500); return;
                } else { lockMsg.style.color = '#fde68a'; lockMsg.textContent = 'ç­”æ¡ˆéŒ¯èª¤'; }
            } catch (e) { lockMsg.textContent = 'é€£ç·šå¤±æ•—'; } finally { btnLockSubmit.disabled = false; btnLockCancel.disabled = false; }
        }
        const btnLock = document.getElementById('btn-open-lock');
        btnLock.onclick = () => { if (!isNumberTask) return; if (!lockWheels.children.length) initLockWheels(lockDigits || 4); lockMsg.textContent = ''; lockOverlay.style.display = 'flex'; fetchCurrentUserTaskId(); };
        btnLockCancel.onclick = () => { lockOverlay.style.display = 'none'; lockMsg.textContent = ''; };
        btnLockSubmit.onclick = submitLockCode;
        lockOverlay.addEventListener('click', (e) => { if (e.target === lockOverlay) btnLockCancel.click(); });
        startBtn.onclick = async () => {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
                }
                startCamera();
                startOverlay.style.display = 'none';
                initSensors();
                showToast(is3DMode ? 'é€²å…¥ 3D AR æ¨¡å¼' : 'é€²å…¥ AR å°èˆªæ¨¡å¼');
            } catch (err) { alert('å•Ÿå‹•éŒ¯èª¤: ' + err.message); startOverlay.style.display = 'none'; }
        };
        function startCamera() {
            status.innerText = 'è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ä¸­...';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false })
            .then(stream => { 
                console.log("âœ… ç›¸æ©Ÿæ¬Šé™å·²å–å¾—");
                if (is3DMode) {
                    // é€™è£¡æ‰åˆ‡æ› UI
                    arWorld.style.display = 'none';
                    video.style.display = 'none';
                    aframeContainer.style.display = 'block';

                    stream.getTracks().forEach(track => track.stop());
                    status.innerText = 'å•Ÿå‹• 3D å¼•æ“...';
                    if (window.currentTask && window.currentTask.ar_model_url) {
                        const scale = window.currentTask.ar_model_scale || 0.5;
                        init3DScene(window.currentTask.ar_model_url, scale);
                    } else { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 3D æ¨¡å‹è¨­å®š"); }
                } else {
                    status.innerText = 'å•Ÿå‹•ç›¸æ©Ÿç•«é¢...';
                    video.srcObject = stream;
                    video.onloadedmetadata = () => { video.play(); };
                }
            })
            .catch(err => { 
                console.error("ç›¸æ©Ÿæ¬Šé™è«‹æ±‚å¤±æ•—:", err);
                status.innerText = "ç›¸æ©ŸéŒ¯èª¤: " + err.message; 
                if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') alert("âŒ æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ã€‚");
            });
        }
        function initSensors() {
            if (!is3DMode) {
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(
                        pos => { userLat = pos.coords.latitude; userLng = pos.coords.longitude; updateAR(); },
                        err => { status.innerText = "GPS éŒ¯èª¤: " + err.message; },
                        { enableHighAccuracy: true, maximumAge: 1000, timeout: 20000 }
                    );
                }
                window.addEventListener('deviceorientation', event => {
                    let currentHeading = event.webkitCompassHeading || (360 - event.alpha);
                    let diff = currentHeading - lastHeading;
                    if (diff > 180) diff -= 360; if (diff < -180) diff += 360;
                    lastHeading += diff * 0.15; deviceHeading = (lastHeading + 360) % 360;
                    updateAR();
                }, true);
            }
        }
        function updateAR() {
            if (is3DMode) return; 
            if (!userLat || !targetLat) { status.innerText = `GPS å®šä½ä¸­...`; return; }
            const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
            const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            status.innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
            let delta = bearing - deviceHeading;
            while (delta < -180) delta += 360; while (delta > 180) delta -= 360;
            debug.innerText = `æ–¹ä½:${bearing.toFixed(0)}Â° æ‰‹æ©Ÿ:${deviceHeading.toFixed(0)}Â° å·®:${delta.toFixed(0)}Â°`;
            const VISIBLE_DISTANCE = 15; 
            if (dist > VISIBLE_DISTANCE) {
                if (isObjectVisible) { isObjectVisible = false; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; }
                arrow.style.display = 'block'; arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`;
                return; 
            }
            const fov = isObjectVisible ? 50 : 30; 
            if (Math.abs(delta) < fov) {
                if (!isObjectVisible) {
                    isObjectVisible = true; arrow.style.display = 'none';
                    if (isLocationTask) { locationObj.style.display = 'block'; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; }
                    else if (requiredItem) {
                        if (hasRequiredItem) { itemUseObj.style.display = 'block'; lockedObj.style.display = 'none'; chest.style.display = 'none'; locationObj.style.display = 'none'; }
                        else { lockedObj.style.display = 'block'; itemUseObj.style.display = 'none'; chest.style.display = 'none'; locationObj.style.display = 'none'; }
                    } else { lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; chest.style.display = 'block'; }
                }
                const screenWidth = window.innerWidth;
                const xOffset = (delta / 40) * (screenWidth / 2);
                let scale = 1.2 - (Math.min(dist, 50) / 60); if (scale < 0.4) scale = 0.4;
                const transformStyle = `translate(${xOffset}px, 0) scale(${scale})`;
                chest.style.transform = transformStyle; lockedObj.style.transform = transformStyle; itemUseObj.style.transform = transformStyle; locationObj.style.transform = transformStyle;
            } else {
                if (isObjectVisible) { isObjectVisible = false; chest.style.display = 'none'; lockedObj.style.display = 'none'; itemUseObj.style.display = 'none'; locationObj.style.display = 'none'; arrow.style.display = 'block'; }
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`; 
            }
        }
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin((destLng-startLng) * Math.PI/180) * Math.cos(destLat * Math.PI/180);
            const x = Math.cos(startLat * Math.PI/180) * Math.sin(destLat * Math.PI/180) - Math.sin(startLat * Math.PI/180) * Math.cos(destLat * Math.PI/180) * Math.cos((destLng-startLng) * Math.PI/180);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
        function extractYouTubeId(url) {
            const match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
            return (match && match[7].length == 11) ? match[7] : null;
        }
    </script>
</body>
</html>