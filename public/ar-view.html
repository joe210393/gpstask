<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        .ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 999;
            pointer-events: none;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .info-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 999;
        }
        
        /* 2D å°èˆªç®­é ­æ¨£å¼ */
        #arrow-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 900;
            pointer-events: none;
            display: none; /* é è¨­éš±è— */
        }
        #nav-arrow {
            width: 0; 
            height: 0; 
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-bottom: 80px solid rgba(255, 0, 0, 0.8);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
            transform-origin: center bottom; /* ä»¥åº•éƒ¨ä¸­å¿ƒç‚ºæ—‹è½‰è»¸ */
        }
        .arrow-text {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="info-box">
        <div id="status">æ­£åœ¨å®šä½ä¸­...</div>
        <div id="dist-debug" style="font-size: 1.2em; font-weight: bold; color: #ffeb3b;"></div>
        <div id="debug-log" style="font-size: 0.8em; color: #ccc;"></div>
    </div>

    <!-- 2D å°èˆªç®­é ­ -->
    <div id="arrow-container">
        <div id="nav-arrow"></div>
        <div class="arrow-text">ç›®æ¨™æ–¹å‘</div>
    </div>

    <div class="ui-overlay">
        <button id="backBtn" class="btn">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
        <a-assets>
            <img id="mascot-img" src="/images/mascot.png">
        </a-assets>

        <a-camera gps-camera rotation-reader>
            <!-- 
                è¿‘è·é›¢å¯¶ç®± (å¼·åˆ¶é¡¯ç¤º)
                åŠ å¤§å°ºå¯¸ scale="3 3 3"
                ä½¿ç”¨ shader: flat ç¢ºä¿ä¸å—å…‰ç…§å½±éŸ¿ (æ°¸é å…¨äº®)
                ä½ç½® z=-4 (å‰æ–¹4ç±³), y=0 (è¦–ç·šé«˜åº¦)
            -->
            <a-image
                id="nearby-target"
                src="#mascot-img"
                position="0 0 -4"
                scale="3 3 3"
                visible="false"
                material="shader: flat; opacity: 1;"
                animation="property: position; to: 0 0.2 -4; dir: alternate; dur: 1500; loop: true"
            ></a-image>
        </a-camera>

        <!-- é è™• GPS å¯¶ç®± -->
        <!-- å°‡ç”± JS å‹•æ…‹åŠ å…¥ -->
    </a-scene>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetLat = parseFloat(urlParams.get('lat'));
        const targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');

        document.getElementById('backBtn').onclick = function() {
            if (taskId) {
                window.location.href = `/task-detail.html?id=${taskId}`;
            } else {
                window.history.back();
            }
        };

        if (!targetLat || !targetLng) {
            document.getElementById('status').innerText = "éŒ¯èª¤ï¼šç„¡æ•ˆçš„ä»»å‹™åº§æ¨™";
        } else {
            const scene = document.querySelector('a-scene');

            // å»ºç«‹é è™•çš„ GPS ç›®æ¨™
            const gpsTarget = document.createElement('a-image');
            gpsTarget.setAttribute('id', 'gps-target');
            gpsTarget.setAttribute('src', '#mascot-img');
            gpsTarget.setAttribute('scale', '8 8 8'); // é è™•çš„è¦æ›´å¤§
            gpsTarget.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
            gpsTarget.setAttribute('material', 'shader: flat; opacity: 1;'); // ç¢ºä¿å¯è¦‹
            gpsTarget.setAttribute('visible', 'true');
            scene.appendChild(gpsTarget);

            const arrowContainer = document.getElementById('arrow-container');
            const navArrow = document.getElementById('nav-arrow');
            const nearbyTarget = document.getElementById('nearby-target');
            
            let userLat = null;
            let userLng = null;
            let userHeading = 0;

            // ç›£è½ GPS æ›´æ–°
            window.addEventListener('gps-camera-update-position', function(e) {
                userLat = e.detail.position.latitude;
                userLng = e.detail.position.longitude;
                
                const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
                document.getElementById('dist-debug').innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
                
                updateArrowAndTarget(dist);
            });

            // ç›£è½æ‰‹æ©Ÿç¾…ç›¤æ–¹å‘
            window.addEventListener('deviceorientation', function(event) {
                if (event.webkitCompassHeading) {
                    userHeading = event.webkitCompassHeading;
                } else if (event.alpha) {
                    userHeading = 360 - event.alpha;
                }
                
                if (userLat) {
                    updateArrowRotation();
                }
            });

            function updateArrowAndTarget(dist) {
                // æ”¾å¯¬è·é›¢é™åˆ¶åˆ° 15 å…¬å°ºï¼Œè®“å¯¶ç®±æ›´å®¹æ˜“å‡ºç¾
                if(dist < 15) {
                    // === è¿‘è·é›¢æ¨¡å¼ ===
                    document.getElementById('status').innerText = "ç›®æ¨™å°±åœ¨çœ¼å‰ï¼";
                    document.getElementById('debug-log').innerText = "æ¨¡å¼: è¿‘è·é›¢ (Nearby)";
                    
                    // éš±è— 2D ç®­é ­
                    arrowContainer.style.display = 'none';
                    
                    // é¡¯ç¤ºè¿‘è·é›¢å¯¶ç®±
                    nearbyTarget.setAttribute('visible', 'true');
                    gpsTarget.setAttribute('visible', 'false');

                } else {
                    // === é è·é›¢æ¨¡å¼ ===
                    document.getElementById('status').innerText = "è·Ÿéš¨ç®­é ­å°‹æ‰¾ç›®æ¨™";
                    document.getElementById('debug-log').innerText = "æ¨¡å¼: å°èˆª (Nav)";
                    
                    // é¡¯ç¤º 2D ç®­é ­
                    arrowContainer.style.display = 'block';
                    
                    // éš±è—è¿‘è·é›¢å¯¶ç®±
                    nearbyTarget.setAttribute('visible', 'false');
                    gpsTarget.setAttribute('visible', 'true');
                    
                    updateArrowRotation();
                }
            }

            function updateArrowRotation() {
                if (arrowContainer.style.display === 'none') return;

                const targetBearing = calculateBearing(userLat, userLng, targetLat, targetLng);
                // è¨ˆç®—ç›¸å°è§’åº¦
                let arrowRotation = targetBearing - userHeading;
                
                // æ—‹è½‰ 2D ç®­é ­
                navArrow.style.transform = `rotate(${arrowRotation}deg)`;
            }

            // --- è¼”åŠ©å‡½å¼ ---
            function calculateBearing(startLat, startLng, destLat, destLng) {
                const startLatRad = toRadians(startLat);
                const startLngRad = toRadians(startLng);
                const destLatRad = toRadians(destLat);
                const destLngRad = toRadians(destLng);

                const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
                const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                        Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
                let brng = Math.atan2(y, x);
                brng = toDegrees(brng);
                return (brng + 360) % 360;
            }

            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; 
                const Ï†1 = toRadians(lat1);
                const Ï†2 = toRadians(lat2);
                const Î”Ï† = toRadians(lat2 - lat1);
                const Î”Î» = toRadians(lon2 - lon1);
                const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                        Math.cos(Ï†1) * Math.cos(Ï†2) *
                        Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function toRadians(degrees) { return degrees * Math.PI / 180; }
            function toDegrees(radians) { return radians * 180 / Math.PI; }
        }
    </script>
</body>
</html>