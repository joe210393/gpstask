<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .ui-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #start-sensor-btn {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            padding: 15px 30px;
            background: #28a745;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: none; /* é è¨­éš±è—ï¼Œéœ€è¦æ™‚æ‰é¡¯ç¤º */
        }

        .info-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            pointer-events: auto;
        }

        .btn-back {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: auto;
            cursor: pointer;
            z-index: 20;
        }

        /* è™›æ“¬ä¸–ç•Œå±¤ */
        #ar-world {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5;
            perspective: 800px;
            pointer-events: none;
            overflow: hidden;
        }

        /* å¯¶ç®±ç‰©ä»¶å®¹å™¨ */
        #chest-obj {
            position: absolute;
            top: 50%; left: 50%;
            width: 350px;
            margin-left: -175px; margin-top: -100px;
            transform-style: preserve-3d;
            display: none;
            cursor: pointer;
            pointer-events: auto;
        }
        
        /* AR å…§å®¹å®¹å™¨ï¼ˆåœ–ç‰‡å’Œå½±ç‰‡ä¸¦æ’ï¼‰ */
        .ar-content-row {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        
        /* é è¨­å¯¶ç®±åœ–ç‰‡ */
        #chest-img {
            width: 150px; height: 150px;
            object-fit: contain;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            animation: float 3s ease-in-out infinite;
        }

        /* YouTube å½±ç‰‡æ¡† */
        #video-frame {
            width: 200px; height: 150px;
            border: 4px solid #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.8);
            background: black;
            display: none;
            animation: float 3s ease-in-out infinite;
        }
        
        /* åªæœ‰åœ–ç‰‡æ™‚ï¼Œè®“å®ƒå±…ä¸­ */
        #chest-obj.only-image .ar-content-row {
            justify-content: center;
        }
        #chest-obj.only-image #chest-img {
            width: 200px; height: 200px;
        }
        
        /* åªæœ‰å½±ç‰‡æ™‚ï¼Œè®“å®ƒå±…ä¸­ */
        #chest-obj.only-video .ar-content-row {
            justify-content: center;
        }
        #chest-obj.only-video #video-frame {
            width: 300px; height: 200px;
        }
        
        iframe {
            width: 100%; height: 100%;
            border: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        #guide-arrow {
            position: absolute;
            top: 50%; left: 50%;
            width: 60px; height: 60px;
            margin-left: -30px; margin-top: -30px;
            display: none;
        }
        #guide-arrow::after {
            content: '';
            display: block;
            width: 100%; height: 100%;
            border-top: 10px solid #ff3b30;
            border-right: 10px solid #ff3b30;
            transform: rotate(45deg);
            box-shadow: 2px -2px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>

    <div id="ar-world">
        <!-- å®¹å™¨ï¼šå¯èƒ½æ˜¯åœ–ç‰‡ã€å½±ç‰‡ï¼Œæˆ–å…©è€…éƒ½æœ‰ -->
        <div id="chest-obj">
            <div class="ar-content-row">
                <!-- 1. AR å°ˆç”¨åœ–ç‰‡ -->
                <img id="chest-img" src="/images/mascot.png" alt="AR åœ–ç‰‡" style="display:none;">
                
                <!-- 2. YouTube å½±ç‰‡ -->
                <div id="video-frame" style="display:none;">
                    <iframe id="yt-player" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
            </div>

            <div id="tap-hint" style="color:white; text-align:center; text-shadow:0 2px 2px black; font-weight:bold; margin-top:10px;">é»æ“Šé ˜å–çå‹µ!</div>
        </div>
        
        <div id="guide-arrow"></div>
    </div>

    <div class="ui-layer">
        <button id="start-sensor-btn">ğŸ“² é»æ“Šå•Ÿç”¨ AR æ„Ÿæ¸¬å™¨</button>
        <div class="info-box">
            <div id="status">å•Ÿå‹•ç›¸æ©Ÿä¸­...</div>
            <div id="debug-info" style="font-size:0.8em; color:#ffeb3b; margin-top:5px;"></div>
        </div>
        <button id="btn-back" class="btn-back">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
    </div>

    <script>
        const API_BASE = ''; // æœ¬åœ°ç”¨ç©ºå­—ä¸²

        // 1. å•Ÿå‹•ç›¸æ©Ÿ
        const video = document.getElementById('camera-feed');
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { document.getElementById('status').innerText = "ç›¸æ©ŸéŒ¯èª¤: " + err.message; });

        // 2. å–å¾—ä»»å‹™è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘ä¸»è¦ä¾è³´ API å›å‚³çš„åº§æ¨™ï¼Œä½†å¦‚æœç¶²å€æœ‰å‚³ lat/lng ä¹Ÿæœƒå…ˆç”¨
        let targetLat = parseFloat(urlParams.get('lat'));
        let targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');

        // è¼‰å…¥ä»»å‹™è©³æƒ… (ç‚ºäº†æ‹¿ YouTube é€£çµ)
        if (taskId) {
            fetch(`${API_BASE}/api/tasks/${taskId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.task) {
                        const task = data.task;
                        
                        // æ›´æ–°åº§æ¨™ (ä»¥è³‡æ–™åº«ç‚ºæº–)
                        if (task.lat && task.lng) {
                            targetLat = task.lat;
                            targetLng = task.lng;
                        }

                        const chestObj = document.getElementById('chest-obj');
                        const chestImg = document.getElementById('chest-img');
                        const videoFrame = document.getElementById('video-frame');
                        let hasImage = false;
                        let hasVideo = false;

                        // æª¢æŸ¥æ˜¯å¦æœ‰ AR å°ˆç”¨åœ–ç‰‡
                        if (task.ar_image_url) {
                            chestImg.src = task.ar_image_url;
                            chestImg.style.display = 'block';
                            hasImage = true;
                        }

                        // æª¢æŸ¥æ˜¯å¦æœ‰ YouTube é€£çµ
                        if (task.youtubeUrl) {
                            const ytId = extractYouTubeId(task.youtubeUrl);
                            if (ytId) {
                                videoFrame.style.display = 'block';
                                document.getElementById('yt-player').src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1&playsinline=1`;
                                hasVideo = true;
                            }
                        }

                        // å¦‚æœéƒ½æ²’æœ‰ï¼Œé¡¯ç¤ºé è¨­å¯¶ç®±
                        if (!hasImage && !hasVideo) {
                            chestImg.src = '/images/mascot.png';
                            chestImg.style.display = 'block';
                            hasImage = true;
                        }

                        // è¨­å®šå®¹å™¨é¡åˆ¥ï¼ˆç”¨æ–¼æ¨£å¼èª¿æ•´ï¼‰
                        if (hasImage && hasVideo) {
                            chestObj.className = 'has-both';
                        } else if (hasImage) {
                            chestObj.className = 'only-image';
                        } else if (hasVideo) {
                            chestObj.className = 'only-video';
                        }
                    }
                })
                .catch(err => console.error("ç„¡æ³•è¼‰å…¥ä»»å‹™è©³æƒ…:", err));
        }

        document.getElementById('btn-back').onclick = () => {
            if (taskId) window.location.href = `/task-detail.html?id=${taskId}`;
            else window.history.back();
        };

        // é»æ“Šäº‹ä»¶ (ç„¡è«–æ˜¯å½±ç‰‡é‚„æ˜¯åœ–ç‰‡ï¼Œé»æ“Šå¤–æ¡†éƒ½ç®—å®Œæˆ)
        document.getElementById('chest-obj').onclick = () => {
            if (taskId) {
                window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
            } else {
                alert("æ¸¬è©¦æ¨¡å¼ï¼šç›®æ¨™å·²æ‰¾åˆ°ï¼");
            }
        };

        // 3. æ„Ÿæ¸¬å™¨èˆ‡ AR é‚è¼¯
        const chest = document.getElementById('chest-obj');
        const arrow = document.getElementById('guide-arrow');
        const debug = document.getElementById('debug-info');
        const status = document.getElementById('status');
        const startSensorBtn = document.getElementById('start-sensor-btn');
        
        let userLat = null, userLng = null;
        let deviceHeading = 0;
        let sensorActive = false;

        // iOS 13+ éœ€è¦ä½¿ç”¨è€…äº’å‹•æ‰èƒ½é–‹å•Ÿæ„Ÿæ¸¬å™¨æ¬Šé™
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            startSensorBtn.style.display = 'block';
            startSensorBtn.onclick = () => {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startSensorBtn.style.display = 'none';
                            initSensors();
                        } else {
                            alert('éœ€è¦æ„Ÿæ¸¬å™¨æ¬Šé™æ‰èƒ½é‹ä½œ AR');
                        }
                    })
                    .catch(console.error);
            };
        } else {
            // Android æˆ–èˆŠç‰ˆ iOS ç›´æ¥å•Ÿå‹•
            initSensors();
        }

        function initSensors() {
            sensorActive = true;
            
            // å•Ÿå‹• GPS
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    pos => {
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        updateAR();
                    },
                    err => {
                        status.innerText = "GPS éŒ¯èª¤: " + err.message;
                        console.error(err);
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
            }

            // å•Ÿå‹•ç¾…ç›¤
            window.addEventListener('deviceorientation', event => {
                if (event.webkitCompassHeading) {
                    deviceHeading = event.webkitCompassHeading;
                } else if (event.alpha) {
                    deviceHeading = 360 - event.alpha;
                }
                updateAR();
            }, true);
        }

        if ('geolocation' in navigator) {
            // å³ä½¿é‚„æ²’é»æŒ‰éˆ•ï¼Œå…ˆå·è·‘ GPS (ä¸æ¶‰åŠ DeviceOrientation)
            navigator.geolocation.watchPosition(
                pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    // å¦‚æœæŒ‰éˆ•é‚„åœ¨é¡¯ç¤ºï¼Œå…ˆåªæ›´æ–°ç‹€æ…‹æ–‡å­—
                    if (!sensorActive) {
                        status.innerText = `GPS å·²é–å®š (ç­‰å¾…æ„Ÿæ¸¬å™¨)`;
                    } else {
                        updateAR();
                    }
                },
                err => status.innerText = "GPS å®šä½ä¸­...", 
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        function updateAR() {
            if (!userLat || !targetLat) {
                status.innerText = `GPS å®šä½ä¸­... (ç›®æ¨™:${targetLat},${targetLng})`;
                return;
            }

            const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
            const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            
            status.innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
            
            let delta = bearing - deviceHeading;
            while (delta < -180) delta += 360;
            while (delta > 180) delta -= 360;

            debug.innerText = `æ–¹ä½:${bearing.toFixed(0)}Â° æ‰‹æ©Ÿ:${deviceHeading.toFixed(0)}Â° å·®:${delta.toFixed(0)}Â°\nGPS: ${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;
            // ... å¾ŒçºŒé‚è¼¯ä¸è®Š ...

            const fov = 30; 

            if (Math.abs(delta) < fov) {
                arrow.style.display = 'none';
                chest.style.display = 'block';

                const screenWidth = window.innerWidth;
                const xOffset = (delta / fov) * (screenWidth / 2);
                
                // è·é›¢ç¸®æ”¾
                let scale = 1.2 - (Math.min(dist, 50) / 60); 
                if (scale < 0.4) scale = 0.4;

                chest.style.transform = `translate(${xOffset}px, 0) scale(${scale})`;

            } else {
                chest.style.display = 'none';
                arrow.style.display = 'block';
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`; 
            }
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin((destLng-startLng) * Math.PI/180) * Math.cos(destLat * Math.PI/180);
            const x = Math.cos(startLat * Math.PI/180) * Math.sin(destLat * Math.PI/180) -
                    Math.sin(startLat * Math.PI/180) * Math.cos(destLat * Math.PI/180) * Math.cos((destLng-startLng) * Math.PI/180);
            const brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : null;
        }
    </script>
</body>
</html>