<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <!-- Look-at component (ç¢ºä¿ç‰©ä»¶é¢å‘é¡é ­) -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        .ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 999;
            pointer-events: none;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .info-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 999;
        }
        
        /* 2D å°èˆªç®­é ­ (é è·é›¢ç”¨) */
        #arrow-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 900;
            pointer-events: none;
            display: none;
        }
        #nav-arrow {
            width: 0; 
            height: 0; 
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-bottom: 80px solid rgba(255, 0, 0, 0.8);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
            transform-origin: center bottom;
        }
        .arrow-text {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="info-box">
        <div id="status">æ­£åœ¨å®šä½ä¸­...</div>
        <div id="dist-debug" style="font-size: 1.2em; font-weight: bold; color: #ffeb3b;"></div>
        <div id="debug-log" style="font-size: 0.8em; color: #ccc;"></div>
    </div>

    <!-- 2D å°èˆªç®­é ­ -->
    <div id="arrow-container">
        <div id="nav-arrow"></div>
        <div class="arrow-text">ç›®æ¨™æ–¹å‘</div>
    </div>

    <div class="ui-overlay">
        <button id="backBtn" class="btn">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true;" 
    >
        <a-assets>
            <img id="mascot-img" src="/images/mascot.png">
        </a-assets>

        <!-- å¢åŠ ç’°å¢ƒå…‰ï¼Œç¢ºä¿ 3D ç‰©ä»¶ä¸æœƒè®Šé»‘ -->
        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" color="#ffffff" intensity="1" position="-1 1 0"></a-light>

        <a-camera gps-camera rotation-reader>
            <!-- é€™è£¡ä¸æ›è¼‰ä»»ä½•å­ç‰©ä»¶ï¼Œç¢ºä¿ä½¿ç”¨ä¸–ç•Œåº§æ¨™ -->
        </a-camera>

        <!-- 
            3D å¯¶ç®±å¯¦é«” 
            åˆå§‹éš±è—ï¼Œç­‰åˆ° GPS å®šä½å¾Œå†é¡¯ç¤º
            ä½¿ç”¨ look-at="[gps-camera]" ç¢ºä¿æ°¸é é¢å‘ä½¿ç”¨è€…
        -->
        <a-image
            id="ar-chest"
            src="#mascot-img"
            scale="5 5 5"
            visible="false"
            look-at="[gps-camera]"
            position="0 0 -100" 
            animation="property: position; to: 0 0.5 0; dir: alternate; dur: 2000; loop: true; easing: easeInOutSine"
        ></a-image>

    </a-scene>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetLat = parseFloat(urlParams.get('lat'));
        const targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');

        document.getElementById('backBtn').onclick = function() {
            if (taskId) {
                window.location.href = `/task-detail.html?id=${taskId}`;
            } else {
                window.history.back();
            }
        };

        if (!targetLat || !targetLng) {
            document.getElementById('status').innerText = "éŒ¯èª¤ï¼šç„¡æ•ˆçš„ä»»å‹™åº§æ¨™";
        } else {
            const arChest = document.getElementById('ar-chest');
            const arrowContainer = document.getElementById('arrow-container');
            const navArrow = document.getElementById('nav-arrow');
            
            let userLat = null;
            let userLng = null;
            let userHeading = 0;
            
            // ç‹€æ…‹è®Šæ•¸
            let isNearbyMode = false;
            let nearbyLat = null;
            let nearbyLng = null;

            // 1. åˆå§‹åŒ–é è™•ç›®æ¨™
            arChest.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);

            // ç›£è½ GPS æ›´æ–°
            window.addEventListener('gps-camera-update-position', function(e) {
                userLat = e.detail.position.latitude;
                userLng = e.detail.position.longitude;
                
                // è¨ˆç®—å¯¦éš›è·é›¢
                const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
                document.getElementById('dist-debug').innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
                
                // æ ¸å¿ƒé‚è¼¯
                updateARLogic(dist);
            });

            // ç›£è½ç¾…ç›¤
            window.addEventListener('deviceorientation', function(event) {
                if (event.webkitCompassHeading) {
                    userHeading = event.webkitCompassHeading;
                } else if (event.alpha) {
                    userHeading = 360 - event.alpha;
                }
                
                if (userLat) {
                    updateArrowRotation();
                }
            });

            function updateARLogic(dist) {
                // å¦‚æœé€²å…¥ 15 å…¬å°ºå…§ï¼Œåˆ‡æ›ç‚ºè¿‘è·é›¢æ¨¡å¼
                if (dist < 15) {
                    if (!isNearbyMode) {
                        // === åˆ‡æ›åˆ°è¿‘è·é›¢æ¨¡å¼ ===
                        isNearbyMode = true;
                        
                        // è¨ˆç®—ã€Œä½¿ç”¨è€…æ­£å‰æ–¹ 3 å…¬å°ºã€çš„è™›æ“¬åº§æ¨™
                        // é€™æ¨£å¯¶ç®±å°±æœƒå‡ºç¾åœ¨ä½¿ç”¨è€…é¢å‰ï¼Œè€Œä¸æ˜¯é ­é ‚æˆ–è…³ä¸‹
                        const forwardPosition = calculateDestination(userLat, userLng, 3, userHeading);
                        nearbyLat = forwardPosition.lat;
                        nearbyLng = forwardPosition.lng;
                        
                        // æ›´æ–°å¯¶ç®±ä½ç½®åˆ°é€™å€‹æ–°åº§æ¨™
                        arChest.setAttribute('gps-entity-place', `latitude: ${nearbyLat}; longitude: ${nearbyLng};`);
                        
                        // æ”¾å¤§å¯¶ç®± (è¿‘è·é›¢çœ‹èµ·ä¾†è¦æœ‰é­„åŠ›)
                        arChest.setAttribute('scale', '4 4 4');
                        arChest.setAttribute('visible', 'true');
                        
                        // éš±è—å°èˆªç®­é ­
                        arrowContainer.style.display = 'none';
                        
                        document.getElementById('status').innerText = "ç›®æ¨™å°±åœ¨çœ¼å‰ï¼";
                        document.getElementById('debug-log').innerText = "æ¨¡å¼: 3D è¿‘è·é›¢ (Re-anchored)";
                    } else {
                        // å¦‚æœå·²ç¶“åœ¨è¿‘è·é›¢æ¨¡å¼ï¼Œæˆ‘å€‘ä¿æŒå¯¶ç®±ä½ç½®ä¸è®Š
                        // é€™æ¨£ä½¿ç”¨è€…å¯ä»¥ç¹è‘—å®ƒèµ° (True 3D experience)
                        // é™¤éè·é›¢è®Šå¾—å¤ªé  (>20m)ï¼Œæ‰é‡ç½®
                    }
                } else {
                    if (isNearbyMode && dist > 20) {
                        // === åˆ‡æ›å›é è·é›¢æ¨¡å¼ ===
                        isNearbyMode = false;
                        
                        // æ¢å¾©åˆ°çœŸå¯¦ GPS åº§æ¨™
                        arChest.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
                        arChest.setAttribute('scale', '10 10 10'); // é è™•è¦å¤§ä¸€é»æ‰çœ‹å¾—åˆ°
                        arChest.setAttribute('visible', 'true');
                        
                        document.getElementById('status').innerText = "è·Ÿéš¨ç®­é ­å°‹æ‰¾ç›®æ¨™";
                        document.getElementById('debug-log').innerText = "æ¨¡å¼: 3D å°èˆª (GPS)";
                    }
                    
                    if (!isNearbyMode) {
                        arrowContainer.style.display = 'block';
                        document.getElementById('status').innerText = "è·Ÿéš¨ç®­é ­å°‹æ‰¾ç›®æ¨™";
                    }
                }
            }

            function updateArrowRotation() {
                if (arrowContainer.style.display === 'none') return;
                const targetBearing = calculateBearing(userLat, userLng, targetLat, targetLng);
                let arrowRotation = targetBearing - userHeading;
                navArrow.style.transform = `rotate(${arrowRotation}deg)`;
            }

            // --- æ•¸å­¸è¨ˆç®—å‡½å¼ ---

            // è¨ˆç®—ç›®æ¨™é»åº§æ¨™ (çµ¦å®šèµ·é»ã€è·é›¢ã€æ–¹ä½è§’)
            function calculateDestination(lat, lng, distMeters, bearing) {
                const R = 6371e3; // åœ°çƒåŠå¾‘ (ç±³)
                const angularDist = distMeters / R;
                const radLat = toRadians(lat);
                const radLng = toRadians(lng);
                const radBearing = toRadians(bearing);

                const destLat = Math.asin(Math.sin(radLat) * Math.cos(angularDist) + 
                                        Math.cos(radLat) * Math.sin(angularDist) * Math.cos(radBearing));
                const destLng = radLng + Math.atan2(Math.sin(radBearing) * Math.sin(angularDist) * Math.cos(radLat), 
                                                    Math.cos(angularDist) - Math.sin(radLat) * Math.sin(destLat));
                
                return {
                    lat: toDegrees(destLat),
                    lng: toDegrees(destLng)
                };
            }

            function calculateBearing(startLat, startLng, destLat, destLng) {
                const startLatRad = toRadians(startLat);
                const startLngRad = toRadians(startLng);
                const destLatRad = toRadians(destLat);
                const destLngRad = toRadians(destLng);
                const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
                const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                        Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
                let brng = Math.atan2(y, x);
                brng = toDegrees(brng);
                return (brng + 360) % 360;
            }

            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; 
                const Ï†1 = toRadians(lat1);
                const Ï†2 = toRadians(lat2);
                const Î”Ï† = toRadians(lat2 - lat1);
                const Î”Î» = toRadians(lon2 - lon1);
                const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                        Math.cos(Ï†1) * Math.cos(Ï†2) *
                        Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function toRadians(degrees) { return degrees * Math.PI / 180; }
            function toDegrees(radians) { return radians * 180 / Math.PI; }
        }
    </script>
</body>
</html>