<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å°‹æ‰¾ç·šç´¢</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        /* ç›¸æ©ŸèƒŒæ™¯ */
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* UI å±¤ */
        .ui-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .info-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            pointer-events: auto;
        }

        .btn-back {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: auto;
            cursor: pointer;
            z-index: 20;
        }

        /* è™›æ“¬ä¸–ç•Œå±¤ (ç”¨ä¾†æ”¾å¯¶ç®±) */
        #ar-world {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5;
            perspective: 800px; /* 3D é€è¦–æ„Ÿ */
            pointer-events: none;
            overflow: hidden;
        }

        /* å¯¶ç®±ç‰©ä»¶ */
        #chest-obj {
            position: absolute;
            top: 50%; left: 50%;
            width: 200px; height: 200px;
            margin-left: -100px; margin-top: -100px;
            transform-style: preserve-3d;
            display: none; /* åˆå§‹éš±è— */
        }
        
        #chest-img {
            width: 100%; height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* å°èˆªç®­é ­ (ç•¶å¯¶ç®±åœ¨ç•«é¢å¤–æ™‚é¡¯ç¤º) */
        #guide-arrow {
            position: absolute;
            top: 50%; left: 50%;
            width: 60px; height: 60px;
            margin-left: -30px; margin-top: -30px;
            display: none;
        }
        #guide-arrow::after {
            content: '';
            display: block;
            width: 100%; height: 100%;
            border-top: 10px solid #ff3b30;
            border-right: 10px solid #ff3b30;
            transform: rotate(45deg);
            box-shadow: 2px -2px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <!-- ç›¸æ©Ÿç•«é¢ -->
    <video id="camera-feed" autoplay playsinline muted></video>

    <!-- AR ä¸–ç•Œ -->
    <div id="ar-world">
        <!-- å¯¶ç®± -->
        <div id="chest-obj" style="cursor: pointer;">
            <img id="chest-img" src="/images/mascot.png" alt="å¯¶ç®±">
            <div style="color:white; text-align:center; text-shadow:0 2px 2px black; font-weight:bold; margin-top:10px;">é»æ“Šé–‹å•Ÿ!</div>
        </div>
        <!-- å°èˆªç®­é ­ -->
        <div id="guide-arrow"></div>
    </div>

    <!-- UI -->
    <div class="ui-layer">
        <div class="info-box">
            <div id="status">å•Ÿå‹•ç›¸æ©Ÿä¸­...</div>
            <div id="debug-info" style="font-size:0.8em; color:#ffeb3b; margin-top:5px;"></div>
        </div>
        <button id="btn-back" class="btn-back">ğŸ”™ è¿”å›å¡«å¯«ç­”æ¡ˆ</button>
    </div>

    <script>
        // 1. å•Ÿå‹•ç›¸æ©Ÿ
        const video = document.getElementById('camera-feed');
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                document.getElementById('status').innerText = "ç„¡æ³•å­˜å–ç›¸æ©Ÿ: " + err.message;
            });

        // 2. å–å¾—ä»»å‹™åº§æ¨™
        const urlParams = new URLSearchParams(window.location.search);
        const targetLat = parseFloat(urlParams.get('lat'));
        const targetLng = parseFloat(urlParams.get('lng'));
        const taskId = urlParams.get('taskId');

        document.getElementById('btn-back').onclick = () => {
            if (taskId) window.location.href = `/task-detail.html?id=${taskId}`;
            else window.history.back();
        };

        // é»æ“Šå¯¶ç®±äº‹ä»¶
        document.getElementById('chest-obj').onclick = () => {
            if (taskId) {
                // å¸¶ä¸Š ar_found=true åƒæ•¸å›åˆ°ä»»å‹™é 
                window.location.href = `/task-detail.html?id=${taskId}&ar_found=true`;
            } else {
                alert("æ¸¬è©¦æ¨¡å¼ï¼šå¯¶ç®±å·²é–‹å•Ÿï¼");
            }
        };

        // 3. æ„Ÿæ¸¬å™¨é‚è¼¯
        const chest = document.getElementById('chest-obj');
        const arrow = document.getElementById('guide-arrow');
        const debug = document.getElementById('debug-info');
        const status = document.getElementById('status');
        
        let userLat = null, userLng = null;
        let deviceHeading = 0; // æ‰‹æ©Ÿæœå‘ (0=åŒ—, 90=æ±)

        // å•Ÿå‹• GPS
        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(
                pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    updateAR();
                },
                err => status.innerText = "GPS éŒ¯èª¤: " + err.message,
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
            );
        }

        // å•Ÿå‹•ç¾…ç›¤
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', event => {
                // iOS ä½¿ç”¨ webkitCompassHeading, Android ä½¿ç”¨ alpha (éœ€æ ¡æ­£)
                if (event.webkitCompassHeading) {
                    deviceHeading = event.webkitCompassHeading;
                } else if (event.alpha) {
                    // ç°¡æ˜“ Android ä¿®æ­£ (å¯¦éš›ä¸Š Android çš„ alpha 0 ä¸¦éç¸½æ˜¯åŒ—æ–¹ï¼Œé€šå¸¸éœ€è¦ getRotationMatrix)
                    // ä½†ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆå‡è¨­ alpha æ˜¯ç›¸å°çš„ï¼Œæˆ–è€…ä½¿ç”¨ absolute æ¨¡å¼
                    deviceHeading = 360 - event.alpha;
                }
                updateAR();
            }, true);
        }

        // æ ¸å¿ƒ AR é‹ç®—
        function updateAR() {
            if (!userLat || !targetLat) return;

            // è¨ˆç®—è·é›¢èˆ‡æ–¹ä½
            const dist = haversineDistance(userLat, userLng, targetLat, targetLng);
            const bearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            
            status.innerText = `è·é›¢ç›®æ¨™: ${dist.toFixed(0)}m`;
            
            // è¨ˆç®—ã€Œç›®æ¨™æ–¹ä½ã€èˆ‡ã€Œæ‰‹æ©Ÿæœå‘ã€çš„è§’åº¦å·® (Delta Angle)
            // ä¾‹å¦‚ï¼šç›®æ¨™åœ¨æ­£åŒ— (0åº¦)ï¼Œæˆ‘æœå‘æ± (90åº¦)ï¼Œå·®å€¼ç‚º -90åº¦ (ç›®æ¨™åœ¨æˆ‘çš„å·¦é‚Š)
            let delta = bearing - deviceHeading;
            // æ­£è¦åŒ–åˆ° -180 ~ 180
            while (delta < -180) delta += 360;
            while (delta > 180) delta -= 360;

            debug.innerText = `æ–¹ä½: ${bearing.toFixed(0)}Â° / æ‰‹æ©Ÿ: ${deviceHeading.toFixed(0)}Â° / å·®: ${delta.toFixed(0)}Â°`;

            // è¦–é‡ç¯„åœ (FOV) å‡è¨­ç‚º 60åº¦ (å·¦å³å„ 30åº¦)
            const fov = 30; 

            if (Math.abs(delta) < fov) {
                // === ç›®æ¨™åœ¨è¦–é‡å…§ ===
                arrow.style.display = 'none';
                chest.style.display = 'block';

                // è¨ˆç®—è¢å¹•ä¸Šçš„æ°´å¹³ä½ç½® (CSS transform)
                // å·® 0 åº¦ -> æ­£ä¸­é–“ (0px)
                // å·® -30 åº¦ -> æœ€å·¦é‚Š
                // å·® +30 åº¦ -> æœ€å³é‚Š
                // ç°¡å–®æ˜ å°„ï¼šæ¯ 1 åº¦ = 10px ä½ç§» (é€™å¯ä»¥æ ¹æ“šè¢å¹•å¯¬åº¦èª¿æ•´)
                const screenWidth = window.innerWidth;
                const xOffset = (delta / fov) * (screenWidth / 2);
                
                // è·é›¢è¶Šé ï¼Œå¯¶ç®±è¶Šå° (ç°¡å–®é€è¦–)
                // 5m å…§æœ€å¤§ (scale 1.5)ï¼Œ50m å¤–æœ€å° (scale 0.5)
                let scale = 1.5 - (Math.min(dist, 50) / 50); 
                if (scale < 0.5) scale = 0.5;

                chest.style.transform = `translate(${xOffset}px, 0) scale(${scale})`;

            } else {
                // === ç›®æ¨™åœ¨è¦–é‡å¤– ===
                chest.style.display = 'none';
                arrow.style.display = 'block';
                
                // æ—‹è½‰ç®­é ­æŒ‡å‘ç›®æ¨™
                // å¦‚æœ delta æ˜¯è² çš„ (ç›®æ¨™åœ¨å·¦)ï¼Œç®­é ­æŒ‡å·¦ (-90åº¦)
                // å¦‚æœ delta æ˜¯æ­£çš„ (ç›®æ¨™åœ¨å³)ï¼Œç®­é ­æŒ‡å³ (90åº¦)
                // é€™è£¡æˆ‘å€‘åšä¸€å€‹å¹³æ»‘æ—‹è½‰
                arrow.style.transform = `rotate(${delta}deg) translate(0, -100px)`; // å¾€è©²æ–¹å‘åç§»
            }
        }

        // --- æ•¸å­¸å·¥å…· ---
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin((destLng-startLng) * Math.PI/180) * Math.cos(destLat * Math.PI/180);
            const x = Math.cos(startLat * Math.PI/180) * Math.sin(destLat * Math.PI/180) -
                    Math.sin(startLat * Math.PI/180) * Math.cos(destLat * Math.PI/180) * Math.cos((destLng-startLng) * Math.PI/180);
            const brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }
    </script>
</body>
</html>