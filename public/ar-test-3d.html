<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR 3D Test</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <!-- Look-at component (optional, makes model face user) -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        .debug-ui {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            z-index: 99999; /* æé«˜ z-index ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto; /* ç¢ºä¿å¯ä»¥æ¥æ”¶é»æ“Šäº‹ä»¶ */
        }
        .debug-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto;
        }
        button {
            padding: 10px 15px; /* åŠ å¤§æŒ‰éˆ•é»æ“Šå€åŸŸ */
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100000; /* æŒ‰éˆ•å±¤ç´šå†é«˜ä¸€é» */
            position: relative; /* ç¢ºä¿ z-index ç”Ÿæ•ˆ */
        }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #0f0;
            padding: 5px;
            z-index: 9999;
            pointer-events: none;
        }
        .toast-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-size: 16px;
            max-width: 80%;
        }
        .toast-message.show {
            opacity: 1;
        }
        
        /* === é—œéµä¿®æ­£ï¼šå¼·åˆ¶ 3D ç•«å¸ƒåœ¨ç›¸æ©Ÿç•«é¢ä¹‹ä¸Š === */
        .a-canvas {
            z-index: 500 !important; /* 3D ç•«å¸ƒ */
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }
        #arjs-video {
            z-index: 100 !important; /* ç›¸æ©Ÿç•«é¢ */
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            display: block !important;
        }
        body {
            background-color: transparent !important; /* ç¢ºä¿èƒŒæ™¯é€æ˜ */
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div id="info">GPS AR 3D æ¸¬è©¦æ¨¡å¼ (v2.0 RedBox)</div>

    <div class="debug-ui">
        <div class="debug-row">
            <span>Scale (å¤§å°): <span id="scale-val">0.5</span></span>
            <input type="range" id="scale-slider" min="0.1" max="50" step="0.1" value="0.5">
        </div>
        <div class="debug-row">
            <span>Height (é«˜åº¦): <span id="height-val">0</span></span>
            <input type="range" id="height-slider" min="-10" max="10" step="0.5" value="0">
        </div>
        <div class="debug-row">
            <button id="set-loc-btn">ğŸ“ GPS æ”¾ç½® (åŒ—æ–¹)</button>
            <button id="force-show-btn" style="background: #28a745;">ğŸ‘ï¸ å¼·åˆ¶çœ¼å‰ (ç„¡ GPS)</button>
        </div>
        <div class="debug-row">
            <span id="dist-val">è·é›¢: ? m</span>
            <span id="gps-acc">ç²¾åº¦: ?</span>
        </div>
        <div class="debug-row">
            <span>æ¨¡æ“¬ GPS: </span>
            <button onclick="simulateMove(0.0001, 0)">åŒ—ç§»</button>
            <button onclick="simulateMove(-0.0001, 0)">å—ç§»</button>
        </div>
    </div>

    <!-- 
        vr-mode-ui="enabled: false": é—œé–‰å³ä¸‹è§’çš„ VR çœ¼é¡æŒ‰éˆ•
        arjs: è¨­å®š AR.js åƒæ•¸ï¼ŒsourceType: webcam é–‹å•Ÿç›¸æ©Ÿ
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true;">

        <!-- é è¼‰è³‡æºï¼šæ”¹ç”¨æœ¬åœ°æª”æ¡ˆ -->
        <a-assets>
            <a-asset-item id="animated-model" src="/models/CesiumMan.glb"></a-asset-item>
        </a-assets>

        <!-- 
            gps-camera: è™•ç† GPS å®šä½
            rotation-reader: è™•ç†ç¾…ç›¤æ–¹å‘
            minDistance: æœ€å°é¡¯ç¤ºè·é›¢
            maxDistance: æœ€å¤§é¡¯ç¤ºè·é›¢
        -->
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- 
            3D å¯¦é«” 
            gps-entity-place: è¨­å®šç¶“ç·¯åº¦ (æœƒåœ¨ JS ä¸­å‹•æ…‹è¨­å®š)
            gltf-model: æŒ‡å®šæ¨¡å‹
            animation-mixer: æ’­æ”¾å‹•ç•«
            look-at: è®“æ¨¡å‹æ°¸é é¢å‘é¡é ­
        -->
        
        <!-- ä¸€å€‹ç´…è‰²çš„åƒè€ƒæ–¹å¡Šï¼Œç”¨ä¾†ç¢ºèªæ¸²æŸ“å¼•æ“æ˜¯å¦æ­£å¸¸é‹ä½œ -->
        <a-box id="ref-box" position="0 0 -3" scale="0.5 0.5 0.5" color="red" visible="false"></a-box>

        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="5 5 5"
            look-at="[gps-camera]"
            position="0 0 0">
        </a-entity>

    </a-scene>

    <script>
        const forceShowBtn = document.getElementById('force-show-btn');
        const setLocBtn = document.getElementById('set-loc-btn');
        const distDisplay = document.getElementById('dist-val');
        const gpsAccDisplay = document.getElementById('gps-acc');
        const infoDiv = document.getElementById('info');
        
        // UI Controls
        const scaleSlider = document.getElementById('scale-slider');
        const heightSlider = document.getElementById('height-slider');
        const scaleVal = document.getElementById('scale-val');
        const heightVal = document.getElementById('height-val');

        // å…¨å±€éŒ¯èª¤æ•æ‰
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            // å¿½ç•¥ä¸€äº›ä¸å½±éŸ¿é‹ä½œçš„è­¦å‘Š
            if (msg.includes('Script error')) return false;
            showToast('âš ï¸ éŒ¯èª¤: ' + msg, 5000);
            return false;
        };
        
        // ç¢ºä¿æ¨¡å‹å…ƒç´ å­˜åœ¨
        const arModel = document.getElementById('ar-model');

        // æ¨¡å‹è¼‰å…¥ç‹€æ…‹ç›£è½
        arModel.addEventListener('model-loaded', () => {
            showToast('âœ… 3D æ¨¡å‹è¼‰å…¥æˆåŠŸï¼');
            infoDiv.innerText += ' | æ¨¡å‹ OK';
            infoDiv.style.color = '#0f0';
            arModel.setAttribute('scale', '2 2 2');
            scaleSlider.value = 2;
            scaleVal.textContent = '2';
        });

        arModel.addEventListener('model-error', (e) => {
            console.error('Model failed to load:', e);
            showToast('âŒ 3D æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ã€‚', 5000);
            infoDiv.innerText += ' | æ¨¡å‹å¤±æ•—';
            infoDiv.style.color = '#f00';
        });

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.innerText = message;
            document.body.appendChild(toast);
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) document.body.removeChild(toast);
                }, 300);
            }, duration);
        }

        // èª¿æ•´å¤§å°
        scaleSlider.addEventListener('input', (e) => {
            const m = document.getElementById('ar-model'); // é‡æ–°ç²å–
            const val = e.target.value;
            m.setAttribute('scale', `${val} ${val} ${val}`);
            scaleVal.textContent = val;
        });

        // èª¿æ•´é«˜åº¦ (Yè»¸)
        heightSlider.addEventListener('input', (e) => {
            const m = document.getElementById('ar-model'); // é‡æ–°ç²å–
            const val = e.target.value;
            m.object3D.position.y = parseFloat(val);
            heightVal.textContent = val;
        });
        
        // å¼·åˆ¶æ”¾ç½®åœ¨é¡é ­å‰æ–¹ (ä¸ä½¿ç”¨ GPS)
        forceShowBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            try {
                showToast('âœ… æŒ‰éˆ•é»æ“Šç¢ºèªï¼è™•ç†ä¸­...', 1000);
                
                const m = document.getElementById('ar-model');
                const box = document.getElementById('ref-box'); // ç²å–ç´…è‰²æ–¹å¡Š
                
                // é¡¯ç¤ºç´…è‰²åƒè€ƒæ–¹å¡Š
                if (box) {
                    box.setAttribute('visible', 'true');
                    // å°‡æ–¹å¡Šä¹Ÿæ›åˆ°ç›¸æ©Ÿä¸‹
                    const camera = document.querySelector('a-camera');
                    if (box.parentNode !== camera) {
                        box.parentNode.removeChild(box);
                        camera.appendChild(box);
                    }
                    box.setAttribute('position', '0 0.5 -2'); // åœ¨ä¸Šæ–¹ä¸€é»
                }
                
                // ç§»é™¤ GPS å±¬æ€§ï¼Œæ”¹ç‚ºç´” 3D åº§æ¨™
                m.removeAttribute('gps-entity-place');
                m.removeAttribute('look-at');
                
                const camera = document.querySelector('a-camera');
                if (!camera) throw new Error('æ‰¾ä¸åˆ°ç›¸æ©Ÿå…ƒä»¶ (a-camera)');
                
                if (m.parentNode !== camera) {
                    m.parentNode.removeChild(m);
                    camera.appendChild(m);
                }
                
                // æ”¾å¤§æ¨¡å‹ï¼
                m.setAttribute('scale', '5 5 5'); 
                m.setAttribute('position', '0 -1 -3'); // å¾€å‰ 3 ç±³ï¼Œå¾€ä¸‹ 1 ç±³
                m.setAttribute('rotation', '0 180 0');
                
                // åŒæ­¥æ›´æ–° UI
                scaleSlider.value = 5;
                scaleVal.textContent = '5';
                
                infoDiv.innerText = "æ¨¡å¼: å¼·åˆ¶çœ¼å‰ (ç„¡ GPS)";
                distDisplay.innerText = "è·é›¢: N/A";
                
                showToast('æ¨¡å‹å·²å›ºå®šï¼\nè«‹çœ‹ç•«é¢ä¸­å¤® (ä¸Šæ–¹æ‡‰æœ‰ç´…è‰²æ–¹å¡Š)');
            } catch (err) {
                console.error(err);
                showToast('æŒ‰éˆ•åŸ·è¡ŒéŒ¯èª¤: ' + err.message);
            }
        });

        // æŒ‰ä¸‹æŒ‰éˆ•æ™‚ï¼Œå°‡æ¨¡å‹æ”¾ç½®åœ¨ä½¿ç”¨è€…ç•¶å‰ä½ç½®çš„"ç¨å¾®å‰é¢ä¸€é»"
        setLocBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            try {
                const m = document.getElementById('ar-model'); // é‡æ–°ç²å–
                const scene = document.querySelector('a-scene');
                const camera = document.querySelector('a-camera');
                
                if (m.parentNode === camera) {
                    m.parentNode.removeChild(m);
                    scene.appendChild(m);
                    m.setAttribute('look-at', '[gps-camera]');
                }

                if (navigator.geolocation) {
                    showToast('æ­£åœ¨ç²å– GPS...', 1000);
                    navigator.geolocation.getCurrentPosition((position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const acc = position.coords.accuracy;
                        
                        gpsAccDisplay.innerText = `ç²¾åº¦: ${acc.toFixed(0)}m`;
                        
                        const newLat = lat + 0.000015; 
                        const newLng = lng;

                        console.log(`Setting model to: ${newLat}, ${newLng}`);
                        
                        m.setAttribute('gps-entity-place', `latitude: ${newLat}; longitude: ${newLng};`);
                        m.setAttribute('scale', '2 2 2');
                        scaleSlider.value = 2;
                        scaleVal.textContent = '2';
                        
                        m.object3D.position.y = 0;
                        heightSlider.value = 0;
                        heightVal.textContent = '0';
                        
                        infoDiv.innerText = "æ¨¡å¼: GPS å®šä½";

                        showToast(`æ¨¡å‹å·²æ”¾ç½®åœ¨åŒ—æ–¹ç´„ 1.5 å…¬å°ºè™•ï¼\nç²¾åº¦: ${acc.toFixed(0)}m\nLat: ${newLat.toFixed(6)}\nLng: ${newLng.toFixed(6)}`);

                    }, (err) => {
                        showToast('ç„¡æ³•ç²å– GPS: ' + err.message);
                    }, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                } else {
                    showToast('ç€è¦½å™¨ä¸æ”¯æ´ Geolocation');
                }
            } catch (err) {
                console.error(err);
                showToast('æŒ‰éˆ•åŸ·è¡ŒéŒ¯èª¤: ' + err.message);
            }
        });

        // ç›£è½è·é›¢äº‹ä»¶ (AR.js ç‰¹æœ‰äº‹ä»¶)
        arModel.addEventListener('gps-entity-place-update-positon', (event) => {
            if(event.detail.distance) {
                distDisplay.textContent = `è·é›¢: ${event.detail.distance.toFixed(1)} m`;
            }
        });
        
        // æ¨¡æ“¬ç§»å‹• (æ¸¬è©¦ç”¨)
        window.simulateMove = function(dLat, dLng) {
            console.log('Simulate move not fully implemented via JS buttons yet, rely on real GPS');
        };

    </script>
</body>
</html>