<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR 3D Showcase</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <!-- åŠ å…¥ look-at å¥—ä»¶ï¼Œè®“æ–‡å­—æ°¸é é¢å‘ä½¿ç”¨è€… -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        .debug-ui {
            position: fixed; bottom: 20px; left: 0; width: 100%; z-index: 99999;
            background: transparent; 
            padding: 10px;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .status-badge {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: sans-serif;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div id="status-log" class="status-badge">ğŸ“¡ ç­‰å¾… GPS å®šä½...</div>
        <button id="place-btn" class="status-badge" style="margin-top: 10px; background: rgba(0,200,100,0.8); pointer-events: auto; display: none;">ğŸ“ åœ¨åŒ—æ–¹ 2 å…¬å°ºæ”¾ç½® (ä¸¦é¡¯ç¤ºæ–¹ä½)</button>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: è§£æ±ºæ·±åº¦é–ƒçˆ
        - colorManagement: ç¢ºä¿ GLTF é¡è‰²æ­£ç¢º
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
        - videoTexture: true (å˜—è©¦å„ªåŒ–æ•ˆèƒ½ï¼Œè‹¥æœ‰å•é¡Œå¯ç§»é™¤)
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false; videoTexture: true;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <a-asset-item id="animated-model" src="/models/result.glb"></a-asset-item>
        </a-assets>

        <!-- minDistance: 0 ç¢ºä¿å†è¿‘ä¹Ÿèƒ½çœ‹åˆ°ï¼ŒmaxDistance: 100 é™åˆ¶é¡¯ç¤ºç¯„åœ -->
        <a-camera gps-camera="minDistance: 0; maxDistance: 100;" rotation-reader></a-camera>

        <!-- åˆå§‹ç„¡ gps-entity-placeï¼Œç­‰å¾…æŒ‰éˆ•è§¸ç™¼è¨­å®š -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="3 3 3"
            position="0 0 0"
            visible="false"> 
        </a-entity>

        <!-- æ”¹ç”¨ç«‹é«”æŸ±å­ç•¶è·¯æ¨™ï¼Œç¢ºä¿å„å€‹è§’åº¦éƒ½çœ‹å¾—åˆ° -->
        <!-- åŒ— (ç´…) -->
        <a-cylinder id="dir-n" color="#ff0000" height="2" radius="0.1" position="0 1 0" visible="false"></a-cylinder>
        <!-- å— (è—) -->
        <a-cylinder id="dir-s" color="#0000ff" height="2" radius="0.1" position="0 1 0" visible="false"></a-cylinder>
        <!-- æ± (ç¶ ) -->
        <a-cylinder id="dir-e" color="#00ff00" height="2" radius="0.1" position="0 1 0" visible="false"></a-cylinder>
        <!-- è¥¿ (é»ƒ) -->
        <a-cylinder id="dir-w" color="#ffff00" height="2" radius="0.1" position="0 1 0" visible="false"></a-cylinder>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');
        const placeBtn = document.getElementById('place-btn');
        
        // æ–¹ä½å…ƒç´ 
        const dirN = document.getElementById('dir-n');
        const dirS = document.getElementById('dir-s');
        const dirE = document.getElementById('dir-e');
        const dirW = document.getElementById('dir-w');

        let currentCoords = null;
        let modelLoaded = false;

        // ç›£è½ GPS æ›´æ–°
        window.addEventListener('gps-camera-update-position', (e) => {
            if (!currentCoords) {
                // ç¬¬ä¸€æ¬¡æŠ“åˆ° GPS
                statusLog.innerText = "âœ… GPS å·²é–å®š";
                statusLog.style.backgroundColor = "rgba(40, 167, 69, 0.8)";
                if (modelLoaded) {
                    placeBtn.style.display = 'block';
                }
            }
            currentCoords = e.detail.position;
        });

        // ç›£è½æ¨¡å‹è¼‰å…¥
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            modelLoaded = true;
            if (currentCoords) {
                placeBtn.style.display = 'block';
                statusLog.innerText = "ğŸš€ æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šæ”¾ç½®";
            } else {
                statusLog.innerText = "â³ æ¨¡å‹ OKï¼Œç­‰å¾… GPS...";
            }
        });

        arModel.addEventListener('model-error', (e) => {
            console.error("Model Error:", e);
            statusLog.innerText = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—";
            statusLog.style.backgroundColor = "rgba(255, 0, 0, 0.6)";
        });

        // æ”¾ç½®æŒ‰éˆ•é‚è¼¯
        placeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentCoords) return;

            statusLog.innerText = "ğŸ“ è¨ˆç®—ä½ç½®ä¸­...";

            // 1. ç¢ºä¿æ¨¡å‹å¾ç›¸æ©Ÿä¸­ç§»é™¤
            if (arModel.object3D.parent !== arModel.sceneEl.object3D) {
                arModel.sceneEl.object3D.add(arModel.object3D);
            }

            // 2. è¨ˆç®—åº§æ¨™
            // 2å…¬å°ºç´„ 0.00002åº¦
            // 3å…¬å°ºç´„ 0.00003åº¦ (è·¯æ¨™)
            const diff2m = 0.00002;
            const diff3m = 0.00003;

            const lat = currentCoords.latitude;
            const lng = currentCoords.longitude;

            // 3. è¨­å®šæ¨¡å‹ä½ç½® (åŒ—æ–¹ 2m)
            // position="0 0 0" ç¢ºä¿å®ƒåœ¨è©² GPS é»çš„åœ°é¢
            arModel.setAttribute('gps-entity-place', `latitude: ${lat + diff2m}; longitude: ${lng};`);
            arModel.setAttribute('position', '0 0 0');
            arModel.setAttribute('scale', '3 3 3'); 
            arModel.setAttribute('visible', 'true');

            // 4. è¨­å®šæ–¹ä½æŸ±å­ (3m è™•)
            setGpsPos(dirN, lat + diff3m, lng); // åŒ— (ç´…)
            setGpsPos(dirS, lat - diff3m, lng); // å— (è—)
            setGpsPos(dirE, lat, lng + diff3m); // æ± (ç¶ )
            setGpsPos(dirW, lat, lng - diff3m); // è¥¿ (é»ƒ)

            // 5. æ›´æ–° UI
            statusLog.innerText = `ğŸ“ æ¨¡å‹åœ¨ç´…æŸ±(åŒ—)å‰æ–¹`;
            placeBtn.innerText = "ğŸ”„ é‡ç½®ä½ç½®";
        });

        function setGpsPos(el, lat, lng) {
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
            el.setAttribute('position', '0 1 0'); // é›¢åœ° 1 ç±³ï¼Œæ‡¸æµ®ä»¥å…è¢«é®æ“‹
            el.setAttribute('visible', 'true');
        }
    </script>
</body>
</html>