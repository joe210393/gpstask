<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR Test v3.1</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        .debug-ui {
            position: fixed; bottom: 20px; left: 0; width: 100%; z-index: 99999;
            background: rgba(0, 0, 0, 0.7); color: white; padding: 10px;
            font-family: monospace; text-align: center;
            pointer-events: auto;
        }
        button {
            padding: 12px 24px; background: #28a745; color: white;
            border: none; border-radius: 6px; font-size: 16px; margin-top: 10px;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div id="status-log">åˆå§‹åŒ–ä¸­...</div>
        <button id="force-show-btn">ğŸ‘ï¸ å¼·åˆ¶æŠŠæ¨¡å‹æ”¾åœ¨çœ¼å‰</button>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: è§£æ±ºæ·±åº¦é–ƒçˆ
        - colorManagement: ç¢ºä¿ GLTF é¡è‰²æ­£ç¢º
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <!-- æ”¹ç”¨ä½¿ç”¨è€…çš„è‡ªå®šç¾©æ¨¡å‹ -->
            <a-asset-item id="animated-model" src="/models/result.glb"></a-asset-item>
        </a-assets>

        <a-camera gps-camera rotation-reader></a-camera>

        <!-- åˆå§‹ä¸å¯è¦‹ï¼Œé€éæŒ‰éˆ•è§¸ç™¼ -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="2 2 2"
            position="0 0 -5"
            visible="false"> 
        </a-entity>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');
        const forceBtn = document.getElementById('force-show-btn');

        // 1. ç›£è½æ¨¡å‹åŠ è¼‰
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            statusLog.innerText = "âœ… æ¨¡å‹ä¸‹è¼‰æˆåŠŸï¼è«‹é»æ“ŠæŒ‰éˆ•";
            statusLog.style.color = "#0f0"; // ç¶ è‰²
        });

        arModel.addEventListener('model-error', (e) => {
            console.error("Model Error:", e);
            statusLog.innerText = "âŒ ä¾ç„¶å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š";
            statusLog.style.color = "#f00"; // ç´…è‰²
        });

        // 2. æŒ‰éˆ•è¡Œç‚º
        forceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const camera = document.querySelector('a-camera');
            
            // é€™è£¡åšä¸€å€‹ã€Œæš´åŠ›è§£æ³•ã€ï¼š
            // ç›´æ¥æŠŠæ¨¡å‹æ›åˆ°ç›¸æ©Ÿåº•ä¸‹ (HUD)ï¼Œé€™æ¨£ä¸ç®¡ GPS æº–ä¸æº–ï¼Œ
            // æ¨¡å‹éƒ½æœƒé»åœ¨ä½ çš„è¢å¹•æ­£ä¸­å¤®
            
            // ä½¿ç”¨ object3D æ“ä½œæ›´åº•å±¤ï¼Œæœ‰æ™‚å€™æ¯” setAttribute æ›´ç©©
            if (arModel.object3D.parent) {
                arModel.object3D.parent.remove(arModel.object3D);
            }
            camera.object3D.add(arModel.object3D);

            // è¨­å®šä½ç½®ï¼šæ­£å‰æ–¹ 2 ç±³ï¼Œç¨å¾®ä½ä¸€é»
            // æ³¨æ„ï¼šé€™è£¡ç›´æ¥æ“ä½œ object3D çš„ positionï¼Œå–®ä½æ˜¯ç±³
            arModel.object3D.position.set(0, -1, -2);
            // é‡ç½®æ¯”ä¾‹ç‚º 1ï¼Œå› ç‚ºä¸ç¢ºå®šä½¿ç”¨è€…æ¨¡å‹å¤§å°
            arModel.object3D.scale.set(1, 1, 1);
            arModel.object3D.rotation.set(0, 0, 0); // å…ˆä¸æ—‹è½‰ï¼Œçœ‹æ¨¡å‹åŸå§‹æ–¹å‘
            
            arModel.setAttribute('visible', 'true');
            
            statusLog.innerText = "æ¨¡å¼ï¼šé»åœ¨é¡é ­ä¸Š (è‡ªå®šç¾©æ¨¡å‹)";
        });
    </script>
</body>
</html>