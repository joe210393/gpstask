<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR 3D Showcase</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <!-- åŠ å…¥ look-at å¥—ä»¶ï¼Œè®“æ–‡å­—æ°¸é é¢å‘ä½¿ç”¨è€… -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        .debug-ui {
            position: fixed; bottom: 20px; left: 0; width: 100%; z-index: 99999;
            background: transparent; 
            padding: 10px;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .status-badge {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: sans-serif;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div id="status-log" class="status-badge">ğŸ“¡ ç­‰å¾… GPS å®šä½...</div>
        <div id="dist-log" class="status-badge" style="display:none; color: yellow;">ğŸ“ å°šæœªæ”¾ç½®</div>
        <button id="place-btn" class="status-badge" style="margin-top: 10px; background: rgba(0,200,100,0.8); pointer-events: auto; display: none;">ğŸ“ åœ¨åŒ—æ–¹ 2 å…¬å°ºæ”¾ç½®</button>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: è§£æ±ºæ·±åº¦é–ƒçˆ
        - colorManagement: ç¢ºä¿ GLTF é¡è‰²æ­£ç¢º
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
        - videoTexture: true
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false; videoTexture: true;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <a-asset-item id="animated-model" src="/models/result.glb"></a-asset-item>
        </a-assets>

        <!-- minDistance: 0 ç¢ºä¿å†è¿‘ä¹Ÿèƒ½çœ‹åˆ°ï¼ŒmaxDistance: 100 é™åˆ¶é¡¯ç¤ºç¯„åœ -->
        <a-camera gps-camera="minDistance: 0; maxDistance: 1000;" rotation-reader></a-camera>

        <!-- 3D æ¨¡å‹ -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="3 3 3"
            position="0 0 0"
            visible="false"> 
        </a-entity>

        <!-- æ”¹ç”¨å·¨å¤§ç«‹é«”æŸ±å­ç•¶è·¯æ¨™ï¼Œç¢ºä¿å„å€‹è§’åº¦éƒ½çœ‹å¾—åˆ° -->
        <!-- åŒ— (ç´…) - åŠå¾‘åŠ å¤§åˆ° 0.5ï¼Œé«˜åº¦ 5 -->
        <a-cylinder id="dir-n" color="#ff0000" height="5" radius="0.5" position="0 2.5 0" visible="false"></a-cylinder>
        <!-- å— (è—) -->
        <a-cylinder id="dir-s" color="#0000ff" height="5" radius="0.5" position="0 2.5 0" visible="false"></a-cylinder>
        <!-- æ± (ç¶ ) -->
        <a-cylinder id="dir-e" color="#00ff00" height="5" radius="0.5" position="0 2.5 0" visible="false"></a-cylinder>
        <!-- è¥¿ (é»ƒ) -->
        <a-cylinder id="dir-w" color="#ffff00" height="5" radius="0.5" position="0 2.5 0" visible="false"></a-cylinder>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');
        const distLog = document.getElementById('dist-log');
        const placeBtn = document.getElementById('place-btn');
        const camera = document.querySelector('a-camera');
        
        // æ–¹ä½å…ƒç´ 
        const dirN = document.getElementById('dir-n');
        const dirS = document.getElementById('dir-s');
        const dirE = document.getElementById('dir-e');
        const dirW = document.getElementById('dir-w');

        let currentCoords = null;
        let modelLoaded = false;
        let placed = false;

        // ç›£è½ GPS æ›´æ–°
        window.addEventListener('gps-camera-update-position', (e) => {
            currentCoords = e.detail.position;
            
            if (!placeBtn.style.display || placeBtn.style.display === 'none') {
                statusLog.innerText = "âœ… GPS å·²é–å®š";
                statusLog.style.backgroundColor = "rgba(40, 167, 69, 0.8)";
                if (modelLoaded) {
                    placeBtn.style.display = 'block';
                }
            }

            // å¦‚æœå·²ç¶“æ”¾ç½®ï¼Œè¨ˆç®—èˆ‡åŒ—æ–¹æŸ±å­çš„è·é›¢
            if (placed && dirN.getAttribute('gps-entity-place')) {
                const dist = dirN.getAttribute('distance'); // AR.js è‡ªå‹•è¨ˆç®—çš„è·é›¢
                const camPos = camera.object3D.position;
                const nPos = dirN.object3D.position;
                
                // ç°¡å–®é™¤éŒ¯è·é›¢
                if (dist) {
                    distLog.innerText = `ğŸ“ è·é›¢åŒ—æ–¹ç´…æŸ±: ${Math.round(dist)}m`;
                } else {
                    // æ‰‹å‹•è¨ˆç®—å¤§æ¦‚è·é›¢ (åƒ…ä¾›åƒè€ƒ)
                    const dx = camPos.x - nPos.x;
                    const dz = camPos.z - nPos.z;
                    const manualDist = Math.sqrt(dx*dx + dz*dz);
                    distLog.innerText = `ğŸ“ è·é›¢åŒ—æ–¹ç´…æŸ±(3D): ${manualDist.toFixed(1)}m`;
                }
            }
        });

        // ç›£è½æ¨¡å‹è¼‰å…¥
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            modelLoaded = true;
            if (currentCoords) {
                placeBtn.style.display = 'block';
                statusLog.innerText = "ğŸš€ æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šæ”¾ç½®";
            } else {
                statusLog.innerText = "â³ æ¨¡å‹ OKï¼Œç­‰å¾… GPS...";
            }
        });

        // æ”¾ç½®æŒ‰éˆ•é‚è¼¯
        placeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentCoords) return;

            statusLog.innerText = "ğŸ“ è¨ˆç®—ä½ç½®ä¸­...";
            distLog.style.display = 'block';
            placed = true;

            // 1. ç¢ºä¿æ¨¡å‹å¾ç›¸æ©Ÿä¸­ç§»é™¤
            if (arModel.object3D.parent !== arModel.sceneEl.object3D) {
                arModel.sceneEl.object3D.add(arModel.object3D);
            }

            // 2. è¨ˆç®—åº§æ¨™
            // 2å…¬å°ºç·¯åº¦å·®ç´„ 0.000018åº¦
            // 3å…¬å°ºæ–¹ä½æŒ‡ç¤ºç´„ 0.000027åº¦
            const diff2m = 0.000018;
            const diff3m = 0.000027;

            const lat = currentCoords.latitude;
            const lng = currentCoords.longitude;

            // 3. è¨­å®šæ¨¡å‹ä½ç½® (åŒ—æ–¹ 2m)
            arModel.setAttribute('gps-entity-place', `latitude: ${lat + diff2m}; longitude: ${lng};`);
            arModel.setAttribute('position', '0 0 0'); // åœ°é¢
            arModel.setAttribute('scale', '3 3 3'); 
            arModel.setAttribute('visible', 'true');

            // 4. è¨­å®šæ–¹ä½æŸ±å­ (3m è™•)
            setGpsPos(dirN, lat + diff3m, lng); // åŒ— (ç´…)
            setGpsPos(dirS, lat - diff3m, lng); // å— (è—)
            setGpsPos(dirE, lat, lng + diff3m); // æ± (ç¶ )
            setGpsPos(dirW, lat, lng - diff3m); // è¥¿ (é»ƒ)

            // 5. æ›´æ–° UI
            statusLog.innerText = `ğŸ“ è·¯æ¨™å·²æ”¾ç½® (åŠå¾‘0.5m é«˜5m)`;
            placeBtn.innerText = "ğŸ”„ é‡ç½®ä½ç½®";
        });

        function setGpsPos(el, lat, lng) {
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
            el.setAttribute('position', '0 2.5 0'); // ä¸­å¿ƒé»åœ¨ 2.5m (é«˜åº¦çš„ä¸€åŠ)ï¼Œç¢ºä¿ç«‹åœ¨åœ°é¢ä¸Š
            el.setAttribute('visible', 'true');
        }
    </script>
</body>
</html>