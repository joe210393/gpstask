<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR Test v3.1</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        .debug-ui {
            position: fixed; bottom: 20px; left: 0; width: 100%; z-index: 99999;
            background: rgba(0, 0, 0, 0.7); color: white; padding: 10px;
            font-family: monospace; text-align: center;
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        button {
            padding: 12px 24px; color: white;
            border: none; border-radius: 6px; font-size: 16px;
        }
        #force-show-btn { background: #28a745; }
        #gps-place-btn { background: #007bff; }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div id="status-log">åˆå§‹åŒ–ä¸­...</div>
        <button id="force-show-btn">ğŸ‘ï¸ å¼·åˆ¶é¡¯ç¤º (çœ¼å‰)</button>
        <button id="gps-place-btn">ğŸ“ GPS æ”¾ç½® (åŒ—æ–¹ 5m)</button>
        <div id="gps-info" style="font-size: 12px; color: #aaa;">GPS æœªå•Ÿå‹•</div>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: è§£æ±ºæ·±åº¦é–ƒçˆ
        - colorManagement: ç¢ºä¿ GLTF é¡è‰²æ­£ç¢º
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <!-- æ”¹ç”¨ä½¿ç”¨è€…çš„è‡ªå®šç¾©æ¨¡å‹ -->
            <a-asset-item id="animated-model" src="/models/result.glb"></a-asset-item>
        </a-assets>

        <a-camera gps-camera rotation-reader></a-camera>

        <!-- åˆå§‹ä¸å¯è¦‹ï¼Œé€éæŒ‰éˆ•è§¸ç™¼ -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="1 1 1"
            position="0 0 -5"
            visible="false"> 
        </a-entity>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');
        const forceBtn = document.getElementById('force-show-btn');
        const gpsBtn = document.getElementById('gps-place-btn');
        const gpsInfo = document.getElementById('gps-info');

        // 1. ç›£è½æ¨¡å‹åŠ è¼‰
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            statusLog.innerText = "âœ… æ¨¡å‹å·²å°±ç·’";
            statusLog.style.color = "#0f0"; // ç¶ è‰²
        });

        arModel.addEventListener('model-error', (e) => {
            console.error("Model Error:", e);
            statusLog.innerText = "âŒ æ¨¡å‹å¤±æ•—";
            statusLog.style.color = "#f00"; // ç´…è‰²
        });

        // 2. å¼·åˆ¶é¡¯ç¤ºæŒ‰éˆ• (HUDæ¨¡å¼)
        forceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const camera = document.querySelector('a-camera');
            
            // ç§»é™¤ GPS å±¬æ€§ï¼Œé¿å…å¹²æ“¾
            arModel.removeAttribute('gps-entity-place');

            // æ›è¼‰åˆ°ç›¸æ©Ÿ
            if (arModel.object3D.parent) arModel.object3D.parent.remove(arModel.object3D);
            camera.object3D.add(arModel.object3D);

            arModel.object3D.position.set(0, -1, -2); // å‰æ–¹ 2 ç±³
            arModel.object3D.scale.set(1, 1, 1);
            arModel.object3D.rotation.set(0, 0, 0); 
            arModel.setAttribute('visible', 'true');
            
            statusLog.innerText = "æ¨¡å¼ï¼šé»åœ¨é¡é ­ä¸Š";
        });

        // 3. GPS æ”¾ç½®æŒ‰éˆ•
        gpsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            statusLog.innerText = "æ­£åœ¨å®šä½...";
            
            if (!navigator.geolocation) {
                statusLog.innerText = "ä¸æ”¯æ´ GPS";
                return;
            }

            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const acc = pos.coords.accuracy;

                // å¾€åŒ—æ–¹åç§»ç´„ 0.00005 åº¦ (ç´„ 5-6 å…¬å°º)
                const newLat = lat + 0.00005;
                const newLng = lng;

                gpsInfo.innerText = `ç›®å‰ç²¾åº¦: ${acc.toFixed(0)}m\næ”¾ç½®æ–¼: ${newLat.toFixed(6)}, ${newLng.toFixed(6)}`;

                // ç§»é™¤ç›¸æ©Ÿæ›è¼‰ï¼Œæ”¾å›å ´æ™¯
                const scene = document.querySelector('a-scene');
                if (arModel.object3D.parent) arModel.object3D.parent.remove(arModel.object3D);
                scene.object3D.add(arModel.object3D);

                // è¨­å®š GPS åº§æ¨™
                arModel.setAttribute('gps-entity-place', `latitude: ${newLat}; longitude: ${newLng};`);
                
                // é‡ç½®æœ¬åœ°è®Šæ› (å› ç‚º gps-entity-place æœƒæ§åˆ¶ position)
                arModel.setAttribute('scale', '1 1 1');
                arModel.setAttribute('position', '0 0 0'); 
                arModel.setAttribute('visible', 'true');

                statusLog.innerText = "âœ… å·²æ”¾ç½®åœ¨åŒ—æ–¹ 5 å…¬å°º";
                
            }, (err) => {
                statusLog.innerText = "GPS éŒ¯èª¤: " + err.message;
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        });
    </script>
</body>
</html>