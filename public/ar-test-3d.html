<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR 3D Test</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <!-- Look-at component (optional, makes model face user) -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        .debug-ui {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .debug-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #0f0;
            padding: 5px;
            z-index: 9999;
            pointer-events: none;
        }
        .toast-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-size: 16px;
            max-width: 80%;
        }
        .toast-message.show {
            opacity: 1;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div id="info">GPS AR 3D Ê∏¨Ë©¶Ê®°Âºè</div>

    <div class="debug-ui">
        <div class="debug-row">
            <span>Scale (Â§ßÂ∞è): <span id="scale-val">0.5</span></span>
            <input type="range" id="scale-slider" min="0.1" max="50" step="0.1" value="0.5">
        </div>
        <div class="debug-row">
            <span>Height (È´òÂ∫¶): <span id="height-val">0</span></span>
            <input type="range" id="height-slider" min="-10" max="10" step="0.5" value="0">
        </div>
        <div class="debug-row">
            <button id="set-loc-btn">üìç GPS ÊîæÁΩÆ (ÂåóÊñπ)</button>
            <button id="force-show-btn" style="background: #28a745;">üëÅÔ∏è Âº∑Âà∂ÁúºÂâç (ÁÑ° GPS)</button>
        </div>
        <div class="debug-row">
            <span id="dist-val">Ë∑ùÈõ¢: ? m</span>
            <span id="gps-acc">Á≤æÂ∫¶: ?</span>
        </div>
        <div class="debug-row">
            <span>Ê®°Êì¨ GPS: </span>
            <button onclick="simulateMove(0.0001, 0)">ÂåóÁßª</button>
            <button onclick="simulateMove(-0.0001, 0)">ÂçóÁßª</button>
        </div>
    </div>

    <!-- 
        vr-mode-ui="enabled: false": ÈóúÈñâÂè≥‰∏ãËßíÁöÑ VR ÁúºÈè°ÊåâÈàï
        arjs: Ë®≠ÂÆö AR.js ÂèÉÊï∏ÔºåsourceType: webcam ÈñãÂïüÁõ∏Ê©ü
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true;">

        <!-- È†êËºâË≥áÊ∫êÔºö‰ΩøÁî®‰∏ÄÂÄãÂÖ¨ÈñãÁöÑ CesiumMan Ê®°Âûã (ÊúÉËµ∞Ë∑ØÁöÑÂ∞è‰∫∫) -->
        <a-assets>
            <a-asset-item id="animated-model" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb"></a-asset-item>
        </a-assets>

        <!-- 
            gps-camera: ËôïÁêÜ GPS ÂÆö‰Ωç
            rotation-reader: ËôïÁêÜÁæÖÁõ§ÊñπÂêë
            minDistance: ÊúÄÂ∞èÈ°ØÁ§∫Ë∑ùÈõ¢
            maxDistance: ÊúÄÂ§ßÈ°ØÁ§∫Ë∑ùÈõ¢
        -->
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- 
            3D ÂØ¶È´î 
            gps-entity-place: Ë®≠ÂÆöÁ∂ìÁ∑ØÂ∫¶ (ÊúÉÂú® JS ‰∏≠ÂãïÊÖãË®≠ÂÆö)
            gltf-model: ÊåáÂÆöÊ®°Âûã
            animation-mixer: Êí≠ÊîæÂãïÁï´
            look-at: ËÆìÊ®°ÂûãÊ∞∏ÈÅ†Èù¢ÂêëÈè°È†≠
        -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="0.5 0.5 0.5"
            look-at="[gps-camera]"
            position="0 0 0">
        </a-entity>

    </a-scene>

    <script>
        const forceShowBtn = document.getElementById('force-show-btn');
        const gpsAccDisplay = document.getElementById('gps-acc');
        
        // UI Controls
        const scaleSlider = document.getElementById('scale-slider');
        const heightSlider = document.getElementById('height-slider');
        const scaleVal = document.getElementById('scale-val');
        const heightVal = document.getElementById('height-val');

        // Ê®°ÂûãËºâÂÖ•ÁãÄÊÖãÁõ£ËÅΩ
        model.addEventListener('model-loaded', () => {
            showToast('‚úÖ 3D Ê®°ÂûãËºâÂÖ•ÊàêÂäüÔºÅ');
            infoDiv.innerText += ' | Ê®°Âûã OK';
            infoDiv.style.color = '#0f0';
            // È†êË®≠Á∏ÆÊîæÁ®çÂæÆÂ§ß‰∏ÄÈªûÔºåÈÅøÂÖçÂ§™Â∞èÁúã‰∏çÂà∞
            model.setAttribute('scale', '2 2 2');
            scaleSlider.value = 2;
            scaleVal.textContent = '2';
        });

        model.addEventListener('model-error', (e) => {
            console.error('Model failed to load:', e);
            showToast('‚ùå 3D Ê®°ÂûãËºâÂÖ•Â§±ÊïóÔºÅË´ãÊ™¢Êü•Á∂≤Ë∑Ø„ÄÇ', 5000);
            infoDiv.innerText += ' | Ê®°ÂûãÂ§±Êïó';
            infoDiv.style.color = '#f00';
        });

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.innerText = message;
            document.body.appendChild(toast);
            
            // Trigger reflow
            void toast.offsetWidth;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Ë™øÊï¥Â§ßÂ∞è
        scaleSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            model.setAttribute('scale', `${val} ${val} ${val}`);
            scaleVal.textContent = val;
        });

        // Ë™øÊï¥È´òÂ∫¶ (YËª∏)
        heightSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            model.object3D.position.y = parseFloat(val);
            heightVal.textContent = val;
        });
        
        // Âº∑Âà∂ÊîæÁΩÆÂú®Èè°È†≠ÂâçÊñπ (‰∏ç‰ΩøÁî® GPS)
        forceShowBtn.addEventListener('click', () => {
            showToast('Ê≠£Âú®Âº∑Âà∂Â∞áÊ®°ÂûãÁßªËá≥ÁúºÂâç...', 1000);
            
            // ÁßªÈô§ GPS Â±¨ÊÄßÔºåÊîπÁÇ∫Á¥î 3D Â∫ßÊ®ô
            model.removeAttribute('gps-entity-place');
            model.removeAttribute('look-at'); // Êö´ÊôÇÁßªÈô§ look-at ‰ª•ÈÅøÂÖçÊóãËΩâÂïèÈ°å
            
            // ÂèñÂæóÁõ∏Ê©ü
            const camera = document.querySelector('a-camera');
            
            // Â∞áÊ®°Âûã„ÄåÊéõ„ÄçÂú®Áõ∏Ê©ü‰∏ãÈù¢ÔºåÊàêÁÇ∫Â≠êÁâ©‰ª∂ÔºåÈÄôÊ®£ÂÆÉÂ∞±ÊúÉË∑üËëóÈè°È†≠Ë∑ë
            // ‰ΩÜ A-Frame ÂãïÊÖã reparenting ÊØîËºÉÈ∫ªÁÖ©ÔºåÊàëÂÄëÁõ¥Êé•Ë®≠ÂÆöÂú®‰∏ñÁïåÂ∫ßÊ®ô
            
            // Á∞°ÂñÆÊö¥ÂäõÊ≥ïÔºöÂ∞áÊ®°ÂûãË®≠ÂÆöÂú® (0, 0, -5)Ôºå‰πüÂ∞±ÊòØ‰∏ñÁïåÂéüÈªûÂâçÊñπ 5 Á±≥
            // ‰ΩÜÂõ†ÁÇ∫ gps-camera ÊúÉÁßªÂãï cameraÔºåÊâÄ‰ª•ÊàëÂÄëÈúÄË¶ÅÊääÊ®°ÂûãÊéõÂú® camera Ë£°Èù¢
            
            // ÈáçÊñ∞Â∞á model Âä†ÂÖ•Âà∞ camera ÂÖßÈÉ®
            if (model.parentNode !== camera) {
                model.parentNode.removeChild(model);
                camera.appendChild(model);
            }
            
            // Ë®≠ÂÆöÂú®Áõ∏Ê©üÂâçÊñπ 2 Á±≥ÔºåÈ´òÂ∫¶Á®çÂæÆ‰Ωé‰∏ÄÈªû
            model.setAttribute('position', '0 -1 -2');
            model.setAttribute('scale', '0.5 0.5 0.5'); // Âú®ÁúºÂâçÁöÑË©±Ë¶ÅÂ∞è‰∏ÄÈªû
            
            // ÊóãËΩâ‰∏Ä‰∏ãËÆì‰ªñÈù¢Â∞çÈè°È†≠
            model.setAttribute('rotation', '0 180 0');
            
            infoDiv.innerText = "Ê®°Âºè: Âº∑Âà∂ÁúºÂâç (ÁÑ° GPS)";
            distDisplay.innerText = "Ë∑ùÈõ¢: N/A";
            
            showToast('Ê®°ÂûãÂ∑≤Âõ∫ÂÆöÂú®Èè°È†≠ÂâçÊñπÔºÅ\nË´ãÁúãÁï´Èù¢Ê≠£‰∏≠Â§Æ');
        });

        // Êåâ‰∏ãÊåâÈàïÊôÇÔºåÂ∞áÊ®°ÂûãÊîæÁΩÆÂú®‰ΩøÁî®ËÄÖÁï∂Ââç‰ΩçÁΩÆÁöÑ"Á®çÂæÆÂâçÈù¢‰∏ÄÈªû"
        setLocBtn.addEventListener('click', () => {
            // Â¶ÇÊûú‰πãÂâçË¢´ÁßªÂÖ• cameraÔºåË¶ÅÁßªÂá∫‰æÜÂõûÂà∞ scene
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('a-camera');
            if (model.parentNode === camera) {
                model.parentNode.removeChild(model);
                scene.appendChild(model);
                model.setAttribute('look-at', '[gps-camera]');
            }

            if (navigator.geolocation) {
                showToast('Ê≠£Âú®Áç≤Âèñ GPS...', 1000);
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const acc = position.coords.accuracy;
                    
                    gpsAccDisplay.innerText = `Á≤æÂ∫¶: ${acc.toFixed(0)}m`;
                    
                    // ÂòóË©¶ÊîæÁΩÆÂú®Â§öÂÄãÊñπ‰ΩçÔºåÂ¢ûÂä†Ë¢´ÁúãÂà∞ÁöÑÊ©üÁéá
                    // È†êË®≠ÊîæÂú®ÂåóÊñπ 1.5 ÂÖ¨Â∞∫
                    // 0.00001 Â∫¶Á¥ÑÁ≠âÊñº 1.1 ÂÖ¨Â∞∫
                    const newLat = lat + 0.000015; 
                    const newLng = lng;

                    console.log(`Setting model to: ${newLat}, ${newLng}`);
                    
                    // Ë®≠ÂÆöÊ®°ÂûãÁöÑ GPS Â∫ßÊ®ô
                    model.setAttribute('gps-entity-place', `latitude: ${newLat}; longitude: ${newLng};`);
                    
                    // ÈáçÁΩÆÈ´òÂ∫¶ÂíåÂ§ßÂ∞èÔºåÈÅøÂÖçË®≠ÂÆöË∑ëÊéâ
                    model.setAttribute('scale', '2 2 2');
                    scaleSlider.value = 2;
                    scaleVal.textContent = '2';
                    
                    model.object3D.position.y = 0;
                    heightSlider.value = 0;
                    heightVal.textContent = '0';
                    
                    infoDiv.innerText = "Ê®°Âºè: GPS ÂÆö‰Ωç";

                    showToast(`Ê®°ÂûãÂ∑≤ÊîæÁΩÆÂú®ÂåóÊñπÁ¥Ñ 1.5 ÂÖ¨Â∞∫ËôïÔºÅ\nÁ≤æÂ∫¶: ${acc.toFixed(0)}m\nLat: ${newLat.toFixed(6)}\nLng: ${newLng.toFixed(6)}`);

                }, (err) => {
                    showToast('ÁÑ°Ê≥ïÁç≤Âèñ GPS: ' + err.message);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                showToast('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ Geolocation');
            }
        });

        // Áõ£ËÅΩË∑ùÈõ¢‰∫ã‰ª∂ (AR.js ÁâπÊúâ‰∫ã‰ª∂)
        model.addEventListener('gps-entity-place-update-positon', (event) => {
            if(event.detail.distance) {
                distDisplay.textContent = `Ë∑ùÈõ¢: ${event.detail.distance.toFixed(1)} m`;
            }
        });
        
        // Ê®°Êì¨ÁßªÂãï (Ê∏¨Ë©¶Áî®)
        window.simulateMove = function(dLat, dLng) {
            // ÈÄôÈÇäÂè™ËÉΩÊ®°Êì¨ model ÁöÑ‰ΩçÁΩÆÊîπËÆäÔºåÊØîËºÉÈõ£Ê®°Êì¨ camera ÁöÑ GPS
            // Á∞°ÂñÆËµ∑Ë¶ãÔºåÊàëÂÄëÁõ¥Êé•ÁßªÂãïÊ®°Âûã
            const currentAttr = model.getAttribute('gps-entity-place');
            if (currentAttr) {
                // Ëß£ÊûêÁèæÊúâÂ∫ßÊ®ô (ÈÄôÊØîËºÉÈ∫ªÁÖ©ÔºåÂÖà‰∏çÂØ¶‰ΩúË§áÈõúËß£Êûê)
                // ÈÄôË£°ÁïôÁµ¶ÈñãÁôºËÄÖÊ∏¨Ë©¶Áî®
                console.log('Simulate move not fully implemented via JS buttons yet, rely on real GPS');
            }
        };
        
        // ‰∏ÄÈñãÂßãÂÖàÂòóË©¶Ëá™ÂãïÊîæÁΩÆ‰∏ÄÊ¨°
        setTimeout(() => {
            setLocBtn.click();
        }, 3000);

    </script>
</body>
</html>
