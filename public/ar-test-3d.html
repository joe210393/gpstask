<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR Test v3.1</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        .debug-ui {
            position: fixed; bottom: 20px; left: 0; width: 100%; z-index: 99999;
            background: transparent; 
            padding: 10px;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .status-badge {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: sans-serif;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div id="status-log" class="status-badge">æ­£åœ¨è¼‰å…¥ 3D æ¨¡å‹...</div>
        <button id="reset-btn" class="status-badge" style="margin-top: 10px; background: rgba(0,100,255,0.6); pointer-events: auto;">ğŸ”„ é‡ç½®ä½ç½®</button>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: è§£æ±ºæ·±åº¦é–ƒçˆ
        - colorManagement: ç¢ºä¿ GLTF é¡è‰²æ­£ç¢º
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <!-- æ”¹ç”¨ä½¿ç”¨è€…çš„è‡ªå®šç¾©æ¨¡å‹ -->
            <a-asset-item id="animated-model" src="/models/result.glb"></a-asset-item>
        </a-assets>

        <a-camera gps-camera rotation-reader></a-camera>

        <!-- åˆå§‹ä¸å¯è¦‹ï¼Œé€éæŒ‰éˆ•è§¸ç™¼ -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="3 3 3"
            position="0 0 -5"
            visible="false"> 
        </a-entity>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');
        const resetBtn = document.getElementById('reset-btn');

        // æ ¸å¿ƒé¡¯ç¤ºé‚è¼¯
        function showModelInFront() {
            try {
                const camera = document.querySelector('a-camera');
                if (!camera || !camera.object3D) {
                    throw new Error("ç›¸æ©Ÿå°šæœªæº–å‚™å¥½");
                }

                // ç§»é™¤ GPS å±¬æ€§
                arModel.removeAttribute('gps-entity-place');

                // æ›è¼‰åˆ°ç›¸æ©Ÿ
                if (arModel.object3D.parent) arModel.object3D.parent.remove(arModel.object3D);
                camera.object3D.add(arModel.object3D);

                // è¨­å®šä½ç½®ï¼šæ­£å‰æ–¹ 2 ç±³ï¼Œç¨å¾®ä½ä¸€é» (-0.5)
                arModel.object3D.position.set(0, -0.5, -2); 
                arModel.object3D.scale.set(3, 3, 3); // æ”¾å¤§ 3 å€
                arModel.object3D.rotation.set(0, 0, 0); 
                
                arModel.setAttribute('visible', 'true');
                
                statusLog.innerText = "âœ… 3D æ¨¡å‹å·²é¡¯ç¤º";
                statusLog.style.color = "#fff";
                statusLog.style.backgroundColor = "rgba(40, 167, 69, 0.8)";
                
                // 3ç§’å¾Œéš±è—ç‹€æ…‹æ–‡å­—
                setTimeout(() => {
                    statusLog.style.opacity = '0';
                }, 3000);
            } catch (err) {
                console.error(err);
                statusLog.innerText = "âš ï¸ é‡è©¦ä¸­...";
                // å¦‚æœå¤±æ•—ï¼Œ1ç§’å¾Œå†è©¦
                setTimeout(showModelInFront, 1000);
            }
        }

        // 1. ç›£è½æ¨¡å‹åŠ è¼‰ä¸¦è‡ªå‹•é¡¯ç¤º
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            statusLog.innerText = "â³ æ¨¡å‹è¼‰å…¥å®Œæˆï¼Œç­‰å¾…ç›¸æ©Ÿ...";
            
            // å»¶é² 2 ç§’å†é¡¯ç¤ºï¼Œç¢ºä¿ AR.js ç›¸æ©Ÿå·²å•Ÿå‹•
            setTimeout(showModelInFront, 2000);
        });

        arModel.addEventListener('model-error', (e) => {
            console.error("Model Error:", e);
            statusLog.innerText = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—";
            statusLog.style.backgroundColor = "rgba(255, 0, 0, 0.6)";
        });

        // 2. æ‰‹å‹•é‡ç½®æŒ‰éˆ•
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            statusLog.style.opacity = '1';
            statusLog.innerText = "ğŸ”„ é‡æ–°å®šä½ä¸­...";
            showModelInFront();
        });
    </script>
</body>
</html>