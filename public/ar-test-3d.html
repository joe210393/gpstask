<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR 3D Fixed</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        .debug-ui {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            z-index: 99999;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        button {
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
        }
        /* ç§»é™¤å¼·åˆ¶è¦†è“‹ .a-canvas çš„ CSSï¼Œè®“ AR.js è‡ªå‹•è™•ç† */
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div>GPS AR ä¿®å¾©ç‰ˆ (v3.0)</div>
        <button id="force-show-btn" style="background: #28a745;">ğŸ‘ï¸ å¼·åˆ¶é¡¯ç¤º (çœ¼å‰)</button>
        <div id="status-log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: è§£æ±ºæ·±åº¦é–ƒçˆ
        - colorManagement: ç¢ºä¿ GLTF é¡è‰²æ­£ç¢º
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
        - videoTexture: false (é è¨­ falseï¼Œé¡¯å¼ç§»é™¤é¿å…å•é¡Œ)
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <!-- å¢åŠ ç’°å¢ƒå…‰å’Œæ–¹å‘å…‰ï¼Œé¿å…æ¨¡å‹å…¨é»‘ -->
        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <a-asset-item id="animated-model" src="/models/CesiumMan.glb"></a-asset-item>
        </a-assets>

        <!-- GPS Camera -->
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- 3D æ¨¡å‹
             åˆå§‹ visible=falseï¼Œé€éæŒ‰éˆ•è§¸ç™¼é¡¯ç¤º
             ç§»é™¤ gps-entity-placeï¼Œå…ˆæ¸¬è©¦ç´”é¡¯ç¤º
        -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="2 2 2"
            position="0 0 0"
            visible="false"> 
        </a-entity>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');
        const forceBtn = document.getElementById('force-show-btn');

        // 1. ç›£è½æ¨¡å‹æ˜¯å¦çœŸçš„è¼‰å…¥
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            statusLog.innerText = "âœ… æ¨¡å‹å·²è¼‰å…¥ (è¨˜æ†¶é«”ä¸­)";
            statusLog.style.color = "#0f0";
        });

        arModel.addEventListener('model-error', (e) => {
            console.error("Model Error:", e);
            statusLog.innerText = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•— (è«‹æª¢æŸ¥ Network)";
            statusLog.style.color = "red";
        });

        // 2. å¼·åˆ¶é¡¯ç¤ºæŒ‰éˆ• (é™¤éŒ¯æ ¸å¿ƒåŠŸèƒ½)
        forceBtn.addEventListener('click', (e) => {
            e.preventDefault(); // é˜²æ­¢è§¸æ§ç©¿é€
            
            statusLog.innerText = "è™•ç†ä¸­...";
            
            try {
                const camera = document.querySelector('a-camera');
                
                // å°‡æ¨¡å‹æ›è¼‰åˆ°ç›¸æ©Ÿåº•ä¸‹ (HUDæ¨¡å¼)ï¼Œç¢ºä¿ä¸€å®šçœ‹å¾—åˆ°
                // ç§»é™¤åŸæœ¬çš„çˆ¶å±¤ç´šé—œä¿‚ (å¾ scene ç§»åˆ° camera)
                if(arModel.parentNode && arModel.parentNode !== camera) {
                    arModel.parentNode.removeChild(arModel);
                    camera.appendChild(arModel);
                }

                // è¨­å®šç‚ºå¯è¦‹ï¼Œä¸¦æ”¾ç½®åœ¨é¡é ­å‰æ–¹ 3 ç±³è™•
                arModel.setAttribute('visible', 'true');
                // HUD æ¨¡å¼ä¸‹ï¼Œåº§æ¨™æ˜¯ç›¸å°ç›¸æ©Ÿçš„
                // 0 -1 -3: ç›¸æ©Ÿæ­£ä¸‹æ–¹ 1 ç±³ï¼Œå‰æ–¹ 3 ç±³
                arModel.setAttribute('position', '0 -1 -3'); 
                arModel.setAttribute('scale', '3 3 3');
                
                // ç¢ºä¿æ—‹è½‰æ­¸é›¶ (æˆ–è€…é¢å‘é¡é ­ï¼Œè¦–æ¨¡å‹è€Œå®š)
                arModel.setAttribute('rotation', '0 180 0');

                // ç§»é™¤ GPS å±¬æ€§ï¼Œé¿å…å®ƒé£›èµ°
                arModel.removeAttribute('gps-entity-place');

                statusLog.innerText = "ğŸ‘ï¸ å¼·åˆ¶é¡¯ç¤ºæ¨¡å¼: é¡é ­å‰æ–¹";
            } catch(err) {
                statusLog.innerText = "âŒ éŒ¯èª¤: " + err.message;
                statusLog.style.color = "red";
            }
        });
    </script>
</body>
</html>