<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GPS AR Test v3.1</title>
    <!-- A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (NFT build works well for location too) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <!-- A-Frame Extras (for animation-mixer) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        .debug-ui {
            position: fixed; bottom: 20px; left: 0; width: 100%; z-index: 99999;
            background: transparent; 
            padding: 10px;
            pointer-events: none; /* 讓點擊穿透 */
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .status-badge {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: sans-serif;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>
    
    <div class="debug-ui">
        <div id="status-log" class="status-badge">正在載入 3D 模型...</div>
    </div>

    <!-- 
        renderer: 
        - logarithmicDepthBuffer: 解決深度閃爍
        - colorManagement: 確保 GLTF 顏色正確
        arjs: 
        - sourceType: webcam
        - debugUIEnabled: false
    -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true; colorManagement: true;">

        <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="1"></a-light>

        <a-assets>
            <!-- 改用使用者的自定義模型 -->
            <a-asset-item id="animated-model" src="/models/result.glb"></a-asset-item>
        </a-assets>

        <a-camera gps-camera rotation-reader></a-camera>

        <!-- 初始不可見，透過按鈕觸發 -->
        <a-entity 
            id="ar-model"
            gltf-model="#animated-model"
            animation-mixer
            scale="1 1 1"
            position="0 0 -5"
            visible="false"> 
        </a-entity>

    </a-scene>

    <script>
        const arModel = document.getElementById('ar-model');
        const statusLog = document.getElementById('status-log');

        // 1. 監聽模型加載並自動顯示
        arModel.addEventListener('model-loaded', () => {
            console.log("Model Loaded!");
            statusLog.innerText = "✅ 3D 模型展示中";
            
            // 自動執行「強制顯示」邏輯
            const camera = document.querySelector('a-camera');
            
            // 移除 GPS 屬性
            arModel.removeAttribute('gps-entity-place');

            // 掛載到相機
            if (arModel.object3D.parent) arModel.object3D.parent.remove(arModel.object3D);
            camera.object3D.add(arModel.object3D);

            // 設定位置：正前方 2 米，稍微低一點 (-0.5)
            // 讓使用者平視就能看到，不用低頭
            arModel.object3D.position.set(0, -0.5, -2); 
            arModel.object3D.scale.set(1, 1, 1);
            arModel.object3D.rotation.set(0, 0, 0); 
            
            arModel.setAttribute('visible', 'true');
            
            // 3秒後隱藏狀態文字，讓畫面更乾淨
            setTimeout(() => {
                statusLog.style.display = 'none';
            }, 3000);
        });

        arModel.addEventListener('model-error', (e) => {
            console.error("Model Error:", e);
            statusLog.innerText = "❌ 模型載入失敗";
            statusLog.style.backgroundColor = "rgba(255, 0, 0, 0.6)";
        });
    </script>
</body>
</html>