<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ ¸éŠ·å„ªæƒ åˆ¸ | GPS è§¸ç™¼ä»»å‹™ç³»çµ±</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
  <style>
    .redeem-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .scan-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    .scan-icon {
      font-size: 4em;
      margin-bottom: 16px;
      opacity: 0.7;
    }

    .scan-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 12px;
      color: #2d3748;
    }

    .scan-description {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .manual-input {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .manual-input h4 {
      color: #2d3748;
      margin-bottom: 12px;
    }

    .manual-form {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .manual-form input {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
    }

    .manual-form input:focus {
      outline: none;
      border-color: #007bff;
    }

    .btn-primary, .btn-secondary {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .coupon-details {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      display: none;
    }

    .coupon-details.show {
      display: block;
    }

    .coupon-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .info-item {
      background: #f8f9fa;
      padding: 12px 16px;
      border-radius: 8px;
    }

    .info-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: 600;
      color: #2d3748;
    }

    .redeem-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .redeem-actions button {
      min-width: 120px;
    }

    .result-message {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .result-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .result-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .history-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .history-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 16px;
      color: #2d3748;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-info h5 {
      margin: 0 0 4px 0;
      color: #2d3748;
    }

    .history-meta {
      font-size: 0.9em;
      color: #666;
    }

    .history-time {
      font-size: 0.9em;
      color: #666;
    }

    @media (max-width: 768px) {
      .redeem-container {
        padding: 16px;
      }

      .coupon-info {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .redeem-actions {
        flex-direction: column;
      }

      .manual-form {
        flex-direction: column;
      }

      .manual-form input {
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div id="navHome"><a href="/">é¦–é </a></div>
      <div id="navMap"><a href="/map.html">åœ°åœ–</a></div>
      <div id="navTasks"><a href="/tasks-list.html">ä»»å‹™åˆ—è¡¨</a></div>
      <div id="navDashboard"><a href="/user-dashboard.html">å€‹äººå„€è¡¨æ¿</a></div>
      <div id="navRedeem"><a href="/products.html">å…Œæ›å•†å“</a></div>
      <div id="navUserTasks"><a href="/user-tasks.html">ä»»å‹™é€²åº¦</a></div>
      <div id="loginUserInfo">è¼‰å…¥ä¸­...</div>
      <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    </nav>
  </header>

  <main>
    <div class="redeem-container">
      <h1>æ ¸éŠ·å„ªæƒ åˆ¸</h1>

      <!-- çµæœè¨Šæ¯ -->
      <div id="resultMessage" class="result-message"></div>

      <!-- æƒæå€åŸŸ -->
      <div class="scan-section">
        <div class="scan-icon">ğŸ“±</div>
        <h3 class="scan-title">æƒæå„ªæƒ åˆ¸QRç¢¼</h3>
        <p class="scan-description">
          è«‹è®“ç”¨æˆ¶å‡ºç¤ºä»–å€‘çš„å„ªæƒ åˆ¸QRç¢¼ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼é€²è¡Œæ ¸éŠ·ã€‚
        </p>

        <!-- æ‰‹å‹•è¼¸å…¥å€åŸŸ -->
        <div class="manual-input">
          <h4>æ‰‹å‹•è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼</h4>
          <div class="manual-form">
            <input type="text" id="couponCode" placeholder="è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼" />
            <button onclick="lookupCoupon()" class="btn-primary">æŸ¥è©¢</button>
          </div>
        </div>
      </div>

      <!-- å„ªæƒ åˆ¸è©³æƒ… -->
      <div id="couponDetails" class="coupon-details">
        <h3>å„ªæƒ åˆ¸è©³æƒ…</h3>
        <div id="couponInfo" class="coupon-info">
          <!-- å„ªæƒ åˆ¸ä¿¡æ¯å°‡å‹•æ…‹è¼‰å…¥ -->
        </div>
        <div class="redeem-actions">
          <button onclick="confirmRedeem()" class="btn-primary" id="redeemBtn">ç¢ºèªæ ¸éŠ·</button>
          <button onclick="cancelRedeem()" class="btn-secondary">å–æ¶ˆ</button>
        </div>
      </div>

      <!-- æ ¸éŠ·æ­·å² -->
      <div class="history-section">
        <h3 class="history-title">ä»Šæ—¥æ ¸éŠ·è¨˜éŒ„</h3>
        <div id="historyList" class="history-list">
          <!-- æ ¸éŠ·æ­·å²å°‡å‹•æ…‹è¼‰å…¥ -->
        </div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 ä»»å‹™ç¶²é ç³»çµ±
  </footer>

  <script>
    const API_BASE = '';
    let currentCoupon = null;

    // æŸ¥è©¢å„ªæƒ åˆ¸
    async function lookupCoupon() {
      const couponCode = document.getElementById('couponCode').value.trim();
      if (!couponCode) {
        showMessage('è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/coupons/lookup/${couponCode}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          displayCouponDetails(data.coupon);
        } else {
          showMessage(data.message || 'æŸ¥è©¢å„ªæƒ åˆ¸å¤±æ•—', 'error');
          hideCouponDetails();
        }
      } catch (error) {
        console.error('æŸ¥è©¢å„ªæƒ åˆ¸éŒ¯èª¤:', error);
        showMessage('æŸ¥è©¢å„ªæƒ åˆ¸å¤±æ•—', 'error');
      }
    }

    // é¡¯ç¤ºå„ªæƒ åˆ¸è©³æƒ…
    function displayCouponDetails(coupon) {
      currentCoupon = coupon;

      const expiryDate = new Date(coupon.expiry_date);
      const isExpired = expiryDate < new Date();
      const isUsed = coupon.is_used;

      let statusText = 'æœ‰æ•ˆ';
      let statusColor = '#28a745';

      if (isUsed) {
        statusText = 'å·²ä½¿ç”¨';
        statusColor = '#6c757d';
      } else if (isExpired) {
        statusText = 'å·²éæœŸ';
        statusColor = '#dc3545';
      }

      document.getElementById('couponInfo').innerHTML = `
        <div class="info-item">
          <div class="info-label">å„ªæƒ åˆ¸ä»£ç¢¼</div>
          <div class="info-value">${coupon.coupon_code}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å„ªæƒ åˆ¸åç¨±</div>
          <div class="info-value">${coupon.title}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç”¨æˆ¶åç¨±</div>
          <div class="info-value">${coupon.username || 'æœªçŸ¥ç”¨æˆ¶'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç‹€æ…‹</div>
          <div class="info-value" style="color: ${statusColor}">${statusText}</div>
        </div>
        <div class="info-item">
          <div class="info-label">æŠ˜æ‰£é‡‘é¡</div>
          <div class="info-value">
            ${coupon.discount_amount ? `${coupon.discount_amount}å…ƒ` : ''}
            ${coupon.discount_percent ? `${coupon.discount_percent}% OFF` : ''}
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">åˆ°æœŸæ—¥æœŸ</div>
          <div class="info-value">${expiryDate.toLocaleDateString('zh-TW')}</div>
        </div>
      `;

      document.getElementById('couponDetails').classList.add('show');

      // æ ¹æ“šç‹€æ…‹æ§åˆ¶æ ¸éŠ·æŒ‰éˆ•
      const redeemBtn = document.getElementById('redeemBtn');
      if (isUsed || isExpired) {
        redeemBtn.disabled = true;
        redeemBtn.textContent = isUsed ? 'å·²ä½¿ç”¨' : 'å·²éæœŸ';
      } else {
        redeemBtn.disabled = false;
        redeemBtn.textContent = 'ç¢ºèªæ ¸éŠ·';
      }
    }

    // éš±è—å„ªæƒ åˆ¸è©³æƒ…
    function hideCouponDetails() {
      document.getElementById('couponDetails').classList.remove('show');
      currentCoupon = null;
    }

    // ç¢ºèªæ ¸éŠ·
    async function confirmRedeem() {
      if (!currentCoupon) return;

      if (!confirm(`ç¢ºå®šè¦æ ¸éŠ·å„ªæƒ åˆ¸ã€Œ${currentCoupon.title}ã€å—ï¼Ÿ\n\næ ¸éŠ·å¾Œæ­¤å„ªæƒ åˆ¸å°‡å¤±æ•ˆä¸”ç„¡æ³•æ¢å¾©ã€‚`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/coupons/${currentCoupon.id}/redeem`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          showMessage('å„ªæƒ åˆ¸æ ¸éŠ·æˆåŠŸï¼', 'success');
          hideCouponDetails();
          document.getElementById('couponCode').value = '';
          loadRedeemHistory();
        } else {
          showMessage(data.message || 'æ ¸éŠ·å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('æ ¸éŠ·å„ªæƒ åˆ¸éŒ¯èª¤:', error);
        showMessage('æ ¸éŠ·å¤±æ•—', 'error');
      }
    }

    // å–æ¶ˆæ ¸éŠ·
    function cancelRedeem() {
      hideCouponDetails();
    }

    // è¼‰å…¥æ ¸éŠ·æ­·å²
    async function loadRedeemHistory() {
      try {
        const response = await fetch(`${API_BASE}/api/coupons/redeem-history`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          displayRedeemHistory(data.history);
        }
      } catch (error) {
        console.error('è¼‰å…¥æ ¸éŠ·æ­·å²éŒ¯èª¤:', error);
      }
    }

    // é¡¯ç¤ºæ ¸éŠ·æ­·å²
    function displayRedeemHistory(history) {
      const historyList = document.getElementById('historyList');

      if (history.length === 0) {
        historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ä»Šæ—¥é‚„æ²’æœ‰æ ¸éŠ·è¨˜éŒ„</p>';
        return;
      }

      historyList.innerHTML = history.map(item => `
        <div class="history-item">
          <div class="history-info">
            <h5>${item.coupon_title}</h5>
            <div class="history-meta">
              ä»£ç¢¼ï¼š${item.coupon_code} | ç”¨æˆ¶ï¼š${item.username}
            </div>
          </div>
          <div class="history-time">
            ${new Date(item.used_at).toLocaleTimeString('zh-TW', {
              hour: '2-digit',
              minute: '2-digit'
            })}
          </div>
        </div>
      `).join('');
    }

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(message, type) {
      const messageDiv = document.getElementById('resultMessage');
      messageDiv.textContent = message;
      messageDiv.className = `result-message ${type}`;
      messageDiv.style.display = 'block';

      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    // æŒ‰ Enter éµæŸ¥è©¢å„ªæƒ åˆ¸
    document.getElementById('couponCode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        lookupCoupon();
      }
    });

    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', function() {
      // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
      const loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');
      if (!loginUser) {
        window.location.href = '/login.html';
        return;
      }

      // æª¢æŸ¥æ¬Šé™
      if (loginUser.role !== 'shop' && loginUser.role !== 'admin') {
        alert('åªæœ‰å•†åº—å’Œç®¡ç†å‘˜å¯ä»¥è¨ªå•æ­¤é é¢');
        window.location.href = '/';
        return;
      }

      // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
      document.getElementById('loginUserInfo').textContent = `å•†åº—ï¼š${loginUser.username}`;
      document.getElementById('logoutBtn').style.display = '';

      // è¨­ç½®ç™»å‡ºåŠŸèƒ½
      document.getElementById('logoutBtn').onclick = async function() {
        try {
          await fetch(`${API_BASE}/api/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (error) {
          console.error('ç™»å‡ºéŒ¯èª¤:', error);
        }
        localStorage.removeItem('loginUser');
        window.location.href = '/login.html';
      };

      // è¼‰å…¥æ ¸éŠ·æ­·å²
      loadRedeemHistory();
    });
  </script>
</body>
</html>
