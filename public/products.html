<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å•†å“å…Œæ› | GPS è§¸ç™¼ä»»å‹™ç³»çµ±</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
</head>
<body>
  <header id="mainHeader">
    <div class="header-content" id="headerContent">
      <h1 id="pageTitle">å•†å“å…Œæ›</h1>
      <button id="hamburgerBtn" class="hamburger" aria-label="å±•é–‹é¸å–®">&#9776;</button>
      <nav class="main-nav">
        <a href="/index.html">é¦–é </a>
        <a href="/map.html">åœ°åœ–é </a>
        <a href="/tasks-list.html" id="navTasksList">ä»»å‹™åˆ—è¡¨</a>
        <a href="/user-tasks.html">ä»»å‹™å¯©æ ¸</a>
        <a href="/staff-dashboard.html" id="navStaff" style="display:none;">æ–°å¢ä»»å‹™</a>
        <a href="/user-dashboard.html" id="navUserTasks">ç”¨æˆ¶ä»»å‹™ç®¡ç†</a>
        <a href="/products.html" class="current-page">å•†å“å…Œæ›</a>
        <a href="/redeem-tasks.html" id="navRedeem" style="display:none;">å…Œæ›å•†å“ç®¡ç†</a>
        <span id="loginUserInfo" style="display:none; color:var(--text-secondary); padding:0.5rem 1rem;"></span>
        <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- ç”¨æˆ¶ç©åˆ†å¡ç‰‡ -->
    <div style="background: var(--gradient-primary); color: white; border-radius: 1rem; padding: 2rem; margin: 0 auto 2rem auto; max-width: 400px; text-align: center; box-shadow: var(--shadow-lg);">
      <h2 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; opacity: 0.9;">æˆ‘çš„ç©åˆ†</h2>
      <div id="userPoints" style="font-size: 3rem; font-weight: 700; margin: 0.5rem 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">0</div>
      <div style="font-size: 0.9rem; opacity: 0.8;">ç´¯è¨ˆç©åˆ†</div>
    </div>

    <!-- å•†å“åˆ—è¡¨ -->
    <section class="mb-4">
      <h2 class="text-center mb-4">ğŸ å¯å…Œæ›å•†å“</h2>
      <div id="productsGrid" class="card-grid">
        <div class="loading-spinner"></div>
      </div>
    </section>

    <!-- å…Œæ›è¨˜éŒ„ -->
    <section style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
      <h2 class="text-center mb-4">ğŸ“‹ å…Œæ›è¨˜éŒ„</h2>
      <div id="redemptionHistory">
        <div class="loading-spinner"></div>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 GPS ä»»å‹™ç³»çµ± - åœ°æ–¹é–‹ç®±ä»»å‹™éŠæˆ²
  </footer>

  <script>
    // HeaderåŠŸèƒ½
    const loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');

    // æ¬Šé™æª¢æŸ¥
    if (!loginUser) {
      alert('è«‹å…ˆç™»å…¥');
      window.location.href = '/login.html';
    }

    // æ¬Šé™æª¢æŸ¥å’Œå°èˆªé¡¯ç¤º
    if (loginUser) {
      const userInfoSpan = document.getElementById('loginUserInfo');
      userInfoSpan.style.display = 'inline-block';
      userInfoSpan.textContent = getUserDisplayName(loginUser);
      
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = function() {
        localStorage.removeItem('loginUser');
        window.location.href = '/login.html';
      };

      if (loginUser.role === 'admin') {
        document.getElementById('navStaff').style.display = '';
        document.getElementById('navRedeem').style.display = '';
      } else if (loginUser.role === 'shop') {
        document.getElementById('navStaff').style.display = '';
        document.getElementById('navRedeem').style.display = '';
      }
      
      if (loginUser.role === 'user') {
        document.getElementById('navUserTasks').style.display = '';
      }
      
      if (loginUser && (loginUser.role === 'shop' || loginUser.role === 'admin')) {
        const navTasksList = document.getElementById('navTasksList');
        if (navTasksList) navTasksList.style.display = 'none';
      }
    }

    function getUserDisplayName(loginUser) {
      switch(loginUser.role) {
        case 'admin': return `ç®¡ç†å“¡ï¼š${loginUser.username}`;
        case 'shop': return `å•†åº—ï¼š${loginUser.username}`;
        case 'user': return `ç”¨æˆ¶ï¼š${loginUser.username}`;
        default: return loginUser.username;
      }
    }

    document.getElementById('hamburgerBtn').onclick = function() {
      document.getElementById('headerContent').classList.toggle('open');
    };

    document.querySelectorAll('.main-nav a').forEach(a => {
      a.onclick = () => document.getElementById('headerContent').classList.remove('open');
    });

    // é é¢æ•¸æ“šè¼‰å…¥
    const API_BASE = '';

    // è¼‰å…¥ç”¨æˆ¶ç©åˆ†
    function loadUserPoints() {
      fetch(`${API_BASE}/api/user/points`, {
        headers: { 'x-username': loginUser.username }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('userPoints').textContent = data.totalPoints;
        }
      })
      .catch(err => console.error('è¼‰å…¥ç©åˆ†å¤±æ•—:', err));
    }

    // è¼‰å…¥å•†å“åˆ—è¡¨
    function loadProducts() {
      fetch(`${API_BASE}/api/products`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          displayProducts(data.products);
        } else {
          document.getElementById('productsGrid').innerHTML = '<div class="text-center text-secondary">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
        }
      })
      .catch(err => {
        console.error('è¼‰å…¥å•†å“å¤±æ•—:', err);
        document.getElementById('productsGrid').innerHTML = '<div class="text-center text-secondary">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      });
    }

    // é¡¯ç¤ºå•†å“
    function displayProducts(products) {
      const container = document.getElementById('productsGrid');

      if (products.length === 0) {
        container.innerHTML = '<div class="text-center text-secondary" style="grid-column: 1/-1; padding: 2rem;">ç›®å‰æ²’æœ‰å¯å…Œæ›çš„å•†å“<br>æ•¬è«‹æœŸå¾…ï¼</div>';
        return;
      }

      container.innerHTML = '';

      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'card';

        const isLowStock = product.stock <= 5;
        const stockText = isLowStock ? `åƒ…å‰© ${product.stock} å€‹` : `åº«å­˜ï¼š${product.stock}`;
        const stockColor = isLowStock ? 'text-danger' : 'text-secondary';

        const creatorInfo = product.creator_username
          ? `<div style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:0.5rem;">ğŸ‘¤ åˆ†äº«è€…ï¼š${product.creator_username}</div>`
          : '';

        const isOwnProduct = loginUser && loginUser.username === product.created_by;
        const isStaff = loginUser && loginUser.role === 'shop';

        let redeemButtonHtml;
        if (product.stock <= 0) {
          redeemButtonHtml = `<button class="btn btn-secondary w-100" disabled>å·²å”®å®Œ</button>`;
        } else if (isStaff && isOwnProduct) {
          redeemButtonHtml = `<div class="text-center text-danger" style="font-size:0.9rem; padding:0.6rem;">âš ï¸ ç„¡æ³•å…Œæ›è‡ªå·±çš„å•†å“</div>`;
        } else {
          redeemButtonHtml = `<button class="btn btn-primary w-100" onclick="redeemProduct(${product.id}, ${product.points_required}, ${product.stock})">ç«‹å³å…Œæ›</button>`;
        }

        card.innerHTML = `
          <img src="${product.image_url || '/images/mascot.png'}" class="card-img" alt="${product.name}" onerror="this.src='/images/mascot.png'">
          <div class="card-body">
            <div class="card-title">${product.name}</div>
            ${creatorInfo}
            <div class="card-text">
              <div style="margin-bottom:8px; color:var(--text-secondary); font-size:0.95rem;">${product.description || 'ç„¡æè¿°'}</div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <span class="text-primary" style="font-weight:600; font-size:1.1rem;">${product.points_required} ç©åˆ†</span>
                <span class="${stockColor}" style="font-size:0.9rem;">${stockText}</span>
              </div>
            </div>
            <div class="card-footer" style="display:block;">
              ${redeemButtonHtml}
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // å…Œæ›å•†å“
    window.redeemProduct = function(productId, pointsRequired, stock) {
      if (stock <= 0) {
        alert('å•†å“å·²å”®å®Œï¼');
        return;
      }

      const currentPoints = parseInt(document.getElementById('userPoints').textContent);
      if (currentPoints < pointsRequired) {
        alert(`ç©åˆ†ä¸è¶³ï¼éœ€è¦ ${pointsRequired} ç©åˆ†ï¼Œæ‚¨ç›®å‰æœ‰ ${currentPoints} ç©åˆ†ã€‚`);
        return;
      }

      if (!confirm(`ç¢ºå®šè¦å…Œæ›é€™å€‹å•†å“å—ï¼Ÿå°‡æ¶ˆè€— ${pointsRequired} ç©åˆ†ã€‚`)) {
        return;
      }

      fetch(`${API_BASE}/api/products/${productId}/redeem`, {
        method: 'POST',
        headers: { 'x-username': loginUser.username }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          loadUserPoints();
          loadProducts();
          loadRedemptionHistory();
        } else {
          alert(data.message || 'å…Œæ›å¤±æ•—');
        }
      })
      .catch(err => {
        console.error('å…Œæ›å¤±æ•—:', err);
        alert('å…Œæ›å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      });
    };

    // è¼‰å…¥å…Œæ›è¨˜éŒ„
    function loadRedemptionHistory() {
      fetch(`${API_BASE}/api/products/redemptions`, {
        headers: { 'x-username': loginUser.username }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          displayRedemptionHistory(data.redemptions);
        }
      })
      .catch(err => console.error('è¼‰å…¥å…Œæ›è¨˜éŒ„å¤±æ•—:', err));
    }

    function displayRedemptionHistory(redemptions) {
      const container = document.getElementById('redemptionHistory');

      if (redemptions.length === 0) {
        container.innerHTML = '<div class="text-center text-secondary" style="padding: 2rem;">é‚„æ²’æœ‰å…Œæ›è¨˜éŒ„</div>';
        return;
      }

      container.innerHTML = '';

      redemptions.forEach(redemption => {
        const card = document.createElement('div');
        card.style.background = 'white';
        card.style.borderRadius = '0.8rem';
        card.style.padding = '1.2rem';
        card.style.marginBottom = '1rem';
        card.style.boxShadow = 'var(--shadow-sm)';
        card.style.borderLeft = '4px solid #e5e7eb';

        let statusText = 'ç‹€æ…‹æœªçŸ¥';
        let statusColor = '#6b7280';
        
        switch(redemption.status) {
          case 'pending': 
            statusText = 'è™•ç†ä¸­'; 
            statusColor = '#f59e0b'; 
            card.style.borderLeftColor = statusColor;
            break;
          case 'completed': 
            statusText = 'å·²å®Œæˆ'; 
            statusColor = '#10b981'; 
            card.style.borderLeftColor = statusColor;
            break;
          case 'cancelled': 
            statusText = 'å·²å–æ¶ˆ'; 
            statusColor = '#ef4444'; 
            card.style.borderLeftColor = statusColor;
            break;
        }

        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
            <div style="font-weight:600; font-size:1.1rem;">${redemption.product_name}</div>
            <div style="color:${statusColor}; font-weight:600; font-size:0.9rem;">${statusText}</div>
          </div>
          <div style="color:var(--text-secondary); font-size:0.9rem; display:flex; gap:1rem;">
            <div>ğŸ“… ${new Date(redemption.redeemed_at).toLocaleDateString()}</div>
            <div>ğŸ’ -${redemption.points_used} ç©åˆ†</div>
          </div>
          ${redemption.notes ? `<div style="margin-top:0.5rem; font-size:0.9rem; color:#666; font-style:italic;">å‚™è¨»ï¼š${redemption.notes}</div>` : ''}
        `;

        container.appendChild(card);
      });
    }

    // åˆå§‹åŒ–
    loadUserPoints();
    loadProducts();
    loadRedemptionHistory();
  </script>
  <script src="/js/nav-access.js"></script>
</body>
</html>
