<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å•†å“å…Œæ› | GPS è§¸ç™¼ä»»å‹™ç³»çµ±</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
</head>
<body>
  <header id="mainHeader">
    <div class="header-content" id="headerContent">
      <h1 id="pageTitle">å•†å“å…Œæ›</h1>
      <button id="hamburgerBtn" class="hamburger" aria-label="å±•é–‹é¸å–®">&#9776;</button>
      <nav class="main-nav">
        <a href="/index.html">é¦–é </a>
        <a href="/map.html">åœ°åœ–é </a>
        <a href="/tasks-list.html" id="navTasksList">ä»»å‹™åˆ—è¡¨</a>
        <a href="/user-tasks.html">ä»»å‹™å¯©æ ¸</a>
        <a href="/staff-dashboard.html" id="navStaff" style="display:none;">æ–°å¢ä»»å‹™</a>
        <a href="/role-management.html" id="navRoleMgmt" style="display:none;">æ¬Šé™ç®¡ç†</a>
        <a href="/user-dashboard.html" id="navUserTasks" style="display:none;">ç”¨æˆ¶ä»»å‹™ç®¡ç†</a>
        <a href="/products.html" class="current-page">å•†å“å…Œæ›</a>
        <a href="/redeem-tasks.html" id="navRedeem" style="display:none;">å…Œæ›å•†å“ç®¡ç†</a>
        <span id="loginUserInfo" style="display:none; color:var(--text-secondary); padding:0.5rem 1rem;"></span>
        <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- ç”¨æˆ¶ç©åˆ†å¡ç‰‡ -->
    <div style="background: var(--gradient-primary); color: white; border-radius: 1rem; padding: 2rem; margin: 0 auto 2rem auto; max-width: 400px; text-align: center; box-shadow: var(--shadow-lg);">
      <h2 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; opacity: 0.9;">æˆ‘çš„ç©åˆ†</h2>
      <div id="userPoints" style="font-size: 3rem; font-weight: 700; margin: 0.5rem 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">0</div>
      <div style="font-size: 0.9rem; opacity: 0.8;">ç´¯è¨ˆç©åˆ†</div>
    </div>

    <!-- å•†å“åˆ—è¡¨ -->
    <section class="mb-4">
      <h2 class="text-center mb-4">ğŸ å¯å…Œæ›å•†å“</h2>
      <div id="productsGrid" class="card-grid">
        <div class="loading-spinner"></div>
      </div>
    </section>

    <!-- å…Œæ›è¨˜éŒ„ -->
    <section style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
      <h2 class="text-center mb-4">ğŸ“‹ å…Œæ›è¨˜éŒ„</h2>
      <div id="redemptionHistory">
        <div class="loading-spinner"></div>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 GPS ä»»å‹™ç³»çµ± - åœ°æ–¹é–‹ç®±ä»»å‹™éŠæˆ²
  </footer>

  <script>
    // HeaderåŠŸèƒ½
    const loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');

    // æ¬Šé™æª¢æŸ¥
    if (!loginUser) {
      alert('è«‹å…ˆç™»å…¥');
      window.location.href = '/login.html';
    }

    // æ¬Šé™æª¢æŸ¥å’Œå°èˆªé¡¯ç¤º
    if (loginUser) {
      const userInfoSpan = document.getElementById('loginUserInfo');
      userInfoSpan.style.display = 'inline-block';
      userInfoSpan.textContent = getUserDisplayName(loginUser);
      
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = function() {
        localStorage.removeItem('loginUser');
        window.location.href = '/login.html';
      };

      if (loginUser.role === 'admin') {
        document.getElementById('navStaff').style.display = '';
        document.getElementById('navRedeem').style.display = '';
      } else if (loginUser.role === 'shop') {
        document.getElementById('navStaff').style.display = '';
        document.getElementById('navRedeem').style.display = '';
      }
      
      if (loginUser.role === 'user') {
        document.getElementById('navUserTasks').style.display = '';
      }
      
      if (loginUser && (loginUser.role === 'shop' || loginUser.role === 'admin')) {
        const navTasksList = document.getElementById('navTasksList');
        if (navTasksList) navTasksList.style.display = 'none';
      }
    }

    function getUserDisplayName(loginUser) {
      switch(loginUser.role) {
        case 'admin': return `ç®¡ç†å“¡ï¼š${loginUser.username}`;
        case 'shop': return `å•†åº—ï¼š${loginUser.username}`;
        case 'user': return `ç”¨æˆ¶ï¼š${loginUser.username}`;
        default: return loginUser.username;
      }
    }

    document.getElementById('hamburgerBtn').onclick = function() {
      document.getElementById('headerContent').classList.toggle('open');
    };

    document.querySelectorAll('.main-nav a').forEach(a => {
      a.onclick = () => document.getElementById('headerContent').classList.remove('open');
    });

    // é é¢æ•¸æ“šè¼‰å…¥
    const API_BASE = '';

    // è¼‰å…¥ç”¨æˆ¶ç©åˆ†
    function loadUserPoints() {
      fetch(`${API_BASE}/api/user/points`, {
        headers: { 'x-username': loginUser.username }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('userPoints').textContent = data.totalPoints;
        }
      })
      .catch(err => console.error('è¼‰å…¥ç©åˆ†å¤±æ•—:', err));
    }

    // è¼‰å…¥å•†å“åˆ—è¡¨
    function loadProducts() {
      fetch(`${API_BASE}/api/products`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          displayProducts(data.products);
        } else {
          document.getElementById('productsGrid').innerHTML = '<div class="text-center text-secondary">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
        }
      })
      .catch(err => {
        console.error('è¼‰å…¥å•†å“å¤±æ•—:', err);
        document.getElementById('productsGrid').innerHTML = '<div class="text-center text-secondary">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      });
    }

    // é¡¯ç¤ºå•†å“
    function displayProducts(products) {
      const container = document.getElementById('productsGrid');

      if (products.length === 0) {
        container.innerHTML = '<div class="text-center text-secondary" style="grid-column: 1/-1; padding: 2rem;">ç›®å‰æ²’æœ‰å¯å…Œæ›çš„å•†å“<br>æ•¬è«‹æœŸå¾…ï¼</div>';
        return;
      }

      container.innerHTML = '';

      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'card';

        const isLowStock = product.stock <= 5;
        const stockText = isLowStock ? `åƒ…å‰© ${product.stock} å€‹` : `åº«å­˜ï¼š${product.stock}`;
        const stockColor = isLowStock ? 'text-danger' : 'text-secondary';

        const creatorInfo = product.creator_username
          ? `<div style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:0.5rem;">ğŸ‘¤ åˆ†äº«è€…ï¼š${product.creator_username}</div>`
          : '';

        const isOwnProduct = loginUser && loginUser.username === product.created_by;
        const isStaff = loginUser && loginUser.role === 'shop';

        let redeemButtonHtml;
        if (product.stock <= 0) {
          redeemButtonHtml = `<button class="btn btn-secondary w-100" disabled>å·²å”®å®Œ</button>`;
        } else if (isStaff && isOwnProduct) {
          redeemButtonHtml = `<div class="text-center text-danger" style="font-size:0.9rem; padding:0.6rem;">âš ï¸ ç„¡æ³•å…Œæ›è‡ªå·±çš„å•†å“</div>`;
        } else {
          redeemButtonHtml = `<button class="btn btn-primary w-100" onclick="redeemProduct(${product.id}, ${product.points_required}, ${product.stock})">ç«‹å³å…Œæ›</button>`;
        }

        card.innerHTML = `
          <img src="${product.image_url || '/images/mascot.png'}" class="card-img" alt="${product.name}" onerror="this.src='/images/mascot.png'">
          <div class="card-body">
            <div class="card-title">${product.name}</div>
            ${creatorInfo}
            <div class="card-text">
              <div style="margin-bottom:8px; color:var(--text-secondary); font-size:0.95rem;">${product.description || 'ç„¡æè¿°'}</div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <span class="text-primary" style="font-weight:600; font-size:1.1rem;">${product.points_required} ç©åˆ†</span>
                <span class="${stockColor}" style="font-size:0.9rem;">${stockText}</span>
              </div>
            </div>
            <div class="card-footer" style="display:block;">
              ${redeemButtonHtml}
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // å…Œæ›å•†å“
    window.redeemProduct = function(productId, pointsRequired, stock) {
      if (stock <= 0) {
        alert('å•†å“å·²å”®å®Œï¼');
        return;
      }

      const currentPoints = parseInt(document.getElementById('userPoints').textContent);
      if (currentPoints < pointsRequired) {
        alert(`ç©åˆ†ä¸è¶³ï¼éœ€è¦ ${pointsRequired} ç©åˆ†ï¼Œæ‚¨ç›®å‰æœ‰ ${currentPoints} ç©åˆ†ã€‚`);
        return;
      }

      if (!confirm(`ç¢ºå®šè¦å…Œæ›é€™å€‹å•†å“å—ï¼Ÿå°‡æ¶ˆè€— ${pointsRequired} ç©åˆ†ã€‚`)) {
        return;
      }

      fetch(`${API_BASE}/api/products/${productId}/redeem`, {
        method: 'POST',
        headers: { 'x-username': loginUser.username },
        credentials: 'include' // ç™¼é€ cookies (JWT)ï¼Œç¢ºä¿èªè­‰è³‡è¨Šå‚³é
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          loadUserPoints();
          loadProducts();
          loadRedemptionHistory();
        } else {
          alert(data.message || 'å…Œæ›å¤±æ•—');
        }
      })
      .catch(err => {
        console.error('å…Œæ›å¤±æ•—:', err);
        alert('å…Œæ›å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      });
    };

    // è¼‰å…¥å…Œæ›è¨˜éŒ„
    function loadRedemptionHistory() {
      fetch(`${API_BASE}/api/products/redemptions`, {
        headers: { 'x-username': loginUser.username },
        credentials: 'include' // ç™¼é€ cookies (JWT)ï¼Œç¢ºä¿èªè­‰è³‡è¨Šå‚³é
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          displayRedemptionHistory(data.redemptions);
        }
      })
      .catch(err => console.error('è¼‰å…¥å…Œæ›è¨˜éŒ„å¤±æ•—:', err));
    }

    function displayRedemptionHistory(redemptions) {
      const container = document.getElementById('redemptionHistory');

      if (!redemptions || redemptions.length === 0) {
        container.innerHTML = '<div class="text-center text-secondary" style="padding: 2rem;">é‚„æ²’æœ‰å…Œæ›è¨˜éŒ„</div>';
        return;
      }

      container.innerHTML = '';

      // åˆ†é¡å…Œæ›è¨˜éŒ„
      const pendingRedemptions = redemptions.filter(r => r.status === 'pending');
      const completedRedemptions = redemptions.filter(r => r.status === 'completed');
      const cancelledRedemptions = redemptions.filter(r => r.status === 'cancelled');
      
      console.log('å…Œæ›è¨˜éŒ„åˆ†é¡:', { 
        pending: pendingRedemptions.length, 
        completed: completedRedemptions.length, 
        cancelled: cancelledRedemptions.length 
      });

      // é¡¯ç¤ºè™•ç†ä¸­çš„å…Œæ›
      if (pendingRedemptions.length > 0) {
        console.log('å‰µå»ºã€Œè™•ç†ä¸­ã€åˆ†é¡æ¨™é¡Œ');
        const pendingSection = document.createElement('div');
        pendingSection.style.cssText = 'margin-top: 1.5rem; margin-bottom: 1rem; width: 100%; background: #fff3cd; padding: 0.5rem; border-radius: 0.5rem;';
        const h3 = document.createElement('h3');
        h3.textContent = 'â³ è™•ç†ä¸­';
        h3.style.cssText = 'font-size: 1.3rem !important; color: #f59e0b !important; margin: 0 !important; padding: 0.75rem 0 !important; font-weight: 700 !important; border-bottom: 3px solid #f59e0b !important; display: block !important; width: 100% !important; background: transparent !important;';
        pendingSection.appendChild(h3);
        container.appendChild(pendingSection);
        console.log('ã€Œè™•ç†ä¸­ã€æ¨™é¡Œå·²æ·»åŠ åˆ° DOMï¼ŒpendingSection:', pendingSection);
        pendingRedemptions.forEach(redemption => {
          container.appendChild(createRedemptionCard(redemption, 'pending'));
        });
      }

      // é¡¯ç¤ºå·²å®Œæˆçš„å…Œæ›ï¼ˆæˆ‘çš„å…Œæ›å•†å“ï¼‰
      if (completedRedemptions.length > 0) {
        const completedSection = document.createElement('div');
        completedSection.style.cssText = `margin-top: ${pendingRedemptions.length > 0 ? '2.5rem' : '1.5rem'}; margin-bottom: 1rem; width: 100%;`;
        const h3 = document.createElement('h3');
        h3.textContent = 'âœ… æˆ‘çš„å…Œæ›å•†å“';
        h3.style.cssText = 'font-size: 1.3rem !important; color: #10b981 !important; margin: 0 !important; padding: 0.75rem 0 !important; font-weight: 700 !important; border-bottom: 3px solid #10b981 !important; display: block !important; width: 100% !important; background: transparent !important;';
        completedSection.appendChild(h3);
        container.appendChild(completedSection);
        completedRedemptions.forEach(redemption => {
          container.appendChild(createRedemptionCard(redemption, 'completed'));
        });
      }

      // é¡¯ç¤ºå·²å–æ¶ˆçš„å…Œæ›
      if (cancelledRedemptions.length > 0) {
        const cancelledSection = document.createElement('div');
        const hasOtherSections = pendingRedemptions.length > 0 || completedRedemptions.length > 0;
        cancelledSection.style.cssText = `margin-top: ${hasOtherSections ? '2.5rem' : '1.5rem'}; margin-bottom: 1rem; width: 100%;`;
        const h3 = document.createElement('h3');
        h3.textContent = 'âŒ å·²å–æ¶ˆ';
        h3.style.cssText = 'font-size: 1.3rem !important; color: #ef4444 !important; margin: 0 !important; padding: 0.75rem 0 !important; font-weight: 700 !important; border-bottom: 3px solid #ef4444 !important; display: block !important; width: 100% !important; background: transparent !important;';
        cancelledSection.appendChild(h3);
        container.appendChild(cancelledSection);
        cancelledRedemptions.forEach(redemption => {
          container.appendChild(createRedemptionCard(redemption, 'cancelled'));
        });
      }
    }

    function createRedemptionCard(redemption, status) {
      const card = document.createElement('div');
      card.style.background = 'white';
      card.style.borderRadius = '0.8rem';
      card.style.padding = '1.2rem';
      card.style.marginBottom = '1rem';
      card.style.boxShadow = 'var(--shadow-sm)';
      card.style.borderLeft = '4px solid #e5e7eb';
      card.style.display = 'flex';
      card.style.gap = '1rem';
      card.style.alignItems = 'flex-start';

      let statusText = 'ç‹€æ…‹æœªçŸ¥';
      let statusColor = '#6b7280';
      
      switch(status) {
        case 'pending': 
          statusText = 'è™•ç†ä¸­'; 
          statusColor = '#f59e0b'; 
          break;
        case 'completed': 
          statusText = 'å·²å®Œæˆ'; 
          statusColor = '#10b981'; 
          break;
        case 'cancelled': 
          statusText = 'å·²å–æ¶ˆ'; 
          statusColor = '#ef4444'; 
          break;
      }
      card.style.borderLeftColor = statusColor;

      // å•†å“åœ–ç‰‡
      const imageHtml = redemption.image_url 
        ? `<img src="${redemption.image_url}" alt="${redemption.product_name}" style="width:80px; height:80px; object-fit:cover; border-radius:0.5rem; flex-shrink:0;">`
        : `<div style="width:80px; height:80px; background:#f3f4f6; border-radius:0.5rem; display:flex; align-items:center; justify-content:center; font-size:2rem; flex-shrink:0;">ğŸ</div>`;

      // å†æ¬¡å…Œæ›æŒ‰éˆ•ï¼ˆåƒ…é™å·²å®Œæˆçš„å…Œæ›ï¼‰
      let redeemAgainBtn = '';
      if (status === 'completed') {
        // éœ€è¦æª¢æŸ¥å•†å“æ˜¯å¦é‚„æœ‰åº«å­˜ï¼ˆé€™è£¡å…ˆé¡¯ç¤ºæŒ‰éˆ•ï¼Œé»æ“Šæ™‚å†æª¢æŸ¥ï¼‰
        redeemAgainBtn = `<button class="btn btn-sm btn-outline-primary" onclick="redeemProductAgain(${redemption.product_id}, '${redemption.product_name}')" style="margin-top:0.5rem; font-size:0.85rem; padding:0.4rem 0.8rem;">ğŸ”„ å†æ¬¡å…Œæ›</button>`;
      }

      card.innerHTML = `
        ${imageHtml}
        <div style="flex:1; min-width:0;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem;">
            <div style="font-weight:600; font-size:1.1rem; color:#333;">${redemption.product_name}</div>
            <div style="color:${statusColor}; font-weight:600; font-size:0.9rem; white-space:nowrap; margin-left:1rem;">${statusText}</div>
          </div>
          <div style="color:var(--text-secondary); font-size:0.9rem; display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:0.5rem;">
            <div>ğŸ“… ${new Date(redemption.redeemed_at).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
            <div>ğŸ’ -${redemption.points_used} ç©åˆ†</div>
          </div>
          ${redemption.notes ? `<div style="margin-top:0.5rem; font-size:0.9rem; color:#666; font-style:italic; background:#f9fafb; padding:0.5rem; border-radius:0.4rem;">ğŸ“ å‚™è¨»ï¼š${redemption.notes}</div>` : ''}
          ${redeemAgainBtn}
        </div>
      `;

      return card;
    }

    // å†æ¬¡å…Œæ›å•†å“
    window.redeemProductAgain = function(productId, productName) {
      if (!confirm(`ç¢ºå®šè¦å†æ¬¡å…Œæ›ã€Œ${productName}ã€å—ï¼Ÿ`)) {
        return;
      }
      // ä½¿ç”¨ç¾æœ‰çš„ redeemProduct å‡½æ•¸
      // éœ€è¦å…ˆç²å–å•†å“çš„ç©åˆ†å’Œåº«å­˜ä¿¡æ¯
      fetch(`${API_BASE}/api/products`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const product = data.products.find(p => p.id === productId);
            if (product) {
              redeemProduct(productId, product.points_required, product.stock);
            } else {
              alert('æ‰¾ä¸åˆ°è©²å•†å“');
            }
          } else {
            alert('è¼‰å…¥å•†å“è³‡è¨Šå¤±æ•—');
          }
        })
        .catch(err => {
          console.error('è¼‰å…¥å•†å“è³‡è¨Šå¤±æ•—:', err);
          alert('è¼‰å…¥å•†å“è³‡è¨Šå¤±æ•—');
        });
    };

    // åˆå§‹åŒ–
    loadUserPoints();
    loadProducts();
    loadRedemptionHistory();
  </script>
  <script src="/js/nav-access.js"></script>
</body>
</html>
