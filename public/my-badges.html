<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„ç¨±è™Ÿ | GPS è§¸ç™¼ä»»å‹™ç³»çµ±</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
  <style>
    /* Header styles */
    header {
      text-align: center;
      position: relative;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 15px 20px;
      margin-bottom: 20px;
    }
    .main-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    .main-nav a {
      color: #555;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    .main-nav a:hover {
      background: #f5f5f5;
      color: #007bff;
    }
    .main-nav button {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .main-nav button:hover {
      background: #c82333;
    }

    .badges-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .badges-hero {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      color: white;
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
    }

    .badges-hero h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .badges-hero p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .badges-stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 1.5rem;
    }

    .badge-stat {
      text-align: center;
    }

    .badge-stat-number {
      font-size: 2rem;
      font-weight: 700;
      display: block;
    }

    .badge-stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 0.3rem;
    }

    .badges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .badge-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .badge-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .badge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .badge-image {
      width: 120px;
      height: 120px;
      object-fit: contain;
      margin: 0 auto 1rem;
      border-radius: 50%;
      border: 4px solid #f0f0f0;
      background: #fafafa;
    }

    .badge-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .badge-source {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .badge-date {
      font-size: 0.85rem;
      color: #999;
    }

    .badge-date::before {
      content: 'ğŸ—“ï¸ ';
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .empty-state-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
    }

    .empty-state-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .empty-state-text {
      font-size: 1rem;
      color: #666;
      margin-bottom: 1.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border-radius: 30px;
      text-decoration: none;
      display: inline-block;
      font-weight: 600;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.2rem;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:1.8rem; color:#333;">ğŸ† æˆ‘çš„ç¨±è™Ÿ</h1>
    <nav class="main-nav">
      <a href="/user-dashboard.html">ğŸ“Š ä»»å‹™ä¸­å¿ƒ</a>
      <a href="/map.html">ğŸ—ºï¸ åœ°åœ–</a>
      <a href="/shop.html">ğŸ›’ å•†åº—</a>
      <a href="/inventory.html">ğŸ’ èƒŒåŒ…</a>
      <a href="/my-badges.html" style="background:#f0f0f0; color:#007bff;">ğŸ† ç¨±è™Ÿ</a>
      <span id="user-greeting"></span>
      <button id="logout-btn">ç™»å‡º</button>
    </nav>
  </header>

  <div class="badges-container">
    <div class="badges-hero">
      <h1>âœ¨ æ¦®è­½æ®¿å ‚</h1>
      <p>æ‚¨é€šéå†’éšªç²å¾—çš„æ‰€æœ‰ç¨±è™Ÿ</p>
      <div class="badges-stats">
        <div class="badge-stat">
          <span class="badge-stat-number" id="total-badges">0</span>
          <span class="badge-stat-label">ç²å¾—ç¨±è™Ÿ</span>
        </div>
        <div class="badge-stat">
          <span class="badge-stat-number" id="quest-badges">0</span>
          <span class="badge-stat-label">åŠ‡æƒ…ç¨±è™Ÿ</span>
        </div>
      </div>
    </div>

    <div id="badges-content">
      <div class="loading">â³ è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script>
    const API_BASE = '';

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkAuth() {
      const loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');
      if (!loginUser) {
        window.location.href = '/login.html';
        return null;
      }
      document.getElementById('user-greeting').textContent = `ğŸ‘¤ ${loginUser.username}`;
      return loginUser;
    }

    // ç™»å‡º
    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('loginUser');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    };

    // è¼‰å…¥ç¨±è™Ÿ
    async function loadBadges() {
      const loginUser = checkAuth();
      if (!loginUser) return;

      try {
        const res = await fetch(`${API_BASE}/api/user/badges`, {
          headers: { 'x-username': loginUser.username }
        });
        const data = await res.json();

        if (data.success) {
          displayBadges(data.badges);
        } else {
          document.getElementById('badges-content').innerHTML = 
            '<div class="empty-state"><div class="empty-state-icon">ğŸ˜¢</div><div class="empty-state-title">è¼‰å…¥å¤±æ•—</div></div>';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('badges-content').innerHTML = 
          '<div class="empty-state"><div class="empty-state-icon">âŒ</div><div class="empty-state-title">é€£ç·šéŒ¯èª¤</div></div>';
      }
    }

    // é¡¯ç¤ºç¨±è™Ÿ
    function displayBadges(badges) {
      const content = document.getElementById('badges-content');
      
      if (badges.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ–ï¸</div>
            <div class="empty-state-title">é‚„æ²’æœ‰ç¨±è™Ÿ</div>
            <div class="empty-state-text">å®ŒæˆåŠ‡æƒ…ä»»å‹™å³å¯ç²å¾—å°ˆå±¬ç¨±è™Ÿï¼</div>
            <a href="/map.html" class="btn-primary">é–‹å§‹å†’éšª</a>
          </div>
        `;
        return;
      }

      // æ›´æ–°çµ±è¨ˆ
      document.getElementById('total-badges').textContent = badges.length;
      document.getElementById('quest-badges').textContent = badges.filter(b => b.source_type === 'quest').length;

      // é¡¯ç¤ºç¨±è™Ÿåˆ—è¡¨
      const grid = document.createElement('div');
      grid.className = 'badges-grid';

      badges.forEach(badge => {
        const card = document.createElement('div');
        card.className = 'badge-card';

        const img = document.createElement('img');
        img.className = 'badge-image';
        img.src = badge.image_url || '/images/mascot.png';
        img.alt = badge.name;
        img.onerror = () => { img.src = '/images/mascot.png'; };

        const name = document.createElement('div');
        name.className = 'badge-name';
        name.textContent = badge.name;

        const source = document.createElement('div');
        source.className = 'badge-source';
        source.textContent = badge.source_type === 'quest' ? 'ğŸ—ºï¸ åŠ‡æƒ…ä»»å‹™' : 
                             badge.source_type === 'event' ? 'ğŸ‰ ç‰¹æ®Šæ´»å‹•' : 'âœ¨ ç‰¹æ®Šçå‹µ';

        const date = document.createElement('div');
        date.className = 'badge-date';
        date.textContent = new Date(badge.obtained_at).toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        card.appendChild(img);
        card.appendChild(name);
        card.appendChild(source);
        card.appendChild(date);
        grid.appendChild(card);
      });

      content.innerHTML = '';
      content.appendChild(grid);
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadBadges();
  </script>
</body>
</html>

