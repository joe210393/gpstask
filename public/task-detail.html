<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä»»å‹™è©³æƒ… | GPS è§¸ç™¼ä»»å‹™ç³»çµ±</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
  <style>
    .detail-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem 4rem;
    }
    .detail-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 1.5rem;
      box-shadow: var(--shadow-lg);
      padding: 2rem;
    }
    .task-type-chip {
      display: inline-block;
      padding: 0.2rem 0.9rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--gradient-primary);
      color: #fff;
    }
    .task-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.5rem;
      margin: 1.25rem 0;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }
    .task-detail-img {
      width: 100%;
      border-radius: 1rem;
      margin: 1.25rem 0;
      object-fit: cover;
      box-shadow: var(--shadow-light);
    }
    #taskDetail h2 {
      margin: 0;
      font-size: 1.6rem;
      color: var(--text-primary);
    }
    #taskDetail iframe {
      width: 100%;
      max-width: 640px;
      height: 360px;
      border: none;
      border-radius: 1rem;
      margin-top: 1rem;
      box-shadow: var(--shadow-light);
    }
    .task-detail-loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem 1rem;
    }
    .detail-actions {
      margin-top: 1.5rem;
    }
    .detail-actions .btn {
      width: 100%;
    }
    .answer-container {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div class="header-content" id="headerContent">
      <h1 id="pageTitle">ä»»å‹™è©³æƒ…</h1>
      <button id="hamburgerBtn" class="hamburger" aria-label="å±•é–‹é¸å–®">&#9776;</button>
      <nav class="main-nav">
        <a href="/index.html">é¦–é </a>
        <a href="/map.html">åœ°åœ–é </a>
        <a href="/tasks-list.html" id="navTasksList">ä»»å‹™åˆ—è¡¨</a>
        <a href="/user-tasks.html">ä»»å‹™å¯©æ ¸</a>
        <a href="/staff-dashboard.html" id="navStaff" style="display:none;">æ–°å¢ä»»å‹™</a>
        <a href="/role-management.html" id="navRoleMgmt" style="display:none;">æ¬Šé™ç®¡ç†</a>
        <a href="/user-dashboard.html" id="navUserTasks" style="display:none;">ç”¨æˆ¶ä»»å‹™ç®¡ç†</a>
        <a href="/products.html">å•†å“å…Œæ›</a>
        <a href="/redeem-tasks.html" id="navRedeem" style="display:none;">å…Œæ›å•†å“ç®¡ç†</a>
        <span id="loginUserInfo" style="display:none; color:var(--text-secondary); padding:0.5rem 1rem;"></span>
        <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
      </nav>
    </div>
  </header>

  <main>
    <section class="detail-wrapper">
      <div class="detail-card">
        <div id="taskDetail" class="task-detail-loading">
          <div class="loading-spinner"></div>
          <p style="margin-top:0.75rem;">è¼‰å…¥ä»»å‹™ä¸­...</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 GPS ä»»å‹™ç³»çµ± - åœ°æ–¹é–‹ç®±ä»»å‹™éŠæˆ²
  </footer>

  <script>
    const loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');
    window.loginUser = loginUser;

    const userInfoSpan = document.getElementById('loginUserInfo');
    const logoutBtn = document.getElementById('logoutBtn');

    if (loginUser) {
      userInfoSpan.style.display = 'inline-block';
      userInfoSpan.textContent = getUserDisplayName(loginUser);
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = function() {
        localStorage.removeItem('loginUser');
        window.location.href = '/login.html';
      };

      if (loginUser.role === 'admin' || loginUser.role === 'shop') {
        document.getElementById('navStaff').style.display = '';
        document.getElementById('navRedeem').style.display = '';
      }
      if (loginUser.role === 'user') {
        document.getElementById('navUserTasks').style.display = '';
      }
      if (loginUser.role === 'shop' || loginUser.role === 'admin') {
        const navTasksList = document.getElementById('navTasksList');
        if (navTasksList) navTasksList.style.display = 'none';
      }
    }

    function getUserDisplayName(user) {
      switch(user.role) {
        case 'admin': return `ç®¡ç†å“¡ï¼š${user.username}`;
        case 'shop': return `å•†åº—ï¼š${user.username}`;
        case 'user': return `ç”¨æˆ¶ï¼š${user.username}`;
        default: return user.username;
      }
    }

    document.getElementById('hamburgerBtn').onclick = function() {
      document.getElementById('headerContent').classList.toggle('open');
    };
    document.querySelectorAll('.main-nav a, .main-nav button').forEach(element => {
      element.addEventListener('click', () => document.getElementById('headerContent').classList.remove('open'));
    });
  </script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const API_BASE = '';
    const taskDetailEl = document.getElementById('taskDetail');

    if (!id) {
      taskDetailEl.innerHTML = '<div class="text-center text-danger">æœªæŒ‡å®šä»»å‹™ ID</div>';
    } else {
      fetch(`${API_BASE}/api/tasks/${id}`, {
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          if (!data.success || !data.task) {
            taskDetailEl.innerHTML = '<div class="text-center text-danger">æ‰¾ä¸åˆ°ä»»å‹™</div>';
            return;
          }
          const t = data.task;

          const typeMap = {
            qa: 'å•ç­”é¡Œ',
            multiple_choice: 'é¸æ“‡é¡Œ',
            photo: 'æ‹ç…§ä»»å‹™',
            number: 'æ•¸å­—è§£è¬',
            keyword: 'é—œéµå­—è§£ç¢¼',
            location: 'åœ°ç†åœæ¬„æ‰“å¡'
          };
          const taskTypeLabel = typeMap[t.task_type] || 'å•ç­”é¡Œ';

          // è§£æé¸é …ï¼ˆå¦‚æœæ˜¯ JSON å­—ä¸²ï¼‰
          let options = [];
          if (t.task_type === 'multiple_choice' && t.options) {
            options = typeof t.options === 'string' ? JSON.parse(t.options) : t.options;
          }

          let rewardItemHtml = '';
          if (t.reward_item_name) {
            rewardItemHtml = `<div style="margin-top:5px; color:#28a745; font-weight:bold; font-size:0.9rem;">ğŸ å®Œæˆçå‹µï¼š${t.reward_item_name}</div>`;
          }

          taskDetailEl.innerHTML = `
            <h2>${t.name}</h2>
            <div class="task-meta-grid">
              <span class="task-type-chip">${taskTypeLabel}</span>
              <span>ğŸ“ (${t.lat}, ${t.lng})</span>
              <span>ğŸ¯ åŠå¾‘ï¼š${t.radius} å…¬å°º</span>
              <span>ğŸ’° ç©åˆ†ï¼š${t.points || 0}</span>
            </div>
            ${rewardItemHtml}
            <div style="margin-bottom:18px; color:var(--text-secondary); line-height:1.6;">${t.description}</div>
            <img src="${t.photoUrl}" alt="ä»»å‹™ç…§ç‰‡" class="task-detail-img" onerror="this.src='/images/mascot.png'">
            <!-- YouTube å½±ç‰‡å·²ç§»è‡³ AR æ¨¡å¼ï¼Œæ­¤è™•ä¸å†é¡¯ç¤º -->
            <div class="detail-actions">
              <button id="startTaskBtn" class="btn btn-primary">é–‹å§‹ä»»å‹™</button>
              <div id="taskMsg" style="margin-top:15px; font-weight:600;"></div>
            </div>
            <div id="answerSection" class="answer-container"></div>
          `;

          const startTaskBtn = document.getElementById('startTaskBtn');
          const taskMsgEl = document.getElementById('taskMsg');

          if (loginUser && loginUser.role === 'shop') {
            startTaskBtn.style.display = 'none';
            taskMsgEl.textContent = 'å·¥ä½œäººå“¡å¸³è™Ÿç„¡æ³•åƒèˆ‡ä»»å‹™';
            return;
          }

          if (loginUser && loginUser.username) {
            fetch(`${API_BASE}/api/user-tasks/all?username=${encodeURIComponent(loginUser.username)}`, {
              credentials: 'include'
            })
              .then(res => res.json())
              .then(udata => {
                if (udata.success && Array.isArray(udata.tasks)) {
                  // å·²å®Œæˆ
                  const completedTask = udata.tasks.find(x => x.id == t.id && x.status === 'å®Œæˆ');
                  if (completedTask) {
                    startTaskBtn.textContent = 'ä»»å‹™å·²å®Œæˆ';
                    startTaskBtn.disabled = true;
                    startTaskBtn.style.backgroundColor = '#6c757d';
                    
                    // å¦‚æœæ˜¯åŠ‡æƒ…ä»»å‹™ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€é—œä¸¦å¼•å°ç”¨æˆ¶
                    if (t.type === 'quest' && t.quest_chain_id && t.quest_order) {
                      // ç²å–åŠ‡æƒ…é€²åº¦
                      fetch(`${API_BASE}/api/user/quest-progress`, {
                        headers: { 'x-username': loginUser.username },
                        credentials: 'include'
                      })
                      .then(res => res.json())
                      .then(progressData => {
                        if (progressData.success) {
                          const progress = progressData.progress || {};
                          const chainId = String(t.quest_chain_id);
                          const currentStep = progress[chainId];
                          
                          // å¦‚æœæœ‰ä¸‹ä¸€é—œï¼ˆcurrentStep > ç•¶å‰é—œå¡ï¼‰ï¼Œå¼•å°ç”¨æˆ¶åˆ°ä¸‹ä¸€é—œ
                          if (currentStep && Number(currentStep) > Number(t.quest_order)) {
                            // ç²å–æ‰€æœ‰ä»»å‹™ï¼Œæ‰¾åˆ°ä¸‹ä¸€é—œ
                            fetch(`${API_BASE}/api/tasks`)
                              .then(res => res.json())
                              .then(tasksData => {
                                if (tasksData.success) {
                                  const nextTask = tasksData.tasks.find(task => 
                                    String(task.quest_chain_id) === chainId &&
                                    Number(task.quest_order) === Number(currentStep) &&
                                    task.type === 'quest'
                                  );
                                  
                                  if (nextTask) {
                                    taskMsgEl.innerHTML = `
                                      <div style="color:#28a745; margin-bottom:10px;">âœ… æ‚¨å·²å®Œæˆæ­¤ä»»å‹™</div>
                                      <div style="color:var(--text-secondary); margin-bottom:15px;">ğŸ“š é€™æ˜¯åŠ‡æƒ…ä»»å‹™çš„ç¬¬ ${t.quest_order} é—œï¼Œä¸‹ä¸€é—œå·²è§£é–ï¼</div>
                                      <button id="goToNextTaskBtn" class="btn btn-primary" style="width:100%;">å‰å¾€ä¸‹ä¸€é—œï¼š${nextTask.name}</button>
                                    `;
                                    
                                    document.getElementById('goToNextTaskBtn').onclick = function() {
                                      window.location.href = `/task-detail.html?id=${nextTask.id}`;
                                    };
                                  } else {
                                    taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                                    taskMsgEl.style.color = '#28a745';
                                  }
                                } else {
                                  taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                                  taskMsgEl.style.color = '#28a745';
                                }
                              })
                              .catch(err => {
                                console.error('ç²å–ä¸‹ä¸€é—œå¤±æ•—:', err);
                                taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                                taskMsgEl.style.color = '#28a745';
                              });
                          } else {
                            // æ²’æœ‰ä¸‹ä¸€é—œæˆ–å·²å®Œæˆæ‰€æœ‰é—œå¡
                            taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                            taskMsgEl.style.color = '#28a745';
                          }
                        } else {
                          taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                          taskMsgEl.style.color = '#28a745';
                        }
                      })
                      .catch(err => {
                        console.error('ç²å–åŠ‡æƒ…é€²åº¦å¤±æ•—:', err);
                        taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                        taskMsgEl.style.color = '#28a745';
                      });
                    } else {
                      // ä¸æ˜¯åŠ‡æƒ…ä»»å‹™ï¼Œç›´æ¥é¡¯ç¤ºå®Œæˆè¨Šæ¯
                      taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                      taskMsgEl.style.color = '#28a745';
                    }
                    return;
                  }
                  // é€²è¡Œä¸­
                  const inProgressTask = udata.tasks.find(x => x.id == t.id && x.status === 'é€²è¡Œä¸­');
                  if (inProgressTask) {
                    showAnswerSection(inProgressTask.user_task_id, inProgressTask.answer || '');
                    startTaskBtn.disabled = true;
                    taskMsgEl.textContent = 'ä»»å‹™é€²è¡Œä¸­ï¼';
                  }
                }
              })
              .catch(err => console.error('æª¢æŸ¥ä»»å‹™ç‹€æ…‹å¤±æ•—:', err));
          }

          startTaskBtn.onclick = function() {
            if (!loginUser || !loginUser.username) {
              taskMsgEl.textContent = 'è«‹å…ˆç™»å…¥';
              taskMsgEl.style.color = '#dc3545';
              return;
            }
            fetch(`${API_BASE}/api/user-tasks`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ username: loginUser.username, task_id: t.id })
            })
            .then(res => res.json())
            .then(resp => {
              if (resp.success) {
                taskMsgEl.textContent = 'ä»»å‹™é€²è¡Œä¸­ï¼';
                taskMsgEl.style.color = 'var(--primary-color)';
                startTaskBtn.disabled = true;
                fetch(`${API_BASE}/api/user-tasks/all?username=${encodeURIComponent(loginUser.username)}`, {
                  credentials: 'include'
                })
                  .then(res => res.json())
                  .then(udata => {
                    if (udata.success && Array.isArray(udata.tasks)) {
                      const ut = udata.tasks.find(x => x.id == t.id && x.status === 'é€²è¡Œä¸­');
                      if (ut) showAnswerSection(ut.user_task_id, ut.answer || '');
                    }
                  });
              } else {
                taskMsgEl.textContent = resp.message || 'åŠ å…¥å¤±æ•—';
                taskMsgEl.style.color = '#dc3545';
                if (resp.message && resp.message.includes('å·²å®Œæˆé')) {
                  startTaskBtn.textContent = 'ä»»å‹™å·²å®Œæˆ';
                  startTaskBtn.disabled = true;
                  startTaskBtn.style.backgroundColor = '#6c757d';
                }
              }
            });
          };

          // Haversine è·é›¢è¨ˆç®—
          function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Km
          }

          function showAnswerSection(userTaskId, currentAnswer) {
            const answerDiv = document.getElementById('answerSection');
            answerDiv.innerHTML = '';

            // --- GPS åœæ¬„ç›£æ§ (é˜²æ­¢ä½œå¼Š) ---
            if (window.gpsWatchId) navigator.geolocation.clearWatch(window.gpsWatchId);
            const existingWarning = document.getElementById('gpsWarning');
            if (existingWarning) existingWarning.remove();

            // å°æ–¼é location é¡å‹çš„ä»»å‹™ï¼Œä¹Ÿéœ€è¦æŒçºŒç›£æ§
            if (t.task_type !== 'location') {
                const limit = (t.radius || 50) + 50; // å¯¬å®¹ 50 å…¬å°º
                const warningEl = document.createElement('div');
                warningEl.id = 'gpsWarning';
                warningEl.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:white; z-index:9999; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;';
                warningEl.innerHTML = `
                    <div style="font-size:4rem; margin-bottom:20px;">ğŸ“¡</div>
                    <h2 style="color:#ffc107; margin-bottom:10px;">è¨Šè™Ÿä¸­æ–·</h2>
                    <p style="font-size:1.1rem; line-height:1.6;">æ‚¨å·²é›¢é–‹ä»»å‹™æœ‰æ•ˆç¯„åœ<br>è«‹å›åˆ°ä»»å‹™åœ°é»ä»¥ç¹¼çºŒä½œç­”</p>
                    <div id="distDisplay" style="margin-top:20px; font-weight:bold; font-size:1.2rem;"></div>
                `;
                document.body.appendChild(warningEl);

                if (navigator.geolocation) {
                    window.gpsWatchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const distKm = haversineDistance(pos.coords.latitude, pos.coords.longitude, t.lat, t.lng);
                            const distM = distKm * 1000;
                            
                            // æª¢æŸ¥è·é›¢
                            if (distM > limit) {
                                warningEl.style.display = 'flex';
                                document.getElementById('distDisplay').textContent = `ç›®å‰è·é›¢ï¼š${Math.round(distM)} å…¬å°º`;
                                // æ¨¡ç³ŠåŒ–ç­”é¡Œå€
                                answerDiv.style.filter = 'blur(5px)';
                                answerDiv.style.pointerEvents = 'none';
                            } else {
                                warningEl.style.display = 'none';
                                answerDiv.style.filter = 'none';
                                answerDiv.style.pointerEvents = 'auto';
                            }
                        },
                        (err) => console.error('GPS ç›£æ§å¤±æ•—:', err),
                        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
                    );
                }
            }
            // ---------------------------

            const container = document.createElement('div');
            container.style.padding = '15px';
            container.style.background = '#f8f9fa';
            container.style.borderRadius = '8px';

            // AR æŒ‰éˆ•
            const arBtn = document.createElement('button');
            arBtn.className = 'btn';
            arBtn.style.width = '100%';
            arBtn.style.marginBottom = '15px';
            arBtn.style.background = '#fd7e14'; // æ©™è‰²ä»¥ç¤ºå€åˆ¥
            arBtn.style.color = 'white';
            arBtn.style.fontWeight = 'bold';
            arBtn.style.border = 'none';
            arBtn.style.borderRadius = '6px';
            arBtn.style.padding = '10px';
            arBtn.innerHTML = 'ğŸ“¸ é–‹å•Ÿ AR å°‹æ‰¾ç·šç´¢';
            arBtn.onclick = () => {
              window.location.href = `/ar-view.html?taskId=${t.id}&lat=${t.lat}&lng=${t.lng}`;
            };
            container.appendChild(arBtn);

            const title = document.createElement('div');
            title.style.fontWeight = 'bold';
            title.style.marginBottom = '10px';
            title.style.color = '#7c3aed';
            title.textContent = 'æäº¤ç­”æ¡ˆï¼š';
            container.appendChild(title);

            if (t.task_type === 'number') {
              const input = document.createElement('input');
              input.type = 'number';
              input.className = 'form-input';
              input.placeholder = 'è«‹è¼¸å…¥æ•¸å­—å¯†ç¢¼';
              input.style.fontSize = '1.5rem';
              input.style.letterSpacing = '2px';
              input.style.textAlign = 'center';
              input.style.padding = '10px';
              input.value = currentAnswer;
              container.appendChild(input);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'ğŸ”“ è§£é–';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.marginTop = '15px';
              submitBtn.style.width = '100%';
              submitBtn.onclick = () => {
                 if(!input.value) return alert('è«‹è¼¸å…¥å¯†ç¢¼');
                 submitAnswer(userTaskId, input.value);
              };
              container.appendChild(submitBtn);

            } else if (t.task_type === 'keyword') {
              const input = document.createElement('input');
              input.type = 'text';
              input.className = 'form-input';
              input.placeholder = 'è«‹è¼¸å…¥é—œéµå­—...';
              input.value = currentAnswer;
              container.appendChild(input);

              const hint = document.createElement('small');
              hint.style.color = '#666';
              hint.style.display = 'block';
              hint.style.marginTop = '5px';
              hint.textContent = 'ğŸ’¡ æç¤ºï¼šè«‹è¼¸å…¥æ¨™æº–åç¨± (ä¾‹å¦‚ "ç™½é·º")';
              container.appendChild(hint);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'ğŸ” è§£ç¢¼';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.marginTop = '15px';
              submitBtn.style.width = '100%';
              submitBtn.onclick = () => {
                 if(!input.value.trim()) return alert('è«‹è¼¸å…¥é—œéµå­—');
                 submitAnswer(userTaskId, input.value);
              };
              container.appendChild(submitBtn);

            } else if (t.task_type === 'location') {
              const info = document.createElement('div');
              info.innerHTML = `
                <div style="text-align:center; padding:20px; background:white; border-radius:8px; border:1px dashed #ccc; margin-bottom:15px;">
                  <div style="font-size:3rem; margin-bottom:10px;">ğŸ“</div>
                  <p style="margin:0; color:#333;">è«‹ç§»å‹•åˆ°ç›®æ¨™åœ°é»</p>
                  <p style="margin:5px 0 0 0; font-size:0.9rem; color:#666;">åˆ°é”å¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œé©—è­‰</p>
                  <div id="gpsStatus" style="font-size:0.9rem; color:#007bff; margin-top:10px; font-weight:bold;">ç­‰å¾…å®šä½...</div>
                </div>
              `;
              container.appendChild(info);

              const checkBtn = document.createElement('button');
              checkBtn.textContent = 'ğŸ“ æˆ‘å·²åˆ°é” (æª¢æŸ¥ä½ç½®)';
              checkBtn.className = 'btn btn-primary';
              checkBtn.style.width = '100%';
              checkBtn.onclick = () => {
                const statusEl = document.getElementById('gpsStatus');
                statusEl.textContent = 'æ­£åœ¨ç²å–ç²¾ç¢ºä½ç½®...';
                checkBtn.disabled = true;

                if (!navigator.geolocation) {
                  statusEl.textContent = 'æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS';
                  return;
                }

                navigator.geolocation.getCurrentPosition(
                  (pos) => {
                    const d = haversineDistance(pos.coords.latitude, pos.coords.longitude, t.lat, t.lng);
                    // è¨­å®š 50 å…¬å°ºçš„å¯¬å®¹åº¦ (è€ƒæ…®åˆ° GPS é£„ç§»ï¼Œæ”¾å¯¬ä¸€é»æ¯”è¼ƒå‹å–„ï¼Œæˆ–è€…ç”¨ t.radius)
                    const limit = (t.radius || 30) / 1000; // è½‰ç‚ºå…¬é‡Œ
                    
                    if (d <= limit) {
                       statusEl.textContent = `âœ… ä½ç½®æ­£ç¢ºï¼(è·é›¢ ${Math.round(d*1000)}m)`;
                       statusEl.style.color = 'green';
                       // è‡ªå‹•é€å‡ºé€šé—œå¯†èªã€‚è«‹å‹™å¿…åœ¨å¾Œå°å°‡æ­¤é¡ä»»å‹™çš„æ¨™æº–ç­”æ¡ˆè¨­ç‚º "ARRIVED"
                       submitAnswer(userTaskId, 'ARRIVED'); 
                    } else {
                       statusEl.textContent = `âŒ è·é›¢ç›®æ¨™å¤ªé  (${Math.round(d*1000)}m)ï¼Œè«‹å†é è¿‘ä¸€é»ï¼`;
                       statusEl.style.color = '#dc3545';
                       checkBtn.disabled = false;
                    }
                  },
                  (err) => {
                    statusEl.textContent = 'ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ';
                    checkBtn.disabled = false;
                  },
                  { enableHighAccuracy: true, timeout: 10000 }
                );
              };
              container.appendChild(checkBtn);

            } else if (t.task_type === 'multiple_choice') {
              const form = document.createElement('div');
              options.forEach((opt, index) => {
                const wrapper = document.createElement('label');
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '8px';
                wrapper.style.marginBottom = '8px';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'mc_option';
                radio.value = opt;
                if (currentAnswer === opt) radio.checked = true;

                wrapper.appendChild(radio);
                wrapper.appendChild(document.createTextNode(opt));
                form.appendChild(wrapper);
              });
              container.appendChild(form);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'é€å‡ºç­”æ¡ˆ';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.marginTop = '10px';
              submitBtn.onclick = () => {
                const selected = form.querySelector('input[name="mc_option"]:checked');
                if (!selected) {
                  alert('è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆ');
                  return;
                }
                submitAnswer(userTaskId, selected.value);
              };
              container.appendChild(submitBtn);
            } else if (t.task_type === 'photo') {
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.style.marginBottom = '10px';

              const preview = document.createElement('img');
              preview.style.maxWidth = '200px';
              preview.style.display = currentAnswer ? 'block' : 'none';
              preview.style.marginTop = '10px';
              if (currentAnswer && currentAnswer.startsWith('/images/')) {
                 preview.src = currentAnswer;
              }

              fileInput.onchange = (e) => {
                 const file = e.target.files[0];
                 if (file) {
                   const reader = new FileReader();
                   reader.onload = (ev) => {
                     preview.src = ev.target.result;
                     preview.style.display = 'block';
                   };
                   reader.readAsDataURL(file);
                 }
              };

              container.appendChild(fileInput);
              container.appendChild(preview);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'ä¸Šå‚³ç…§ç‰‡ä¸¦é€å‡º';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.display = 'block';
              submitBtn.style.marginTop = '10px';
              submitBtn.onclick = async () => {
                 const file = fileInput.files[0];
                 if (!file) {
                   alert('è«‹é¸æ“‡ç…§ç‰‡');
                   return;
                 }

                 const msg = document.getElementById('answerMsg');
                 msg.textContent = 'ä¸Šå‚³ä¸­...';
                 try {
                   const fd = new FormData();
                   fd.append('photo', file);
                   const uploadRes = await fetch(`${API_BASE}/api/upload`, {
                      method: 'POST',
                      headers: loginUser ? { 'x-username': loginUser.username } : {},
                      body: fd
                   });
                   const uploadData = await uploadRes.json();
                   if(!uploadData.success) {
                      msg.textContent = uploadData.message || 'ä¸Šå‚³å¤±æ•—';
                      return;
                   }
                   submitAnswer(userTaskId, uploadData.url);
                 } catch (e) {
                   msg.textContent = 'ä¸Šå‚³éŒ¯èª¤';
                 }
              };
              container.appendChild(submitBtn);
            } else {
              const textarea = document.createElement('textarea');
              textarea.rows = 3;
              textarea.style.width = '100%';
              textarea.style.borderRadius = '6px';
              textarea.style.padding = '8px';
              textarea.placeholder = 'è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ';
              textarea.value = currentAnswer || '';
              container.appendChild(textarea);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'é€å‡ºç­”æ¡ˆ';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.marginTop = '10px';
              submitBtn.onclick = () => {
                const val = textarea.value.trim();
                if (!val) { alert('è«‹è¼¸å…¥ç­”æ¡ˆ'); return; }
                submitAnswer(userTaskId, val);
              };
              container.appendChild(submitBtn);
            }

            const msgSpan = document.createElement('div');
            msgSpan.id = 'answerMsg';
            msgSpan.style.marginTop = '10px';
            msgSpan.style.color = '#007bff';
            container.appendChild(msgSpan);

            answerDiv.appendChild(container);
          }

          async function submitAnswer(userTaskId, val) {
            const msg = document.getElementById('answerMsg');
            if (!msg) return;
            msg.textContent = 'å„²å­˜ä¸­...';
            try {
              const res = await fetch(`${API_BASE}/api/user-tasks/${userTaskId}/answer`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ answer: val })
              });
              const data = await res.json();
              if (data.success) {
                msg.textContent = data.message;
                if (data.isCompleted) {
                   msg.style.color = '#28a745';
                   msg.style.fontWeight = 'bold';
                   document.getElementById('answerSection').querySelectorAll('button').forEach(b => b.disabled = true);
                   const startBtn = document.getElementById('startTaskBtn');
                   startBtn.textContent = 'ä»»å‹™å·²å®Œæˆ';
                   startBtn.style.backgroundColor = '#28a745';
                }
              } else {
                msg.textContent = data.message || 'å„²å­˜å¤±æ•—';
                msg.style.color = '#dc3545';
              }
            } catch(e) {
              msg.textContent = 'é€£ç·šå¤±æ•—';
              msg.style.color = '#dc3545';
            }
          }
        })
        .catch(() => {
          taskDetailEl.innerHTML = '<div class="text-center text-danger">è¼‰å…¥ä»»å‹™æ™‚ç™¼ç”ŸéŒ¯èª¤</div>';
        });
    }
  </script>
  <script src="/js/nav-access.js"></script>
</body>
</html>
