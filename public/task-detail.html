<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä»»å‹™è©³æƒ… | GPS è§¸ç™¼ä»»å‹™ç³»çµ±</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" type="image/png" href="/images/mascot.png" />
  <style>
    .detail-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem 4rem;
    }
    .detail-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 1.5rem;
      box-shadow: var(--shadow-lg);
      padding: 2rem;
    }
    .task-type-chip {
      display: inline-block;
      padding: 0.2rem 0.9rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--gradient-primary);
      color: #fff;
    }
    .task-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.5rem;
      margin: 1.25rem 0;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }
    .task-detail-img {
      width: 100%;
      border-radius: 1rem;
      margin: 1.25rem 0;
      object-fit: cover;
      box-shadow: var(--shadow-light);
    }
    #taskDetail h2 {
      margin: 0;
      font-size: 1.6rem;
      color: var(--text-primary);
    }
    #taskDetail iframe {
      width: 100%;
      max-width: 640px;
      height: 360px;
      border: none;
      border-radius: 1rem;
      margin-top: 1rem;
      box-shadow: var(--shadow-light);
    }
    .task-detail-loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem 1rem;
    }
    .detail-actions {
      margin-top: 1.5rem;
    }
    .detail-actions .btn {
      width: 100%;
    }
    .answer-container {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div class="header-content" id="headerContent">
      <h1 id="pageTitle">ä»»å‹™è©³æƒ…</h1>
      <button id="hamburgerBtn" class="hamburger" aria-label="å±•é–‹é¸å–®">&#9776;</button>
      <nav class="main-nav">
        <a href="/index.html">é¦–é </a>
        <a href="/map.html">åœ°åœ–é </a>
        <a href="/tasks-list.html" id="navTasksList">ä»»å‹™åˆ—è¡¨</a>
        <a href="/user-tasks.html">ä»»å‹™å¯©æ ¸</a>
        <a href="/staff-dashboard.html" id="navStaff" style="display:none;">æ–°å¢ä»»å‹™</a>
        <a href="/user-dashboard.html" id="navUserTasks" style="display:none;">ç”¨æˆ¶ä»»å‹™ç®¡ç†</a>
        <a href="/products.html">å•†å“å…Œæ›</a>
        <a href="/redeem-tasks.html" id="navRedeem" style="display:none;">å…Œæ›å•†å“ç®¡ç†</a>
        <span id="loginUserInfo" style="display:none; color:var(--text-secondary); padding:0.5rem 1rem;"></span>
        <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
      </nav>
    </div>
  </header>

  <main>
    <section class="detail-wrapper">
      <div class="detail-card">
        <div id="taskDetail" class="task-detail-loading">
          <div class="loading-spinner"></div>
          <p style="margin-top:0.75rem;">è¼‰å…¥ä»»å‹™ä¸­...</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 GPS ä»»å‹™ç³»çµ± - åœ°æ–¹é–‹ç®±ä»»å‹™éŠæˆ²
  </footer>

  <script>
    const loginUser = JSON.parse(localStorage.getItem('loginUser') || 'null');
    window.loginUser = loginUser;

    const userInfoSpan = document.getElementById('loginUserInfo');
    const logoutBtn = document.getElementById('logoutBtn');

    if (loginUser) {
      userInfoSpan.style.display = 'inline-block';
      userInfoSpan.textContent = getUserDisplayName(loginUser);
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = function() {
        localStorage.removeItem('loginUser');
        window.location.href = '/login.html';
      };

      if (loginUser.role === 'admin' || loginUser.role === 'shop') {
        document.getElementById('navStaff').style.display = '';
        document.getElementById('navRedeem').style.display = '';
      }
      if (loginUser.role === 'user') {
        document.getElementById('navUserTasks').style.display = '';
      }
      if (loginUser.role === 'shop' || loginUser.role === 'admin') {
        const navTasksList = document.getElementById('navTasksList');
        if (navTasksList) navTasksList.style.display = 'none';
      }
    }

    function getUserDisplayName(user) {
      switch(user.role) {
        case 'admin': return `ç®¡ç†å“¡ï¼š${user.username}`;
        case 'shop': return `å•†åº—ï¼š${user.username}`;
        case 'user': return `ç”¨æˆ¶ï¼š${user.username}`;
        default: return user.username;
      }
    }

    document.getElementById('hamburgerBtn').onclick = function() {
      document.getElementById('headerContent').classList.toggle('open');
    };
    document.querySelectorAll('.main-nav a, .main-nav button').forEach(element => {
      element.addEventListener('click', () => document.getElementById('headerContent').classList.remove('open'));
    });
  </script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const API_BASE = '';
    const taskDetailEl = document.getElementById('taskDetail');

    if (!id) {
      taskDetailEl.innerHTML = '<div class="text-center text-danger">æœªæŒ‡å®šä»»å‹™ ID</div>';
    } else {
      fetch(`${API_BASE}/api/tasks/${id}`)
        .then(res => res.json())
        .then(data => {
          if (!data.success || !data.task) {
            taskDetailEl.innerHTML = '<div class="text-center text-danger">æ‰¾ä¸åˆ°ä»»å‹™</div>';
            return;
          }
          const t = data.task;

          const typeMap = {
            qa: 'å•ç­”é¡Œ',
            multiple_choice: 'é¸æ“‡é¡Œ',
            photo: 'æ‹ç…§ä»»å‹™'
          };
          const taskTypeLabel = typeMap[t.task_type] || 'å•ç­”é¡Œ';

          // è§£æé¸é …ï¼ˆå¦‚æœæ˜¯ JSON å­—ä¸²ï¼‰
          let options = [];
          if (t.task_type === 'multiple_choice' && t.options) {
            options = typeof t.options === 'string' ? JSON.parse(t.options) : t.options;
          }

          taskDetailEl.innerHTML = `
            <h2>${t.name}</h2>
            <div class="task-meta-grid">
              <span class="task-type-chip">${taskTypeLabel}</span>
              <span>ğŸ“ (${t.lat}, ${t.lng})</span>
              <span>ğŸ¯ åŠå¾‘ï¼š${t.radius} å…¬å°º</span>
              <span>ğŸ’° ç©åˆ†ï¼š${t.points || 0}</span>
            </div>
            <div style="margin-bottom:18px; color:var(--text-secondary); line-height:1.6;">${t.description}</div>
            <img src="${t.photoUrl}" alt="ä»»å‹™ç…§ç‰‡" class="task-detail-img" onerror="this.src='/images/mascot.png'">
            ${t.youtubeUrl ? `<div><iframe src="${t.youtubeUrl.replace('watch?v=','embed/')}" allowfullscreen></iframe></div>` : ''}
            <div class="detail-actions">
              <button id="startTaskBtn" class="btn btn-primary">é–‹å§‹ä»»å‹™</button>
              <div id="taskMsg" style="margin-top:15px; font-weight:600;"></div>
            </div>
            <div id="answerSection" class="answer-container"></div>
          `;

          const startTaskBtn = document.getElementById('startTaskBtn');
          const taskMsgEl = document.getElementById('taskMsg');

          if (loginUser && loginUser.role === 'shop') {
            startTaskBtn.style.display = 'none';
            taskMsgEl.textContent = 'å·¥ä½œäººå“¡å¸³è™Ÿç„¡æ³•åƒèˆ‡ä»»å‹™';
            return;
          }

          if (loginUser && loginUser.username) {
            fetch(`${API_BASE}/api/user-tasks/all?username=${encodeURIComponent(loginUser.username)}`)
              .then(res => res.json())
              .then(udata => {
                if (udata.success && Array.isArray(udata.tasks)) {
                  // å·²å®Œæˆ
                  const completedTask = udata.tasks.find(x => x.id == t.id && x.status === 'å®Œæˆ');
                  if (completedTask) {
                    startTaskBtn.textContent = 'ä»»å‹™å·²å®Œæˆ';
                    startTaskBtn.disabled = true;
                    startTaskBtn.style.backgroundColor = '#6c757d';
                    taskMsgEl.textContent = 'æ‚¨å·²å®Œæˆæ­¤ä»»å‹™';
                    taskMsgEl.style.color = '#28a745';
                    return;
                  }
                  // é€²è¡Œä¸­
                  const inProgressTask = udata.tasks.find(x => x.id == t.id && x.status === 'é€²è¡Œä¸­');
                  if (inProgressTask) {
                    showAnswerSection(inProgressTask.user_task_id, inProgressTask.answer || '');
                    startTaskBtn.disabled = true;
                    taskMsgEl.textContent = 'ä»»å‹™é€²è¡Œä¸­ï¼';
                  }
                }
              })
              .catch(err => console.error('æª¢æŸ¥ä»»å‹™ç‹€æ…‹å¤±æ•—:', err));
          }

          startTaskBtn.onclick = function() {
            if (!loginUser || !loginUser.username) {
              taskMsgEl.textContent = 'è«‹å…ˆç™»å…¥';
              taskMsgEl.style.color = '#dc3545';
              return;
            }
            fetch(`${API_BASE}/api/user-tasks`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: loginUser.username, task_id: t.id })
            })
            .then(res => res.json())
            .then(resp => {
              if (resp.success) {
                taskMsgEl.textContent = 'ä»»å‹™é€²è¡Œä¸­ï¼';
                taskMsgEl.style.color = 'var(--primary-color)';
                startTaskBtn.disabled = true;
                fetch(`${API_BASE}/api/user-tasks/all?username=${encodeURIComponent(loginUser.username)}`)
                  .then(res => res.json())
                  .then(udata => {
                    if (udata.success && Array.isArray(udata.tasks)) {
                      const ut = udata.tasks.find(x => x.id == t.id && x.status === 'é€²è¡Œä¸­');
                      if (ut) showAnswerSection(ut.user_task_id, ut.answer || '');
                    }
                  });
              } else {
                taskMsgEl.textContent = resp.message || 'åŠ å…¥å¤±æ•—';
                taskMsgEl.style.color = '#dc3545';
                if (resp.message && resp.message.includes('å·²å®Œæˆé')) {
                  startTaskBtn.textContent = 'ä»»å‹™å·²å®Œæˆ';
                  startTaskBtn.disabled = true;
                  startTaskBtn.style.backgroundColor = '#6c757d';
                }
              }
            });
          };

          function showAnswerSection(userTaskId, currentAnswer) {
            const answerDiv = document.getElementById('answerSection');
            answerDiv.innerHTML = '';

            const container = document.createElement('div');
            container.style.padding = '15px';
            container.style.background = '#f8f9fa';
            container.style.borderRadius = '8px';

            const title = document.createElement('div');
            title.style.fontWeight = 'bold';
            title.style.marginBottom = '10px';
            title.style.color = '#7c3aed';
            title.textContent = 'æäº¤ç­”æ¡ˆï¼š';
            container.appendChild(title);

            if (t.task_type === 'multiple_choice') {
              const form = document.createElement('div');
              options.forEach((opt, index) => {
                const wrapper = document.createElement('label');
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '8px';
                wrapper.style.marginBottom = '8px';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'mc_option';
                radio.value = opt;
                if (currentAnswer === opt) radio.checked = true;

                wrapper.appendChild(radio);
                wrapper.appendChild(document.createTextNode(opt));
                form.appendChild(wrapper);
              });
              container.appendChild(form);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'é€å‡ºç­”æ¡ˆ';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.marginTop = '10px';
              submitBtn.onclick = () => {
                const selected = form.querySelector('input[name="mc_option"]:checked');
                if (!selected) {
                  alert('è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆ');
                  return;
                }
                submitAnswer(userTaskId, selected.value);
              };
              container.appendChild(submitBtn);
            } else if (t.task_type === 'photo') {
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.style.marginBottom = '10px';

              const preview = document.createElement('img');
              preview.style.maxWidth = '200px';
              preview.style.display = currentAnswer ? 'block' : 'none';
              preview.style.marginTop = '10px';
              if (currentAnswer && currentAnswer.startsWith('/images/')) {
                 preview.src = currentAnswer;
              }

              fileInput.onchange = (e) => {
                 const file = e.target.files[0];
                 if (file) {
                   const reader = new FileReader();
                   reader.onload = (ev) => {
                     preview.src = ev.target.result;
                     preview.style.display = 'block';
                   };
                   reader.readAsDataURL(file);
                 }
              };

              container.appendChild(fileInput);
              container.appendChild(preview);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'ä¸Šå‚³ç…§ç‰‡ä¸¦é€å‡º';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.display = 'block';
              submitBtn.style.marginTop = '10px';
              submitBtn.onclick = async () => {
                 const file = fileInput.files[0];
                 if (!file) {
                   alert('è«‹é¸æ“‡ç…§ç‰‡');
                   return;
                 }

                 const msg = document.getElementById('answerMsg');
                 msg.textContent = 'ä¸Šå‚³ä¸­...';
                 try {
                   const fd = new FormData();
                   fd.append('photo', file);
                   const uploadRes = await fetch(`${API_BASE}/api/upload`, {
                      method: 'POST',
                      headers: loginUser ? { 'x-username': loginUser.username } : {},
                      body: fd
                   });
                   const uploadData = await uploadRes.json();
                   if(!uploadData.success) {
                      msg.textContent = uploadData.message || 'ä¸Šå‚³å¤±æ•—';
                      return;
                   }
                   submitAnswer(userTaskId, uploadData.url);
                 } catch (e) {
                   msg.textContent = 'ä¸Šå‚³éŒ¯èª¤';
                 }
              };
              container.appendChild(submitBtn);
            } else {
              const textarea = document.createElement('textarea');
              textarea.rows = 3;
              textarea.style.width = '100%';
              textarea.style.borderRadius = '6px';
              textarea.style.padding = '8px';
              textarea.placeholder = 'è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ';
              textarea.value = currentAnswer || '';
              container.appendChild(textarea);

              const submitBtn = document.createElement('button');
              submitBtn.textContent = 'é€å‡ºç­”æ¡ˆ';
              submitBtn.className = 'btn btn-primary';
              submitBtn.style.marginTop = '10px';
              submitBtn.onclick = () => {
                const val = textarea.value.trim();
                if (!val) { alert('è«‹è¼¸å…¥ç­”æ¡ˆ'); return; }
                submitAnswer(userTaskId, val);
              };
              container.appendChild(submitBtn);
            }

            const msgSpan = document.createElement('div');
            msgSpan.id = 'answerMsg';
            msgSpan.style.marginTop = '10px';
            msgSpan.style.color = '#007bff';
            container.appendChild(msgSpan);

            answerDiv.appendChild(container);
          }

          async function submitAnswer(userTaskId, val) {
            const msg = document.getElementById('answerMsg');
            if (!msg) return;
            msg.textContent = 'å„²å­˜ä¸­...';
            try {
              const res = await fetch(`${API_BASE}/api/user-tasks/${userTaskId}/answer`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answer: val })
              });
              const data = await res.json();
              if (data.success) {
                msg.textContent = data.message;
                if (data.isCompleted) {
                   msg.style.color = '#28a745';
                   msg.style.fontWeight = 'bold';
                   document.getElementById('answerSection').querySelectorAll('button').forEach(b => b.disabled = true);
                   const startBtn = document.getElementById('startTaskBtn');
                   startBtn.textContent = 'ä»»å‹™å·²å®Œæˆ';
                   startBtn.style.backgroundColor = '#28a745';
                }
              } else {
                msg.textContent = data.message || 'å„²å­˜å¤±æ•—';
                msg.style.color = '#dc3545';
              }
            } catch(e) {
              msg.textContent = 'é€£ç·šå¤±æ•—';
              msg.style.color = '#dc3545';
            }
          }
        })
        .catch(() => {
          taskDetailEl.innerHTML = '<div class="text-center text-danger">è¼‰å…¥ä»»å‹™æ™‚ç™¼ç”ŸéŒ¯èª¤</div>';
        });
    }
  </script>
  <script src="/js/nav-access.js"></script>
</body>
</html>
