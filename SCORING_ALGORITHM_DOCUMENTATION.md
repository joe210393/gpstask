# 分數計算演算法完整文檔
## Scoring Algorithm Complete Documentation

> 本文檔詳細記錄所有與分數計算相關的公式、加權值、閾值和演算法

---

## 📊 一、混合搜尋分數計算 (Hybrid Search Score)

### 1.1 核心公式

```
hybrid_score = base_score + enhancement + keyword_bonus
```

其中：
- `base_score` = 加權平均分數
- `enhancement` = 乘法增強分數
- `keyword_bonus` = 關鍵字匹配加分

### 1.2 基礎分數 (Base Score)

```
base_score = (EMBEDDING_WEIGHT × embedding_score) + (FEATURE_WEIGHT × feature_score)
```

**權重設定**：
- `EMBEDDING_WEIGHT = 0.6` (60%) - embedding 相似度權重
- `FEATURE_WEIGHT = 0.4` (40%) - 特徵匹配權重

**分數範圍**：
- `embedding_score`: 0.0 ~ 1.0 (來自 Qdrant 的餘弦相似度)
- `feature_score`: 0.0 ~ 1.0 (特徵匹配總分，見下方說明)

### 1.3 增強分數 (Enhancement Score)

```
enhancement = embedding_score × feature_score × 0.3
```

**增強係數**: `0.3` (30%)

**作用**：當 embedding 和 feature 都匹配時，使用乘法增強，放大同時匹配的情況

### 1.4 關鍵字匹配加分 (Keyword Bonus)

```
keyword_bonus = KEYWORD_BONUS_WEIGHT  (如果匹配) 或 0.0 (如果不匹配)
```

**權重設定**：
- `KEYWORD_BONUS_WEIGHT = 0.1` (10%)

**匹配條件**：
- 如果 `guess_names` 中的名稱匹配到植物的 `chinese_name` 或 `scientific_name`
- 使用部分匹配（包含關係）

### 1.5 最終混合分數

```
hybrid_score = min(1.0, base_score + enhancement + keyword_bonus)
```

**限制**：確保分數不超過 1.0

---

## 🌿 二、特徵匹配分數計算 (Feature Matching Score)

### 2.1 特徵權重計算公式

特徵權重使用 **TF-IDF 變體** 計算：

#### 步驟 1: 計算 IDF (Inverse Document Frequency)

```
IDF = ln((N + 1) / (df + 1))
```

其中：
- `N` = 總文件數（植物資料總數）
- `df` = 文件頻率（包含該特徵的植物數量）

#### 步驟 2: 計算 RareCoef (稀有度係數)

```
RareCoef = clamp(0.2, 2.5, IDF / 2)
```

**範圍限制**：
- 最小值：`0.2`
- 最大值：`2.5`
- 計算：`IDF / 2` 後限制在範圍內

#### 步驟 3: 計算最終特徵權重

```
FeatureWeight = min(BaseW × RareCoef, MaxCap)
```

其中：
- `BaseW` = 基礎權重（見下方特徵權重表）
- `RareCoef` = 稀有度係數（從步驟 2）
- `MaxCap` = 最大權重上限（見下方特徵權重表）

### 2.2 特徵匹配分數

```
feature_score = Σ(FeatureWeight_i)  (對於所有匹配的特徵 i)
```

**匹配條件**：
- 特徵名稱（中文）出現在植物描述文字中，或
- 特徵英文名稱出現在植物描述文字中（不區分大小寫）

---

## 📋 三、特徵權重表 (Feature Weight Table)

### 3.1 生命型態 (Life Form)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 喬木 | tree | 0.05 | 0.05 |
| 灌木 | shrub | 0.05 | 0.05 |
| 草本 | herb | 0.05 | 0.05 |
| 藤本 | vine | 0.06 | 0.06 |

### 3.2 葉序 (Leaf Arrangement)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 互生 | alternate | 0.05 | 0.06 |
| 對生 | opposite | 0.05 | 0.06 |
| 輪生 | whorled | 0.06 | 0.09 |

### 3.3 葉型 (Leaf Type)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 單葉 | simple leaf | 0.05 | 0.08 |
| 複葉 | compound leaf | 0.05 | 0.08 |
| 羽狀複葉 | pinnate leaves | 0.05 | 0.07 |
| 二回羽狀 | bipinnate leaves | 0.08 | 0.12 |
| 掌狀複葉 | palmate leaves | 0.07 | 0.10 |

### 3.4 葉緣 (Leaf Margin)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 全緣 | entire | 0.05 | 0.07 |
| 鋸齒 | serrated | 0.05 | 0.07 |

### 3.5 花色 (Flower Color)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 白花 | white flower | 0.05 | 0.07 |
| 黃花 | yellow flower | 0.05 | 0.07 |
| 紅花 | red flower | 0.05 | 0.07 |
| 紫花 | purple flower | 0.05 | 0.07 |

### 3.6 花序 (Flower Inflorescence)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 總狀花序 | raceme | 0.06 | 0.09 |
| 圓錐花序 | panicle | 0.06 | 0.09 |

### 3.7 果實 (Fruit Type)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 莢果 | pod | 0.08 | 0.12 |

### 3.8 根/樹幹 (Trunk/Root)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 板根 | buttress | 0.12 | 0.18 |
| 氣生根 | aerial root | 0.16 | 0.22 |

### 3.9 特殊特徵 (Special Features)

| 特徵 | 英文 | 基礎權重 (BaseW) | 最大上限 (MaxCap) |
|------|------|------------------|-------------------|
| 有刺 | thorns | 0.08 | 0.12 |
| 胎生苗 | viviparous | 0.22 | 0.30 |

**注意**：實際權重會根據資料庫中的 `df`（文件頻率）動態調整，使用 `FeatureWeight = min(BaseW × RareCoef, MaxCap)` 公式。

---

## 🎯 四、LM 信心度加成 (LM Confidence Boost)

### 4.1 匹配條件

LM 與 RAG 匹配時，給予信心度加成：

**嚴格匹配規則**：
```
isExactMatch = 
  (plantNameLower === lmNameLower) ||                    // 完全匹配
  (scientificNameLower === lmNameLower) ||              // 學名完全匹配
  (plantNameLower.includes(lmNameLower) && lmNameLower.length >= 3) ||  // 包含匹配（長度 >= 3）
  (lmNameLower.includes(plantNameLower) && plantNameLower.length >= 3)  // 反向包含匹配（長度 >= 3）
```

**加成值**：
- `lmConfidenceBoost = 0.4` (40%) - 當匹配成功時

### 4.2 應用條件

**閾值檢查**：
```
if (topScore >= 0.5) {
  // 應用 LM 加成
}
```

**條件**：只有當最高分數 >= 0.5 (50%) 時，才應用 LM 加成

### 4.3 分數調整公式

```
maxBoost = score × 0.5  // 最多加成原始分數的 50%
actualBoost = min(lmConfidenceBoost, maxBoost)
adjusted_score = min(1.0, score + actualBoost)
```

**範例**：
- 原始分數 63.5%：`maxBoost = 0.635 × 0.5 = 0.3175`，`actualBoost = min(0.4, 0.3175) = 0.3175`，調整後 = `min(1.0, 0.635 + 0.3175) = 0.9525` (95.25%)
- 原始分數 59.9%：`maxBoost = 0.599 × 0.5 = 0.2995`，`actualBoost = min(0.4, 0.2995) = 0.2995`，調整後 = `min(1.0, 0.599 + 0.2995) = 0.8985` (89.85%)

**限制**：
- 最多加成原始分數的 50%
- 最終分數不超過 1.0 (100%)

---

## 🔍 五、兩階段搜尋結果比較

### 5.1 第一階段：傳統搜尋（Embedding Only）

**搜尋方式**：純 embedding 相似度搜尋

**分數**：
```
score = embedding_score  (直接使用 Qdrant 的餘弦相似度)
```

**結果保存**：保存到 `preSearchResults` 作為基準

### 5.2 第二階段：Traits-based 混合搜尋

**搜尋方式**：混合搜尋（embedding + feature matching）

**分數**：使用上述混合搜尋公式計算

### 5.3 結果比較與選擇

**比較邏輯**：
```
if (newTopScore > preTopScore + 0.15) {
  // 使用第二階段結果
  plantResults = newResults;
} else {
  // 保留第一階段結果
  plantResults = preSearchResults;
}
```

**閾值**：`0.15` (15%) - 只有當新結果分數明顯更高（>15%）時才替換

---

## 🚦 六、植物判斷閾值 (Plant Classification Thresholds)

### 6.1 Embedding API 分類閾值

**位置**：`scripts/rag/vectordb/start_api.py`

```
PLANT_THRESHOLD = 0.4  (40%)
```

**判斷邏輯**：
```
is_plant = (plant_score >= PLANT_THRESHOLD)
```

### 6.2 Vision API 分類閾值

**位置**：`index.js`

**動態閾值**：
```
PLANT_SCORE_THRESHOLD = 
  visionSaysPlant ? 0.4 :           // 如果 Vision 明確說是植物
  (finishReason === 'length' ? 0.45 : 0.5)  // 如果回應被截斷，降低閾值
```

**判斷邏輯**：
```
if (classification.plant_score >= PLANT_SCORE_THRESHOLD) {
  // 進行 RAG 搜尋
}
```

---

## 📈 七、分數計算流程圖

```
1. Embedding 搜尋
   └─> embedding_score (0.0 ~ 1.0)

2. 特徵匹配
   └─> 計算每個特徵的權重
       └─> IDF = ln((N+1)/(df+1))
       └─> RareCoef = clamp(0.2, 2.5, IDF/2)
       └─> FeatureWeight = min(BaseW × RareCoef, MaxCap)
   └─> feature_score = Σ(FeatureWeight_i) (匹配的特徵)

3. 關鍵字匹配
   └─> keyword_bonus = 0.1 (如果匹配) 或 0.0

4. 混合分數計算
   └─> base_score = 0.6 × embedding_score + 0.4 × feature_score
   └─> enhancement = embedding_score × feature_score × 0.3
   └─> hybrid_score = min(1.0, base_score + enhancement + keyword_bonus)

5. LM 信心度加成（如果匹配）
   └─> 檢查：topScore >= 0.5
   └─> maxBoost = score × 0.5
   └─> actualBoost = min(0.4, maxBoost)
   └─> adjusted_score = min(1.0, score + actualBoost)
```

---

## 🔢 八、數值範圍總結

### 8.1 各類分數範圍

| 分數類型 | 範圍 | 說明 |
|---------|------|------|
| embedding_score | 0.0 ~ 1.0 | Qdrant 餘弦相似度 |
| feature_score | 0.0 ~ 1.0 | 特徵匹配總分（理論上可超過 1.0，但實際會受 MaxCap 限制） |
| keyword_bonus | 0.0 或 0.1 | 關鍵字匹配加分 |
| base_score | 0.0 ~ 1.0 | 加權平均分數 |
| enhancement | 0.0 ~ 0.3 | 乘法增強分數（embedding × feature × 0.3） |
| hybrid_score | 0.0 ~ 1.0 | 最終混合分數 |
| adjusted_score | 0.0 ~ 1.0 | LM 加成後的分數 |

### 8.2 權重係數總結

| 係數名稱 | 數值 | 說明 |
|---------|------|------|
| EMBEDDING_WEIGHT | 0.6 | Embedding 相似度權重 |
| FEATURE_WEIGHT | 0.4 | 特徵匹配權重 |
| ENHANCEMENT_COEFFICIENT | 0.3 | 乘法增強係數 |
| KEYWORD_BONUS_WEIGHT | 0.1 | 關鍵字匹配加分 |
| LM_CONFIDENCE_BOOST | 0.4 | LM 匹配時的基礎加成 |
| MAX_BOOST_RATIO | 0.5 | 最多加成原始分數的 50% |
| RESULT_COMPARISON_THRESHOLD | 0.15 | 結果比較閾值（15%） |
| PLANT_THRESHOLD | 0.4 | 植物判斷閾值（40%） |

### 8.3 特徵權重範圍

| 特徵類別 | BaseW 範圍 | MaxCap 範圍 | 說明 |
|---------|-----------|-------------|------|
| 生命型態 | 0.05 ~ 0.06 | 0.05 ~ 0.06 | 較低權重，常見特徵 |
| 葉序 | 0.05 ~ 0.06 | 0.06 ~ 0.09 | 中等權重 |
| 葉型 | 0.05 ~ 0.08 | 0.07 ~ 0.12 | 中等權重，複葉類型較高 |
| 葉緣 | 0.05 | 0.07 | 較低權重 |
| 花色 | 0.05 | 0.07 | 較低權重 |
| 花序 | 0.06 | 0.09 | 中等權重 |
| 果實 | 0.08 | 0.12 | 較高權重 |
| 根/樹幹 | 0.12 ~ 0.16 | 0.18 ~ 0.22 | 高權重，稀有特徵 |
| 特殊特徵 | 0.08 ~ 0.22 | 0.12 ~ 0.30 | 高權重，非常稀有 |

---

## 📝 九、計算範例

### 範例 1：基本混合搜尋

**輸入**：
- `embedding_score = 0.65`
- `feature_score = 0.30` (匹配了 3 個特徵：互生 0.05、鋸齒 0.05、白花 0.05、總狀花序 0.06、有刺 0.09)
- `keyword_bonus = 0.0` (無關鍵字匹配)

**計算**：
```
base_score = 0.6 × 0.65 + 0.4 × 0.30 = 0.39 + 0.12 = 0.51
enhancement = 0.65 × 0.30 × 0.3 = 0.0585
hybrid_score = min(1.0, 0.51 + 0.0585 + 0.0) = 0.5685 (56.85%)
```

### 範例 2：帶關鍵字匹配

**輸入**：
- `embedding_score = 0.70`
- `feature_score = 0.25`
- `keyword_bonus = 0.1` (關鍵字匹配)

**計算**：
```
base_score = 0.6 × 0.70 + 0.4 × 0.25 = 0.42 + 0.10 = 0.52
enhancement = 0.70 × 0.25 × 0.3 = 0.0525
hybrid_score = min(1.0, 0.52 + 0.0525 + 0.1) = 0.6725 (67.25%)
```

### 範例 3：LM 信心度加成

**輸入**：
- `hybrid_score = 0.635` (63.5%)
- `lmConfidenceBoost = 0.4` (LM 匹配成功)

**計算**：
```
maxBoost = 0.635 × 0.5 = 0.3175
actualBoost = min(0.4, 0.3175) = 0.3175
adjusted_score = min(1.0, 0.635 + 0.3175) = 0.9525 (95.25%)
```

---

## 🔧 十、實現位置

### 10.1 Python 後端 (Embedding API)

- **文件**：`scripts/rag/vectordb/start_api.py`
- **函數**：`hybrid_search()` (第 516 行)
- **權重設定**：第 101-103 行
- **特徵權重計算**：`scripts/rag/vectordb/feature_weights.py`

### 10.2 Node.js 後端 (Main API)

- **文件**：`index.js`
- **LM 信心度加成**：第 3619-3725 行
- **兩階段搜尋比較**：第 3306-3443 行
- **分數調整**：第 3704-3721 行

---

## 📌 十一、注意事項

1. **特徵權重是動態的**：根據資料庫中的 `df`（文件頻率）計算，不同資料庫可能會有不同的權重值
2. **分數上限**：所有最終分數都會限制在 0.0 ~ 1.0 範圍內
3. **LM 加成條件**：只有當原始分數 >= 0.5 時才應用，避免低分數結果被過度提升
4. **結果比較**：只有當新結果分數明顯更高（>15%）時才替換，避免高分數結果被低分數結果覆蓋
5. **關鍵字匹配**：只是輔助加分，不會過度影響整體匹配結果

---

---

## 💬 十三、AI 提示詞 (Prompts)

### 13.1 主要 Vision AI System Prompt（自由探索模式）

**位置**：`public/js/ai-lab.js` 第 110-257 行

**用途**：完整的植物辨識分析，包含詳細的形態學描述和結構化特徵提取

**完整內容**：

```
你是一位專業的植物形態學家與生態研究員。

**重要：你必須按照以下步驟進行分析，絕對不能跳過任何步驟！**

請依照以下 XML 格式回答，並在最後輸出結構化的 traits JSON：

<analysis>
**第一步：尺寸判斷（必須完成，用於驗證生活型）**

**請透過以下方式估算尺寸：**
1. **畫面比例推估：** 觀察物體在畫面中佔據的比例
   - 如果物體佔畫面高度約 1/3，且畫面是標準手機拍攝（約 50-100 公分距離），可推估物體高度
   - 如果物體佔畫面很小（< 10%），可能是大型物體（喬木）的局部
   - 如果物體佔畫面很大（> 50%），可能是小型物體（草本）的特寫

2. **視覺經驗推估：** 根據常見物體的視覺大小經驗
   - 葉片：一般草本葉片 2-10 公分，灌木葉片 3-15 公分，喬木葉片 5-30 公分
   - 花朵：一般小花 0.5-2 公分，中型花 2-5 公分，大花 5-15 公分
   - 整體：草本通常 < 50 公分，灌木 50-300 公分，喬木 > 300 公分

3. **結構特徵推估：** 觀察植物的結構特徵
   - 如果能看到明顯的主幹且粗壯 → 可能是喬木
   - 如果多分枝且無明顯主幹 → 可能是灌木
   - 如果莖細軟且低矮 → 可能是草本

**估算物體的實際尺寸範圍（必須具體）：**
- 整體高度：約 X 公分（或 X 公尺）
- 葉片長度：約 X 公分
- 花朵直徑：約 X 公分

**尺寸判斷的重要性：**
- 喬木：通常高度 > 3 公尺，主幹明顯
- 灌木：通常高度 0.5-3 公尺，多分枝
- 草本：通常高度 < 0.5 公尺，莖柔軟
- 如果判斷為「灌木」但高度只有 10 公分，請重新檢查為「草本」！

**第二步：詳細描述圖片細節（必須完成）**

**如果是植物，必須使用專業的植物形態學術語描述，絕對不能用「葉子形狀」「顏色」這種模糊詞彙！**

植物描述必須包含以下專業術語（根據圖片可見特徵選擇）：

**一、形態（整體外觀與生活型）**
- 生活型：喬木、灌木、草本、藤本、半灌木（必須與尺寸判斷一致！）
- 生長型：直立、匍匐、攀緣、纏繞、蔓生、叢生、浮水、沉水
- 壽命型：一年生、二年生、多年生
- 表面特徵：光滑、有毛、有刺、有蠟質、粗糙、黏性
- **整體尺寸：** 高度、寬度、葉片大小、花朵大小（必須具體描述）

**二、葉（Leaf）**
- 葉的構造：單葉、複葉、退化葉
- 葉序：互生、對生、輪生
- 葉形：披針形、卵形、橢圓形、心形、線形、圓形、腎形、倒卵形、針形、戟形、楔形、扇形
- 葉緣：全緣、鋸齒緣、波狀緣、裂緣、鈍齒緣、重鋸齒
- **葉片尺寸：** 長度、寬度（必須具體描述）

**三、根與莖（Root & Stem）**
- 根的類型：直根、鬚根、氣生根、儲藏根、支柱根
- 莖的類型：地上莖、地下莖、匍匐莖、直立莖、肉質莖、木質莖
- 地下莖細分：根莖、球莖、鱗莖、塊莖

**四、花（Flower）- 特別注意花序類型！**
- 花的性別：單性花、雙性花、無性花
- **花序（必須仔細觀察，這是識別關鍵）：**
  - **總狀花序：** 花軸上有多朵花，每朵花有花梗，從下往上開花（如：油菜花）
  - **穗狀花序：** 花軸上有多朵花，但花無梗或極短（如：小麥）
  - **繖形花序：** 花軸頂端有多朵花，花梗長度相近，呈傘狀（如：繡球花、蔥）
  - **圓錐花序：** 總狀花序的分枝版，呈圓錐形（如：稻米）
  - **頭狀花序：** 花軸頂端膨大，多朵小花密集排列（如：向日葵）
  - **聚繖花序：** 多個繖形花序組合，呈球狀或半球狀（如：繡球花、八仙花）
  - **佛焰花序：** 特殊結構，有佛焰苞包裹（如：芋頭）
  - **單生花：** 只有一朵花
- 花對稱性：放射對稱、左右對稱、不對稱
- **花朵尺寸：** 直徑、長度（必須具體描述）

**五、果實（Fruit）**
- 乾果：裂果、不裂果、翅果、堅果
- 肉果：漿果、核果、梨果、聚合果
- 果實來源：單果、聚合果、多花果

**範例（正確）：**
「這是一種灌木植物，整體高度約 50-80 公分。葉序為對生，葉形為橢圓形，葉緣為鋸齒緣，葉片長約 5-8 公分。具有聚繖花序，花朵密集排列成球狀，花朵直徑約 2-3 公分，花色為粉紅色。」

**範例（錯誤）：**
「這是一種綠色植物，葉子長長的，邊緣有鋸齒，開白色小花。」（不能用這種描述！）

**如果是動物：** 描述體型、顏色、特徵部位、行為等
**如果是物品：** 描述形狀、顏色、材質、大小、用途等

**第三步：判斷類別（必須完成）**
明確指出這是：植物 / 動物 / 人造物 / 其他

**第四步：提取生物特徵（僅限植物）**
如果是植物，請用上述專業術語提取關鍵識別特徵，例如：
- 生活型：灌木（必須與尺寸判斷一致！）
- 葉序：對生
- 葉形：橢圓形
- 葉緣：鋸齒緣
- 花序：聚繖花序（必須仔細觀察！）
- 花色：粉紅色
- 尺寸：高度 50-80 公分，花朵直徑 2-3 公分
- 其他：有刺、氣生根等

**第五步：尺寸驗證（僅限植物）**
檢查生活型與尺寸是否一致：
- 如果判斷為「喬木」但高度只有 30 公分 → 重新判斷為「灌木」或「草本」
- 如果判斷為「灌木」但高度只有 10 公分 → 重新判斷為「草本」
- 如果判斷為「草本」但高度有 2 公尺 → 重新判斷為「灌木」

**第六步：初步猜測（僅限植物）**
根據你觀察到的特徵，猜測可能是什麼植物（給 1-3 個候選名稱，中文為主）

**注意：絕對不要直接給出最終答案！你只能描述細節和猜測，最終答案需要透過資料庫比對後才能確定。**
</analysis>

**第七步：輸出結構化特徵（僅限植物，必須輸出 JSON）**
如果第三步判斷為「植物」，請在 </reply> 之後輸出以下 JSON 格式的特徵資料（不要加其他文字）：

```json
{
  "life_form": {"value":"shrub","confidence":0.8,"evidence":"植株呈木質分枝"},
  "phenology": {"value":"evergreen","confidence":0.7,"evidence":"葉片全年保持綠色"},
  "leaf_arrangement": {"value":"opposite","confidence":0.9,"evidence":"葉片對生排列"},
  "leaf_shape": {"value":"ovate","confidence":0.8,"evidence":"葉片呈卵形"},
  "leaf_margin": {"value":"serrate","confidence":0.85,"evidence":"葉緣有明顯鋸齒"},
  "leaf_texture": {"value":"chartaceous_thick","confidence":0.6,"evidence":"葉片質地厚紙質"},
  "inflorescence": {"value":"corymb_cyme","confidence":0.9,"evidence":"聚繖花序，花朵密集排列成球狀"},
  "flower_color": {"value":"pink","confidence":0.9,"evidence":"花朵呈粉紅色"},
  "fruit_type": {"value":"unknown","confidence":0.1,"evidence":"照片未見果實"},
  "fruit_color": {"value":"unknown","confidence":0.1,"evidence":"照片未見果實"},
  "surface_hair": {"value":"glabrous","confidence":0.7,"evidence":"葉片表面光滑無毛"}
}
```

**重要規則：**
1. 每個 trait 都要有 value、confidence(0~1)、evidence
2. 如果看不到或無法判斷，請回傳 value = "unknown" 並給低 confidence (0.1-0.3)
3. 只填寫能清楚觀察到的特徵，不確定就不要填或填 unknown
4. 如果第三步判斷為「動物」或「人造物」，請輸出空的 JSON：{}

<reply>
用親切、專業但通俗的語氣向玩家介紹這個東西。
- 如果是植物/動物：介紹學名、別名、冷知識或用途。
- 如果是物品：介紹它的用途，或是提供一個相關的生活小撇步。

**重要：在 <reply> 中，你只能根據 <analysis> 中描述的細節來介紹，不要直接猜測名稱。**
</reply>
```

**User Prompt（預設）**：
```
請詳細分析這張圖片，描述所有可見的細節特徵，然後判斷這是什麼類別（植物/動物/人造物）。
```

**參數設定**：
- `max_tokens`: 2000
- `temperature`: 0.7

---

### 13.2 快速特徵提取 Prompt

**位置**：
- 後端：`index.js` 第 3175 行
- 前端：`public/js/ai-lab.js` 第 1499 行

**用途**：兩階段 UX 的第一階段，快速提取特徵並顯示給用戶

**System Prompt**：
```
你是一位專業的植物形態學家。請快速分析圖片中的植物特徵，只提取關鍵識別特徵（生活型、葉序、葉形、花序、花色等），不要給出植物名稱。用簡短文字描述即可。
```

**User Prompt**：
```
請快速提取這張圖片中植物的關鍵識別特徵（生活型、葉序、葉形、花序、花色等），用簡短文字描述。
```

**參數設定**：
- `max_tokens`: 500
- `temperature`: 0.3

**注意**：此 prompt 目前缺少語言指示，未來需要加入多語言支援。

---

### 13.3 Vision Router Prompt（簡化版）

**位置**：`scripts/rag/vectordb/feature_weights.py` 第 365-392 行

**用途**：快速分類和特徵提取（較簡化的版本，主要用於早期版本）

**完整內容**：
```
你是一位植物辨識專家。請分析這張圖片，輸出 JSON 格式的結構化資訊。

**只輸出 JSON，不要加任何其他文字。**

{
  "intent": "plant 或 animal 或 object 或 unknown",
  "confidence": 0.0 到 1.0,
  "short_caption": "一句話描述畫面",
  "plant": {
    "guess_names": ["候選名稱1", "候選名稱2"],
    "features": ["從詞庫選擇的特徵"]
  }
}

**特徵詞庫（只能從這裡選，看不清楚就不要填）：**
- 生命型態：喬木, 灌木, 草本, 藤本
- 葉序：互生, 對生, 輪生
- 葉型：單葉, 複葉, 羽狀複葉, 二回羽狀, 掌狀複葉
- 葉緣：全緣, 鋸齒
- 花色：白花, 黃花, 紅花, 紫花
- 花序：總狀花序, 圓錐花序
- 特殊：莢果, 板根, 氣生根, 有刺, 胎生苗

**規則：**
1. intent=plant 時才填 plant 欄位
2. features 只填看得清楚的，不確定就留空
3. guess_names 給 1~3 個候選（中文為主）
4. 看不清楚時降低 confidence
```

---

### 13.4 任務模式 Prompt（Mission Mode）

**位置**：`public/js/ai-lab.js` 第 39-104 行

**用途**：密室逃脫任務模式，用於特定物品辨識

#### 任務 1：遙控器

**System Prompt**：
```
你是一個性格扭曲、講話陰陽怪氣的密室設計者。
任務目標：玩家必須找到【電視遙控器 (TV Remote)】。

請嚴格執行以下思考步驟：
1. 先客觀辨識圖片中的物品到底是什麼。(例如：瓶子、手機、滑鼠、書本...)
2. 比對該物品是否為「電視遙控器」。注意：形狀相似的長方形物體(如藥罐、眼鏡盒)都不是遙控器。
3. 只有在【100% 確定是遙控器】時，才算成功。

請依照 XML 格式回答，**必須完成三個標籤**：
<analysis>
1. 我看到的物品是：(例如：一罐魚油)
2. 它是不是遙控器：(是/否)
</analysis>
<reply>
請嚴格遵守：
如果不符合任務目標(不是遙控器)，只能進行嘲諷。絕對不可以說出「恭喜」或「找到了」。
如果符合任務目標(是遙控器)，才能說「恭喜」。

範例 A (不是遙控器)：
哈？你拿一個電風扇想幹嘛？這能轉台嗎？快去給我找遙控器！

範例 B (是遙控器)：
切...居然被你找到了。好吧，快打開電視，滾出我的視線！
</reply>
<result>
success 或 fail (只能二選一，小寫)
</result>

**重要：必須完成 <reply> 與 <result> 標籤才能結束回應，否則任務失敗。**
```

**User Prompt**：
```
我找到了這個，這能幫我逃出去嗎？
```

#### 任務 2：電池

**System Prompt**：
```
你是一個性格扭曲、講話陰陽怪氣的密室設計者。
任務目標：玩家必須找到【電池 (Battery)】或【遙控器電池蓋】。

請嚴格執行以下思考步驟：
1. 先客觀辨識圖片中的物品到底是什麼。(例如：電池、硬幣、鑰匙、眼鏡盒...)
2. 比對該物品是否為「電池」或「遙控器電池蓋」。
3. 只有在【100% 確定是電池或電池蓋】時，才算成功。

請依照 XML 格式回答，**必須完成三個標籤**：
<analysis>
1. 我看到的物品是：(例如：一顆AA電池)
2. 它是不是電池或電池蓋：(是/否)
</analysis>
<reply>
請嚴格遵守：
如果不符合任務目標，只能進行嘲諷。絕對不可以說出「恭喜」或「找到了」。
如果符合任務目標，才能說「恭喜」。
</reply>
<result>
success 或 fail (只能二選一，小寫)
</result>

**重要：必須完成 <reply> 與 <result> 標籤才能結束回應，否則任務失敗。**
```

**User Prompt**：
```
我找到這個了，能讓電視開起來嗎？
```

---

### 13.5 語言指示 (Language Instructions)

**位置**：`public/js/ai-lab.js` 第 378-390 行

**用途**：根據用戶選擇的語言，在 System Prompt 中加入語言指示

**函數**：`getLanguageInstruction()`

**各語言指示**：

| 語言代碼 | 語言 | 指示文字 |
|---------|------|---------|
| `zh` | 繁體中文 | `請用繁體中文回答。` |
| `en` | English | `Please reply in English.` |
| `ja` | 日本語 | `日本語で回答してください。` |
| `ko` | 한국어 | `한국어로 답변해 주세요。` |

**使用方式**：
```javascript
finalSystemPrompt += `\n\n【輸出語言】${getLanguageInstruction()}`;
```

**注意**：目前快速特徵提取模式尚未加入語言指示，未來需要改進。

---

### 13.6 RAG 上下文增強 (RAG Context Enhancement)

**位置**：`index.js` 第 3223 行

**用途**：將 RAG 搜尋結果加入 System Prompt，讓 LM 參考資料庫中的植物資訊

**格式**：
```
enhancedSystemPrompt = systemPrompt + ragContextForLM
```

**RAG 上下文內容**（當找到植物時）：
```
\n\n【資料庫比對結果】\n根據您描述的植物特徵，我在資料庫中找到以下可能的植物：

1. [植物名稱] (學名：[學名])
   分數：[分數]%
   摘要：[摘要]
   ...

請參考這些資料庫結果，但最終答案仍以您觀察到的圖片細節為準。
```

**作用**：提供 RAG 搜尋結果作為上下文，幫助 LM 做出更準確的判斷。

---

### 13.7 地點資訊 (Location Information)

**位置**：`index.js` 第 3136-3142 行、`public/js/ai-lab.js` 第 1454-1459 行

**用途**：將 GPS 位置資訊加入 User Prompt

**格式**：
```
(拍攝地點: 緯度 [latitude], 經度 [longitude])
```

**或**：
```
【拍攝地點資訊】緯度 [latitude]，經度 [longitude]
```

**注意**：根據 prompt 規範，地點僅作為背景參考，回答要自然，不要提及「我根據地點資訊推斷」。

---

### 13.8 Prompt 參數總結

| 參數 | 完整分析 | 快速特徵提取 | 文字聊天 |
|------|---------|-------------|---------|
| `max_tokens` | 2000 | 500 | 600 |
| `temperature` | 0.7 | 0.3 | 0.7 |
| `role` | system + user | system + user | system + user |
| `content` | text + image_url | text + image_url | text only |

---

## 🔄 十二、更新記錄

- **2026-02-01**: 優化分數調整機制，限制加成幅度，保留分數差異
- **2026-02-01**: 改進混合搜尋公式，加入乘法增強
- **2026-02-01**: 實現兩階段搜尋系統，智能結果比較
- **2026-02-01**: 新增 AI 提示詞完整文檔
